(()=>{var X=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(e){this.objectFactory=e}size(){return this.keyToIndex.size}add(e){return this.keyToIndex.has(e)?this.storage[this.keyToIndex.get(e)]:(this.storage.length<=this.keyToIndex.size&&this.storage.push(this.objectFactory()),this.keyToIndex.set(e,this.keyToIndex.size),this.indexToKey[this.keyToIndex.size-1]=e,this.storage[this.keyToIndex.get(e)])}remove(e){let n=this.keyToIndex.get(e);if(n==null)return;let s=this.indexToKey[this.keyToIndex.size-1],i=this.storage[n];this.storage[n]=this.storage[this.keyToIndex.size-1],this.storage[this.keyToIndex.size-1]=i,this.indexToKey[n]=s,this.indexToKey.pop(),this.keyToIndex.set(s,n),this.keyToIndex.delete(e)}get(e){let n=this.keyToIndex.get(e);if(n==null)throw new Error("Key not found.");return this.storage[n]}has(e){return this.keyToIndex.has(e)}clean(){this.storage.splice(this.keyToIndex.size)}};var A=class{poolMap=new Map;maskMap=new Map;register(e){this.poolMap.has(e)||(this.maskMap.set(e,1<<this.maskMap.size),this.poolMap.set(e,new X(()=>({...e}))))}getMask(e){let n=this.maskMap.get(e);return n??(this.register(e),this.maskMap.get(e))}add(e,n){return Object.assign(this.poolMap.get(n).add(e),n)}remove(e,n){this.poolMap.get(n).remove(e)}has(e,n){return this.poolMap.has(n)&&this.poolMap.get(n).has(e)}get(e,n){return this.poolMap.get(n).get(e)}size(e){return this.poolMap.get(e).size()}delete(e){for(let n of this.poolMap.entries())n[1].remove(e)}copy(e,n){for(let s of this.poolMap.entries())s[1].has(e)&&Object.assign(s[1].add(n),s[1].get(e))}clean(){for(let e of this.poolMap.entries())e[1].clean()}};function H(){return Math.random()}var q=class{maskMap=new Map;archetypeMap=new Map;compManager=new A;addEntity(e=H()){return this.maskMap.has(e)||this.maskMap.set(e,0),e}copyEntity(e,n=H()){this.compManager.copy(e,n);let s=this.maskMap.get(e)??0;return this.maskMap.set(n,s),this.getArchetype(s).add(n),n}getArchetype(e){let n=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,n),n}deleteEntity(e){this.compManager.delete(e),this.getArchetype(this.maskMap.get(e)??0).delete(e),this.maskMap.delete(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,n){return this.compManager.has(e,n)}addComponent(e,n,s=n){this.compManager.register(n);let i=this.maskMap.get(e)??0,o=this.compManager.getMask(n);return i&o?Object.assign(this.compManager.get(e,n),s):(this.getArchetype(i).delete(e),i^=o,this.maskMap.set(e,i),this.getArchetype(i).add(e),Object.assign(this.compManager.add(e,n),s))}removeComponent(e,n){this.compManager.register(n);let s=this.maskMap.get(e)??0,i=this.compManager.getMask(n);s&i^i||(this.compManager.remove(e,n),this.getArchetype(s).delete(e),s^=i,this.maskMap.set(e,s),this.getArchetype(s).add(e))}getComponent(e,n){return this.compManager.get(e,n)}update(...e){for(let n=0,s=e.length;n<s;n++)e[n](this)}cleanObjectPools(){this.compManager.clean()}query(e){let n=0,s=0;if(e.and)for(let o=0,a=e.and.length;o<a;o++)n|=this.compManager.getMask(e.and[o]);if(e.not)for(let o=0,a=e.not.length;o<a;o++)s|=this.compManager.getMask(e.not[o]);let i=[];for(let o of this.archetypeMap.entries())o[1].size>0&&(o[0]&n)==n&&(o[0]&s)==0&&i.push(...o[1]);return i}entityCount(){return this.maskMap.size}};function te(t,e,n,s,i){let o=new Path2D;return o.moveTo(t+n/2,e),o.arcTo(t+n,e,t+n,e+s/2,i),o.lineTo(t+n,e+s/2),o}function ne(){let t={hearts:new Path2D,spades:new Path2D,clubs:new Path2D,diamonds:new Path2D},e=1;{let n=t.hearts,s=Math.cos(Math.PI/4),i=Math.sin(Math.PI/4),o=e/4,a=e/4,c=e/4;n.arc(o,a,c,0,Math.PI*2),n.arc(o+e/2,a,c,0,Math.PI*2),n.moveTo(o+-i*c,a+s*c),n.lineTo(e/2,e),o+=e/2,n.lineTo(o+s*c,a+i*c)}{let n=t.spades,s=e/4,i=e/2,o=e/4,a=Math.cos(Math.PI/4),c=Math.sin(Math.PI/4);n.arc(s,i,o,0,Math.PI*2),n.arc(s+e/2,i,o,0,Math.PI*2),n.moveTo(s+a*-o,i+c*-o),n.lineTo(e/2,0),n.lineTo(s+e/2+-c*-o,i+a*-o),n.moveTo(e/2,i),n.lineTo(s+e/8,e),n.lineTo(e/8*5,e),n.closePath()}{let n=t.diamonds,s=e*(e-e/4)/(2*(e**2+(e-e/4)**2)**.5);n.arc(e/2,e/2,s,0,Math.PI*2),n.moveTo(e/2,0),n.lineTo(e/8,e/2),n.lineTo(e/2,e),n.lineTo(e-e/8,e/2),n.closePath()}{let n=t.clubs,s=e/4,i=e/2,o=e/4;n.arc(e/2,o,o,0,Math.PI*2),n.arc(s,i,o,0,Math.PI*2),n.arc(s+e/2,i,o,0,Math.PI*2),n.moveTo(e/2,i),n.lineTo(s+e/8,e),n.lineTo(e/8*5,e),n.closePath()}return t}function J(t=1,e=1.43,n=.05,s,i,o,a,c=!1){let r=t*.03,g=t/2,m=Math.cos(Math.PI),y=Math.sin(Math.PI),d=t,f=e;if(a.clearRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle="lightgrey",a.beginPath(),a.roundRect(0,0,t,e,n),a.fill(),a.save(),a.clip(),c?a.fillStyle="darkgrey":a.fillStyle="silver",a.beginPath(),a.roundRect(r,r,t-r*2,e-r*2,n),a.fill(),c){a.save(),a.clip(),a.strokeStyle="silver",a.lineWidth=t*.05;let u=new Path2D;for(let P=e/2;P>0;P-=a.lineWidth*2)u.ellipse(t*.5,0,t*.5,P,0,0,Math.PI);a.setTransform(m,y,-y,m,d,f),a.transform(1,0,0,1,t/2,0),a.stroke(u),a.transform(m,y,-y,m,d,f),a.stroke(u),a.transform(1,0,0,1,t,0),a.stroke(u),a.transform(m,y,-y,m,d,f),a.stroke(u),a.resetTransform(),a.restore()}if(a.strokeStyle="gold",a.fillStyle="gold",c){a.lineWidth=t/30;let u=te(r,r,t-r*2,e-r*2,a.lineWidth);a.stroke(u),a.setTransform(m,y,-y,m,d,f),a.stroke(u),a.resetTransform(),a.lineWidth=t/100,a.roundRect(r*2,r*2,t-r*4,e-r*4,a.lineWidth),a.stroke()}else{{a.lineWidth=t/30;let u=new Path2D;u.moveTo(r,e*.7+r),u.arcTo(r,e-r,t*.3-r,e-r,a.lineWidth),u.lineTo(t*.3-r,e-r),a.stroke(u),a.transform(m,y,-y,m,d,f),a.stroke(u),a.resetTransform()}{a.lineWidth=t/100;let u=new Path2D;u.moveTo(r*2,e*.7+r*2),u.arcTo(r*2,e-r*2,t*.3-r*2,e-r*2,a.lineWidth),u.lineTo(t*.3-r*2,e-r*2),a.stroke(u),a.transform(m,y,-y,m,d,f),a.stroke(u),a.resetTransform()}}a.lineWidth=t/1e4,a.transform(g,0,0,g,r,r),c||a.stroke(o[s]),a.resetTransform(),a.font=`${t/2.5}px sans-serif`;let C=a.measureText(i);a.fillText(i,(t-r*2)/4-C.width/2+r,e/2+C.emHeightAscent),a.transform(m,y,-y,m,d,f),a.fillText(i,(t-r*2)/4-C.width/2+r,e/2+C.emHeightAscent),a.transform(g,0,0,g,r,r),c||a.stroke(o[s]),a.resetTransform(),a.restore()}function F(t=1,e=1.43,n=.05){let s=ne(),i=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],o=document.createElement("canvas"),a=o.getContext("2d");if(!a)throw new Error("cannot initialize 2d context.");o.width=t,o.height=e;let c=Object.keys(s),r={};J(t,e,n,"hearts","",s,a,!0);let g=new Image;g.src=o.toDataURL(),r.back=g;for(let m=0,y=c.length*i.length;m<y;m++){let d=Math.floor(m/i.length),f=m%i.length;J(t,e,n,c[d],i[f],s,a);let C=new Image;C.src=o.toDataURL(),r[`${c[d]}-${i[f]}`]=C}return r}function se(){return{dtMilli:0,timeMilli:0,dtSeconds:0,timeSeconds:0}}function oe(t){let e=performance.now();t.dtMilli=e-t.timeMilli,t.timeMilli+=t.dtMilli,t.dtSeconds=t.dtMilli/1e3,t.timeSeconds=t.timeMilli/1e3}function ae(){let t=[];return globalThis.onpointerup=e=>{e.preventDefault();let n=e.pointerId;t[n]??={x:e.x,y:e.y,isDown:!1,justPressed:!1,justReleased:!1},t[n].x=e.x,t[n].y=e.y,t[n].isDown=!1,t[n].justReleased=!0},globalThis.onpointerdown=e=>{e.preventDefault();let n=e.pointerId;t[n]??={x:e.x,y:e.y,isDown:!1,justPressed:!1,justReleased:!1},t[n].x=e.x,t[n].y=e.y,t[n].isDown=!0,t[n].justPressed=!0},globalThis.onpointermove=e=>{e.preventDefault();let n=e.pointerId;t[n]??={x:e.x,y:e.y,isDown:!1,justPressed:!1,justReleased:!1},t[n].x=e.x,t[n].y=e.y},t}function ie(t){for(let e=0,n=t.length;e<n;e++)t[e].justPressed=!1;for(let e=0,n=t.length;e<n;e++)t[e].justReleased=!1}function re(){let t=document.querySelector("canvas");t||(t=document.createElement("canvas"),document.appendChild(t));let e=t.getContext("2d");if(!e)throw new Error("cannot initialize 2d context.");return{canvas:t,ctx:e}}function Q(t,e){let n=l.canvas.getBoundingClientRect(),s=l.canvas.width/l.canvas.height>innerWidth/innerHeight?innerWidth/l.canvas.width:innerHeight/l.canvas.height;return{x:(t-n.left)/s,y:(e-n.top)/s}}function ce(){l.ctx.fillStyle="orange",l.ctx.beginPath();for(let t=0,e=k.length;t<e;t++){if(!k[t].isDown)continue;let n=Q(k[t].x,k[t].y);l.ctx.rect(n.x,n.y,10,10)}l.ctx.fill()}function L(t,e,n,s,i,o){return t>n&&t<n+i&&e>s&&e<s+o}function he(t){return new Promise(e=>setTimeout(e,t*1e3))}function de(t){for(let e of t.query({and:[j,M]})){let n=t.getComponent(e,j),s=t.getComponent(e,M);s.image=E[n.value],!t.hasComponent(e,v)&&(s.image=E.back)}}function le(t){for(let e of t.query({and:[p,M]})){let n=t.getComponent(e,p),s=t.getComponent(e,M),i=Math.cos(n.rad),o=Math.sin(n.rad);l.ctx.transform(i,o,-o,i,n.x,n.y),l.ctx.transform(n.scaleX,0,0,n.scaleY,0,0),l.ctx.drawImage(s.image,0,0),l.ctx.transform(1/n.scaleX,0,0,1/n.scaleY,0,0),l.ctx.transform(i,-o,o,i,i*-n.x+o*-n.y,-o*-n.x+i*-n.y)}}function pe(t){for(let e of t.query({and:[p,O]})){let n=t.getComponent(e,p),s=t.getComponent(e,O),i=Math.cos(n.rad)*s.zoom,o=Math.sin(n.rad)*s.zoom;l.ctx.setTransform(i,o,-o,i,n.x,n.y)}}function G(t,e=!0){let n,s;for(let a of t.query({and:[p,x]})){let c=t.getComponent(a,p),r=t.getComponent(a,x);c.y==0&&(s=r.entities),c.y==l.canvas.height-S.height&&(n=r.entities)}if(!n||!s)return;let i=t.query({and:[j],not:[v]}),o=i[Math.round(Math.random()*(i.length-1))];t.addComponent(o,v,{isPlayer:e}),t.addComponent(o,p,{x:h.deckX,y:h.deckY}),t.addComponent(o,M),e?n.push(o):s.push(o)}function R(t){let e=t.query({and:[v]}),n=[[],[]],s=0,i=1;for(let o of e)n[t.getComponent(o,v).isPlayer?s:i].push(o);return n}function $(t,e=!0){R(t)[e?0:1].length==0&&G(t,e),G(t,e)}function me(t){let e=t.query({and:[j],not:[v]}),n=t.query({and:[M],not:[j]}),s=n.findIndex(i=>t.getComponent(i,M).image=E.back);if(e.length>0){if(s==-1){let c=t.addEntity();t.addComponent(c,p,{x:h.deckX,y:h.deckY}),t.addComponent(c,M,{image:E.back});return}if(h.status==0)return;let i=t.getComponent(n[s],p),o=t.getComponent(n[s],M),a=!1;for(let c=0,r=k.length;c<r;c++){let g=Q(k[c].x,k[c].y);if(L(g.x,g.y,i.x,i.y,o.image.width*i.scaleX,o.image.height*i.scaleY)&&(a=k[c].justPressed,!!a))break}if(!a)return;$(t)}else t.deleteEntity(n[s])}function fe(t){for(let e of t.query({and:[j,p,M],not:[v,D]}))t.removeComponent(e,p),t.removeComponent(e,M)}function _(t){for(let e of t.query({and:[v]}))t.removeComponent(e,v),t.addComponent(e,D,{x:h.deckX,y:h.deckY});for(let e of t.query({and:[p,x]})){let n=t.getComponent(e,p),s=t.getComponent(e,x);(n.y==0||n.y==l.canvas.height-S.height)&&(s.entities.length=0)}}function N(t){_(t),h.credits=100,h.bet=h.minBet,h.status=0}function Z(){switch(h.status){case 1:h.credits+=Math.floor(h.bet/2*3);break;case 4:case 2:h.credits-=h.bet;break;case 5:h.credits+=h.bet;break;case 0:case 3:}h.bet=Math.min(h.bet,h.credits)}function ue(t){_(t),h.status=0}function V(t,e=[],n=21){let s=0,i=[],o=[];for(let c of e){let r=t.getComponent(c,j),g=De[r.value].sort();i.push(g),o.push(g.length-1),s+=g[g.length-1]}let a=!1;for(;s>n&&!a;){let c=0;for(let r=0,g=o.length;r<g&&!(o[r]!=0&&(c+=o[r],s-=i[r][o[r]],o[r]--,s+=i[r][o[r]],s<=n));r++);a=c==0}return s}function ge(t){for(let e of t.query({and:[I,p,T]})){let n=t.getComponent(e,I),s=t.getComponent(e,p),i=t.getComponent(e,T);for(let o=0,a=k.length;o<a;o++){let c=Q(k[o].x,k[o].y);n.hovered=L(c.x,c.y,s.x,s.y,i.w*s.scaleX,i.h*s.scaleY),n.justPressed=n.hovered&&k[o].justPressed,n.justReleased=n.hovered&&k[o].justReleased}}}function ye(t){for(let e of t.query({and:[U]}))t.getComponent(e,U).callback(e)}function Ce(t){l.ctx.strokeStyle="red",l.ctx.fillStyle="#00000050",l.ctx.beginPath();for(let e of t.query({and:[p,T]})){let n=t.getComponent(e,p),s=t.getComponent(e,T);l.ctx.rect(n.x,n.y,s.w*n.scaleX,s.h*n.scaleY)}l.ctx.fill()}function Me(t){for(let e of t.query({and:[p,D]})){let n=t.getComponent(e,p),s=t.getComponent(e,D),i=t.addComponent(e,Y),o=s.x-n.x,a=s.y-n.y,c=(o*o+a*a)**.5;i.x=o/c*h.cardSpeed,i.y=a/c*h.cardSpeed,!(c>h.cardSpeed*B.dtSeconds)&&(i.x=i.y=0,n.x=s.x,n.y=s.y,t.removeComponent(e,D),t.removeComponent(e,Y))}}function ke(t){for(let e of t.query({and:[p,Y]})){let n=t.getComponent(e,p),s=t.getComponent(e,Y);n.x+=s.x*B.dtSeconds,n.y+=s.y*B.dtSeconds}}function be(t){for(let e of t.query({and:[K,p]})){let n=t.getComponent(e,K),s=t.getComponent(e,p),i=n.content.split(`
`);l.ctx.fillStyle="white",l.ctx.font=n.font;let o=l.ctx.measureText(n.content);for(let a=0,c=i.length;a<c;a++)l.ctx.fillText(i[a],s.x,s.y+o.emHeightAscent*(a+1))}}async function Te(t){let n=R(t),s=V(t,n[1]);for(;s<=16;){$(t,!1);let i=R(t);s=V(t,i[1]),await he(2)}h.status=W(t),Z()}function W(t){let e=R(t),n=0,s=1,i=V(t,e[n]),o=V(t,e[s]);return i>h.targetVal?2:o==0?0:i==h.targetVal&&o!=h.targetVal?1:i==o?3:o>i&&o<=h.targetVal?4:i>o&&i<=h.targetVal||o>h.targetVal?5:0}function ve(t){for(let e of t.query({and:[p,z,x]})){let n=t.getComponent(e,p),s=t.getComponent(e,z),i=t.getComponent(e,x),o=s.padding*n.scaleX,a=s.padding*n.scaleY,c=(s.width-o*2)*n.scaleX,r=o*n.scaleX*(i.entities.length-1),g=0;for(let d of i.entities){let f=t.getComponent(d,p),C=0;t.hasComponent(d,M)&&(C=t.getComponent(d,M).image.width),t.hasComponent(d,T)&&(C=t.getComponent(d,T).w),C*=f.scaleX,r+=C,g=C}let m=r>c,y=m?n.x+o*n.scaleX:n.x+s.width/2-r/2;for(let d=0,f=i.entities,C=f.length;d<C;d++){let u=t.getComponent(f[d],p),P=0;t.hasComponent(f[d],M)&&(P=t.getComponent(f[d],M).image.width),t.hasComponent(f[d],T)&&(P=t.getComponent(f[d],T).w),P*=u.scaleX,t.addComponent(f[d],D,{x:y+(m?(c-g)/(C-1)*d:0),y:n.y+a}),y+=m?0:P+o}}}var K={content:"placeholder",font:""},p={x:0,y:0,rad:0,scaleX:1,scaleY:1},M={image:new Image},O={zoom:1},j={value:"back"},v={isPlayer:!0},I={hovered:!1,justPressed:!1,justReleased:!1},T={w:10,h:10},U={callback:t=>{}},D={x:0,y:0},Y={x:0,y:0},z={width:100,padding:0},x={entities:[]};function xe(t){let e=t.addEntity();t.addComponent(e,p,{x:l.canvas.width*.3,y:l.canvas.height-S.height}),t.addComponent(e,z,{width:l.canvas.width*.65}),t.addComponent(e,x,{entities:[]});let n=t.addEntity();t.addComponent(n,p,{x:l.canvas.width*.3,y:0}),t.addComponent(n,z,{width:l.canvas.width*.65}),t.addComponent(n,x,{entities:[]})}function Pe(t){let e={"bet /2":d=>{if(t.getComponent(d,I).justReleased){if(h.status==0)return;h.bet/=2,h.bet=Math.round(h.bet),h.bet=Math.max(h.minBet,h.bet)}},"bet *2":d=>{if(t.getComponent(d,I).justReleased){if(h.status==0)return;h.bet*=2,h.bet=Math.min(h.bet,h.credits)}},hit:d=>{t.getComponent(d,I).justReleased&&(h.status!=0&&ue(t),$(t),h.status=W(t),Z())},stay:d=>{if(t.getComponent(d,I).justReleased){if(h.status!=0||R(t)[0].length==0)return;Te(t)}},reset:d=>{t.getComponent(d,I).justReleased&&N(t)}},n=100,s=100,i=l.canvas.height/2-s/2,o=5,a=s+o,c=Object.keys(e),r=c.length*a+o,g=l.canvas.width*.6-r/2,m=t.addEntity();t.addComponent(m,p,{x:g,y:i}),t.addComponent(m,z,{width:r,padding:o});let y=t.addComponent(m,x,{entities:[]});for(let d=0,f=c.length;d<f;d++)y.entities.push(Ie(t,c[d],0,0,s,n,e[c[d]]))}function Ie(t,e,n,s,i,o,a=c=>{}){let c=t.addEntity();return t.addComponent(c,p,{x:n,y:s}),t.addComponent(c,U,{callback:a}),t.addComponent(c,T,{w:i,h:o}),t.addComponent(c,I),t.addComponent(c,K,{content:e,font:"20px sans-serif"}),c}function je(t,e){let n=t.addEntity();return t.addComponent(n,j,{value:e}),n}var k=ae(),l=re(),B=se(),S={width:1*200,height:1.43*200,round:.05*200},E=F(S.width,S.height,S.round),De={"hearts-A":[1,11],"hearts-2":[2],"hearts-3":[3],"hearts-4":[4],"hearts-5":[5],"hearts-6":[6],"hearts-7":[7],"hearts-8":[8],"hearts-9":[9],"hearts-10":[10],"hearts-J":[10],"hearts-Q":[10],"hearts-K":[10],"spades-A":[1,11],"spades-2":[2],"spades-3":[3],"spades-4":[4],"spades-5":[5],"spades-6":[6],"spades-7":[7],"spades-8":[8],"spades-9":[9],"spades-10":[10],"spades-J":[10],"spades-Q":[10],"spades-K":[10],"clubs-A":[1,11],"clubs-2":[2],"clubs-3":[3],"clubs-4":[4],"clubs-5":[5],"clubs-6":[6],"clubs-7":[7],"clubs-8":[8],"clubs-9":[9],"clubs-10":[10],"clubs-J":[10],"clubs-Q":[10],"clubs-K":[10],"diamonds-A":[1,11],"diamonds-2":[2],"diamonds-3":[3],"diamonds-4":[4],"diamonds-5":[5],"diamonds-6":[6],"diamonds-7":[7],"diamonds-8":[8],"diamonds-9":[9],"diamonds-10":[10],"diamonds-J":[10],"diamonds-Q":[10],"diamonds-K":[10],back:[0]},h={width:900,height:600,deckX:20,deckY:600/2-150,cardSpeed:1800,credits:100,bet:0,minBet:10,targetVal:21,status:0},Se={0:"",1:"Blackjack",2:"Busted",3:"Draw",4:"Lose",5:"Win"};l.canvas.width=h.width;l.canvas.height=h.height;var b=new q;for(let t in E)t!="back"&&je(b,t);var w=b.addEntity();b.addComponent(w,p);b.addComponent(w,O,{zoom:1});var ee=b.addEntity();b.addComponent(ee,p);var Re=b.addComponent(ee,K,{font:"40px sans-serif"});Pe(b);xe(b);N(b);(function t(){l.ctx.resetTransform(),l.ctx.fillStyle="#424242",l.ctx.fillRect(0,0,l.canvas.width,l.canvas.height),Re.content=`Credits: ${h.credits}
Bet: ${h.bet}
${Se[h.status]}`,ce(),b.update(pe,le,Ce,be),b.update(ve,fe,me,de,ge,Me,ye,ke),oe(B),ie(k),requestAnimationFrame(t)})();})();
//# sourceMappingURL=out.js.map
