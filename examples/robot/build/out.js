(()=>{var T=class{storage=new Map;freeKeys=new Set;count=0;objectFactory;constructor(t){this.objectFactory=t}size(){return this.count}add(t){if(this.has(t))return this.storage.get(t);let n,s;if(this.freeKeys.has(t))s=t;else for(let o of this.freeKeys){s=o;break}return s!=null&&(this.freeKeys.delete(s),n=this.storage.get(s),this.storage.delete(s)),n=n??this.objectFactory(),this.storage.set(t,n),this.count++,n}remove(t){this.has(t)&&(this.freeKeys.add(t),this.count--)}get(t){let n=this.storage.get(t);if(n==null)throw new Error("Key not found.");return n}has(t){return this.storage.has(t)&&!this.freeKeys.has(t)}clean(){for(let t of this.freeKeys)this.storage.delete(t);this.freeKeys.clear()}};var E=class{poolMap=new Map;maskMap=new Map;register(t){this.poolMap.has(t)||(this.maskMap.set(t,1<<this.maskMap.size),this.poolMap.set(t,new T(()=>({...t}))))}getMask(t){return this.maskMap.get(t)??-1}add(t,n){return Object.assign(this.poolMap.get(n).add(t),n)}remove(t,n){this.poolMap.get(n).remove(t)}has(t,n){return this.poolMap.has(n)&&this.poolMap.get(n).has(t)}get(t,n){return this.poolMap.get(n).get(t)}size(t){return this.poolMap.get(t).size()}delete(t){for(let n of this.poolMap.entries())n[1].remove(t)}copy(t,n){for(let s of this.poolMap.entries())s[1].has(t)&&Object.assign(s[1].add(n),s[1].get(t))}clean(){for(let t of this.poolMap.entries())t[1].clean()}};function z(){return Math.random()}var I=class{maskMap=new Map;archetypeMap=new Map;compManager=new E;addEntity(t=z()){return this.maskMap.has(t)||this.maskMap.set(t,0),t}copyEntity(t,n=z()){this.compManager.copy(t,n);let s=this.maskMap.get(t)??0;return this.maskMap.set(n,s),this.getArchetype(s).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.compManager.delete(t),this.getArchetype(this.maskMap.get(t)??0).delete(t),this.maskMap.delete(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return this.compManager.has(t,n)}addComponent(t,n,s=n){this.compManager.register(n);let o=this.maskMap.get(t)??0,a=this.compManager.getMask(n);return o&a?Object.assign(this.compManager.get(t,n),s):(this.getArchetype(o).delete(t),o^=a,this.maskMap.set(t,o),this.getArchetype(o).add(t),Object.assign(this.compManager.add(t,n),s))}removeComponent(t,n){this.compManager.register(n);let s=this.maskMap.get(t)??0,o=this.compManager.getMask(n);s&o^o||(this.compManager.remove(t,n),this.getArchetype(s).delete(t),s^=o,this.maskMap.set(t,s),this.getArchetype(s).add(t))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,s=t.length;n<s;n++)t[n](this)}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,s=0;if(t.and)for(let a=0,i=t.and.length;a<i;a++)n|=this.compManager.getMask(t.and[a]);if(t.not)for(let a=0,i=t.not.length;a<i;a++)s|=this.compManager.getMask(t.not[a]);let o=[];for(let a of this.archetypeMap.entries())a[1].size>0&&(a[0]&n)==n&&(a[0]&s)==0&&o.push(...a[1]);return o}entityCount(){return this.maskMap.size}};var c=B(),x=Y(),A=X();function B(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function Y(){return{dtMilli:0,timeMilli:0}}function G(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function X(){let e={pos:new Map,isDown:new Map,justPressed:new Map,justReleased:new Map,pressPos:new Map,releasePos:new Map};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.pos.set(t.pointerId,{x:t.x,y:t.y}),e.pressPos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.set(t.pointerId,!0),e.justPressed.set(t.pointerId,!0))},globalThis.onpointerup=t=>{e.pos.delete(t.pointerId),e.releasePos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.delete(t.pointerId),e.justReleased.set(t.pointerId,!0)},globalThis.onpointermove=t=>{e.pos.set(t.pointerId,{x:t.x,y:t.y})},e}function J(e){e.justReleased.clear(),e.justPressed.clear(),e.releasePos.clear(),e.pressPos.clear()}var p={x:0,y:0,rad:0},g={parent:-1,children:[]},k={eyeWhiteRadius:1,pupilRadius:.4,lookAtEntity:-1},l={zoom:20,tilt:0,isActive:!1},b={width:1,height:1},Q={density:.1},C={x:0,y:0},R={x:0,y:0},j={},M={radPerSecond:0};function f(e,t=0,n=0,s={width:1,height:1},o={x:0,y:0},a=-1){let i=e.addEntity();e.addComponent(i,p,{x:t,y:n}),e.addComponent(i,C),e.addComponent(i,R),e.addComponent(i,M);let r=e.addEntity();return e.addComponent(r,p,o),e.addComponent(r,b,s),e.addComponent(r,Q),F(e,a,i),F(e,i,r),i}function W(e,t=0,n=0,s=1,o=.4,a=-1,i=-1){let r=e.addEntity();return e.addComponent(r,p,{x:t,y:n}),e.addComponent(r,g,{parent:i}),e.addComponent(r,k,{eyeWhiteRadius:s,pupilRadius:o,lookAtEntity:a}),r}function $(e,t=0,n=0,s=-1){let o={width:1,height:1},a={x:-.5,y:0},i={width:1,height:2},r={x:-.5,y:-2},h={width:.5,height:.9},d={x:-.25,y:-.9},m=f(e,t,n,i,r),u=f(e,0,.2,o,a,m),O=W(e,.4,.4,.3,.1,s,u),U=W(e,-.4,.4,.3,.1,s,u),L=f(e,1,0,h,d,m),H=f(e,0,-1,h,d,L),S=f(e,-1,0,h,d,m),V=f(e,0,-1,h,d,S),q=f(e,.5,-2.2,h,d,m),_=f(e,0,-1,h,d,q),D=f(e,-.5,-2.2,h,d,m),N=f(e,0,-1,h,d,D);return{head:u,rightEye:U,leftEye:O,torso:m,rightUpperArm:S,rightLowerArm:V,leftUpperArm:L,leftLowerArm:H,rightUpperLeg:D,rightLowerLeg:N,leftUpperLeg:q,leftLowerLeg:_}}function Z(e){e.query({and:[p,M]}).forEach(t=>{let n=e.getComponent(t,p),s=e.getComponent(t,M);n.rad+=s.radPerSecond*x.dtMilli/1e3})}function w(e){c.ctx.beginPath(),e.query({and:[p,b]}).forEach(t=>{let{x:n,y:s,rad:o}=v(e,t),a=e.getComponent(t,b),i=Math.cos(o),r=Math.sin(o);c.ctx.transform(i,r,-r,i,n,s),c.ctx.rect(0,0,a.width,a.height),c.ctx.transform(i,-r,r,i,i*-n+r*-s,-r*-n+i*-s)}),c.ctx.fillStyle="white",c.ctx.fill()}function tt(e){e.query({and:[p,k,g]}).forEach(t=>{let n=e.getComponent(t,k),{x:s,y:o}=v(e,t);c.ctx.fillStyle="lightgrey",c.ctx.beginPath(),c.ctx.ellipse(s,o,n.eyeWhiteRadius,n.eyeWhiteRadius,0,0,Math.PI*2),c.ctx.fill();let a=0,i=0,r=n.eyeWhiteRadius-n.pupilRadius;if(n.lookAtEntity!=-1){let h=e.getComponent(n.lookAtEntity,p);a=h.x-s,i=h.y-o;let d=(a**2+i**2)**.5;a/=d,i/=d,r=Math.min(d,r)}c.ctx.fillStyle="black",c.ctx.beginPath(),c.ctx.ellipse(s+a*r,o+i*r,n.pupilRadius,n.pupilRadius,0,0,Math.PI*2),c.ctx.fill()})}function et(e){let t=e.query({and:[l,p]}).find(h=>e.getComponent(h,l).isActive);if(!t)return;c.ctx.resetTransform();let n=e.getComponent(t,l),s=e.getComponent(t,p);if(e.hasComponent(t,g)){let h=e.getComponent(t,g);e.hasComponent(h.parent,p)&&Object.assign(s,v(e,h.parent))}let o=Math.sin(s.rad+n.tilt),a=Math.cos(s.rad+n.tilt),i=s.x*n.zoom,r=s.y*-n.zoom;c.ctx.transform(a,o,-o,a,a*-i-o*-r+c.canvas.width*.5,o*-i+a*-r+c.canvas.height*.5),c.ctx.transform(n.zoom,0,0,-n.zoom,0,0)}function nt(e){e.query({and:[C,R]}).forEach(t=>{let n=e.getComponent(t,C),s=e.getComponent(t,R);n.x+=s.x*x.dtMilli/1e3,n.y+=s.y*x.dtMilli/1e3}),e.query({and:[p,C]}).forEach(t=>{let n=e.getComponent(t,p),s=e.getComponent(t,C);n.x+=s.x*x.dtMilli/1e3,n.y+=s.y*x.dtMilli/1e3})}function st(e){e.query({and:[j]}).forEach(o=>e.deleteEntity(o));let t=e.query({and:[l,p]}).find(o=>e.getComponent(o,l).isActive);if(!t)return;let n=e.getComponent(t,l),s=e.getComponent(t,p);A.isDown.forEach((o,a)=>{let i=e.addEntity(),r=A.pos.get(a);r&&(e.addComponent(i,p,at(rt(r,c.canvas,!0),s,n.tilt,n.zoom)),e.addComponent(i,j),e.addComponent(i,b))})}function ot(e){e.query({and:[k,p]}).forEach(t=>{let n=e.getComponent(t,k),{x:s,y:o}=v(e,t),a=-1,i=Number.POSITIVE_INFINITY;e.query({and:[j,p]}).forEach(r=>{let h=e.getComponent(r,p),d=h.x-s,m=h.y-o,u=(d**2+m**2)**.5;u>i||(i=u,a=r)}),n.lookAtEntity=a??-1})}function it(e="#202020"){c.ctx.resetTransform(),c.ctx.fillStyle=e,c.ctx.fillRect(0,0,c.canvas.width,c.canvas.height)}function at(e,t,n,s){let o=Math.cos(n),a=Math.sin(n),i={x:0,y:0},r=e.x-c.canvas.width/2,h=e.y-c.canvas.height/2;return i.x=o*r-a*h,i.y=a*r+o*h,i.x/=s,i.y/=s,i.x+=t.x,i.y+=t.y,i}function rt(e,t,n=!1){let s={x:0,y:0},o=t.getBoundingClientRect();return s.x=e.x-o.left,s.y=e.y-o.top,innerWidth/innerHeight<t.width/t.height?(s.x*=t.width/innerWidth,s.y*=t.width/innerWidth):(s.x*=t.height/innerHeight,s.y*=t.height/innerHeight),n&&(s.y=-s.y+t.height),s}function v(e,t){let n=e.getComponent(t,p);if(!e.hasComponent(t,g))return n;let s=n.x,o=n.y,a=n.rad,i=e.getComponent(t,g);for(;e.hasComponent(i.parent,g);){if(e.hasComponent(i.parent,p)){let r=e.getComponent(i.parent,p),h=Math.cos(r.rad),d=Math.sin(r.rad),m=s,u=o;s=h*m-d*u,o=d*m+h*u,s+=r.x,o+=r.y,a+=r.rad}i=e.getComponent(i.parent,g)}return{x:s,y:o,rad:a}}function F(e,t,n){if(t!=-1){!e.hasComponent(t,g)&&e.addComponent(t,g,{children:[]});let o=e.getComponent(t,g);for(let a=0,i=o.children.length;a<i;a++)if(o.children[a]==n)return;o.children.push(n)}!e.hasComponent(n,g)&&e.addComponent(n,g,{children:[]});let s=e.getComponent(n,g);s.parent=t}var y=new I,P=$(y,0,0);y.getComponent(P.rightUpperLeg,M).radPerSecond=2;y.getComponent(P.rightLowerLeg,M).radPerSecond=-2;y.getComponent(P.leftLowerArm,M).radPerSecond=-1;var K=y.addEntity();y.addComponent(K,p,{x:0,y:0});y.addComponent(K,l,{zoom:18,isActive:!0});y.addComponent(K,g,{parent:P.torso});(function e(){requestAnimationFrame(e),it(),y.update(et,st,ot,w,tt,nt,Z),G(x),J(A)})();})();
//# sourceMappingURL=out.js.map
