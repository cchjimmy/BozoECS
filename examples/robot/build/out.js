(()=>{var T=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(t){this.objectFactory=t}size(){return this.keyToIndex.size}add(t){return this.keyToIndex.has(t)?this.storage[this.keyToIndex.get(t)]:(this.storage.length<=this.keyToIndex.size&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.keyToIndex.size),this.indexToKey[this.keyToIndex.size-1]=t,this.storage[this.keyToIndex.get(t)])}remove(t){let n=this.keyToIndex.get(t);if(n==null)return;let o=this.indexToKey[this.keyToIndex.size-1],s=this.storage[n];this.storage[n]=this.storage[this.keyToIndex.size-1],this.storage[this.keyToIndex.size-1]=s,this.indexToKey[n]=o,this.indexToKey.pop(),this.keyToIndex.set(o,n),this.keyToIndex.delete(t)}get(t){let n=this.keyToIndex.get(t);if(n==null)throw new Error("Key not found.");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.keyToIndex.size)}};var I=class{poolMap=new Map;idMap=new Map;register(t){this.poolMap.has(t)||(this.idMap.set(t,this.idMap.size),this.poolMap.set(t,new T(()=>({...t}))))}getId(t){let n=this.idMap.get(t);return n??(this.register(t),this.idMap.get(t))}add(t,n){return Object.assign(this.poolMap.get(n).add(t),n)}remove(t,n){this.poolMap.get(n).remove(t)}has(t,n){return this.poolMap.has(n)&&this.poolMap.get(n).has(t)}get(t,n){return this.poolMap.get(n).get(t)}size(t){return this.poolMap.get(t).size()}delete(t){for(let n of this.poolMap.entries())n[1].remove(t)}copy(t,n){for(let o of this.poolMap.entries())o[1].has(t)&&Object.assign(o[1].add(n),o[1].get(t))}clean(){for(let t of this.poolMap.entries())t[1].clean()}};function v(){return Math.random()}var b=class{compEntityMap=new Map;compManager=new I;entitySet=new Set;addEntity(t=v()){return this.entitySet.add(t),t}copyEntity(t,n=v()){this.compManager.copy(t,n);for(let o of this.compEntityMap)o[1].has(t)&&o[1].add(n);return this.entitySet.add(n),n}getCompEntityMap(t){let n=this.compEntityMap.get(t)??new Set;return this.compEntityMap.set(t,n),n}deleteEntity(t){this.compManager.delete(t);for(let n of this.compEntityMap)n[1].delete(t);this.entitySet.delete(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return this.compManager.has(t,n)}addComponent(t,n,o=n){this.compManager.register(n);let s=this.getCompEntityMap(this.compManager.getId(n));return s.has(t)?Object.assign(this.compManager.get(t,n),o):(s.add(t),Object.assign(this.compManager.add(t,n),o))}removeComponent(t,n){this.compManager.register(n);let o=this.getCompEntityMap(this.compManager.getId(n));o.has(t)&&o.delete(t)}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this)}cleanObjectPools(){this.compManager.clean()}query(t){let n=this.entitySet;if(t.and)for(let o of t.and)n=n.intersection(this.getCompEntityMap(this.compManager.getId(o)));if(t.not)for(let o of t.not)n=n.difference(this.getCompEntityMap(this.compManager.getId(o)));return[...n]}entityCount(){return this.entitySet.size}};var c=B(),x=Y(),S=X();function B(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function Y(){return{dtMilli:0,timeMilli:0}}function G(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function X(){let e={pos:new Map,isDown:new Map,justPressed:new Map,justReleased:new Map,pressPos:new Map,releasePos:new Map};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.pos.set(t.pointerId,{x:t.x,y:t.y}),e.pressPos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.set(t.pointerId,!0),e.justPressed.set(t.pointerId,!0))},globalThis.onpointerup=t=>{e.pos.delete(t.pointerId),e.releasePos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.delete(t.pointerId),e.justReleased.set(t.pointerId,!0)},globalThis.onpointermove=t=>{e.pos.set(t.pointerId,{x:t.x,y:t.y})},e}function J(e){e.justReleased.clear(),e.justPressed.clear(),e.releasePos.clear(),e.pressPos.clear()}var p={x:0,y:0,rad:0},g={parent:-1,children:[]},E={eyeWhiteRadius:1,pupilRadius:.4,lookAtEntity:-1},l={zoom:20,tilt:0,isActive:!1},P={width:1,height:1},Q={density:.1},M={x:0,y:0},R={x:0,y:0},A={},C={radPerSecond:0};function y(e,t=0,n=0,o={width:1,height:1},s={x:0,y:0},r=-1){let i=e.addEntity();e.addComponent(i,p,{x:t,y:n}),e.addComponent(i,M),e.addComponent(i,R),e.addComponent(i,C);let a=e.addEntity();return e.addComponent(a,p,s),e.addComponent(a,P,o),e.addComponent(a,Q),U(e,r,i),U(e,i,a),i}function W(e,t=0,n=0,o=1,s=.4,r=-1,i=-1){let a=e.addEntity();return e.addComponent(a,p,{x:t,y:n}),e.addComponent(a,g,{parent:i}),e.addComponent(a,E,{eyeWhiteRadius:o,pupilRadius:s,lookAtEntity:r}),a}function $(e,t=0,n=0,o=-1){let s={width:1,height:1},r={x:-.5,y:0},i={width:1,height:2},a={x:-.5,y:-2},h={width:.5,height:.9},d={x:-.25,y:-.9},m=y(e,t,n,i,a),f=y(e,0,.2,s,r,m),H=W(e,.4,.4,.3,.1,o,f),K=W(e,-.4,.4,.3,.1,o,f),L=y(e,1,0,h,d,m),F=y(e,0,-1,h,d,L),q=y(e,-1,0,h,d,m),V=y(e,0,-1,h,d,q),O=y(e,.5,-2.2,h,d,m),_=y(e,0,-1,h,d,O),D=y(e,-.5,-2.2,h,d,m),N=y(e,0,-1,h,d,D);return{head:f,rightEye:K,leftEye:H,torso:m,rightUpperArm:q,rightLowerArm:V,leftUpperArm:L,leftLowerArm:F,rightUpperLeg:D,rightLowerLeg:N,leftUpperLeg:O,leftLowerLeg:_}}function Z(e){e.query({and:[p,C]}).forEach(t=>{let n=e.getComponent(t,p),o=e.getComponent(t,C);n.rad+=o.radPerSecond*x.dtMilli/1e3})}function w(e){c.ctx.beginPath(),e.query({and:[p,P]}).forEach(t=>{let{x:n,y:o,rad:s}=k(e,t),r=e.getComponent(t,P),i=Math.cos(s),a=Math.sin(s);c.ctx.transform(i,a,-a,i,n,o),c.ctx.rect(0,0,r.width,r.height),c.ctx.transform(i,-a,a,i,i*-n+a*-o,-a*-n+i*-o)}),c.ctx.fillStyle="white",c.ctx.fill()}function tt(e){e.query({and:[p,E,g]}).forEach(t=>{let n=e.getComponent(t,E),{x:o,y:s}=k(e,t);c.ctx.fillStyle="lightgrey",c.ctx.beginPath(),c.ctx.ellipse(o,s,n.eyeWhiteRadius,n.eyeWhiteRadius,0,0,Math.PI*2),c.ctx.fill();let r=0,i=0,a=n.eyeWhiteRadius-n.pupilRadius;if(n.lookAtEntity!=-1){let h=e.getComponent(n.lookAtEntity,p);r=h.x-o,i=h.y-s;let d=(r**2+i**2)**.5;r/=d,i/=d,a=Math.min(d,a)}c.ctx.fillStyle="black",c.ctx.beginPath(),c.ctx.ellipse(o+r*a,s+i*a,n.pupilRadius,n.pupilRadius,0,0,Math.PI*2),c.ctx.fill()})}function et(e){let t=e.query({and:[l,p]}).find(h=>e.getComponent(h,l).isActive);if(!t)return;c.ctx.resetTransform();let n=e.getComponent(t,l),o=e.getComponent(t,p);if(e.hasComponent(t,g)){let h=e.getComponent(t,g);e.hasComponent(h.parent,p)&&Object.assign(o,k(e,h.parent))}let s=Math.sin(o.rad+n.tilt),r=Math.cos(o.rad+n.tilt),i=o.x*n.zoom,a=o.y*-n.zoom;c.ctx.transform(r,s,-s,r,r*-i-s*-a+c.canvas.width*.5,s*-i+r*-a+c.canvas.height*.5),c.ctx.transform(n.zoom,0,0,-n.zoom,0,0)}function nt(e){e.query({and:[M,R]}).forEach(t=>{let n=e.getComponent(t,M),o=e.getComponent(t,R);n.x+=o.x*x.dtMilli/1e3,n.y+=o.y*x.dtMilli/1e3}),e.query({and:[p,M]}).forEach(t=>{let n=e.getComponent(t,p),o=e.getComponent(t,M);n.x+=o.x*x.dtMilli/1e3,n.y+=o.y*x.dtMilli/1e3})}function ot(e){e.query({and:[A]}).forEach(s=>e.deleteEntity(s));let t=e.query({and:[l,p]}).find(s=>e.getComponent(s,l).isActive);if(!t)return;let n=e.getComponent(t,l),o=e.getComponent(t,p);S.isDown.forEach((s,r)=>{let i=e.addEntity(),a=S.pos.get(r);a&&(e.addComponent(i,p,at(rt(a,c.canvas,!0),o,n.tilt,n.zoom)),e.addComponent(i,A),e.addComponent(i,P))})}function it(e){e.query({and:[E,p]}).forEach(t=>{let n=e.getComponent(t,E),{x:o,y:s}=k(e,t),r=-1,i=Number.POSITIVE_INFINITY;e.query({and:[A,p]}).forEach(a=>{let h=e.getComponent(a,p),d=h.x-o,m=h.y-s,f=(d**2+m**2)**.5;f>i||(i=f,r=a)}),n.lookAtEntity=r??-1})}function st(e="#202020"){c.ctx.resetTransform(),c.ctx.fillStyle=e,c.ctx.fillRect(0,0,c.canvas.width,c.canvas.height)}function at(e,t,n,o){let s=Math.cos(n),r=Math.sin(n),i={x:0,y:0},a=e.x-c.canvas.width/2,h=e.y-c.canvas.height/2;return i.x=s*a-r*h,i.y=r*a+s*h,i.x/=o,i.y/=o,i.x+=t.x,i.y+=t.y,i}function rt(e,t,n=!1){let o={x:0,y:0},s=t.getBoundingClientRect();return o.x=e.x-s.left,o.y=e.y-s.top,innerWidth/innerHeight<t.width/t.height?(o.x*=t.width/innerWidth,o.y*=t.width/innerWidth):(o.x*=t.height/innerHeight,o.y*=t.height/innerHeight),n&&(o.y=-o.y+t.height),o}function k(e,t){let n=e.getComponent(t,p);if(!e.hasComponent(t,g))return n;let o=n.x,s=n.y,r=n.rad,i=e.getComponent(t,g);for(;e.hasComponent(i.parent,g);){if(e.hasComponent(i.parent,p)){let a=e.getComponent(i.parent,p),h=Math.cos(a.rad),d=Math.sin(a.rad),m=o,f=s;o=h*m-d*f,s=d*m+h*f,o+=a.x,s+=a.y,r+=a.rad}i=e.getComponent(i.parent,g)}return{x:o,y:s,rad:r}}function U(e,t,n){if(t!=-1){!e.hasComponent(t,g)&&e.addComponent(t,g,{children:[]});let s=e.getComponent(t,g);for(let r=0,i=s.children.length;r<i;r++)if(s.children[r]==n)return;s.children.push(n)}!e.hasComponent(n,g)&&e.addComponent(n,g,{children:[]});let o=e.getComponent(n,g);o.parent=t}var u=new b,z=$(u,0,0);u.getComponent(z.rightUpperLeg,C).radPerSecond=2;u.getComponent(z.rightLowerLeg,C).radPerSecond=-2;u.getComponent(z.leftLowerArm,C).radPerSecond=-1;var j=u.addEntity();u.addComponent(j,p,{x:0,y:0});u.addComponent(j,l,{zoom:18,isActive:!0});u.addComponent(j,g,{parent:z.torso});(function e(){requestAnimationFrame(e),st(),u.update(et,ot,it,w,tt,nt,Z),G(x),J(S)})();})();
//# sourceMappingURL=out.js.map
