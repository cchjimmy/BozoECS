(()=>{var C=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}add(t){let n=this.keyToIndex.get(t);return n!=null?this.storage[n]:(this.size>=this.storage.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.size),this.indexToKey[this.size]=t,this.size++,this.storage[this.size-1])}remove(t){let n=this.keyToIndex.get(t)??-1,s=this.indexToKey[this.size-1];if(n<0||n>=this.size||!s)return!1;let o=this.storage[n];return this.storage[n]=this.storage[this.size-1],this.storage[this.size-1]=o,this.keyToIndex.set(s,n),this.keyToIndex.delete(t),this.indexToKey[n]=s,this.size--,!0}get(t){let n=this.keyToIndex.get(t)??-1;if(n<0||n>=this.size)throw new Error("Index out of range.");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.size),this.indexToKey.splice(this.size);for(let t of this.keyToIndex.keys()){let n=this.keyToIndex.get(t)??-1;(n<0||n>=this.size)&&this.keyToIndex.delete(t)}}};var k=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new C(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,n){return Object.assign(this.pools.get(n).add(t),n)}remove(t,n){return this.pools.get(n).remove(t)}get(t,n){return this.pools.get(n).get(t)}len(t){return this.pools.get(t).len()}delete(t){for(let n of this.pools.values())n.remove(t)}copy(t,n){for(let s of this.pools.values()){let o=s;o.has(t)&&Object.assign(o.add(n),o.get(t))}}clean(){for(let t of this.pools.values())t.clean()}};function E(){return Math.random()}var T=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new k;addEntity(t=E()){return this.maskMap.set(t,0),this.getArchetype(0).add(t),t}copyEntity(t,n=E()){this.compManager.copy(t,n);let s=this.maskMap.get(t)??0;return this.maskMap.set(n,s),this.getArchetype(s).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.entitiesToDelete.push(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return((this.maskMap.get(t)??0)&1<<this.compManager.getId(n))>0}addComponent(t,n,s=n){this.registerComponent(n);let o=this.maskMap.get(t)??0,a=this.compManager.getId(n);return(o&1<<a)!=0?Object.assign(this.compManager.get(t,n),s):(this.getArchetype(o).delete(t),o|=1<<a,this.maskMap.set(t,o),this.getArchetype(o).add(t),Object.assign(this.compManager.add(t,n),s))}removeComponent(t,n){this.registerComponent(n);let s=this.maskMap.get(t)??0,o=this.compManager.getId(n);return(s&1<<o)==0?!1:(this.getArchetype(s).delete(t),s&=~(1<<o),this.maskMap.set(t,s),this.getArchetype(s).add(t),this.compManager.remove(t,n))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,s=t.length;n<s;n++)t[n](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let t=this.entitiesToDelete.pop();this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,s=0;if(t.and)for(let a=0,h=t.and.length;a<h;a++)n|=1<<this.compManager.getId(t.and[a]);if(t.not)for(let a=0,h=t.not.length;a<h;a++)s|=1<<this.compManager.getId(t.not[a]);let o=[];return this.archetypeMap.forEach((a,h)=>{let d=a;d.size>0&&(h&n)==n&&(h&s)==0&&o.push(...d)}),[...new Set(o)]}entityCount(){return this.maskMap.size}};var i=j(),M=D(),f=z(),x=A(),g={snakeWidth:10,foodRadius:15,startLength:5};function j(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function D(){return{dtMilli:0,timeMilli:0}}function P(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function z(){let e={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!e.isDown[t.key]&&(e.justPressed[t.key]=!0),e.isDown[t.key]=!0},globalThis.onkeyup=t=>{e.isDown[t.key]=!1,e.justReleased[t.key]=!0},e}function R(e){for(let t in e.justPressed)e.justPressed[t]=!1;for(let t in e.justReleased)e.justReleased[t]=!1}function A(){let e={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.x=t.x,e.y=t.y,Object.assign(e.pressPos,e),e.isDown=e.justPressed=!0)},globalThis.onpointerup=t=>{e.x=t.x,e.y=t.y,Object.assign(e.releasePos,e),e.isDown=!1,e.justReleased=!0},globalThis.onpointermove=t=>{e.x=t.x,e.y=t.y},e}function S(e){e.justPressed=!1,e.justReleased=!1}var r={x:0,y:0,rad:0},p={x:0,y:0},c={parent:-1,child:-1},y={},v={};function q(e){e.query({and:[r,p]}).forEach(t=>{let n=e.getComponent(t,r),s=e.getComponent(t,p);n.x+=s.x*M.dtMilli/1e3,n.y+=s.y*M.dtMilli/1e3,!(s.x==0&&s.y==0)&&(n.rad=Math.atan2(s.y,s.x))})}function F(e){i.ctx.fillStyle="#202020",i.ctx.fillRect(0,0,i.canvas.width,i.canvas.height),i.ctx.fillStyle="#F0A0A0",i.ctx.beginPath(),e.query({and:[r,v]}).forEach(t=>{let n=e.getComponent(t,r);i.ctx.ellipse(n.x,n.y,g.foodRadius,g.foodRadius,0,0,Math.PI*2)}),i.ctx.fill(),i.ctx.beginPath(),e.query({and:[r,c]}).forEach(t=>{let n=e.getComponent(t,c),s=e.getComponent(t,r);if(i.ctx.moveTo(s.x,s.y),n.child!=-1&&e.hasComponent(n.child,r)){let o=e.getComponent(n.child,r);i.ctx.lineTo(o.x,o.y)}}),i.ctx.strokeStyle="#F0D0D0",i.ctx.lineCap="round",i.ctx.lineWidth=g.snakeWidth,i.ctx.stroke(),i.ctx.fillStyle="white",i.ctx.fillText(`Score: ${e.query({and:[c]}).length-g.startLength}; Best: ${localStorage.getItem("snake_best")??0}`,0,10)}function K(e){e.query({and:[y,p]}).forEach(t=>{let n=e.getComponent(t,p),s=0;(f.isDown.a||f.isDown.ArrowLeft||x.isDown&&x.x<i.canvas.width/2)&&(s-=Math.PI),(f.isDown.d||f.isDown.ArrowRight||x.isDown&&x.x>i.canvas.width/2)&&(s+=Math.PI);let o=Math.cos(s*M.dtMilli/1e3),a=Math.sin(s*M.dtMilli/1e3),h=n.x,d=n.y;n.x=o*h-a*d,n.y=a*h+o*d})}function L(e){e.query({and:[y,r,c,p]}).forEach(t=>{let n=e.getComponent(t,r),s=e.query({and:[c],not:[y]}).find(o=>{if(e.getComponent(o,c).parent==t)return!1;let h=e.getComponent(o,r);return(h.x-n.x)**2+(h.y-n.y)**2<6**2});if(n.x>i.canvas.width||n.x<0||n.y>i.canvas.height||n.y<0||e.entityCount()<g.startLength||s!=null){let o=e.query({and:[c]}).length-g.startLength;o>Number.parseInt(localStorage.getItem("snake_best")??"0")&&localStorage.setItem("snake_best",o.toString()),n.x=i.canvas.width/2,n.y=i.canvas.height/2,e.query({not:[y]}).forEach(d=>e.deleteEntity(d)),e.getComponent(t,c).child=-1;let a=e.getComponent(t,p);a.x=40,a.y=0;let h=t;for(let d=0;d<g.startLength-1;d++){let l=e.addEntity();e.addComponent(l,p),e.addComponent(l,c,{parent:h});let u=e.getComponent(h,r);e.addComponent(l,r,{x:u.x-6,y:u.y}),e.getComponent(h,c).child=l,h=l}}})}function O(e){if(e.query({and:[v]}).length>0)return;let n=e.addEntity();e.addComponent(n,v),e.addComponent(n,r,{x:Math.random()*i.canvas.width,y:Math.random()*i.canvas.height})}function H(e){e.query({and:[y,r]}).forEach(t=>{let n=e.getComponent(t,r);e.query({and:[v,r]}).forEach(s=>{let o=e.getComponent(s,r);if((n.x-o.x)**2<((g.snakeWidth+g.foodRadius)/2)**2&&(n.y-o.y)**2<((g.snakeWidth+g.foodRadius)/2)**2){e.deleteEntity(s);let a=e.query({and:[c]}).find(d=>e.getComponent(d,c).child==-1);if(!a||!e.hasComponent(a,r)||!e.hasComponent(a,c))return;let h=e.addEntity();e.addComponent(h,p),e.addComponent(h,c,{parent:a}),e.addComponent(h,r,e.getComponent(a,r)),e.getComponent(a,c).child=h}})})}function W(e){e.query({and:[c,r,p]}).forEach(t=>{let n=e.getComponent(t,c),s=e.getComponent(t,r),o=e.getComponent(t,p);if(n.parent!=-1&&e.hasComponent(n.parent,r)&&e.hasComponent(n.parent,p)){let a=e.getComponent(n.parent,r);if((s.x-a.x)**2+(s.y-a.y)**2<50){o.x=o.y=0;return}let h=e.getComponent(n.parent,p),d=(h.x**2+h.y**2)**.5,l=a.x-s.x,u=a.y-s.y,I=(l**2+u**2)**.5;o.x=l/I*d,o.y=u/I*d}})}var m=new T,b=m.addEntity();m.addComponent(b,r,{x:i.canvas.width/2,y:i.canvas.height/2});m.addComponent(b,p,{x:40});m.addComponent(b,y);m.addComponent(b,c);(function e(){requestAnimationFrame(e),m.update(F,L,O,H,K,q,W),P(M),R(f),S(x)})();})();
//# sourceMappingURL=out.js.map
