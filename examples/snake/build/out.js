(()=>{var j=class{storage=[];map=new Map;objectFactory;constructor(e){this.objectFactory=e}size(){return this.map.size}add(e){let n=this.map.get(e);return n||(this.storage.push(this.objectFactory()),this.map.set(e,this.storage[this.storage.length-1]),this.storage[this.storage.length-1])}remove(e){this.map.delete(e)}get(e){let n=this.map.get(e);if(!n)throw new Error("Key not found");return n}has(e){return this.map.has(e)}clean(){this.storage.splice(this.map.size)}};var I=class{pools=new Map;idMap=new Map;register(e){this.pools.has(e)||(this.idMap.set(e,this.idMap.size),this.pools.set(e,new j(()=>({...e}))))}getId(e){return this.idMap.get(e)??-1}add(e,n){return Object.assign(this.pools.get(n).add(e),n)}remove(e,n){this.pools.get(n).remove(e)}get(e,n){return this.pools.get(n).get(e)}size(e){return this.pools.get(e).size()}delete(e){for(let n of this.pools.values())n.remove(e)}copy(e,n){for(let s of this.pools.values())s.has(e)&&Object.assign(s.add(n),s.get(e))}clean(){for(let e of this.pools.values())e.clean()}};function F(){return Math.random()}var R=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new I;addEntity(e=F()){return this.maskMap.set(e,0),this.getArchetype(0).add(e),e}copyEntity(e,n=F()){this.compManager.copy(e,n);let s=this.maskMap.get(e)??0;return this.maskMap.set(n,s),this.getArchetype(s).add(n),n}getArchetype(e){let n=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,n),n}deleteEntity(e){this.entitiesToDelete.push(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,n){return((this.maskMap.get(e)??0)&1<<this.compManager.getId(n))>0}addComponent(e,n,s=n){this.registerComponent(n);let o=this.maskMap.get(e)??0,a=this.compManager.getId(n);return(o&1<<a)!=0?Object.assign(this.compManager.get(e,n),s):(this.getArchetype(o).delete(e),o|=1<<a,this.maskMap.set(e,o),this.getArchetype(o).add(e),Object.assign(this.compManager.add(e,n),s))}removeComponent(e,n){this.registerComponent(n);let s=this.maskMap.get(e)??0,o=this.compManager.getId(n);if((s&1<<o)==0)return!1;this.getArchetype(s).delete(e),s&=~(1<<o),this.maskMap.set(e,s),this.getArchetype(s).add(e),this.compManager.remove(e,n)}getComponent(e,n){return this.compManager.get(e,n)}update(...e){for(let n=0,s=e.length;n<s;n++)e[n](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let e=this.entitiesToDelete.pop();this.compManager.delete(e);let n=this.maskMap.get(e)??0;this.maskMap.delete(e),this.getArchetype(n).delete(e)}}cleanObjectPools(){this.compManager.clean()}query(e){let n=0,s=0;if(e.and)for(let a=0,r=e.and.length;a<r;a++)n|=1<<this.compManager.getId(e.and[a]);if(e.not)for(let a=0,r=e.not.length;a<r;a++)s|=1<<this.compManager.getId(e.not[a]);let o=[];return this.archetypeMap.forEach((a,r)=>{let c=a;c.size>0&&(r&n)==n&&(r&s)==0&&o.push(...c)}),[...new Set(o)]}entityCount(){return this.maskMap.size}};var i=Y(),b=K(),v=V(),E=B(),l={snakeWidth:10,foodRadius:15,startLength:5,foodColor:"#F0A0A0",snakeColor:"#F0D0D0"};function Y(){let t=document.querySelector("canvas")??document.createElement("canvas");if(!t)throw new Error("Cannot create canvas element.");let e=t.getContext("2d");if(!e)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(t),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<t.width/t.height?(t.style.width="100%",t.style.height=""):(t.style.width="",t.style.height="100%")},{canvas:t,ctx:e}}function K(){return{dtMilli:0,timeMilli:0}}function U(t){t.dtMilli=performance.now()-t.timeMilli,t.timeMilli+=t.dtMilli}function V(){let t={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=e=>{!t.isDown[e.key]&&(t.justPressed[e.key]=!0),t.isDown[e.key]=!0},globalThis.onkeyup=e=>{t.isDown[e.key]=!1,t.justReleased[e.key]=!0},t}function _(t){for(let e in t.justPressed)t.justPressed[e]=!1;for(let e in t.justReleased)t.justReleased[e]=!1}function B(){let t={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=e=>{e.target instanceof HTMLCanvasElement&&(t.x=e.x,t.y=e.y,Object.assign(t.pressPos,t),t.isDown=t.justPressed=!0)},globalThis.onpointerup=e=>{t.x=e.x,t.y=e.y,Object.assign(t.releasePos,t),t.isDown=!1,t.justReleased=!0},globalThis.onpointermove=e=>{t.x=e.x,t.y=e.y},t}function $(t){t.justPressed=!1,t.justReleased=!1}var h={x:0,y:0,rad:0},g={x:0,y:0},p={parent:-1,child:-1},x={},T={};function G(t){t.query({and:[h,g]}).forEach(e=>{let n=t.getComponent(e,h),s=t.getComponent(e,g);n.x+=s.x*b.dtMilli/1e3,n.y+=s.y*b.dtMilli/1e3,!(s.x==0&&s.y==0)&&(n.rad=Math.atan2(s.y,s.x))})}function N(t){i.ctx.fillStyle="#202020",i.ctx.fillRect(0,0,i.canvas.width,i.canvas.height),i.ctx.fillStyle=l.foodColor,i.ctx.beginPath(),t.query({and:[h,T]}).forEach(s=>{let o=t.getComponent(s,h);i.ctx.ellipse(o.x,o.y,l.foodRadius,l.foodRadius,0,0,Math.PI*2)}),i.ctx.fill(),i.ctx.beginPath(),t.query({and:[h,p]}).forEach(s=>{let o=t.getComponent(s,p),a=t.getComponent(s,h);if(i.ctx.moveTo(a.x,a.y),o.child!=-1&&t.hasComponent(o.child,h)){let r=t.getComponent(o.child,h);i.ctx.lineTo(r.x,r.y)}}),i.ctx.strokeStyle=l.snakeColor,i.ctx.lineCap="round",i.ctx.lineWidth=l.snakeWidth,i.ctx.stroke();let e=t.query({and:[p]}).find(s=>t.getComponent(s,p).child==-1);if(e){let s=t.getComponent(e,h),o=Math.cos(s.rad),a=Math.sin(s.rad);i.ctx.beginPath();let r=0,c=-l.snakeWidth/2;i.ctx.moveTo(o*r-a*c+s.x,a*r+o*c+s.y),r=0,c=+l.snakeWidth/2,i.ctx.lineTo(o*r-a*c+s.x,a*r+o*c+s.y),r=-l.snakeWidth*2,c=0,i.ctx.lineTo(o*r-a*c+s.x,a*r+o*c+s.y),i.ctx.fillStyle=l.snakeColor,i.ctx.fill()}let n=t.query({and:[p]}).find(s=>t.getComponent(s,p).parent==-1);if(n){i.ctx.fillStyle="white";let s=t.getComponent(n,h),o=Math.cos(s.rad),a=Math.sin(s.rad),r=5,c=4,d=2;i.ctx.beginPath();let m=0,f=-r,L=o*m-a*f+s.x,O=a*m+o*f+s.y;i.ctx.ellipse(L,O,c,c,s.rad,0,Math.PI*2),m=0,f=r;let H=o*m-a*f+s.x,X=a*m+o*f+s.y;i.ctx.ellipse(H,X,c,c,s.rad,0,Math.PI*2),i.ctx.fill(),i.ctx.fillStyle="black",i.ctx.beginPath();let q=L,A=O,D=t.query({and:[T,h]})[0];if(D){let C=t.getComponent(D,h),y=C.x-q,u=C.y-A,k=(y**2+u**2)**.5;y/=k,u/=k;let P=c-d;q+=y*P,A+=u*P}i.ctx.ellipse(q,A,d,d,s.rad,0,Math.PI*2);let W=H,z=X;if(D){let C=t.getComponent(D,h),y=C.x-W,u=C.y-z,k=(y**2+u**2)**.5;y/=k,u/=k;let P=c-d;W+=y*P,z+=u*P}i.ctx.ellipse(W,z,d,d,s.rad,0,Math.PI*2),i.ctx.fill()}i.ctx.fillStyle="white",i.ctx.fillText(`Score: ${t.query({and:[p]}).length-l.startLength}; Best: ${localStorage.getItem("snake_best")??0}`,0,10)}function J(t){t.query({and:[x,g]}).forEach(e=>{let n=t.getComponent(e,g),s=0;(v.isDown.a||v.isDown.ArrowLeft||E.isDown&&E.x<innerWidth/2)&&(s-=Math.PI),(v.isDown.d||v.isDown.ArrowRight||E.isDown&&E.x>innerWidth/2)&&(s+=Math.PI);let o=Math.cos(s*b.dtMilli/1e3),a=Math.sin(s*b.dtMilli/1e3),r=n.x,c=n.y;n.x=o*r-a*c,n.y=a*r+o*c})}function Q(t){t.query({and:[x,h,p,g]}).forEach(e=>{let n=t.getComponent(e,h),s=t.query({and:[p],not:[x]}).find(o=>{if(t.getComponent(o,p).parent==e)return!1;let r=t.getComponent(o,h);return(r.x-n.x)**2+(r.y-n.y)**2<6**2});if(n.x>i.canvas.width||n.x<0||n.y>i.canvas.height||n.y<0||t.entityCount()<l.startLength||s!=null){let o=t.query({and:[p]}).length-l.startLength;o>Number.parseInt(localStorage.getItem("snake_best")??"0")&&localStorage.setItem("snake_best",o.toString()),n.x=i.canvas.width/2,n.y=i.canvas.height/2,t.query({not:[x]}).forEach(c=>t.deleteEntity(c)),t.getComponent(e,p).child=-1;let a=t.getComponent(e,g);a.x=40,a.y=0;let r=e;for(let c=0;c<l.startLength-1;c++){let d=t.addEntity();t.addComponent(d,g),t.addComponent(d,p,{parent:r});let m=t.getComponent(r,h);t.addComponent(d,h,{x:m.x-6,y:m.y}),t.getComponent(r,p).child=d,r=d}}})}function Z(t){if(t.query({and:[T]}).length>0)return;let n=t.addEntity();t.addComponent(n,T),t.addComponent(n,h,{x:Math.random()*i.canvas.width,y:Math.random()*i.canvas.height})}function w(t){t.query({and:[x,h]}).forEach(e=>{let n=t.getComponent(e,h);t.query({and:[T,h]}).forEach(s=>{let o=t.getComponent(s,h);if((n.x-o.x)**2<((l.snakeWidth+l.foodRadius)/2)**2&&(n.y-o.y)**2<((l.snakeWidth+l.foodRadius)/2)**2){t.deleteEntity(s);let a=t.query({and:[p]}).find(c=>t.getComponent(c,p).child==-1);if(!a||!t.hasComponent(a,h)||!t.hasComponent(a,p))return;let r=t.addEntity();t.addComponent(r,g),t.addComponent(r,p,{parent:a}),t.addComponent(r,h,t.getComponent(a,h)),t.getComponent(a,p).child=r}})})}function tt(t){t.query({and:[p,h,g]}).forEach(e=>{let n=t.getComponent(e,p),s=t.getComponent(e,h),o=t.getComponent(e,g);if(n.parent!=-1&&t.hasComponent(n.parent,h)&&t.hasComponent(n.parent,g)){let a=t.getComponent(n.parent,h);if((s.x-a.x)**2+(s.y-a.y)**2<50){o.x=o.y=0;return}let r=t.getComponent(n.parent,g),c=(r.x**2+r.y**2)**.5,d=a.x-s.x,m=a.y-s.y,f=(d**2+m**2)**.5;o.x=d/f*c,o.y=m/f*c}})}var M=new R,S=M.addEntity();M.addComponent(S,h,{x:i.canvas.width/2,y:i.canvas.height/2});M.addComponent(S,g,{x:40});M.addComponent(S,x);M.addComponent(S,p);(function t(){requestAnimationFrame(t),M.update(N,Q,Z,w,J,tt,G),U(b),_(v),$(E)})();})();
//# sourceMappingURL=out.js.map
