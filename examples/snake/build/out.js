(()=>{var D=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(t){this.objectFactory=t}size(){return this.indexToKey.length}add(t){return this.keyToIndex.has(t)||(this.storage.length<=this.indexToKey.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.indexToKey.length),this.indexToKey[this.indexToKey.length]=t),this.storage[this.keyToIndex.get(t)]}remove(t){let n=this.keyToIndex.get(t),o=this.indexToKey[this.indexToKey.length-1];if(n==null||o==null)return;let s=this.storage[this.indexToKey.length-1];this.storage[this.indexToKey.length-1]=this.storage[n],this.storage[n]=s,this.indexToKey[n]=o,this.keyToIndex.set(o,n),this.indexToKey.pop(),this.keyToIndex.delete(t)}get(t){let n=this.keyToIndex.get(t);if(n==null)throw new Error("Key not found");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.indexToKey.length)}};var j=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new D(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,n){return Object.assign(this.pools.get(n).add(t),n)}remove(t,n){this.pools.get(n).remove(t)}get(t,n){return this.pools.get(n).get(t)}size(t){return this.pools.get(t).size()}delete(t){for(let n of this.pools)n[1].remove(t)}copy(t,n){for(let o of this.pools)o[1].has(t)&&Object.assign(o[1].add(n),o[1].get(t))}clean(){for(let t of this.pools)t[1].clean()}};function F(){return Math.random()}var K=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new j;addEntity(t=F()){return this.maskMap.set(t,0),this.getArchetype(0).add(t),t}copyEntity(t,n=F()){this.compManager.copy(t,n);let o=this.maskMap.get(t)??0;return this.maskMap.set(n,o),this.getArchetype(o).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.entitiesToDelete.push(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return((this.maskMap.get(t)??0)&1<<this.compManager.getId(n))>0}addComponent(t,n,o=n){this.registerComponent(n);let s=this.maskMap.get(t)??0,i=this.compManager.getId(n);return(s&1<<i)!=0?Object.assign(this.compManager.get(t,n),o):(this.getArchetype(s).delete(t),s|=1<<i,this.maskMap.set(t,s),this.getArchetype(s).add(t),Object.assign(this.compManager.add(t,n),o))}removeComponent(t,n){this.registerComponent(n);let o=this.maskMap.get(t)??0,s=this.compManager.getId(n);(o&1<<s)!=0&&(this.getArchetype(o).delete(t),o&=~(1<<s),this.maskMap.set(t,o),this.getArchetype(o).add(t),this.compManager.remove(t,n))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let t=this.entitiesToDelete.pop();this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,o=0;if(t.and)for(let i=0,r=t.and.length;i<r;i++)n|=1<<this.compManager.getId(t.and[i]);if(t.not)for(let i=0,r=t.not.length;i<r;i++)o|=1<<this.compManager.getId(t.not[i]);let s=[];for(let i of this.archetypeMap)i[1].size>0&&(i[0]&n)==n&&(i[0]&o)==0&&s.push(...i[1]);return s}entityCount(){return this.maskMap.size}};var a=X(),E=Y(),P=V(),b=B(),p={snakeWidth:10,foodRadius:15,startLength:5,foodColor:"#F0A0A0",snakeColor:"#F0D0D0"};function X(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function Y(){return{dtMilli:0,timeMilli:0}}function U(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function V(){let e={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!e.isDown[t.key]&&(e.justPressed[t.key]=!0),e.isDown[t.key]=!0},globalThis.onkeyup=t=>{e.isDown[t.key]=!1,e.justReleased[t.key]=!0},e}function _(e){for(let t in e.justPressed)e.justPressed[t]=!1;for(let t in e.justReleased)e.justReleased[t]=!1}function B(){let e={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.x=t.x,e.y=t.y,Object.assign(e.pressPos,e),e.isDown=e.justPressed=!0)},globalThis.onpointerup=t=>{e.x=t.x,e.y=t.y,Object.assign(e.releasePos,e),e.isDown=!1,e.justReleased=!0},globalThis.onpointermove=t=>{e.x=t.x,e.y=t.y},e}function $(e){e.justPressed=!1,e.justReleased=!1}var c={x:0,y:0,rad:0},g={x:0,y:0},d={parent:-1,child:-1},x={},v={};function G(e){e.query({and:[c,g]}).forEach(t=>{let n=e.getComponent(t,c),o=e.getComponent(t,g);n.x+=o.x*E.dtMilli/1e3,n.y+=o.y*E.dtMilli/1e3,!(o.x==0&&o.y==0)&&(n.rad=Math.atan2(o.y,o.x))})}function N(e){a.ctx.fillStyle="#202020",a.ctx.fillRect(0,0,a.canvas.width,a.canvas.height),a.ctx.fillStyle=p.foodColor,a.ctx.beginPath(),e.query({and:[c,v]}).forEach(o=>{let s=e.getComponent(o,c);a.ctx.ellipse(s.x,s.y,p.foodRadius,p.foodRadius,0,0,Math.PI*2)}),a.ctx.fill(),a.ctx.beginPath(),e.query({and:[c,d]}).forEach(o=>{let s=e.getComponent(o,d),i=e.getComponent(o,c);if(a.ctx.moveTo(i.x,i.y),s.child!=-1&&e.hasComponent(s.child,c)){let r=e.getComponent(s.child,c);a.ctx.lineTo(r.x,r.y)}}),a.ctx.strokeStyle=p.snakeColor,a.ctx.lineCap="round",a.ctx.lineWidth=p.snakeWidth,a.ctx.stroke();let t=e.query({and:[d]}).find(o=>e.getComponent(o,d).child==-1);if(t){let o=e.getComponent(t,c),s=Math.cos(o.rad),i=Math.sin(o.rad);a.ctx.beginPath();let r=0,h=-p.snakeWidth/2;a.ctx.moveTo(s*r-i*h+o.x,i*r+s*h+o.y),r=0,h=+p.snakeWidth/2,a.ctx.lineTo(s*r-i*h+o.x,i*r+s*h+o.y),r=-p.snakeWidth*2,h=0,a.ctx.lineTo(s*r-i*h+o.x,i*r+s*h+o.y),a.ctx.fillStyle=p.snakeColor,a.ctx.fill()}let n=e.query({and:[d]}).find(o=>e.getComponent(o,d).parent==-1);if(n){a.ctx.fillStyle="white";let o=e.getComponent(n,c),s=Math.cos(o.rad),i=Math.sin(o.rad),r=5,h=4,l=2;a.ctx.beginPath();let y=0,f=-r,z=s*y-i*f+o.x,L=i*y+s*f+o.y;a.ctx.ellipse(z,L,h,h,o.rad,0,Math.PI*2),y=0,f=r;let O=s*y-i*f+o.x,H=i*y+s*f+o.y;a.ctx.ellipse(O,H,h,h,o.rad,0,Math.PI*2),a.ctx.fill(),a.ctx.fillStyle="black",a.ctx.beginPath();let q=z,S=L,I=e.query({and:[v,c]})[0];if(I){let C=e.getComponent(I,c),m=C.x-q,u=C.y-S,T=(m**2+u**2)**.5;m/=T,u/=T;let k=h-l;q+=m*k,S+=u*k}a.ctx.ellipse(q,S,l,l,o.rad,0,Math.PI*2);let A=O,W=H;if(I){let C=e.getComponent(I,c),m=C.x-A,u=C.y-W,T=(m**2+u**2)**.5;m/=T,u/=T;let k=h-l;A+=m*k,W+=u*k}a.ctx.ellipse(A,W,l,l,o.rad,0,Math.PI*2),a.ctx.fill()}a.ctx.fillStyle="white",a.ctx.fillText(`Score: ${e.query({and:[d]}).length-p.startLength}; Best: ${localStorage.getItem("snake_best")??0}`,0,10)}function J(e){e.query({and:[x,g]}).forEach(t=>{let n=e.getComponent(t,g),o=0;(P.isDown.a||P.isDown.ArrowLeft||b.isDown&&b.x<innerWidth/2)&&(o-=Math.PI),(P.isDown.d||P.isDown.ArrowRight||b.isDown&&b.x>innerWidth/2)&&(o+=Math.PI);let s=Math.cos(o*E.dtMilli/1e3),i=Math.sin(o*E.dtMilli/1e3),r=n.x,h=n.y;n.x=s*r-i*h,n.y=i*r+s*h})}function Q(e){e.query({and:[x,c,d,g]}).forEach(t=>{let n=e.getComponent(t,c),o=e.query({and:[d],not:[x]}).find(s=>{if(e.getComponent(s,d).parent==t)return!1;let r=e.getComponent(s,c);return(r.x-n.x)**2+(r.y-n.y)**2<6**2});if(n.x>a.canvas.width||n.x<0||n.y>a.canvas.height||n.y<0||e.entityCount()<p.startLength||o!=null){let s=e.query({and:[d]}).length-p.startLength;s>Number.parseInt(localStorage.getItem("snake_best")??"0")&&localStorage.setItem("snake_best",s.toString()),n.x=a.canvas.width/2,n.y=a.canvas.height/2,e.query({not:[x]}).forEach(h=>e.deleteEntity(h)),e.getComponent(t,d).child=-1;let i=e.getComponent(t,g);i.x=40,i.y=0;let r=t;for(let h=0;h<p.startLength-1;h++){let l=e.addEntity();e.addComponent(l,g),e.addComponent(l,d,{parent:r});let y=e.getComponent(r,c);e.addComponent(l,c,{x:y.x-6,y:y.y}),e.getComponent(r,d).child=l,r=l}}})}function Z(e){if(e.query({and:[v]}).length>0)return;let n=e.addEntity();e.addComponent(n,v),e.addComponent(n,c,{x:Math.random()*a.canvas.width,y:Math.random()*a.canvas.height})}function w(e){e.query({and:[x,c]}).forEach(t=>{let n=e.getComponent(t,c);e.query({and:[v,c]}).forEach(o=>{let s=e.getComponent(o,c);if((n.x-s.x)**2<((p.snakeWidth+p.foodRadius)/2)**2&&(n.y-s.y)**2<((p.snakeWidth+p.foodRadius)/2)**2){e.deleteEntity(o);let i=e.query({and:[d]}).find(h=>e.getComponent(h,d).child==-1);if(!i||!e.hasComponent(i,c)||!e.hasComponent(i,d))return;let r=e.addEntity();e.addComponent(r,g),e.addComponent(r,d,{parent:i}),e.addComponent(r,c,e.getComponent(i,c)),e.getComponent(i,d).child=r}})})}function tt(e){e.query({and:[d,c,g]}).forEach(t=>{let n=e.getComponent(t,d),o=e.getComponent(t,c),s=e.getComponent(t,g);if(n.parent!=-1&&e.hasComponent(n.parent,c)&&e.hasComponent(n.parent,g)){let i=e.getComponent(n.parent,c);if((o.x-i.x)**2+(o.y-i.y)**2<50){s.x=s.y=0;return}let r=e.getComponent(n.parent,g),h=(r.x**2+r.y**2)**.5,l=i.x-o.x,y=i.y-o.y,f=(l**2+y**2)**.5;s.x=l/f*h,s.y=y/f*h}})}var M=new K,R=M.addEntity();M.addComponent(R,c,{x:a.canvas.width/2,y:a.canvas.height/2});M.addComponent(R,g,{x:40});M.addComponent(R,x);M.addComponent(R,d);(function e(){requestAnimationFrame(e),M.update(N,Q,Z,w,J,tt,G),U(E),_(P),$(b)})();})();
//# sourceMappingURL=out.js.map
