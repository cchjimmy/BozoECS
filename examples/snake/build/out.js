(()=>{var I=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(t){this.objectFactory=t}size(){return this.keyToIndex.size}add(t){return this.keyToIndex.has(t)?this.storage[this.keyToIndex.get(t)]:(this.storage.length<=this.keyToIndex.size&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.keyToIndex.size),this.indexToKey[this.keyToIndex.size-1]=t,this.storage[this.keyToIndex.get(t)])}remove(t){let n=this.keyToIndex.get(t);if(n==null)return;let s=this.indexToKey[this.keyToIndex.size-1],a=this.storage[n];this.storage[n]=this.storage[this.keyToIndex.size-1],this.storage[this.keyToIndex.size-1]=a,this.indexToKey[n]=s,this.indexToKey.pop(),this.keyToIndex.set(s,n),this.keyToIndex.delete(t)}get(t){let n=this.keyToIndex.get(t);if(n==null)throw new Error("Key not found.");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.keyToIndex.size)}};var v=class{poolMap=new Map;maskMap=new Map;register(t){this.poolMap.has(t)||(this.maskMap.set(t,BigInt(2**this.maskMap.size)),this.poolMap.set(t,new I(()=>({...t}))))}getMask(t){let n=this.maskMap.get(t);return n??(this.register(t),this.maskMap.get(t))}add(t,n){return Object.assign(this.poolMap.get(n).add(t),n)}remove(t,n){this.poolMap.get(n).remove(t)}has(t,n){return this.poolMap.has(n)&&this.poolMap.get(n).has(t)}get(t,n){return this.poolMap.get(n).get(t)}size(t){return this.poolMap.get(t).size()}delete(t){for(let n of this.poolMap.entries())n[1].remove(t)}copy(t,n){for(let s of this.poolMap.entries())s[1].has(t)&&Object.assign(s[1].add(n),s[1].get(t))}clean(){for(let t of this.poolMap.entries())t[1].clean()}};function A(){return Math.random()}var j=class{maskMap=new Map;archetypeMap=new Map;compManager=new v;addEntity(t=A()){return this.maskMap.has(t)||this.maskMap.set(t,0n),t}copyEntity(t,n=A()){this.compManager.copy(t,n);let s=this.maskMap.get(t)??0n;return this.maskMap.set(n,s),this.getArchetype(s).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.compManager.delete(t),this.getArchetype(this.maskMap.get(t)??0n).delete(t),this.maskMap.delete(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return this.compManager.has(t,n)}addComponent(t,n,s=n){this.compManager.register(n);let a=this.maskMap.get(t)??0n,o=this.compManager.getMask(n);return a&o?Object.assign(this.compManager.get(t,n),s):(this.getArchetype(a).delete(t),a^=o,this.maskMap.set(t,a),this.getArchetype(a).add(t),Object.assign(this.compManager.add(t,n),s))}removeComponent(t,n){this.compManager.register(n);let s=this.maskMap.get(t)??0n,a=this.compManager.getMask(n);s&a^a||(this.compManager.remove(t,n),this.getArchetype(s).delete(t),s^=a,this.maskMap.set(t,s),this.getArchetype(s).add(t))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,s=t.length;n<s;n++)t[n](this)}cleanObjectPools(){this.compManager.clean()}query(t){let n=0n,s=0n;if(t.and)for(let o=0,r=t.and.length;o<r;o++)n|=this.compManager.getMask(t.and[o]);if(t.not)for(let o=0,r=t.not.length;o<r;o++)s|=this.compManager.getMask(t.not[o]);let a=[];for(let o of this.archetypeMap.entries())o[1].size>0&&(o[0]&n)==n&&(o[0]&s)==0n&&a.push(...o[1]);return a}entityCount(){return this.maskMap.size}};var i=O(),D=X(),C=H(),T=B(),d={startLength:5,snakeWidth:10,snakeColor:"#F0D0D0",snakeSpeed:40,foodRadius:15,foodColor:"#F0A0A0"};function O(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function X(){return{dtMilli:0,timeMilli:0}}function Y(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function H(){let e={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!e.isDown[t.key]&&(e.justPressed[t.key]=!0),e.isDown[t.key]=!0},globalThis.onkeyup=t=>{e.isDown[t.key]=!1,e.justReleased[t.key]=!0},e}function U(e){for(let t in e.justPressed)e.justPressed[t]=!1;for(let t in e.justReleased)e.justReleased[t]=!1}function B(){let e={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.x=t.x,e.y=t.y,Object.assign(e.pressPos,e),e.isDown=e.justPressed=!0)},globalThis.onpointerup=t=>{e.x=t.x,e.y=t.y,Object.assign(e.releasePos,e),e.isDown=!1,e.justReleased=!0},globalThis.onpointermove=t=>{e.x=t.x,e.y=t.y},e}function V(e){e.justPressed=!1,e.justReleased=!1}var c={x:0,y:0,rad:0},g={x:0,y:0},p={parent:-1,child:-1},P={},b={};function _(e){e.query({and:[c,g]}).forEach(t=>{let n=e.getComponent(t,c),s=e.getComponent(t,g);n.x+=s.x*D.dtMilli/1e3,n.y+=s.y*D.dtMilli/1e3,!(s.x==0&&s.y==0)&&(n.rad=Math.atan2(s.y,s.x))})}function $(e){i.ctx.fillStyle="#202020",i.ctx.fillRect(0,0,i.canvas.width,i.canvas.height),i.ctx.fillStyle=d.foodColor,i.ctx.beginPath(),e.query({and:[c,b]}).forEach(s=>{let a=e.getComponent(s,c);i.ctx.ellipse(a.x,a.y,d.foodRadius,d.foodRadius,0,0,Math.PI*2)}),i.ctx.fill(),i.ctx.beginPath(),e.query({and:[c,p]}).forEach(s=>{let a=e.getComponent(s,p),o=e.getComponent(s,c);if(i.ctx.moveTo(o.x,o.y),a.child!=-1&&e.hasComponent(a.child,c)){let r=e.getComponent(a.child,c);i.ctx.lineTo(r.x,r.y)}}),i.ctx.strokeStyle=d.snakeColor,i.ctx.lineCap="round",i.ctx.lineWidth=d.snakeWidth,i.ctx.stroke();let t=e.query({and:[p]}).find(s=>e.getComponent(s,p).child==-1);if(t){let s=e.getComponent(t,c),a=Math.cos(s.rad),o=Math.sin(s.rad);i.ctx.beginPath();let r=0,h=-d.snakeWidth/2;i.ctx.moveTo(a*r-o*h+s.x,o*r+a*h+s.y),r=0,h=+d.snakeWidth/2,i.ctx.lineTo(a*r-o*h+s.x,o*r+a*h+s.y),r=-d.snakeWidth*2,h=0,i.ctx.lineTo(a*r-o*h+s.x,o*r+a*h+s.y),i.ctx.fillStyle=d.snakeColor,i.ctx.fill()}let n=e.query({and:[p]}).find(s=>e.getComponent(s,p).parent==-1);if(n){i.ctx.fillStyle="white";let s=e.getComponent(n,c),a=Math.cos(s.rad),o=Math.sin(s.rad),r=5,h=4,y=2;i.ctx.beginPath();let l=0,f=-r,W=a*l-o*f+s.x,K=o*l+a*f+s.y;i.ctx.ellipse(W,K,h,h,s.rad,0,Math.PI*2),l=0,f=r;let F=a*l-o*f+s.x,L=o*l+a*f+s.y;i.ctx.ellipse(F,L,h,h,s.rad,0,Math.PI*2),i.ctx.fill(),i.ctx.fillStyle="black",i.ctx.beginPath();let S=W,z=K,E=e.query({and:[b,c]})[0];if(E){let x=e.getComponent(E,c),m=x.x-S,u=x.y-z,M=(m**2+u**2)**.5;m/=M,u/=M;let k=h-y;S+=m*k,z+=u*k}i.ctx.ellipse(S,z,y,y,s.rad,0,Math.PI*2);let R=F,q=L;if(E){let x=e.getComponent(E,c),m=x.x-R,u=x.y-q,M=(m**2+u**2)**.5;m/=M,u/=M;let k=h-y;R+=m*k,q+=u*k}i.ctx.ellipse(R,q,y,y,s.rad,0,Math.PI*2),i.ctx.fill()}i.ctx.fillStyle="white",i.ctx.fillText(`Score: ${e.query({and:[p]}).length-d.startLength}; Best: ${localStorage.getItem("snake_best")??0}`,0,10)}function G(e){e.query({and:[P,g]}).forEach(t=>{let n=e.getComponent(t,g),s=0;(C.isDown.a||C.isDown.ArrowLeft||T.isDown&&T.x<innerWidth/2)&&(s-=Math.PI),(C.isDown.d||C.isDown.ArrowRight||T.isDown&&T.x>innerWidth/2)&&(s+=Math.PI),s*=D.dtMilli/1e3;let a=Math.cos(s),o=Math.sin(s),r=n.x,h=n.y;n.x=a*r-o*h,n.y=o*r+a*h})}function N(e){let t=-1;e.query({and:[P]}).forEach(a=>t=a),t==-1&&(t=e.addEntity(),e.addComponent(t,c,{x:i.canvas.width/2,y:i.canvas.height/2}),e.addComponent(t,g,{x:d.snakeSpeed}),e.addComponent(t,P),e.addComponent(t,p));let n=e.getComponent(t,c),s=e.query({and:[p,c]}).find(a=>{let o=e.getComponent(a,p);if(t==o.parent||t==a)return!1;let r=e.getComponent(a,c);return(r.x-n.x)**2+(r.y-n.y)**2<d.snakeWidth**2});if(n.x>i.canvas.width||n.x<0||n.y>i.canvas.height||n.y<0||e.entityCount()<d.startLength||s!=null){let a=e.query({and:[p]}).length-d.startLength;a>Number.parseInt(localStorage.getItem("snake_best")??"0")&&localStorage.setItem("snake_best",a.toString()),n.x=i.canvas.width/2,n.y=i.canvas.height/2;let o=e.getComponent(t,g);o.x=d.snakeSpeed,o.y=0,e.query({not:[P]}).forEach(h=>e.deleteEntity(h));let r=t;for(let h=0,y=d.startLength-1;h<y;h++){let l=e.addEntity();e.addComponent(l,g),e.addComponent(l,p,{parent:r});let f=e.getComponent(r,c);e.addComponent(l,c,{x:f.x-d.snakeWidth,y:f.y}),e.getComponent(r,p).child=l,r=l}}}function J(e){if(e.query({and:[b]}).length>0)return;let t=e.addEntity();e.addComponent(t,b),e.addComponent(t,c,{x:Math.random()*i.canvas.width,y:Math.random()*i.canvas.height})}function Q(e){e.query({and:[P,c]}).forEach(t=>{let n=e.getComponent(t,c);e.query({and:[b,c]}).forEach(s=>{let a=e.getComponent(s,c);if((a.x-n.x)**2+(a.y-n.y)**2>(d.snakeWidth/2+d.foodRadius)**2)return;e.deleteEntity(s);let o=e.query({and:[p]}).find(h=>e.getComponent(h,p).child==-1);if(!o||!e.hasComponent(o,c)||!e.hasComponent(o,p))return;let r=e.addEntity();e.addComponent(r,g),e.addComponent(r,p,{parent:o}),e.addComponent(r,c,e.getComponent(o,c)),e.getComponent(o,p).child=r})})}function Z(e){e.query({and:[p,c,g]}).forEach(t=>{let n=e.getComponent(t,p),s=e.getComponent(t,c),a=e.getComponent(t,g);if(n.parent!=-1&&e.hasComponent(n.parent,c)&&e.hasComponent(n.parent,g)){let o=e.getComponent(n.parent,c);if((s.x-o.x)**2+(s.y-o.y)**2<50)return;let r=e.getComponent(n.parent,g),h=(r.x**2+r.y**2)**.5,y=o.x-s.x,l=o.y-s.y,f=(y**2+l**2)**.5;a.x=y/f*h,a.y=l/f*h}})}var w=new j;(function e(){requestAnimationFrame(e),w.update($,N,J,Q,G,Z,_),Y(D),U(C),V(T)})();})();
//# sourceMappingURL=out.js.map
