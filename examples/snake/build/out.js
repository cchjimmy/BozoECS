(()=>{var I=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(e){this.objectFactory=e}size(){return this.keyToIndex.size}add(e){return this.keyToIndex.has(e)?this.storage[this.keyToIndex.get(e)]:(this.storage.length<=this.keyToIndex.size&&this.storage.push(this.objectFactory()),this.keyToIndex.set(e,this.keyToIndex.size),this.indexToKey[this.keyToIndex.size-1]=e,this.storage[this.keyToIndex.get(e)])}remove(e){let n=this.keyToIndex.get(e);if(n==null)return;let o=this.indexToKey[this.keyToIndex.size-1],s=this.storage[n];this.storage[n]=this.storage[this.keyToIndex.size-1],this.storage[this.keyToIndex.size-1]=s,this.indexToKey[n]=o,this.indexToKey.pop(),this.keyToIndex.set(o,n),this.keyToIndex.delete(e)}get(e){let n=this.keyToIndex.get(e);if(n==null)throw new Error("Key not found.");return this.storage[n]}has(e){return this.keyToIndex.has(e)}clean(){this.storage.splice(this.keyToIndex.size)}};var v=class{poolMap=new Map;idMap=new Map;register(e){this.poolMap.has(e)||(this.idMap.set(e,this.idMap.size),this.poolMap.set(e,new I(()=>({...e}))))}getId(e){let n=this.idMap.get(e);return n??(this.register(e),this.idMap.get(e))}add(e,n){return Object.assign(this.poolMap.get(n).add(e),n)}remove(e,n){this.poolMap.get(n).remove(e)}has(e,n){return this.poolMap.has(n)&&this.poolMap.get(n).has(e)}get(e,n){return this.poolMap.get(n).get(e)}size(e){return this.poolMap.get(e).size()}delete(e){for(let n of this.poolMap.entries())n[1].remove(e)}copy(e,n){for(let o of this.poolMap.entries())o[1].has(e)&&Object.assign(o[1].add(n),o[1].get(e))}clean(){for(let e of this.poolMap.entries())e[1].clean()}};function W(){return Math.random()}var j=class{compEntityMap=new Map;compManager=new v;entitySet=new Set;addEntity(e=W()){return this.entitySet.add(e),e}copyEntity(e,n=W()){this.compManager.copy(e,n);for(let o of this.compEntityMap)o[1].has(e)&&o[1].add(n);return this.entitySet.add(n),n}getCompEntityMap(e){let n=this.compEntityMap.get(e)??new Set;return this.compEntityMap.set(e,n),n}deleteEntity(e){this.compManager.delete(e);for(let n of this.compEntityMap)n[1].delete(e);this.entitySet.delete(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,n){return this.compManager.has(e,n)}addComponent(e,n,o=n){this.compManager.register(n);let s=this.getCompEntityMap(this.compManager.getId(n));return s.has(e)?Object.assign(this.compManager.get(e,n),o):(s.add(e),Object.assign(this.compManager.add(e,n),o))}removeComponent(e,n){this.compManager.register(n);let o=this.getCompEntityMap(this.compManager.getId(n));o.has(e)&&(o.delete(e),this.compManager.remove(e,n))}getComponent(e,n){return this.compManager.get(e,n)}update(...e){for(let n=0,o=e.length;n<o;n++)e[n](this)}cleanObjectPools(){this.compManager.clean()}query(e){let n=this.entitySet,o={and:[],not:[]};Object.assign(o,e);for(let s of o.and)n=n.intersection(this.getCompEntityMap(this.compManager.getId(s)));for(let s of o.not)n=n.difference(this.getCompEntityMap(this.compManager.getId(s)));return[...n]}entityCount(){return this.entitySet.size}};var i=X(),S=Y(),T=H(),k=V(),p={startLength:5,snakeWidth:10,snakeColor:"#F0D0D0",snakeSpeed:40,foodRadius:15,foodColor:"#F0A0A0"};function X(){let t=document.querySelector("canvas")??document.createElement("canvas");if(!t)throw new Error("Cannot create canvas element.");let e=t.getContext("2d");if(!e)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(t),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<t.width/t.height?(t.style.width="100%",t.style.height=""):(t.style.width="",t.style.height="100%")},{canvas:t,ctx:e}}function Y(){return{dtMilli:0,timeMilli:0}}function A(t){t.dtMilli=performance.now()-t.timeMilli,t.timeMilli+=t.dtMilli}function H(){let t={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=e=>{!t.isDown[e.key]&&(t.justPressed[e.key]=!0),t.isDown[e.key]=!0},globalThis.onkeyup=e=>{t.isDown[e.key]=!1,t.justReleased[e.key]=!0},t}function U(t){for(let e in t.justPressed)t.justPressed[e]=!1;for(let e in t.justReleased)t.justReleased[e]=!1}function V(){let t={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=e=>{e.target instanceof HTMLCanvasElement&&(t.x=e.x,t.y=e.y,Object.assign(t.pressPos,t),t.isDown=t.justPressed=!0)},globalThis.onpointerup=e=>{t.x=e.x,t.y=e.y,Object.assign(t.releasePos,t),t.isDown=!1,t.justReleased=!0},globalThis.onpointermove=e=>{t.x=e.x,t.y=e.y},t}function _(t){t.justPressed=!1,t.justReleased=!1}var c={x:0,y:0,rad:0},l={x:0,y:0},d={parent:-1,child:-1},E={},P={};function B(t){t.query({and:[c,l]}).forEach(e=>{let n=t.getComponent(e,c),o=t.getComponent(e,l);n.x+=o.x*S.dtMilli/1e3,n.y+=o.y*S.dtMilli/1e3,!(o.x==0&&o.y==0)&&(n.rad=Math.atan2(o.y,o.x))})}function $(t){i.ctx.fillStyle="#202020",i.ctx.fillRect(0,0,i.canvas.width,i.canvas.height),i.ctx.fillStyle=p.foodColor,i.ctx.beginPath(),t.query({and:[c,P]}).forEach(o=>{let s=t.getComponent(o,c);i.ctx.ellipse(s.x,s.y,p.foodRadius,p.foodRadius,0,0,Math.PI*2)}),i.ctx.fill(),i.ctx.beginPath(),t.query({and:[c,d]}).forEach(o=>{let s=t.getComponent(o,d),a=t.getComponent(o,c);if(i.ctx.moveTo(a.x,a.y),s.child!=-1&&t.hasComponent(s.child,c)){let r=t.getComponent(s.child,c);i.ctx.lineTo(r.x,r.y)}}),i.ctx.strokeStyle=p.snakeColor,i.ctx.lineCap="round",i.ctx.lineWidth=p.snakeWidth,i.ctx.lineJoin="round",i.ctx.stroke();let e=t.query({and:[d]}).find(o=>t.getComponent(o,d).child==-1);if(e){let o=t.getComponent(e,c),s=Math.cos(o.rad),a=Math.sin(o.rad);i.ctx.beginPath();let r=0,h=-p.snakeWidth/2;i.ctx.moveTo(s*r-a*h+o.x,a*r+s*h+o.y),r=0,h=+p.snakeWidth/2,i.ctx.lineTo(s*r-a*h+o.x,a*r+s*h+o.y),r=-p.snakeWidth*2,h=0,i.ctx.lineTo(s*r-a*h+o.x,a*r+s*h+o.y),i.ctx.fillStyle=p.snakeColor,i.ctx.fill()}let n=t.query({and:[d]}).find(o=>t.getComponent(o,d).parent==-1);if(n){i.ctx.fillStyle="white";let o=t.getComponent(n,c),s=Math.cos(o.rad),a=Math.sin(o.rad),r=5,h=4,g=2;i.ctx.beginPath();let y=0,f=-r,K=s*y-a*f+o.x,F=a*y+s*f+o.y;i.ctx.ellipse(K,F,h,h,o.rad,0,Math.PI*2),y=0,f=r;let O=s*y-a*f+o.x,L=a*y+s*f+o.y;i.ctx.ellipse(O,L,h,h,o.rad,0,Math.PI*2),i.ctx.fill(),i.ctx.fillStyle="black",i.ctx.beginPath();let q=K,D=F,b=t.query({and:[P,c]})[0];if(b){let x=t.getComponent(b,c),u=x.x-q,m=x.y-D,M=(u**2+m**2)**.5;u/=M,m/=M;let C=h-g;q+=u*C,D+=m*C}i.ctx.ellipse(q,D,g,g,o.rad,0,Math.PI*2);let R=O,z=L;if(b){let x=t.getComponent(b,c),u=x.x-R,m=x.y-z,M=(u**2+m**2)**.5;u/=M,m/=M;let C=h-g;R+=u*C,z+=m*C}i.ctx.ellipse(R,z,g,g,o.rad,0,Math.PI*2),i.ctx.fill()}i.ctx.fillStyle="white",i.ctx.fillText(`Score: ${t.query({and:[d]}).length-p.startLength}; Best: ${localStorage.getItem("snake_best")??0}`,0,10)}function G(t){t.query({and:[E,l]}).forEach(e=>{let n=t.getComponent(e,l),o=0;(T.isDown.a||T.isDown.ArrowLeft||k.isDown&&k.x<innerWidth/2)&&(o-=Math.PI),(T.isDown.d||T.isDown.ArrowRight||k.isDown&&k.x>innerWidth/2)&&(o+=Math.PI),o*=S.dtMilli/1e3;let s=Math.cos(o),a=Math.sin(o),r=n.x,h=n.y;n.x=s*r-a*h,n.y=a*r+s*h})}function J(t){let e=-1;t.query({and:[E]}).forEach(s=>e=s),e==-1&&(e=t.addEntity(),t.addComponent(e,c,{x:i.canvas.width/2,y:i.canvas.height/2}),t.addComponent(e,l,{x:p.snakeSpeed}),t.addComponent(e,E),t.addComponent(e,d));let n=t.getComponent(e,c),o=t.query({and:[d,c]}).find(s=>{let a=t.getComponent(s,d);if(e==a.parent||e==s)return!1;let r=t.getComponent(s,c);return(r.x-n.x)**2+(r.y-n.y)**2<p.snakeWidth**2});if(n.x>i.canvas.width||n.x<0||n.y>i.canvas.height||n.y<0||t.entityCount()<p.startLength||o!=null){let s=t.query({and:[d]}).length-p.startLength;s>Number.parseInt(localStorage.getItem("snake_best")??"0")&&localStorage.setItem("snake_best",s.toString()),n.x=i.canvas.width/2,n.y=i.canvas.height/2;let a=t.getComponent(e,l);a.x=p.snakeSpeed,a.y=0,t.query({not:[E]}).forEach(h=>t.deleteEntity(h));let r=e;for(let h=0,g=p.startLength-1;h<g;h++){let y=t.addEntity();t.addComponent(y,l),t.addComponent(y,d,{parent:r});let f=t.getComponent(r,c);t.addComponent(y,c,{x:f.x-p.snakeWidth,y:f.y}),t.getComponent(r,d).child=y,r=y}}}function N(t){if(t.query({and:[P]}).length>0)return;let e=t.addEntity();t.addComponent(e,P),t.addComponent(e,c,{x:Math.random()*i.canvas.width,y:Math.random()*i.canvas.height})}function Q(t){t.query({and:[E,c]}).forEach(e=>{let n=t.getComponent(e,c);t.query({and:[P,c]}).forEach(o=>{let s=t.getComponent(o,c);if((s.x-n.x)**2+(s.y-n.y)**2>(p.snakeWidth/2+p.foodRadius)**2)return;t.deleteEntity(o);let a=t.query({and:[d]}).find(h=>t.getComponent(h,d).child==-1);if(!a||!t.hasComponent(a,c)||!t.hasComponent(a,d))return;let r=t.addEntity();t.addComponent(r,l),t.addComponent(r,d,{parent:a}),t.addComponent(r,c,t.getComponent(a,c)),t.getComponent(a,d).child=r})})}function Z(t){t.query({and:[d,c,l]}).forEach(e=>{let n=t.getComponent(e,d),o=t.getComponent(e,c),s=t.getComponent(e,l);if(n.parent!=-1&&t.hasComponent(n.parent,c)&&t.hasComponent(n.parent,l)){let a=t.getComponent(n.parent,c);if((o.x-a.x)**2+(o.y-a.y)**2<50)return;let r=t.getComponent(n.parent,l),h=(r.x**2+r.y**2)**.5,g=a.x-o.x,y=a.y-o.y,f=(g**2+y**2)**.5;s.x=g/f*h,s.y=y/f*h}})}var w=new j;(function t(){requestAnimationFrame(t),w.update($,J,N,Q,G,Z,B),A(S),U(T),_(k)})();})();
//# sourceMappingURL=out.js.map
