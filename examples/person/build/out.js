(()=>{var k=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}add(t){let n=this.keyToIndex.get(t);return n!=null?this.storage[n]:(this.size>=this.storage.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.size),this.indexToKey[this.size]=t,this.size++,this.storage[this.size-1])}remove(t){let n=this.keyToIndex.get(t)??-1,s=this.indexToKey[this.size-1];if(n<0||n>=this.size||!s)return!1;let o=this.storage[n];return this.storage[n]=this.storage[this.size-1],this.storage[this.size-1]=o,this.keyToIndex.set(s,n),this.keyToIndex.delete(t),this.indexToKey[n]=s,this.size--,!0}get(t){let n=this.keyToIndex.get(t)??-1;if(n<0||n>=this.size)throw new Error("Index out of range.");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.size),this.indexToKey.splice(this.size);for(let t of this.keyToIndex.keys()){let n=this.keyToIndex.get(t)??-1;(n<0||n>=this.size)&&this.keyToIndex.delete(t)}}};var E=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new k(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,n){return Object.assign(this.pools.get(n).add(t),n)}remove(t,n){return this.pools.get(n).remove(t)}get(t,n){return this.pools.get(n).get(t)}len(t){return this.pools.get(t).len()}delete(t){for(let n of this.pools.values())n.remove(t)}copy(t,n){for(let s of this.pools.values()){let o=s;o.has(t)&&Object.assign(o.add(n),o.get(t))}}clean(){for(let t of this.pools.values())t.clean()}};function I(){return Math.random()}var z=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new E;addEntity(t=I()){return this.maskMap.set(t,0),this.getArchetype(0).add(t),t}copyEntity(t,n=I()){this.compManager.copy(t,n);let s=this.maskMap.get(t)??0;return this.maskMap.set(n,s),this.getArchetype(s).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.entitiesToDelete.push(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return((this.maskMap.get(t)??0)&1<<this.compManager.getId(n))>0}addComponent(t,n,s=n){this.registerComponent(n);let o=this.maskMap.get(t)??0,i=this.compManager.getId(n);return(o&1<<i)!=0?Object.assign(this.compManager.get(t,n),s):(this.getArchetype(o).delete(t),o|=1<<i,this.maskMap.set(t,o),this.getArchetype(o).add(t),Object.assign(this.compManager.add(t,n),s))}removeComponent(t,n){this.registerComponent(n);let s=this.maskMap.get(t)??0,o=this.compManager.getId(n);return(s&1<<o)==0?!1:(this.getArchetype(s).delete(t),s&=~(1<<o),this.maskMap.set(t,s),this.getArchetype(s).add(t),this.compManager.remove(t,n))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,s=t.length;n<s;n++)t[n](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let t=this.entitiesToDelete.pop();this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,s=0;if(t.and)for(let i=0,a=t.and.length;i<a;i++)n|=1<<this.compManager.getId(t.and[i]);if(t.not)for(let i=0,a=t.not.length;i<a;i++)s|=1<<this.compManager.getId(t.not[i]);let o=[];return this.archetypeMap.forEach((i,a)=>{let c=i;c.size>0&&(a&n)==n&&(a&s)==0&&o.push(...c)}),[...new Set(o)]}entityCount(){return this.maskMap.size}};var r=S(),T=U(),D=K();function S(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function U(){return{dtMilli:0,timeMilli:0}}function H(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function K(){let e={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.x=t.x,e.y=t.y,Object.assign(e.pressPos,e),e.isDown=e.justPressed=!0)},globalThis.onpointerup=t=>{e.x=t.x,e.y=t.y,Object.assign(e.releasePos,e),e.isDown=!1,e.justReleased=!0},globalThis.onpointermove=t=>{e.x=t.x,e.y=t.y},e}function q(e){e.justPressed=!1,e.justReleased=!1}var p={x:0,y:0,rad:0},l={parent:-1},A={eyeWhiteRadius:1,pupilRadius:.4,lookAtEntity:-1},b={zoom:20,tilt:0,isActive:!1,targetEntity:-1},C={width:1,height:1,offsetX:-.5,offsetY:-.5},F={density:.1},j={x:0,y:0},P={x:0,y:0};function y(e,t=0,n=0,s=1,o=1,i=-1,a=-s/2,c=0){let h=e.addEntity();return e.addComponent(h,p,{x:t,y:n}),e.addComponent(h,l,{parent:i}),e.addComponent(h,C,{width:s,height:o,offsetX:a,offsetY:c}),e.addComponent(h,F),e.addComponent(h,j),e.addComponent(h,P),h}function L(e,t=0,n=0,s=1,o=.4,i=-1,a=-1){let c=e.addEntity();return e.addComponent(c,p,{x:t,y:n}),e.addComponent(c,l,{parent:a}),e.addComponent(c,A,{eyeWhiteRadius:s,pupilRadius:o,lookAtEntity:i}),c}function R(e,t=0,n=0){let s=y(e,t,n,1,2),o=y(e,0,-.2,1,1,s,-.5,-1),i=L(e,-.4,-.4,.3,.1,v,o),a=L(e,.4,-.4,.3,.1,v,o),c=y(e,-1,0,.5,1,s),h=y(e,0,1,.5,1,c),d=y(e,1,0,.5,1,s),g=y(e,0,1,.5,1,d),m=y(e,-.5,2,.5,1,s),x=y(e,0,1,.5,1,m),u=y(e,.5,2,.5,1,s),M=y(e,0,1,.5,1,u);return s}function X(e){r.ctx.beginPath(),e.query({and:[p,C],not:[l]}).forEach(t=>{let n=e.getComponent(t,p),s=e.getComponent(t,C),o=Math.cos(n.rad),i=Math.sin(n.rad);r.ctx.transform(o,i,-i,o,n.x,n.y),r.ctx.rect(s.offsetX,s.offsetY,s.width,s.height),r.ctx.transform(o,-i,i,o,o*-n.x+i*-n.y,-i*-n.x+o*-n.y)}),e.query({and:[p,C,l]}).forEach(t=>{let n=e.getComponent(t,p),s=e.getComponent(t,C),o=e.getComponent(t,l),i=n.x,a=n.y,c=n.rad;for(;e.hasComponent(o.parent,l);){if(e.hasComponent(o.parent,p)){let g=e.getComponent(o.parent,p),m=Math.cos(g.rad),x=Math.sin(g.rad),u=i,M=a;i=m*u-x*M,a=x*u+m*M,i+=g.x,a+=g.y,c+=g.rad}o=e.getComponent(o.parent,l)}let h=Math.cos(c),d=Math.sin(c);r.ctx.transform(h,d,-d,h,i,a),r.ctx.rect(s.offsetX,s.offsetY,s.width,s.height),r.ctx.transform(h,-d,d,h,h*-i+d*-a,-d*-i+h*-a)}),r.ctx.fillStyle="white",r.ctx.fill(),e.query({and:[p,A,l]}).forEach(t=>{let n=e.getComponent(t,p),s=e.getComponent(t,A),o=e.getComponent(t,l),i=n.x,a=n.y;for(;e.hasComponent(o.parent,l);){if(e.hasComponent(o.parent,p)){let g=e.getComponent(o.parent,p),m=Math.cos(g.rad),x=Math.sin(g.rad),u=i,M=a;i=m*u-x*M,a=x*u+m*M,i+=g.x,a+=g.y}o=e.getComponent(o.parent,l)}r.ctx.fillStyle="lightgrey",r.ctx.beginPath(),r.ctx.ellipse(i,a,s.eyeWhiteRadius,s.eyeWhiteRadius,0,0,Math.PI*2),r.ctx.fill();let c=0,h=0,d=s.eyeWhiteRadius-s.pupilRadius;if(s.lookAtEntity!=-1){let g=e.getComponent(s.lookAtEntity,p);c=g.x-i,h=g.y-a;let m=(c**2+h**2)**.5;c/=m,h/=m,d=Math.min(m,d)}r.ctx.fillStyle="black",r.ctx.beginPath(),r.ctx.ellipse(i+c*d,a+h*d,s.pupilRadius,s.pupilRadius,0,0,Math.PI*2),r.ctx.fill()})}function Y(e){let t=e.query({and:[b,p]}).find(a=>e.getComponent(a,b).isActive);if(!t)return;r.ctx.resetTransform();let n=e.getComponent(t,b),s=e.getComponent(t,p);if(n.targetEntity!=-1&&e.hasComponent(n.targetEntity,p)){let a=e.getComponent(n.targetEntity,p);Object.assign(s,a)}let o=Math.sin(n.tilt)*n.zoom,i=Math.cos(n.tilt)*n.zoom;r.ctx.transform(i,o,-o,i,i*-s.x-o*-s.y+r.canvas.width*.5,o*-s.x+i*-s.y+r.canvas.height*.5)}function _(e){e.query({and:[p,j,P]}).forEach(t=>{let n=e.getComponent(t,p),s=e.getComponent(t,j),o=e.getComponent(t,P);s.x+=o.x*T.dtMilli/1e3,s.y+=o.y*T.dtMilli/1e3,n.x+=s.x*T.dtMilli/1e3,n.y+=s.y*T.dtMilli/1e3})}function B(e="#202020"){r.ctx.resetTransform(),r.ctx.fillStyle=e,r.ctx.fillRect(0,0,r.canvas.width,r.canvas.height)}function G(e,t,n,s){let o=Math.cos(n),i=Math.sin(n),a={x:0,y:0},c=e.x-r.canvas.width/2,h=e.y-r.canvas.height/2;return a.x=o*c+i*h,a.y=-i*c+o*h,a.x/=s,a.y/=s,a.x+=t.x,a.y+=t.y,a}function V(e,t){let n={x:0,y:0},s=t.getBoundingClientRect();return n.x=e.x-s.left,n.y=e.y-s.top,innerWidth/innerHeight<t.width/t.height?(n.x*=t.width/innerWidth,n.y*=t.width/innerWidth):(n.x*=t.height/innerHeight,n.y*=t.height/innerHeight),n}var f=new z,W=f.addEntity(),J=f.addComponent(W,p,{y:1}),O=f.addComponent(W,b,{zoom:20,isActive:!0}),v=f.addEntity(),N=f.addComponent(v,p);f.addComponent(v,C);R(f);R(f,3);R(f,-3);(function e(){requestAnimationFrame(e),B(),f.update(Y,X,_),H(T),q(D),Object.assign(N,G(V(D,r.canvas),J,O.tilt,O.zoom))})();})();
//# sourceMappingURL=out.js.map
