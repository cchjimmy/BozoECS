(()=>{var P=class{storage=[];map=new Map;objectFactory;constructor(t){this.objectFactory=t}size(){return this.map.size}add(t){let n=this.map.get(t);return n||(this.storage.push(this.objectFactory()),this.map.set(t,this.storage[this.storage.length-1]),this.storage[this.storage.length-1])}remove(t){this.map.delete(t)}get(t){let n=this.map.get(t);if(!n)throw new Error("Key not found");return n}has(t){return this.map.has(t)}clean(){this.storage.splice(this.map.size)}};var T=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new P(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,n){return Object.assign(this.pools.get(n).add(t),n)}remove(t,n){this.pools.get(n).remove(t)}get(t,n){return this.pools.get(n).get(t)}size(t){return this.pools.get(t).size()}delete(t){for(let n of this.pools.values())n.remove(t)}copy(t,n){for(let s of this.pools.values())s.has(t)&&Object.assign(s.add(n),s.get(t))}clean(){for(let t of this.pools.values())t.clean()}};function j(){return Math.random()}var k=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new T;addEntity(t=j()){return this.maskMap.set(t,0),this.getArchetype(0).add(t),t}copyEntity(t,n=j()){this.compManager.copy(t,n);let s=this.maskMap.get(t)??0;return this.maskMap.set(n,s),this.getArchetype(s).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.entitiesToDelete.push(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return((this.maskMap.get(t)??0)&1<<this.compManager.getId(n))>0}addComponent(t,n,s=n){this.registerComponent(n);let o=this.maskMap.get(t)??0,i=this.compManager.getId(n);return(o&1<<i)!=0?Object.assign(this.compManager.get(t,n),s):(this.getArchetype(o).delete(t),o|=1<<i,this.maskMap.set(t,o),this.getArchetype(o).add(t),Object.assign(this.compManager.add(t,n),s))}removeComponent(t,n){this.registerComponent(n);let s=this.maskMap.get(t)??0,o=this.compManager.getId(n);if((s&1<<o)==0)return!1;this.getArchetype(s).delete(t),s&=~(1<<o),this.maskMap.set(t,s),this.getArchetype(s).add(t),this.compManager.remove(t,n)}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,s=t.length;n<s;n++)t[n](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let t=this.entitiesToDelete.pop();this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,s=0;if(t.and)for(let i=0,a=t.and.length;i<a;i++)n|=1<<this.compManager.getId(t.and[i]);if(t.not)for(let i=0,a=t.not.length;i<a;i++)s|=1<<this.compManager.getId(t.not[i]);let o=[];return this.archetypeMap.forEach((i,a)=>{let h=i;h.size>0&&(a&n)==n&&(a&s)==0&&o.push(...h)}),[...new Set(o)]}entityCount(){return this.maskMap.size}};var c=S(),E=W(),R=_();function S(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function W(){return{dtMilli:0,timeMilli:0}}function O(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function _(){let e={pos:new Map,isDown:new Map,justPressed:new Map,justReleased:new Map,pressPos:new Map,releasePos:new Map};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.pos.set(t.pointerId,{x:t.x,y:t.y}),e.pressPos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.set(t.pointerId,!0),e.justPressed.set(t.pointerId,!0))},globalThis.onpointerup=t=>{e.pos.delete(t.pointerId),e.releasePos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.delete(t.pointerId),e.justReleased.set(t.pointerId,!0)},globalThis.onpointermove=t=>{e.pos.set(t.pointerId,{x:t.x,y:t.y})},e}function U(e){e.justReleased.clear(),e.justPressed.clear(),e.releasePos.clear(),e.pressPos.clear()}var r={x:0,y:0,rad:0},d={parent:-1},I={eyeWhiteRadius:1,pupilRadius:.4,lookAtEntity:-1},C={zoom:20,tilt:0,isActive:!1,targetEntity:-1},M={width:1,height:1,offsetX:-.5,offsetY:-.5},z={density:.1},v={x:0,y:0},b={x:0,y:0},D={};function u(e,t=0,n=0,s=1,o=1,i=-1,a=-s/2,h=0){let p=e.addEntity();return e.addComponent(p,r,{x:t,y:n}),e.addComponent(p,d,{parent:i}),e.addComponent(p,M,{width:s,height:o,offsetX:a,offsetY:h}),e.addComponent(p,z),e.addComponent(p,v),e.addComponent(p,b),p}function L(e,t=0,n=0,s=1,o=.4,i=-1,a=-1){let h=e.addEntity();return e.addComponent(h,r,{x:t,y:n}),e.addComponent(h,d,{parent:a}),e.addComponent(h,I,{eyeWhiteRadius:s,pupilRadius:o,lookAtEntity:i}),h}function H(e,t=0,n=0,s=-1){let o=u(e,t,n,1,2),i=u(e,0,-.2,1,1,o,-.5,-1),a=L(e,-.4,-.4,.3,.1,s,i),h=L(e,.4,-.4,.3,.1,s,i),p=u(e,-1,0,.5,1,o),g=u(e,0,1,.5,1,p),m=u(e,1,0,.5,1,o),l=u(e,0,1,.5,1,m),y=u(e,-.5,2,.5,1,o),f=u(e,0,1,.5,1,y),x=u(e,.5,2,.5,1,o),$=u(e,0,1,.5,1,x);return o}function F(e){c.ctx.beginPath(),e.query({and:[r,M],not:[d]}).forEach(t=>{let n=e.getComponent(t,r),s=e.getComponent(t,M),o=Math.cos(n.rad),i=Math.sin(n.rad);c.ctx.transform(o,i,-i,o,n.x,n.y),c.ctx.rect(s.offsetX,s.offsetY,s.width,s.height),c.ctx.transform(o,-i,i,o,o*-n.x+i*-n.y,-i*-n.x+o*-n.y)}),e.query({and:[r,M,d]}).forEach(t=>{let n=e.getComponent(t,r),s=e.getComponent(t,M),o=e.getComponent(t,d),i=n.x,a=n.y,h=n.rad;for(;e.hasComponent(o.parent,d);){if(e.hasComponent(o.parent,r)){let m=e.getComponent(o.parent,r),l=Math.cos(m.rad),y=Math.sin(m.rad),f=i,x=a;i=l*f-y*x,a=y*f+l*x,i+=m.x,a+=m.y,h+=m.rad}o=e.getComponent(o.parent,d)}let p=Math.cos(h),g=Math.sin(h);c.ctx.transform(p,g,-g,p,i,a),c.ctx.rect(s.offsetX,s.offsetY,s.width,s.height),c.ctx.transform(p,-g,g,p,p*-i+g*-a,-g*-i+p*-a)}),c.ctx.fillStyle="white",c.ctx.fill()}function Y(e){e.query({and:[r,I,d]}).forEach(t=>{let n=e.getComponent(t,r),s=e.getComponent(t,I),o=e.getComponent(t,d),i=n.x,a=n.y;for(;e.hasComponent(o.parent,d);){if(e.hasComponent(o.parent,r)){let m=e.getComponent(o.parent,r),l=Math.cos(m.rad),y=Math.sin(m.rad),f=i,x=a;i=l*f-y*x,a=y*f+l*x,i+=m.x,a+=m.y}o=e.getComponent(o.parent,d)}c.ctx.fillStyle="lightgrey",c.ctx.beginPath(),c.ctx.ellipse(i,a,s.eyeWhiteRadius,s.eyeWhiteRadius,0,0,Math.PI*2),c.ctx.fill();let h=0,p=0,g=s.eyeWhiteRadius-s.pupilRadius;if(s.lookAtEntity!=-1){let m=e.getComponent(s.lookAtEntity,r);h=m.x-i,p=m.y-a;let l=(h**2+p**2)**.5;h/=l,p/=l,g=Math.min(l,g)}c.ctx.fillStyle="black",c.ctx.beginPath(),c.ctx.ellipse(i+h*g,a+p*g,s.pupilRadius,s.pupilRadius,0,0,Math.PI*2),c.ctx.fill()})}function X(e){let t=e.query({and:[C,r]}).find(a=>e.getComponent(a,C).isActive);if(!t)return;c.ctx.resetTransform();let n=e.getComponent(t,C),s=e.getComponent(t,r);if(n.targetEntity!=-1&&e.hasComponent(n.targetEntity,r)){let a=e.getComponent(n.targetEntity,r);Object.assign(s,a)}let o=Math.sin(n.tilt)*n.zoom,i=Math.cos(n.tilt)*n.zoom;c.ctx.transform(i,o,-o,i,i*-s.x-o*-s.y+c.canvas.width*.5,o*-s.x+i*-s.y+c.canvas.height*.5)}function N(e){e.query({and:[M,z,b,d]}).forEach(t=>{let n=e.getComponent(t,M),s=e.getComponent(t,z),o=e.getComponent(t,b),i=e.getComponent(t,d),a=n.width*n.height*s.density;i.parent==-1&&(o.y=9.81)})}function B(e){e.query({and:[v,b]}).forEach(t=>{let n=e.getComponent(t,v),s=e.getComponent(t,b);n.x+=s.x*E.dtMilli/1e3,n.y+=s.y*E.dtMilli/1e3}),e.query({and:[r,v]}).forEach(t=>{let n=e.getComponent(t,r),s=e.getComponent(t,v);n.x+=s.x*E.dtMilli/1e3,n.y+=s.y*E.dtMilli/1e3})}function V(e){e.query({and:[D]}).forEach(o=>e.deleteEntity(o));let t=e.query({and:[C,r]}).find(o=>e.getComponent(o,C).isActive);if(!t)return;let n=e.getComponent(t,C),s=e.getComponent(t,r);R.isDown.forEach((o,i)=>{let a=e.addEntity(),h=R.pos.get(i);h&&(Object.assign(e.addComponent(a,r),J(Q(h,c.canvas),s,n.tilt,n.zoom)),e.addComponent(a,D))})}function G(e){e.query({and:[I,r,d]}).forEach(t=>{let n=e.getComponent(t,I),s=e.getComponent(t,r),o=e.getComponent(t,d),i=s.x,a=s.y;for(;e.hasComponent(o.parent,d);){if(e.hasComponent(o.parent,r)){let g=e.getComponent(o.parent,r),m=Math.cos(g.rad),l=Math.sin(g.rad),y=i,f=a;i=m*y-l*f,a=l*y+m*f,i+=g.x,a+=g.y}o=e.getComponent(o.parent,d)}let h=-1,p=Number.POSITIVE_INFINITY;e.query({and:[D,r]}).forEach(g=>{let m=e.getComponent(g,r),l=m.x-i,y=m.y-a,f=(l**2+y**2)**.5;f>p||(p=f,h=g)}),n.lookAtEntity=h??-1})}function K(e="#202020"){c.ctx.resetTransform(),c.ctx.fillStyle=e,c.ctx.fillRect(0,0,c.canvas.width,c.canvas.height)}function J(e,t,n,s){let o=Math.cos(n),i=Math.sin(n),a={x:0,y:0},h=e.x-c.canvas.width/2,p=e.y-c.canvas.height/2;return a.x=o*h+i*p,a.y=-i*h+o*p,a.x/=s,a.y/=s,a.x+=t.x,a.y+=t.y,a}function Q(e,t){let n={x:0,y:0},s=t.getBoundingClientRect();return n.x=e.x-s.left,n.y=e.y-s.top,innerWidth/innerHeight<t.width/t.height?(n.x*=t.width/innerWidth,n.y*=t.width/innerWidth):(n.x*=t.height/innerHeight,n.y*=t.height/innerHeight),n}var A=new k,rt=H(A,0,0),q=A.addEntity();A.addComponent(q,r,{y:1});A.addComponent(q,C,{zoom:18,isActive:!0});(function e(){requestAnimationFrame(e),K(),A.update(G,X,F,Y,V,N,B),O(E),U(R)})();})();
//# sourceMappingURL=out.js.map
