(()=>{var v=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(t){this.objectFactory=t}size(){return this.indexToKey.length}add(t){let n=this.keyToIndex.get(t);return n!=null?this.storage[n]:(this.storage.length<=this.indexToKey.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.indexToKey.length),this.indexToKey[this.indexToKey.length]=t,this.storage[this.indexToKey.length-1])}remove(t){let n=this.keyToIndex.get(t),s=this.indexToKey[this.indexToKey.length-1];if(n==null||s==null)return;let o=this.storage[this.indexToKey.length-1];this.storage[this.indexToKey.length-1]=this.storage[n],this.storage[n]=o,this.indexToKey[n]=s,this.keyToIndex.set(s,n),this.indexToKey.pop(),this.keyToIndex.delete(t)}get(t){let n=this.keyToIndex.get(t);if(n==null)throw new Error("Key not found");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.indexToKey.length)}};var A=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new v(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,n){return Object.assign(this.pools.get(n).add(t),n)}remove(t,n){this.pools.get(n).remove(t)}get(t,n){return this.pools.get(n).get(t)}size(t){return this.pools.get(t).size()}delete(t){for(let n of this.pools.values())n.remove(t)}copy(t,n){for(let s of this.pools.values())s.has(t)&&Object.assign(s.add(n),s.get(t))}clean(){for(let t of this.pools.values())t.clean()}};function j(){return Math.random()}var P=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new A;addEntity(t=j()){return this.maskMap.set(t,0),this.getArchetype(0).add(t),t}copyEntity(t,n=j()){this.compManager.copy(t,n);let s=this.maskMap.get(t)??0;return this.maskMap.set(n,s),this.getArchetype(s).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.entitiesToDelete.push(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return((this.maskMap.get(t)??0)&1<<this.compManager.getId(n))>0}addComponent(t,n,s=n){this.registerComponent(n);let o=this.maskMap.get(t)??0,i=this.compManager.getId(n);return(o&1<<i)!=0?Object.assign(this.compManager.get(t,n),s):(this.getArchetype(o).delete(t),o|=1<<i,this.maskMap.set(t,o),this.getArchetype(o).add(t),Object.assign(this.compManager.add(t,n),s))}removeComponent(t,n){this.registerComponent(n);let s=this.maskMap.get(t)??0,o=this.compManager.getId(n);if((s&1<<o)==0)return!1;this.getArchetype(s).delete(t),s&=~(1<<o),this.maskMap.set(t,s),this.getArchetype(s).add(t),this.compManager.remove(t,n)}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,s=t.length;n<s;n++)t[n](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let t=this.entitiesToDelete.pop();this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,s=0;if(t.and)for(let i=0,a=t.and.length;i<a;i++)n|=1<<this.compManager.getId(t.and[i]);if(t.not)for(let i=0,a=t.not.length;i<a;i++)s|=1<<this.compManager.getId(t.not[i]);let o=[];return this.archetypeMap.forEach((i,a)=>{let h=i;h.size>0&&(a&n)==n&&(a&s)==0&&o.push(...h)}),[...new Set(o)]}entityCount(){return this.maskMap.size}};var r=q(),T=S(),K=O();function q(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function S(){return{dtMilli:0,timeMilli:0}}function W(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function O(){let e={pos:new Map,isDown:new Map,justPressed:new Map,justReleased:new Map,pressPos:new Map,releasePos:new Map};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.pos.set(t.pointerId,{x:t.x,y:t.y}),e.pressPos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.set(t.pointerId,!0),e.justPressed.set(t.pointerId,!0))},globalThis.onpointerup=t=>{e.pos.delete(t.pointerId),e.releasePos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.delete(t.pointerId),e.justReleased.set(t.pointerId,!0)},globalThis.onpointermove=t=>{e.pos.set(t.pointerId,{x:t.x,y:t.y})},e}function _(e){e.justReleased.clear(),e.justPressed.clear(),e.releasePos.clear(),e.pressPos.clear()}var c={x:0,y:0,rad:0},m={parent:-1},I={eyeWhiteRadius:1,pupilRadius:.4,lookAtEntity:-1},C={zoom:20,tilt:0,isActive:!1,targetEntity:-1},M={width:1,height:1,offsetX:-.5,offsetY:-.5},R={density:.1},E={x:0,y:0},k={x:0,y:0},D={};function u(e,t=0,n=0,s=1,o=1,i=-1,a=-s/2,h=0){let p=e.addEntity();return e.addComponent(p,c,{x:t,y:n}),e.addComponent(p,m,{parent:i}),e.addComponent(p,M,{width:s,height:o,offsetX:a,offsetY:h}),e.addComponent(p,R),e.addComponent(p,E),e.addComponent(p,k),p}function z(e,t=0,n=0,s=1,o=.4,i=-1,a=-1){let h=e.addEntity();return e.addComponent(h,c,{x:t,y:n}),e.addComponent(h,m,{parent:a}),e.addComponent(h,I,{eyeWhiteRadius:s,pupilRadius:o,lookAtEntity:i}),h}function U(e,t=0,n=0,s=-1){let o=u(e,t,n,1,2),i=u(e,0,-.2,1,1,o,-.5,-1),a=z(e,-.4,-.4,.3,.1,s,i),h=z(e,.4,-.4,.3,.1,s,i),p=u(e,-1,0,.5,1,o),d=u(e,0,1,.5,1,p),g=u(e,1,0,.5,1,o),y=u(e,0,1,.5,1,g),l=u(e,-.5,2,.5,1,o),f=u(e,0,1,.5,1,l),x=u(e,.5,2,.5,1,o),$=u(e,0,1,.5,1,x);return o}function H(e){r.ctx.beginPath(),e.query({and:[c,M],not:[m]}).forEach(t=>{let n=e.getComponent(t,c),s=e.getComponent(t,M),o=Math.cos(n.rad),i=Math.sin(n.rad);r.ctx.transform(o,i,-i,o,n.x,n.y),r.ctx.rect(s.offsetX,s.offsetY,s.width,s.height),r.ctx.transform(o,-i,i,o,o*-n.x+i*-n.y,-i*-n.x+o*-n.y)}),e.query({and:[c,M,m]}).forEach(t=>{let n=e.getComponent(t,c),s=e.getComponent(t,M),o=e.getComponent(t,m),i=n.x,a=n.y,h=n.rad;for(;e.hasComponent(o.parent,m);){if(e.hasComponent(o.parent,c)){let g=e.getComponent(o.parent,c),y=Math.cos(g.rad),l=Math.sin(g.rad),f=i,x=a;i=y*f-l*x,a=l*f+y*x,i+=g.x,a+=g.y,h+=g.rad}o=e.getComponent(o.parent,m)}let p=Math.cos(h),d=Math.sin(h);r.ctx.transform(p,d,-d,p,i,a),r.ctx.rect(s.offsetX,s.offsetY,s.width,s.height),r.ctx.transform(p,-d,d,p,p*-i+d*-a,-d*-i+p*-a)}),r.ctx.fillStyle="white",r.ctx.fill()}function F(e){e.query({and:[c,I,m]}).forEach(t=>{let n=e.getComponent(t,c),s=e.getComponent(t,I),o=e.getComponent(t,m),i=n.x,a=n.y;for(;e.hasComponent(o.parent,m);){if(e.hasComponent(o.parent,c)){let g=e.getComponent(o.parent,c),y=Math.cos(g.rad),l=Math.sin(g.rad),f=i,x=a;i=y*f-l*x,a=l*f+y*x,i+=g.x,a+=g.y}o=e.getComponent(o.parent,m)}r.ctx.fillStyle="lightgrey",r.ctx.beginPath(),r.ctx.ellipse(i,a,s.eyeWhiteRadius,s.eyeWhiteRadius,0,0,Math.PI*2),r.ctx.fill();let h=0,p=0,d=s.eyeWhiteRadius-s.pupilRadius;if(s.lookAtEntity!=-1){let g=e.getComponent(s.lookAtEntity,c);h=g.x-i,p=g.y-a;let y=(h**2+p**2)**.5;h/=y,p/=y,d=Math.min(y,d)}r.ctx.fillStyle="black",r.ctx.beginPath(),r.ctx.ellipse(i+h*d,a+p*d,s.pupilRadius,s.pupilRadius,0,0,Math.PI*2),r.ctx.fill()})}function Y(e){let t=e.query({and:[C,c]}).find(a=>e.getComponent(a,C).isActive);if(!t)return;r.ctx.resetTransform();let n=e.getComponent(t,C),s=e.getComponent(t,c);if(n.targetEntity!=-1&&e.hasComponent(n.targetEntity,c)){let a=e.getComponent(n.targetEntity,c);Object.assign(s,a)}let o=Math.sin(n.tilt)*n.zoom,i=Math.cos(n.tilt)*n.zoom;r.ctx.transform(i,o,-o,i,i*-s.x-o*-s.y+r.canvas.width*.5,o*-s.x+i*-s.y+r.canvas.height*.5)}function X(e){e.query({and:[M,R,k,m]}).forEach(t=>{let n=e.getComponent(t,M),s=e.getComponent(t,R),o=e.getComponent(t,k),i=e.getComponent(t,m),a=n.width*n.height*s.density;i.parent==-1&&(o.y=9.81)})}function N(e){e.query({and:[E,k]}).forEach(t=>{let n=e.getComponent(t,E),s=e.getComponent(t,k);n.x+=s.x*T.dtMilli/1e3,n.y+=s.y*T.dtMilli/1e3}),e.query({and:[c,E]}).forEach(t=>{let n=e.getComponent(t,c),s=e.getComponent(t,E);n.x+=s.x*T.dtMilli/1e3,n.y+=s.y*T.dtMilli/1e3})}function B(e){e.query({and:[D]}).forEach(o=>e.deleteEntity(o));let t=e.query({and:[C,c]}).find(o=>e.getComponent(o,C).isActive);if(!t)return;let n=e.getComponent(t,C),s=e.getComponent(t,c);K.isDown.forEach((o,i)=>{let a=e.addEntity(),h=K.pos.get(i);h&&(Object.assign(e.addComponent(a,c),J(Q(h,r.canvas),s,n.tilt,n.zoom)),e.addComponent(a,D))})}function V(e){e.query({and:[I,c,m]}).forEach(t=>{let n=e.getComponent(t,I),s=e.getComponent(t,c),o=e.getComponent(t,m),i=s.x,a=s.y;for(;e.hasComponent(o.parent,m);){if(e.hasComponent(o.parent,c)){let d=e.getComponent(o.parent,c),g=Math.cos(d.rad),y=Math.sin(d.rad),l=i,f=a;i=g*l-y*f,a=y*l+g*f,i+=d.x,a+=d.y}o=e.getComponent(o.parent,m)}let h=-1,p=Number.POSITIVE_INFINITY;e.query({and:[D,c]}).forEach(d=>{let g=e.getComponent(d,c),y=g.x-i,l=g.y-a,f=(y**2+l**2)**.5;f>p||(p=f,h=d)}),n.lookAtEntity=h??-1})}function G(e="#202020"){r.ctx.resetTransform(),r.ctx.fillStyle=e,r.ctx.fillRect(0,0,r.canvas.width,r.canvas.height)}function J(e,t,n,s){let o=Math.cos(n),i=Math.sin(n),a={x:0,y:0},h=e.x-r.canvas.width/2,p=e.y-r.canvas.height/2;return a.x=o*h+i*p,a.y=-i*h+o*p,a.x/=s,a.y/=s,a.x+=t.x,a.y+=t.y,a}function Q(e,t){let n={x:0,y:0},s=t.getBoundingClientRect();return n.x=e.x-s.left,n.y=e.y-s.top,innerWidth/innerHeight<t.width/t.height?(n.x*=t.width/innerWidth,n.y*=t.width/innerWidth):(n.x*=t.height/innerHeight,n.y*=t.height/innerHeight),n}var b=new P,ct=U(b,0,0),L=b.addEntity();b.addComponent(L,c,{y:1});b.addComponent(L,C,{zoom:18,isActive:!0});(function e(){requestAnimationFrame(e),G(),b.update(V,Y,H,F,B,X,N),W(T),_(K)})();})();
//# sourceMappingURL=out.js.map
