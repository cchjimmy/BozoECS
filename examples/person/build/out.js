(()=>{var I=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(t){this.objectFactory=t}size(){return this.indexToKey.length}add(t){return this.keyToIndex.has(t)||(this.storage.length<=this.indexToKey.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.indexToKey.length),this.indexToKey[this.indexToKey.length]=t),this.storage[this.keyToIndex.get(t)]}remove(t){let n=this.keyToIndex.get(t);if(n==null)return;let o=this.indexToKey[this.indexToKey.length-1],s=this.storage[this.indexToKey.length-1];this.storage[this.indexToKey.length-1]=this.storage[n],this.storage[n]=s,this.indexToKey[n]=o,this.keyToIndex.set(o,n),this.indexToKey.pop(),this.keyToIndex.delete(t)}get(t){let n=this.keyToIndex.get(t);if(n==null)throw new Error("Key not found");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.indexToKey.length)}};var k=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new I(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,n){return Object.assign(this.pools.get(n).add(t),n)}remove(t,n){this.pools.get(n).remove(t)}has(t,n){return this.pools.get(n).has(t)}get(t,n){return this.pools.get(n).get(t)}size(t){return this.pools.get(t).size()}delete(t){for(let n of this.pools)n[1].remove(t)}copy(t,n){for(let o of this.pools)o[1].has(t)&&Object.assign(o[1].add(n),o[1].get(t))}clean(){for(let t of this.pools)t[1].clean()}};function A(){return Math.random()}var b=class{maskMap=new Map;archetypeMap=new Map;compManager=new k;addEntity(t=A()){return this.maskMap.has(t)||(this.maskMap.set(t,0),this.getArchetype(0).add(t)),t}copyEntity(t,n=A()){this.compManager.copy(t,n);let o=this.maskMap.get(t)??0;return this.maskMap.set(n,o),this.getArchetype(o).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return this.compManager.has(t,n)}addComponent(t,n,o=n){this.registerComponent(n);let s=this.maskMap.get(t)??0,a=this.compManager.getId(n);return s&1<<a?Object.assign(this.compManager.get(t,n),o):(this.getArchetype(s).delete(t),s|=1<<a,this.maskMap.set(t,s),this.getArchetype(s).add(t),Object.assign(this.compManager.add(t,n),o))}removeComponent(t,n){this.registerComponent(n);let o=this.maskMap.get(t)??0,s=this.compManager.getId(n);(o&1<<s)!=0&&(this.getArchetype(o).delete(t),o^=1<<s,this.maskMap.set(t,o),this.getArchetype(o).add(t),this.compManager.remove(t,n))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this)}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,o=0;if(t.and)for(let a=0,i=t.and.length;a<i;a++)n|=1<<this.compManager.getId(t.and[a]);if(t.not)for(let a=0,i=t.not.length;a<i;a++)o|=1<<this.compManager.getId(t.not[a]);let s=[];for(let a of this.archetypeMap)a[1].size>0&&(a[0]&n)==n&&(a[0]&o)==0&&s.push(...a[1]);return s}entityCount(){return this.maskMap.size}};var c=q(),M=S(),P=U();function q(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function S(){return{dtMilli:0,timeMilli:0}}function H(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function U(){let e={pos:new Map,isDown:new Map,justPressed:new Map,justReleased:new Map,pressPos:new Map,releasePos:new Map};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.pos.set(t.pointerId,{x:t.x,y:t.y}),e.pressPos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.set(t.pointerId,!0),e.justPressed.set(t.pointerId,!0))},globalThis.onpointerup=t=>{e.pos.delete(t.pointerId),e.releasePos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.delete(t.pointerId),e.justReleased.set(t.pointerId,!0)},globalThis.onpointermove=t=>{e.pos.set(t.pointerId,{x:t.x,y:t.y})},e}function F(e){e.justReleased.clear(),e.justPressed.clear(),e.releasePos.clear(),e.pressPos.clear()}var p={x:0,y:0,rad:0},g={parent:-1},T={eyeWhiteRadius:1,pupilRadius:.4,lookAtEntity:-1},u={zoom:20,tilt:0,isActive:!1},f={width:1,height:1},v={density:.1},C={x:0,y:0},E={x:0,y:0},R={};function y(e,t=0,n=0,o={width:1,height:1},s={x:0,y:0},a=-1){let i=e.addEntity();e.addComponent(i,p,{x:t,y:n}),e.addComponent(i,g,{parent:a});let r=e.addEntity();return e.addComponent(r,p,s),e.addComponent(r,g,{parent:i}),e.addComponent(r,f,o),e.addComponent(r,v),e.addComponent(r,C),e.addComponent(r,E),i}function K(e,t=0,n=0,o=1,s=.4,a=-1,i=-1){let r=e.addEntity();return e.addComponent(r,p,{x:t,y:n}),e.addComponent(r,g,{parent:i}),e.addComponent(r,T,{eyeWhiteRadius:o,pupilRadius:s,lookAtEntity:a}),r}function _(e,t=0,n=0,o=-1){let s={width:1,height:1},a={x:-.5,y:0},i={width:1,height:2},r={x:-.5,y:-2},h={width:.5,height:.9},d={x:-.25,y:-.9},m=y(e,t,n,i,r),l=y(e,0,.2,s,a,m),tt=K(e,.4,.4,.3,.1,o,l),et=K(e,-.4,.4,.3,.1,o,l),L=y(e,1,0,h,d,m),nt=y(e,0,-1,h,d,L),O=y(e,-1,0,h,d,m),ot=y(e,0,-1,h,d,O),D=y(e,.5,-2.2,h,d,m),st=y(e,0,-1,h,d,D),W=y(e,-.5,-2.2,h,d,m),it=y(e,0,-1,h,d,W);return m}function N(e){c.ctx.beginPath(),e.query({and:[p,f]}).forEach(t=>{let{x:n,y:o,rad:s}=j(e,t),a=e.getComponent(t,f),i=Math.cos(s),r=Math.sin(s);c.ctx.transform(i,r,-r,i,n,o),c.ctx.rect(0,0,a.width,a.height),c.ctx.transform(i,-r,r,i,i*-n+r*-o,-r*-n+i*-o)}),c.ctx.fillStyle="white",c.ctx.fill()}function B(e){e.query({and:[p,T,g]}).forEach(t=>{let n=e.getComponent(t,T),{x:o,y:s}=j(e,t);c.ctx.fillStyle="lightgrey",c.ctx.beginPath(),c.ctx.ellipse(o,s,n.eyeWhiteRadius,n.eyeWhiteRadius,0,0,Math.PI*2),c.ctx.fill();let a=0,i=0,r=n.eyeWhiteRadius-n.pupilRadius;if(n.lookAtEntity!=-1){let h=e.getComponent(n.lookAtEntity,p);a=h.x-o,i=h.y-s;let d=(a**2+i**2)**.5;a/=d,i/=d,r=Math.min(d,r)}c.ctx.fillStyle="black",c.ctx.beginPath(),c.ctx.ellipse(o+a*r,s+i*r,n.pupilRadius,n.pupilRadius,0,0,Math.PI*2),c.ctx.fill()})}function V(e){let t=e.query({and:[u,p]}).find(h=>e.getComponent(h,u).isActive);if(!t)return;c.ctx.resetTransform();let n=e.getComponent(t,u),o=e.getComponent(t,p);if(e.hasComponent(t,g)){let h=e.getComponent(t,g);e.hasComponent(h.parent,p)&&Object.assign(o,e.getComponent(h.parent,p))}let s=Math.sin(o.rad+n.tilt),a=Math.cos(o.rad+n.tilt),i=o.x*n.zoom,r=o.y*-n.zoom;c.ctx.transform(a,s,-s,a,a*-i-s*-r+c.canvas.width*.5,s*-i+a*-r+c.canvas.height*.5),c.ctx.transform(n.zoom,0,0,-n.zoom,0,0)}function Y(e){e.query({and:[f,v,E,g]}).forEach(t=>{let n=e.getComponent(t,f),o=e.getComponent(t,v),s=e.getComponent(t,E),a=e.getComponent(t,g),i=n.width*n.height*o.density;a.parent==-1&&(s.y=-9.81)})}function G(e){e.query({and:[C,E]}).forEach(t=>{let n=e.getComponent(t,C),o=e.getComponent(t,E);n.x+=o.x*M.dtMilli/1e3,n.y+=o.y*M.dtMilli/1e3}),e.query({and:[p,C]}).forEach(t=>{let n=e.getComponent(t,p),o=e.getComponent(t,C);n.x+=o.x*M.dtMilli/1e3,n.y+=o.y*M.dtMilli/1e3})}function X(e){e.query({and:[R]}).forEach(s=>e.deleteEntity(s));let t=e.query({and:[u,p]}).find(s=>e.getComponent(s,u).isActive);if(!t)return;let n=e.getComponent(t,u),o=e.getComponent(t,p);P.isDown.forEach((s,a)=>{let i=e.addEntity(),r=P.pos.get(a);r&&(e.addComponent(i,p,$(Z(r,c.canvas,!0),o,n.tilt,n.zoom)),e.addComponent(i,R),e.addComponent(i,f))})}function J(e){e.query({and:[T,p]}).forEach(t=>{let n=e.getComponent(t,T),{x:o,y:s}=j(e,t),a=-1,i=Number.POSITIVE_INFINITY;e.query({and:[R,p]}).forEach(r=>{let h=e.getComponent(r,p),d=h.x-o,m=h.y-s,l=(d**2+m**2)**.5;l>i||(i=l,a=r)}),n.lookAtEntity=a??-1})}function Q(e="#202020"){c.ctx.resetTransform(),c.ctx.fillStyle=e,c.ctx.fillRect(0,0,c.canvas.width,c.canvas.height)}function $(e,t,n,o){let s=Math.cos(n),a=Math.sin(n),i={x:0,y:0},r=e.x-c.canvas.width/2,h=e.y-c.canvas.height/2;return i.x=s*r-a*h,i.y=a*r+s*h,i.x/=o,i.y/=o,i.x+=t.x,i.y+=t.y,i}function Z(e,t,n=!1){let o={x:0,y:0},s=t.getBoundingClientRect();return o.x=e.x-s.left,o.y=e.y-s.top,innerWidth/innerHeight<t.width/t.height?(o.x*=t.width/innerWidth,o.y*=t.width/innerWidth):(o.x*=t.height/innerHeight,o.y*=t.height/innerHeight),n&&(o.y=-o.y+t.height),o}function j(e,t){let n=e.getComponent(t,p);if(!e.hasComponent(t,g))return n;let o=n.x,s=n.y,a=n.rad,i=e.getComponent(t,g);for(;e.hasComponent(i.parent,g);){if(e.hasComponent(i.parent,p)){let r=e.getComponent(i.parent,p),h=Math.cos(r.rad),d=Math.sin(r.rad),m=o,l=s;o=h*m-d*l,s=d*m+h*l,o+=r.x,s+=r.y,a+=r.rad}i=e.getComponent(i.parent,g)}return{x:o,y:s,rad:a}}var x=new b,w=_(x,0,0),z=x.addEntity();x.addComponent(z,p,{x:0,y:0});x.addComponent(z,u,{zoom:18,isActive:!0});x.addComponent(z,g,{parent:w});(function e(){requestAnimationFrame(e),Q(),x.update(V,X,J,N,B,Y,G),H(M),F(P)})();})();
//# sourceMappingURL=out.js.map
