(()=>{var T=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(t){this.objectFactory=t}size(){return this.keyToIndex.size}add(t){return this.keyToIndex.has(t)?this.storage[this.keyToIndex.get(t)]:(this.storage.length<=this.keyToIndex.size&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.keyToIndex.size),this.indexToKey[this.keyToIndex.size-1]=t,this.storage[this.keyToIndex.get(t)])}remove(t){let n=this.keyToIndex.get(t);if(n==null)return;let o=this.storage[n];this.storage[n]=this.storage[this.keyToIndex.size-1],this.storage[this.keyToIndex.size-1]=o;let s=this.indexToKey[this.keyToIndex.size-1];this.indexToKey[n]=s,this.indexToKey.pop(),this.keyToIndex.set(s,n),this.keyToIndex.delete(t)}get(t){let n=this.keyToIndex.get(t);if(n==null)throw new Error("Key not found.");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.keyToIndex.size)}};var E=class{poolMap=new Map;maskMap=new Map;register(t){this.poolMap.has(t)||(this.maskMap.set(t,1<<this.maskMap.size),this.poolMap.set(t,new T(()=>({...t}))))}getMask(t){return this.maskMap.get(t)??-1}add(t,n){return Object.assign(this.poolMap.get(n).add(t),n)}remove(t,n){this.poolMap.get(n).remove(t)}has(t,n){return this.poolMap.has(n)&&this.poolMap.get(n).has(t)}get(t,n){return this.poolMap.get(n).get(t)}size(t){return this.poolMap.get(t).size()}delete(t){for(let n of this.poolMap.entries())n[1].remove(t)}copy(t,n){for(let o of this.poolMap.entries())o[1].has(t)&&Object.assign(o[1].add(n),o[1].get(t))}clean(){for(let t of this.poolMap.entries())t[1].clean()}};function z(){return Math.random()}var I=class{maskMap=new Map;archetypeMap=new Map;compManager=new E;addEntity(t=z()){return this.maskMap.has(t)||(this.maskMap.set(t,0),this.getArchetype(0).add(t)),t}copyEntity(t,n=z()){this.compManager.copy(t,n);let o=this.maskMap.get(t)??0;return this.maskMap.set(n,o),this.getArchetype(o).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return this.compManager.has(t,n)}addComponent(t,n,o=n){this.compManager.register(n);let s=this.maskMap.get(t)??0,a=this.compManager.getMask(n);return s&a?Object.assign(this.compManager.get(t,n),o):(this.getArchetype(s).delete(t),s^=a,this.maskMap.set(t,s),this.getArchetype(s).add(t),Object.assign(this.compManager.add(t,n),o))}removeComponent(t,n){this.compManager.register(n);let o=this.maskMap.get(t)??0,s=this.compManager.getMask(n);o&s&&(this.compManager.remove(t,n),this.getArchetype(o).delete(t),o^=s,this.maskMap.set(t,o),this.getArchetype(o).add(t))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this)}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,o=0;if(t.and)for(let a=0,i=t.and.length;a<i;a++)n|=this.compManager.getMask(t.and[a]);if(t.not)for(let a=0,i=t.not.length;a<i;a++)o|=this.compManager.getMask(t.not[a]);let s=[];for(let a of this.archetypeMap.entries())a[1].size>0&&(a[0]&n)==n&&(a[0]&o)==0&&s.push(...a[1]);return s}entityCount(){return this.maskMap.size}};var c=B(),x=Y(),v=X();function B(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function Y(){return{dtMilli:0,timeMilli:0}}function G(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function X(){let e={pos:new Map,isDown:new Map,justPressed:new Map,justReleased:new Map,pressPos:new Map,releasePos:new Map};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.pos.set(t.pointerId,{x:t.x,y:t.y}),e.pressPos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.set(t.pointerId,!0),e.justPressed.set(t.pointerId,!0))},globalThis.onpointerup=t=>{e.pos.delete(t.pointerId),e.releasePos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.delete(t.pointerId),e.justReleased.set(t.pointerId,!0)},globalThis.onpointermove=t=>{e.pos.set(t.pointerId,{x:t.x,y:t.y})},e}function J(e){e.justReleased.clear(),e.justPressed.clear(),e.releasePos.clear(),e.pressPos.clear()}var p={x:0,y:0,rad:0},g={parent:-1,children:[]},k={eyeWhiteRadius:1,pupilRadius:.4,lookAtEntity:-1},l={zoom:20,tilt:0,isActive:!1},b={width:1,height:1},Q={density:.1},C={x:0,y:0},R={x:0,y:0},j={},M={radPerSecond:0};function y(e,t=0,n=0,o={width:1,height:1},s={x:0,y:0},a=-1){let i=e.addEntity();e.addComponent(i,p,{x:t,y:n}),e.addComponent(i,C),e.addComponent(i,R),e.addComponent(i,M);let r=e.addEntity();return e.addComponent(r,p,s),e.addComponent(r,b,o),e.addComponent(r,Q),U(e,a,i),U(e,i,r),i}function W(e,t=0,n=0,o=1,s=.4,a=-1,i=-1){let r=e.addEntity();return e.addComponent(r,p,{x:t,y:n}),e.addComponent(r,g,{parent:i}),e.addComponent(r,k,{eyeWhiteRadius:o,pupilRadius:s,lookAtEntity:a}),r}function $(e,t=0,n=0,o=-1){let s={width:1,height:1},a={x:-.5,y:0},i={width:1,height:2},r={x:-.5,y:-2},h={width:.5,height:.9},d={x:-.25,y:-.9},m=y(e,t,n,i,r),u=y(e,0,.2,s,a,m),H=W(e,.4,.4,.3,.1,o,u),K=W(e,-.4,.4,.3,.1,o,u),S=y(e,1,0,h,d,m),F=y(e,0,-1,h,d,S),O=y(e,-1,0,h,d,m),V=y(e,0,-1,h,d,O),q=y(e,.5,-2.2,h,d,m),_=y(e,0,-1,h,d,q),D=y(e,-.5,-2.2,h,d,m),N=y(e,0,-1,h,d,D);return{head:u,rightEye:K,leftEye:H,torso:m,rightUpperArm:O,rightLowerArm:V,leftUpperArm:S,leftLowerArm:F,rightUpperLeg:D,rightLowerLeg:N,leftUpperLeg:q,leftLowerLeg:_}}function Z(e){e.query({and:[p,M]}).forEach(t=>{let n=e.getComponent(t,p),o=e.getComponent(t,M);n.rad+=o.radPerSecond*x.dtMilli/1e3})}function w(e){c.ctx.beginPath(),e.query({and:[p,b]}).forEach(t=>{let{x:n,y:o,rad:s}=P(e,t),a=e.getComponent(t,b),i=Math.cos(s),r=Math.sin(s);c.ctx.transform(i,r,-r,i,n,o),c.ctx.rect(0,0,a.width,a.height),c.ctx.transform(i,-r,r,i,i*-n+r*-o,-r*-n+i*-o)}),c.ctx.fillStyle="white",c.ctx.fill()}function tt(e){e.query({and:[p,k,g]}).forEach(t=>{let n=e.getComponent(t,k),{x:o,y:s}=P(e,t);c.ctx.fillStyle="lightgrey",c.ctx.beginPath(),c.ctx.ellipse(o,s,n.eyeWhiteRadius,n.eyeWhiteRadius,0,0,Math.PI*2),c.ctx.fill();let a=0,i=0,r=n.eyeWhiteRadius-n.pupilRadius;if(n.lookAtEntity!=-1){let h=e.getComponent(n.lookAtEntity,p);a=h.x-o,i=h.y-s;let d=(a**2+i**2)**.5;a/=d,i/=d,r=Math.min(d,r)}c.ctx.fillStyle="black",c.ctx.beginPath(),c.ctx.ellipse(o+a*r,s+i*r,n.pupilRadius,n.pupilRadius,0,0,Math.PI*2),c.ctx.fill()})}function et(e){let t=e.query({and:[l,p]}).find(h=>e.getComponent(h,l).isActive);if(!t)return;c.ctx.resetTransform();let n=e.getComponent(t,l),o=e.getComponent(t,p);if(e.hasComponent(t,g)){let h=e.getComponent(t,g);e.hasComponent(h.parent,p)&&Object.assign(o,P(e,h.parent))}let s=Math.sin(o.rad+n.tilt),a=Math.cos(o.rad+n.tilt),i=o.x*n.zoom,r=o.y*-n.zoom;c.ctx.transform(a,s,-s,a,a*-i-s*-r+c.canvas.width*.5,s*-i+a*-r+c.canvas.height*.5),c.ctx.transform(n.zoom,0,0,-n.zoom,0,0)}function nt(e){e.query({and:[C,R]}).forEach(t=>{let n=e.getComponent(t,C),o=e.getComponent(t,R);n.x+=o.x*x.dtMilli/1e3,n.y+=o.y*x.dtMilli/1e3}),e.query({and:[p,C]}).forEach(t=>{let n=e.getComponent(t,p),o=e.getComponent(t,C);n.x+=o.x*x.dtMilli/1e3,n.y+=o.y*x.dtMilli/1e3})}function ot(e){e.query({and:[j]}).forEach(s=>e.deleteEntity(s));let t=e.query({and:[l,p]}).find(s=>e.getComponent(s,l).isActive);if(!t)return;let n=e.getComponent(t,l),o=e.getComponent(t,p);v.isDown.forEach((s,a)=>{let i=e.addEntity(),r=v.pos.get(a);r&&(e.addComponent(i,p,at(rt(r,c.canvas,!0),o,n.tilt,n.zoom)),e.addComponent(i,j),e.addComponent(i,b))})}function st(e){e.query({and:[k,p]}).forEach(t=>{let n=e.getComponent(t,k),{x:o,y:s}=P(e,t),a=-1,i=Number.POSITIVE_INFINITY;e.query({and:[j,p]}).forEach(r=>{let h=e.getComponent(r,p),d=h.x-o,m=h.y-s,u=(d**2+m**2)**.5;u>i||(i=u,a=r)}),n.lookAtEntity=a??-1})}function it(e="#202020"){c.ctx.resetTransform(),c.ctx.fillStyle=e,c.ctx.fillRect(0,0,c.canvas.width,c.canvas.height)}function at(e,t,n,o){let s=Math.cos(n),a=Math.sin(n),i={x:0,y:0},r=e.x-c.canvas.width/2,h=e.y-c.canvas.height/2;return i.x=s*r-a*h,i.y=a*r+s*h,i.x/=o,i.y/=o,i.x+=t.x,i.y+=t.y,i}function rt(e,t,n=!1){let o={x:0,y:0},s=t.getBoundingClientRect();return o.x=e.x-s.left,o.y=e.y-s.top,innerWidth/innerHeight<t.width/t.height?(o.x*=t.width/innerWidth,o.y*=t.width/innerWidth):(o.x*=t.height/innerHeight,o.y*=t.height/innerHeight),n&&(o.y=-o.y+t.height),o}function P(e,t){let n=e.getComponent(t,p);if(!e.hasComponent(t,g))return n;let o=n.x,s=n.y,a=n.rad,i=e.getComponent(t,g);for(;e.hasComponent(i.parent,g);){if(e.hasComponent(i.parent,p)){let r=e.getComponent(i.parent,p),h=Math.cos(r.rad),d=Math.sin(r.rad),m=o,u=s;o=h*m-d*u,s=d*m+h*u,o+=r.x,s+=r.y,a+=r.rad}i=e.getComponent(i.parent,g)}return{x:o,y:s,rad:a}}function U(e,t,n){if(t!=-1){!e.hasComponent(t,g)&&e.addComponent(t,g,{children:[]});let s=e.getComponent(t,g);for(let a=0,i=s.children.length;a<i;a++)if(s.children[a]==n)return;s.children.push(n)}!e.hasComponent(n,g)&&e.addComponent(n,g,{children:[]});let o=e.getComponent(n,g);o.parent=t}var f=new I,A=$(f,0,0);f.getComponent(A.rightUpperLeg,M).radPerSecond=2;f.getComponent(A.rightLowerLeg,M).radPerSecond=-2;f.getComponent(A.leftLowerArm,M).radPerSecond=-1;var L=f.addEntity();f.addComponent(L,p,{x:0,y:0});f.addComponent(L,l,{zoom:18,isActive:!0});f.addComponent(L,g,{parent:A.torso});(function e(){requestAnimationFrame(e),it(),f.update(et,ot,st,w,tt,nt,Z),G(x),J(v)})();})();
//# sourceMappingURL=out.js.map
