(()=>{var A=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(t){this.objectFactory=t}size(){return this.indexToKey.length}add(t){return this.keyToIndex.has(t)||(this.storage.length<=this.indexToKey.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.indexToKey.length),this.indexToKey[this.indexToKey.length]=t),this.storage[this.keyToIndex.get(t)]}remove(t){let n=this.keyToIndex.get(t),o=this.indexToKey[this.indexToKey.length-1];if(n==null||o==null)return;let s=this.storage[this.indexToKey.length-1];this.storage[this.indexToKey.length-1]=this.storage[n],this.storage[n]=s,this.indexToKey[n]=o,this.keyToIndex.set(o,n),this.indexToKey.pop(),this.keyToIndex.delete(t)}get(t){let n=this.keyToIndex.get(t);if(n==null)throw new Error("Key not found");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.indexToKey.length)}};var P=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new A(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,n){return Object.assign(this.pools.get(n).add(t),n)}remove(t,n){this.pools.get(n).remove(t)}get(t,n){return this.pools.get(n).get(t)}size(t){return this.pools.get(t).size()}delete(t){for(let n of this.pools)n[1].remove(t)}copy(t,n){for(let o of this.pools)o[1].has(t)&&Object.assign(o[1].add(n),o[1].get(t))}clean(){for(let t of this.pools)t[1].clean()}};function j(){return Math.random()}var v=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new P;addEntity(t=j()){return this.maskMap.set(t,0),this.getArchetype(0).add(t),t}copyEntity(t,n=j()){this.compManager.copy(t,n);let o=this.maskMap.get(t)??0;return this.maskMap.set(n,o),this.getArchetype(o).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.entitiesToDelete.push(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return((this.maskMap.get(t)??0)&1<<this.compManager.getId(n))>0}addComponent(t,n,o=n){this.registerComponent(n);let s=this.maskMap.get(t)??0,i=this.compManager.getId(n);return(s&1<<i)!=0?Object.assign(this.compManager.get(t,n),o):(this.getArchetype(s).delete(t),s|=1<<i,this.maskMap.set(t,s),this.getArchetype(s).add(t),Object.assign(this.compManager.add(t,n),o))}removeComponent(t,n){this.registerComponent(n);let o=this.maskMap.get(t)??0,s=this.compManager.getId(n);(o&1<<s)!=0&&(this.getArchetype(o).delete(t),o&=~(1<<s),this.maskMap.set(t,o),this.getArchetype(o).add(t),this.compManager.remove(t,n))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let t=this.entitiesToDelete.pop();this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,o=0;if(t.and)for(let i=0,a=t.and.length;i<a;i++)n|=1<<this.compManager.getId(t.and[i]);if(t.not)for(let i=0,a=t.not.length;i<a;i++)o|=1<<this.compManager.getId(t.not[i]);let s=[];for(let i of this.archetypeMap)i[1].size>0&&(i[0]&n)==n&&(i[0]&o)==0&&s.push(...i[1]);return s}entityCount(){return this.maskMap.size}};var r=q(),T=W(),R=S();function q(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function W(){return{dtMilli:0,timeMilli:0}}function O(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function S(){let e={pos:new Map,isDown:new Map,justPressed:new Map,justReleased:new Map,pressPos:new Map,releasePos:new Map};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.pos.set(t.pointerId,{x:t.x,y:t.y}),e.pressPos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.set(t.pointerId,!0),e.justPressed.set(t.pointerId,!0))},globalThis.onpointerup=t=>{e.pos.delete(t.pointerId),e.releasePos.set(t.pointerId,{x:t.x,y:t.y}),e.isDown.delete(t.pointerId),e.justReleased.set(t.pointerId,!0)},globalThis.onpointermove=t=>{e.pos.set(t.pointerId,{x:t.x,y:t.y})},e}function _(e){e.justReleased.clear(),e.justPressed.clear(),e.releasePos.clear(),e.pressPos.clear()}var c={x:0,y:0,rad:0},m={parent:-1},I={eyeWhiteRadius:1,pupilRadius:.4,lookAtEntity:-1},C={zoom:20,tilt:0,isActive:!1,targetEntity:-1},M={width:1,height:1,offsetX:-.5,offsetY:-.5},D={density:.1},E={x:0,y:0},k={x:0,y:0},K={};function u(e,t=0,n=0,o=1,s=1,i=-1,a=-o/2,p=0){let h=e.addEntity();return e.addComponent(h,c,{x:t,y:n}),e.addComponent(h,m,{parent:i}),e.addComponent(h,M,{width:o,height:s,offsetX:a,offsetY:p}),e.addComponent(h,D),e.addComponent(h,E),e.addComponent(h,k),h}function z(e,t=0,n=0,o=1,s=.4,i=-1,a=-1){let p=e.addEntity();return e.addComponent(p,c,{x:t,y:n}),e.addComponent(p,m,{parent:a}),e.addComponent(p,I,{eyeWhiteRadius:o,pupilRadius:s,lookAtEntity:i}),p}function U(e,t=0,n=0,o=-1){let s=u(e,t,n,1,2),i=u(e,0,-.2,1,1,s,-.5,-1),a=z(e,-.4,-.4,.3,.1,o,i),p=z(e,.4,-.4,.3,.1,o,i),h=u(e,-1,0,.5,1,s),d=u(e,0,1,.5,1,h),g=u(e,1,0,.5,1,s),y=u(e,0,1,.5,1,g),l=u(e,-.5,2,.5,1,s),f=u(e,0,1,.5,1,l),x=u(e,.5,2,.5,1,s),$=u(e,0,1,.5,1,x);return s}function H(e){r.ctx.beginPath(),e.query({and:[c,M],not:[m]}).forEach(t=>{let n=e.getComponent(t,c),o=e.getComponent(t,M),s=Math.cos(n.rad),i=Math.sin(n.rad);r.ctx.transform(s,i,-i,s,n.x,n.y),r.ctx.rect(o.offsetX,o.offsetY,o.width,o.height),r.ctx.transform(s,-i,i,s,s*-n.x+i*-n.y,-i*-n.x+s*-n.y)}),e.query({and:[c,M,m]}).forEach(t=>{let n=e.getComponent(t,c),o=e.getComponent(t,M),s=e.getComponent(t,m),i=n.x,a=n.y,p=n.rad;for(;e.hasComponent(s.parent,m);){if(e.hasComponent(s.parent,c)){let g=e.getComponent(s.parent,c),y=Math.cos(g.rad),l=Math.sin(g.rad),f=i,x=a;i=y*f-l*x,a=l*f+y*x,i+=g.x,a+=g.y,p+=g.rad}s=e.getComponent(s.parent,m)}let h=Math.cos(p),d=Math.sin(p);r.ctx.transform(h,d,-d,h,i,a),r.ctx.rect(o.offsetX,o.offsetY,o.width,o.height),r.ctx.transform(h,-d,d,h,h*-i+d*-a,-d*-i+h*-a)}),r.ctx.fillStyle="white",r.ctx.fill()}function F(e){e.query({and:[c,I,m]}).forEach(t=>{let n=e.getComponent(t,c),o=e.getComponent(t,I),s=e.getComponent(t,m),i=n.x,a=n.y;for(;e.hasComponent(s.parent,m);){if(e.hasComponent(s.parent,c)){let g=e.getComponent(s.parent,c),y=Math.cos(g.rad),l=Math.sin(g.rad),f=i,x=a;i=y*f-l*x,a=l*f+y*x,i+=g.x,a+=g.y}s=e.getComponent(s.parent,m)}r.ctx.fillStyle="lightgrey",r.ctx.beginPath(),r.ctx.ellipse(i,a,o.eyeWhiteRadius,o.eyeWhiteRadius,0,0,Math.PI*2),r.ctx.fill();let p=0,h=0,d=o.eyeWhiteRadius-o.pupilRadius;if(o.lookAtEntity!=-1){let g=e.getComponent(o.lookAtEntity,c);p=g.x-i,h=g.y-a;let y=(p**2+h**2)**.5;p/=y,h/=y,d=Math.min(y,d)}r.ctx.fillStyle="black",r.ctx.beginPath(),r.ctx.ellipse(i+p*d,a+h*d,o.pupilRadius,o.pupilRadius,0,0,Math.PI*2),r.ctx.fill()})}function Y(e){let t=e.query({and:[C,c]}).find(a=>e.getComponent(a,C).isActive);if(!t)return;r.ctx.resetTransform();let n=e.getComponent(t,C),o=e.getComponent(t,c);if(n.targetEntity!=-1&&e.hasComponent(n.targetEntity,c)){let a=e.getComponent(n.targetEntity,c);Object.assign(o,a)}let s=Math.sin(n.tilt)*n.zoom,i=Math.cos(n.tilt)*n.zoom;r.ctx.transform(i,s,-s,i,i*-o.x-s*-o.y+r.canvas.width*.5,s*-o.x+i*-o.y+r.canvas.height*.5)}function X(e){e.query({and:[M,D,k,m]}).forEach(t=>{let n=e.getComponent(t,M),o=e.getComponent(t,D),s=e.getComponent(t,k),i=e.getComponent(t,m),a=n.width*n.height*o.density;i.parent==-1&&(s.y=9.81)})}function N(e){e.query({and:[E,k]}).forEach(t=>{let n=e.getComponent(t,E),o=e.getComponent(t,k);n.x+=o.x*T.dtMilli/1e3,n.y+=o.y*T.dtMilli/1e3}),e.query({and:[c,E]}).forEach(t=>{let n=e.getComponent(t,c),o=e.getComponent(t,E);n.x+=o.x*T.dtMilli/1e3,n.y+=o.y*T.dtMilli/1e3})}function B(e){e.query({and:[K]}).forEach(s=>e.deleteEntity(s));let t=e.query({and:[C,c]}).find(s=>e.getComponent(s,C).isActive);if(!t)return;let n=e.getComponent(t,C),o=e.getComponent(t,c);R.isDown.forEach((s,i)=>{let a=e.addEntity(),p=R.pos.get(i);p&&(Object.assign(e.addComponent(a,c),J(Q(p,r.canvas),o,n.tilt,n.zoom)),e.addComponent(a,K))})}function V(e){e.query({and:[I,c,m]}).forEach(t=>{let n=e.getComponent(t,I),o=e.getComponent(t,c),s=e.getComponent(t,m),i=o.x,a=o.y;for(;e.hasComponent(s.parent,m);){if(e.hasComponent(s.parent,c)){let d=e.getComponent(s.parent,c),g=Math.cos(d.rad),y=Math.sin(d.rad),l=i,f=a;i=g*l-y*f,a=y*l+g*f,i+=d.x,a+=d.y}s=e.getComponent(s.parent,m)}let p=-1,h=Number.POSITIVE_INFINITY;e.query({and:[K,c]}).forEach(d=>{let g=e.getComponent(d,c),y=g.x-i,l=g.y-a,f=(y**2+l**2)**.5;f>h||(h=f,p=d)}),n.lookAtEntity=p??-1})}function G(e="#202020"){r.ctx.resetTransform(),r.ctx.fillStyle=e,r.ctx.fillRect(0,0,r.canvas.width,r.canvas.height)}function J(e,t,n,o){let s=Math.cos(n),i=Math.sin(n),a={x:0,y:0},p=e.x-r.canvas.width/2,h=e.y-r.canvas.height/2;return a.x=s*p+i*h,a.y=-i*p+s*h,a.x/=o,a.y/=o,a.x+=t.x,a.y+=t.y,a}function Q(e,t){let n={x:0,y:0},o=t.getBoundingClientRect();return n.x=e.x-o.left,n.y=e.y-o.top,innerWidth/innerHeight<t.width/t.height?(n.x*=t.width/innerWidth,n.y*=t.width/innerWidth):(n.x*=t.height/innerHeight,n.y*=t.height/innerHeight),n}var b=new v,ct=U(b,0,0),L=b.addEntity();b.addComponent(L,c,{y:1});b.addComponent(L,C,{zoom:18,isActive:!0});(function e(){requestAnimationFrame(e),G(),b.update(V,Y,H,F,B,X,N),O(T),_(R)})();})();
//# sourceMappingURL=out.js.map
