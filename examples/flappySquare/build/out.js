(()=>{var C=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;size=0;constructor(e){this.objectFactory=e}len(){return this.size}add(e){let t=this.keyToIndex.get(e);return t!=null?this.storage[t]:(this.size>=this.storage.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(e,this.size),this.indexToKey[this.size]=e,this.size++,this.storage[this.size-1])}remove(e){let t=this.keyToIndex.get(e)??-1,n=this.indexToKey[this.size-1];if(t<0||t>=this.size||!n)return!1;let o=this.storage[t];return this.storage[t]=this.storage[this.size-1],this.storage[this.size-1]=o,this.keyToIndex.set(n,t),this.keyToIndex.delete(e),this.indexToKey[t]=n,this.size--,!0}get(e){let t=this.keyToIndex.get(e)??-1;if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}has(e){return this.keyToIndex.has(e)}clean(){this.storage.splice(this.size),this.indexToKey.splice(this.size);for(let e of this.keyToIndex.keys()){let t=this.keyToIndex.get(e)??-1;(t<0||t>=this.size)&&this.keyToIndex.delete(e)}}};var k=class{pools=new Map;idMap=new Map;register(e){this.pools.has(e)||(this.idMap.set(e,this.idMap.size),this.pools.set(e,new C(()=>({...e}))))}getId(e){return this.idMap.get(e)??-1}add(e,t){return Object.assign(this.pools.get(t).add(e),t)}remove(e,t){return this.pools.get(t).remove(e)}get(e,t){return this.pools.get(t).get(e)}len(e){return this.pools.get(e).len()}delete(e){for(let t of this.pools.values())t.remove(e)}copy(e,t){for(let n of this.pools.values()){let o=n;o.has(e)&&Object.assign(o.add(t),o.get(e))}}clean(){for(let e of this.pools.values())e.clean()}};function j(){return Math.random()}var S=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new k;addEntity(e=j()){return this.maskMap.set(e,0),this.getArchetype(0).add(e),e}copyEntity(e,t=j()){this.compManager.copy(e,t);let n=this.maskMap.get(e)??0;return this.maskMap.set(t,n),this.getArchetype(n).add(t),t}getArchetype(e){let t=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,t),t}deleteEntity(e){this.entitiesToDelete.push(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,t){return((this.maskMap.get(e)??0)&1<<this.compManager.getId(t))>0}addComponent(e,t,n=t){this.registerComponent(t);let o=this.maskMap.get(e)??0,i=this.compManager.getId(t);return(o&1<<i)!=0?Object.assign(this.compManager.get(e,t),n):(this.getArchetype(o).delete(e),o|=1<<i,this.maskMap.set(e,o),this.getArchetype(o).add(e),Object.assign(this.compManager.add(e,t),n))}removeComponent(e,t){this.registerComponent(t);let n=this.maskMap.get(e)??0,o=this.compManager.getId(t);return(n&1<<o)==0?!1:(this.getArchetype(n).delete(e),n&=~(1<<o),this.maskMap.set(e,n),this.getArchetype(n).add(e),this.compManager.remove(e,t))}getComponent(e,t){return this.compManager.get(e,t)}update(...e){for(let t=0,n=e.length;t<n;t++)e[t](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let e=this.entitiesToDelete.pop();this.compManager.delete(e);let t=this.maskMap.get(e)??0;this.maskMap.delete(e),this.getArchetype(t).delete(e)}}cleanObjectPools(){this.compManager.clean()}query(e){let t=0,n=0;if(e.and)for(let i=0,a=e.and.length;i<a;i++)t|=1<<this.compManager.getId(e.and[i]);if(e.not)for(let i=0,a=e.not.length;i<a;i++)n|=1<<this.compManager.getId(e.not[i]);let o=[];return this.archetypeMap.forEach((i,a)=>{let l=i;l.size>0&&(a&t)==t&&(a&n)==0&&o.push(...l)}),[...new Set(o)]}entityCount(){return this.maskMap.size}};var m={grav:981,hSpeedMult:1.001,pipe:{gapHeight:80,baseSpeed:100,width:30,height:1e3}};var r=document.createElement("canvas");if(!r)throw new Error("Cannot create canvas element.");r.style.imageRendering="pixelated";document.body.appendChild(r);var y=r.getContext("2d");if(!y)throw new Error("Cannot initialize 2d context.");var f={isDown:!1,justPressed:!1,justReleased:!1},g={isDown:{},justPressed:{},justReleased:{}},c={currentScore:0,bestScore:0},h={x:0,y:0,rad:0,scaleX:1,scaleY:1},p={width:10,height:10},M={x:0,y:0},x={x:0,y:0},w={},u={gapHeight:m.pipe.gapHeight};function b(s,e,t,n="white"){let o=Math.sin(e.rad),i=Math.cos(e.rad),a=s.fillStyle;s.transform(i,o,-o,i,e.x,e.y),s.fillStyle=n,s.fillRect(-t.width*.5,-t.height*.5,t.width*e.scaleX,t.height*e.scaleY),s.fillStyle=a,s.transform(i,-o,o,i,i*-e.x+o*-e.y,-o*-e.x+i*-e.y)}function R(s){y&&(K(y,"green"),s.query({and:[h,p],not:[u]}).forEach(e=>{let t=s.getComponent(e,h),n=s.getComponent(e,p);b(y,t,n)}),s.query({and:[h,p,u]}).forEach(e=>{let t=s.getComponent(e,h),n=s.getComponent(e,p),o=s.getComponent(e,u),i=(n.height-o.gapHeight)*.5;b(y,{x:t.x,y:t.y+(o.gapHeight+i)*.5,scaleX:1,scaleY:1,rad:0},{width:n.width,height:i}),b(y,{x:t.x,y:t.y-(o.gapHeight+i)*.5,scaleX:1,scaleY:1,rad:0},{width:n.width,height:i})}),y.fillText("Score: "+c.currentScore+"; Best: "+c.bestScore,0,10))}function A(s){let e=T/1e3;s.query({and:[h,x,M]}).forEach(t=>{let n=s.getComponent(t,h),o=s.getComponent(t,M),i=s.getComponent(t,x);o.x+=i.x*e,o.x*=m.hSpeedMult,o.y+=i.y*e,n.x+=o.x*e,n.y+=o.y*e})}function H(s){s.query({and:[w,x,M]}).forEach(e=>{let t=s.getComponent(e,x),n=s.getComponent(e,M);t.y=m.grav,(g.justPressed[" "]||f.justPressed)&&(t.y=-m.grav*20,n.x=n.y=0)})}function I(s){c.bestScore=parseInt(localStorage.getItem("best")||"0"),c.bestScore=c.currentScore>c.bestScore?c.currentScore:c.bestScore,c.currentScore=0,localStorage.setItem("best",c.bestScore.toString()),s.query({and:[w]}).forEach(e=>{X(e)}),s.query({and:[u]}).forEach(e=>{let t=s.getComponent(e,M);t.x=-m.pipe.baseSpeed,D(e)})}function O(s){s.query({and:[w,p,h]}).forEach(e=>{let t=s.getComponent(e,h),n=s.getComponent(e,p);t.y>r.height-n.height*.5&&I(s),s.query({and:[h,p,u]}).forEach(o=>{let i=s.getComponent(o,h),a=s.getComponent(o,p),l=s.getComponent(o,u);(t.x-i.x)**2<((n.width+a.width)*.5)**2&&(t.y-i.y)**2>((l.gapHeight-n.height)*.5)**2&&I(s),i.x+a.width*.5<0&&(D(o),c.currentScore++)})})}function K(s,e=""){s.setTransform(1,0,0,1,0,0);let t=s.fillStyle;s.fillStyle=e,s.fillRect(0,0,s.canvas.width,s.canvas.height),s.fillStyle=t}function E(s,e=0,t=0,n=0,o=10,i=10){let a=s.addEntity(),l=s.addComponent(a,h);l.x=e,l.y=t,l.rad=n;let v=s.addComponent(a,p);return v.width=o,v.height=i,s.addComponent(a,M),s.addComponent(a,x),a}function F(s){let e=E(s);return s.addComponent(e,w),e}function q(s){let e=E(s),t=s.getComponent(e,p);return s.addComponent(e,u),t.width=m.pipe.width,t.height=m.pipe.height,e}function X(s){let e=d.getComponent(s,h),t=d.getComponent(s,M),n=d.getComponent(s,x);e.x=r.width*.15,e.y=r.height*.5,t.x=t.y=n.x=n.y=0}function D(s){let e=d.getComponent(s,h),t=d.getComponent(s,p),o=d.getComponent(s,u).gapHeight;e.y=Math.random()*(r.height-o)+o*.5,e.x=r.width+t.width*.5}document.onkeydown=s=>{!g.isDown[s.key]&&(g.justPressed[s.key]=!0),g.isDown[s.key]=!0};document.onkeyup=s=>{g.isDown[s.key]=!1,g.justReleased[s.key]=!0};globalThis.window.onresize=document.body.onload=()=>{innerWidth/innerHeight<r.width/r.height?(r.style.width="100%",r.style.height=""):(r.style.width="",r.style.height="100%")};document.onpointerdown=()=>{f.isDown=!0,f.justPressed=!0};document.onpointerup=()=>{f.isDown=!1,f.justReleased=!0};var d=new S,T=0,z=0;F(d);q(d);I(d);(function s(){requestAnimationFrame(s),d.update(R,H,O,A),f.justReleased=!1,f.justPressed=!1;for(let e in g.justPressed)g.justPressed[e]=!1;for(let e in g.justReleased)g.justReleased[e]=!1;T=performance.now()-z,z+=T})();})();
//# sourceMappingURL=out.js.map
