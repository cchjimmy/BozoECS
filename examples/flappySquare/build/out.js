(()=>{var x=class{storage=[];indices=new Map;objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}add(t){let e=this.indices.get(t);return e!=null?this.storage[e]:(this.size>=this.storage.length&&this.storage.push(this.objectFactory()),this.indices.set(t,this.size),this.size++,this.storage[this.size-1])}remove(t){let e=this.indices.get(t)??-1;if(e<0||e>=this.size)return!1;let n=this.storage[e];this.storage[e]=this.storage[this.size-1],this.storage[this.size-1]=n;for(let[o,i]of this.indices)if(i==this.size-1){this.indices.set(o,e);break}return this.indices.delete(t),this.size--,!0}get(t){let e=this.indices.get(t)??-1;if(e<0||e>=this.size)throw new Error("Index out of range.");return this.storage[e]}has(t){return this.indices.has(t)}};function E(){return Math.random()}var c=class s{static pools=new Map;static idMap=new Map;static register(t){s.pools.has(t)||(s.idMap.set(t,s.idMap.size),s.pools.set(t,new x(()=>({...t}))))}static getId(t){return s.idMap.get(t)??-1}static add(t,e){return Object.assign(s.pools.get(e).add(t),e)}static remove(t,e){return s.pools.get(e).remove(t)}static get(t,e){return s.pools.get(e).get(t)}static len(t){return s.pools.get(t).len()}static delete(t){for(let e of this.pools){let n=e[1];n.has(t)&&n.remove(t)}}static copy(t){let e=E();for(let n of this.pools){let o=n[1];o.has(t)&&Object.assign(o.add(e),o.get(t))}return e}};var r=class s{static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static entitiesToDelete=[];localEntities=new Set;constructor(){s.worlds.push(this)}static createEntity(){let t=E();return s.maskMap.set(t,0),s.getArchetype(0).add(t),t}static copyEntity(t){let e=c.copy(t),n=this.maskMap.get(t)??0;return this.maskMap.set(e,n),this.getArchetype(n).add(e),e}static getArchetype(t){let e=s.archetypeMap.get(t)??new Set;return s.archetypeMap.set(t,e),e}static deleteEntity(t){s.entitiesToDelete.push(t)}addEntity(t=s.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}static registerComponent(t){return c.register(t),s}static hasComponent(t,e){return((s.maskMap.get(t)??0)&1<<c.getId(e))>0}static addComponent(t,e,n=e){s.registerComponent(e);let o=s.maskMap.get(t)??0,i=c.getId(e);return(o&1<<i)!=0?Object.assign(c.get(t,e),n):(s.getArchetype(o).delete(t),o|=1<<i,s.maskMap.set(t,o),s.getArchetype(o).add(t),Object.assign(c.add(t,e),n))}static removeComponent(t,e){s.registerComponent(e);let n=s.maskMap.get(t)??0,o=c.getId(e);return(n&1<<o)==0?!1:(s.getArchetype(n).delete(t),n&=~(1<<o),s.maskMap.set(t,n),s.getArchetype(n).add(t),c.remove(t,e))}static getComponent(t,e){return c.get(t,e)}update(...t){for(let e=0,n=t.length;e<n;e++)t[e](this);for(;s.entitiesToDelete.length;){let e=s.entitiesToDelete.pop();for(let o=0,i=s.worlds.length;o<i;o++)s.worlds[o].localEntities.delete(e);c.delete(e);let n=s.maskMap.get(e)??0;s.maskMap.delete(e),s.getArchetype(n).delete(e)}}query(t){let e=0,n=0;if(t.and)for(let i=0,a=t.and.length;i<a;i++)e|=1<<c.getId(t.and[i]);if(t.not)for(let i=0,a=t.not.length;i<a;i++)n|=1<<c.getId(t.not[i]);let o=[];for(let i=s.archetypeMap.keys().toArray(),a=i.length,u=0;u<a;u++){let M=i[u],I=s.getArchetype(M);I.size!=0&&(M&e)==e&&(M&n)==0&&o.push(...I)}return[...this.localEntities.intersection(new Set(o))]}entityCount(){return this.localEntities.size}};var f={grav:981,hSpeedMult:1.001,pipe:{gapHeight:80,baseSpeed:100,width:30,height:1e3}};var d=document.createElement("canvas");if(!d)throw new Error("Cannot create canvas element.");d.style.imageRendering="pixelated";document.body.appendChild(d);var y=d.getContext("2d");if(!y)throw new Error("Cannot initialize 2d context.");var w={isDown:!1,justPressed:!1,justReleased:!1},p={isDown:{},justPressed:{},justReleased:{}},l={currentScore:0,bestScore:0},h={x:0,y:0,rad:0,scaleX:1,scaleY:1},g={width:10,height:10},C={x:0,y:0},S={x:0,y:0},k={},m={gapHeight:f.pipe.gapHeight};function b(s,t,e,n="white"){let o=Math.sin(t.rad),i=Math.cos(t.rad),a=s.fillStyle;s.transform(i,o,-o,i,t.x,t.y),s.fillStyle=n,s.fillRect(-e.width*.5,-e.height*.5,e.width*t.scaleX,e.height*t.scaleY),s.fillStyle=a,s.transform(i,-o,o,i,i*-t.x+o*-t.y,-o*-t.x+i*-t.y)}function H(s){y&&(q(y,"green"),s.query({and:[h,g],not:[m]}).forEach(t=>{let e=r.getComponent(t,h),n=r.getComponent(t,g);b(y,e,n)}),s.query({and:[h,g,m]}).forEach(t=>{let e=r.getComponent(t,h),n=r.getComponent(t,g),o=r.getComponent(t,m),i=(n.height-o.gapHeight)*.5;b(y,{x:e.x,y:e.y+(o.gapHeight+i)*.5,scaleX:1,scaleY:1,rad:0},{width:n.width,height:i}),b(y,{x:e.x,y:e.y-(o.gapHeight+i)*.5,scaleX:1,scaleY:1,rad:0},{width:n.width,height:i})}),y.fillText("Score: "+l.currentScore+"; Best: "+l.bestScore,0,10))}function T(s){let t=z/1e3;s.query({and:[h,S,C]}).forEach(e=>{let n=r.getComponent(e,h),o=r.getComponent(e,C),i=r.getComponent(e,S);o.x+=i.x*t,o.x*=f.hSpeedMult,o.y+=i.y*t,n.x+=o.x*t,n.y+=o.y*t})}function O(s){s.query({and:[k,S,C]}).forEach(t=>{let e=r.getComponent(t,S),n=r.getComponent(t,C);e.y=f.grav,(p.justPressed[" "]||w.justPressed)&&(e.y=-f.grav*20,n.x=n.y=0)})}function v(s){l.bestScore=parseInt(localStorage.getItem("best")||"0"),l.bestScore=l.currentScore>l.bestScore?l.currentScore:l.bestScore,l.currentScore=0,localStorage.setItem("best",l.bestScore.toString()),s.query({and:[k]}).forEach(t=>{B(t)}),s.query({and:[m]}).forEach(t=>{let e=r.getComponent(t,C);e.x=-f.pipe.baseSpeed,A(t)})}function F(s){s.query({and:[k,g,h]}).forEach(t=>{let e=r.getComponent(t,h),n=r.getComponent(t,g);e.y>d.height-n.height*.5&&v(s),s.query({and:[h,g,m]}).forEach(o=>{let i=r.getComponent(o,h),a=r.getComponent(o,g),u=r.getComponent(o,m);(e.x-i.x)**2<((n.width+a.width)*.5)**2&&(e.y-i.y)**2>((u.gapHeight-n.height)*.5)**2&&v(s),i.x+a.width*.5<0&&(A(o),l.currentScore++)})})}function q(s,t=""){s.setTransform(1,0,0,1,0,0);let e=s.fillStyle;s.fillStyle=t,s.fillRect(0,0,s.canvas.width,s.canvas.height),s.fillStyle=e}function R(s,t=0,e=0,n=0,o=10,i=10){let a=s.addEntity(),u=r.addComponent(a,h);u.x=t,u.y=e,u.rad=n;let M=r.addComponent(a,g);return M.width=o,M.height=i,r.addComponent(a,C),r.addComponent(a,S),a}function X(s){let t=R(s);return r.addComponent(t,k),t}function Y(s){let t=R(s),e=r.getComponent(t,g);return r.addComponent(t,m),e.width=f.pipe.width,e.height=f.pipe.height,t}function B(s){let t=r.getComponent(s,h),e=r.getComponent(s,C),n=r.getComponent(s,S);t.x=d.width*.15,t.y=d.height*.5,e.x=e.y=n.x=n.y=0}function A(s){let t=r.getComponent(s,h),e=r.getComponent(s,g),o=r.getComponent(s,m).gapHeight;t.y=Math.random()*(d.height-o)+o*.5,t.x=d.width+e.width*.5}document.onkeydown=s=>{!p.isDown[s.key]&&(p.justPressed[s.key]=!0),p.isDown[s.key]=!0};document.onkeyup=s=>{p.isDown[s.key]=!1,p.justReleased[s.key]=!0};globalThis.window.onresize=document.body.onload=()=>{innerWidth/innerHeight<d.width/d.height?(d.style.width="100%",d.style.height=""):(d.style.width="",d.style.height="100%")};document.onpointerdown=()=>{w.isDown=!0,w.justPressed=!0};document.onpointerup=()=>{w.isDown=!1,w.justReleased=!0};var j=new r,z=0,P=0;X(j);Y(j);v(j);(function s(){requestAnimationFrame(s),j.update(H,O,F,T),w.justReleased=!1,w.justPressed=!1;for(let t in p.justPressed)p.justPressed[t]=!1;for(let t in p.justReleased)p.justReleased[t]=!1;z=performance.now()-P,P+=z})();})();
//# sourceMappingURL=out.js.map
