(()=>{var S=class{storage=[];indices=new Map;objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(t){let s;return this.size<this.storage.length?s=this.storage[this.size]:(s=this.objectFactory(),this.storage.push(s)),this.indices.set(t,this.size),this.size++,s}removeObj(t){let s=this.indices.get(t)??-1;if(s<0||s>=this.size)return!1;let i=this.storage[s];this.storage[s]=this.storage[this.size-1],this.storage[this.size-1]=i;for(let[o,n]of this.indices)if(n==this.size-1){this.indices.set(o,s);break}return this.indices.delete(t),this.size--,!0}getObj(t){let s=this.indices.get(t)??-1;if(s<0||s>=this.size)throw new Error("Index out of range.");return this.storage[s]}};var c=class e{static pools=new Map;static idMap=new Map;static register(t){e.pools.has(t)||(e.idMap.set(t,e.idMap.size),e.pools.set(t,new S(()=>({...t}))))}static getId(t){return e.idMap.get(t)??-1}static add(t,s){return Object.assign(e.pools.get(s).addObj(t),s)}static delete(t,s){return e.pools.get(s).removeObj(t)}static get(t,s){return e.pools.get(s).getObj(t)}static len(t){return e.pools.get(t).len()}static typeLen(){return e.pools.size}static types(){return e.pools.keys().toArray()}};var r=class e{static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static entitiesToDelete=[];localEntities=new Set;constructor(){e.worlds.push(this)}static createEntity(){let t=Math.random();return e.maskMap.set(t,0),e.getArchetype(0).add(t),t}static copyEntity(t){let s=Math.random(),i=c.types(),o=this.maskMap.get(t)??0;e.maskMap.set(s,o),e.getArchetype(o).add(s);for(let n=0,a=i.length;n<a;n++)o&1<<n&&Object.assign(c.add(s,i[n]),c.get(t,i[n]));return s}static getArchetype(t){let s=e.archetypeMap.get(t)??new Set;return e.archetypeMap.set(t,s),s}static deleteEntity(t){e.entitiesToDelete.push(t)}addEntity(t=e.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}static registerComponent(t){return c.register(t),e}static hasComponent(t,s){return((e.maskMap.get(t)??0)&1<<c.getId(s))>0}static addComponent(t,s,i=s){e.registerComponent(s);let o=e.maskMap.get(t)??0,n=c.getId(s);return(o&1<<n)!=0?Object.assign(c.get(t,s),i):(e.getArchetype(o).delete(t),o|=1<<n,e.maskMap.set(t,o),e.getArchetype(o).add(t),Object.assign(c.add(t,s),i))}static removeComponent(t,s){e.registerComponent(s);let i=e.maskMap.get(t)??0,o=c.getId(s);return(i&1<<o)==0?!1:(e.getArchetype(i).delete(t),i&=~(1<<o),e.maskMap.set(t,i),e.getArchetype(i).add(t),c.delete(t,s))}static getComponent(t,s){return c.get(t,s)}update(...t){for(let s=0,i=t.length;s<i;s++)t[s](this);for(;e.entitiesToDelete.length;){let s=e.entitiesToDelete.pop();for(let n=0,a=e.worlds.length;n<a;n++)e.worlds[n].localEntities.delete(s);let i=c.types(),o=e.maskMap.get(s)??0;e.getArchetype(o).delete(s);for(let n=0,a=i.length;n<a;n++)o&1<<n&&c.delete(s,i[n])}}query(t){let s=0,i=0;if(t.and)for(let n=0,a=t.and.length;n<a;n++)s|=1<<c.getId(t.and[n]);if(t.not)for(let n=0,a=t.not.length;n<a;n++)i|=1<<c.getId(t.not[n]);let o=[];for(let n=e.archetypeMap.keys().toArray(),a=n.length,u=0;u<a;u++){let M=n[u],z=e.getArchetype(M);z.size!=0&&(M&s)==s&&(M&i)==0&&o.push(...z)}return[...this.localEntities.intersection(new Set(o))]}entityCount(){return this.localEntities.size}};var f={grav:981,hSpeedMult:1.001,pipe:{gapHeight:80,baseSpeed:100,width:30,height:1e3}};var d=document.createElement("canvas");if(!d)throw new Error("Cannot create canvas element.");d.style.imageRendering="pixelated";document.body.appendChild(d);var y=d.getContext("2d");if(!y)throw new Error("Cannot initialize 2d context.");var w={isDown:!1,justPressed:!1,justReleased:!1},p={isDown:{},justPressed:{},justReleased:{}},h={currentScore:0,bestScore:0},l={x:0,y:0,rad:0,scaleX:1,scaleY:1},g={width:10,height:10},C={x:0,y:0},j={x:0,y:0},b={},m={gapHeight:f.pipe.gapHeight};function x(e,t,s,i="white"){let o=Math.sin(t.rad),n=Math.cos(t.rad),a=e.fillStyle;e.transform(n,o,-o,n,t.x,t.y),e.fillStyle=i,e.fillRect(-s.width*.5,-s.height*.5,s.width*t.scaleX,s.height*t.scaleY),e.fillStyle=a,e.transform(n,-o,o,n,n*-t.x+o*-t.y,-o*-t.x+n*-t.y)}function R(e){y&&(F(y,"green"),e.query({and:[l,g],not:[m]}).forEach(t=>{let s=r.getComponent(t,l),i=r.getComponent(t,g);x(y,s,i)}),e.query({and:[l,g,m]}).forEach(t=>{let s=r.getComponent(t,l),i=r.getComponent(t,g),o=r.getComponent(t,m),n=(i.height-o.gapHeight)*.5;x(y,{x:s.x,y:s.y+(o.gapHeight+n)*.5,scaleX:1,scaleY:1,rad:0},{width:i.width,height:n}),x(y,{x:s.x,y:s.y-(o.gapHeight+n)*.5,scaleX:1,scaleY:1,rad:0},{width:i.width,height:n})}),y.fillText("Score: "+h.currentScore+"; Best: "+h.bestScore,0,10))}function D(e){let t=v/1e3;e.query({and:[l,j,C]}).forEach(s=>{let i=r.getComponent(s,l),o=r.getComponent(s,C),n=r.getComponent(s,j);o.x+=n.x*t,o.x*=f.hSpeedMult,o.y+=n.y*t,i.x+=o.x*t,i.y+=o.y*t})}function H(e){e.query({and:[b,j,C]}).forEach(t=>{let s=r.getComponent(t,j),i=r.getComponent(t,C);s.y=f.grav,(p.justPressed[" "]||w.justPressed)&&(s.y=-f.grav*20,i.x=i.y=0)})}function E(e){h.bestScore=parseInt(localStorage.getItem("best")||"0"),h.bestScore=h.currentScore>h.bestScore?h.currentScore:h.bestScore,h.currentScore=0,localStorage.setItem("best",h.bestScore.toString()),e.query({and:[b]}).forEach(t=>{Y(t)}),e.query({and:[m]}).forEach(t=>{let s=r.getComponent(t,C);s.x=-f.pipe.baseSpeed,O(t)})}function T(e){e.query({and:[b,g,l]}).forEach(t=>{let s=r.getComponent(t,l),i=r.getComponent(t,g);s.y>d.height-i.height*.5&&E(e),e.query({and:[l,g,m]}).forEach(o=>{let n=r.getComponent(o,l),a=r.getComponent(o,g),u=r.getComponent(o,m);(s.x-n.x)**2<((i.width+a.width)*.5)**2&&(s.y-n.y)**2>((u.gapHeight-i.height)*.5)**2&&E(e),n.x+a.width*.5<0&&(O(o),h.currentScore++)})})}function F(e,t=""){e.setTransform(1,0,0,1,0,0);let s=e.fillStyle;e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=s}function I(e,t=0,s=0,i=0,o=10,n=10){let a=e.addEntity(),u=r.addComponent(a,l);u.x=t,u.y=s,u.rad=i;let M=r.addComponent(a,g);return M.width=o,M.height=n,r.addComponent(a,C),r.addComponent(a,j),a}function q(e){let t=I(e);return r.addComponent(t,b),t}function X(e){let t=I(e),s=r.getComponent(t,g);return r.addComponent(t,m),s.width=f.pipe.width,s.height=f.pipe.height,t}function Y(e){let t=r.getComponent(e,l),s=r.getComponent(e,C),i=r.getComponent(e,j);t.x=d.width*.15,t.y=d.height*.5,s.x=s.y=i.x=i.y=0}function O(e){let t=r.getComponent(e,l),s=r.getComponent(e,g),o=r.getComponent(e,m).gapHeight;t.y=Math.random()*(d.height-o)+o*.5,t.x=d.width+s.width*.5}document.onkeydown=e=>{!p.isDown[e.key]&&(p.justPressed[e.key]=!0),p.isDown[e.key]=!0};document.onkeyup=e=>{p.isDown[e.key]=!1,p.justReleased[e.key]=!0};globalThis.window.onresize=document.body.onload=()=>{innerWidth/innerHeight<d.width/d.height?(d.style.width="100%",d.style.height=""):(d.style.width="",d.style.height="100%")};document.onpointerdown=()=>{w.isDown=!0,w.justPressed=!0};document.onpointerup=()=>{w.isDown=!1,w.justReleased=!0};var k=new r,v=0,A=0;q(k);X(k);E(k);(function e(){requestAnimationFrame(e),k.update(R,H,T,D),w.justReleased=!1,w.justPressed=!1;for(let t in p.justPressed)p.justPressed[t]=!1;for(let t in p.justReleased)p.justReleased[t]=!1;v=performance.now()-A,A+=v})();})();
//# sourceMappingURL=out.js.map
