(()=>{var x=class{storage=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(){let t;return this.size<this.storage.length?t=this.storage[this.size]:(t=this.objectFactory(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(n=>n==t)}removeObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");let n=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=n,this.size--,n}getObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var d=class e{static pools=new Map;static idMap=new Map;static register(t){e.idMap.set(t,e.idMap.size),e.pools.set(t,new x(()=>({...t})))}static getId(t){return e.idMap.get(t)??-1}static add(t){return Object.assign(e.pools.get(t).addObj(),t)}static delete(t,n){return e.pools.get(t).removeObj(n)}static get(t,n){return e.pools.get(t).getObj(n)}static len(t){return e.pools.get(t).len()}static typeLen(){return e.pools.size}static types(){return e.pools.keys().toArray()}};var j=class e{static nextId=0;static pool=new x(()=>e.nextId++);static add(){return e.pool.addObj()}static findIndex(t){return e.pool.findIndex(t)}static delete(t){return e.pool.removeObj(t)}};var i=class e{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];localEntities=new Set;timeMilli=0;dtMilli=0;constructor(){e.worlds.push(this)}static createEntity(){let t=j.add();return e.maskMap.set(t,0),e.getArchetype(0).add(t),t}static getArchetype(t){let n=e.archetypeMap.get(t)??new Set;return e.archetypeMap.set(t,n),n}static deleteEntity(t){for(let o=0,s=e.worlds.length;o<s;o++)e.worlds[o].removeEntity(t);let n=d.types(),r=e.maskMap.get(t);for(let o=0,s=n.length;o<s;o++)r&1<<o&&e.removeComponent(t,n[o]);j.delete(j.findIndex(t))}addEntity(t=e.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static registerComponent(t){return e.indexMap.has(t)||(d.register(t),e.indexMap.set(t,new Map)),e}static hasComponent(t,n){return!!(e.maskMap.get(t)&1<<d.getId(n))}static addComponent(t,n,r={}){e.registerComponent(n);let o=e.maskMap.get(t),s=d.getId(n);if((o&1<<s)!=0)throw new Error(`Entity ${t} already had that component.`);e.getArchetype(o).delete(t),o|=1<<s,e.maskMap.set(t,o),e.getArchetype(o).add(t);let a=d.len(n);return e.indexMap.get(n).set(t,a),Object.assign(d.add(n),r)}static removeComponent(t,n){e.registerComponent(n);let r=e.maskMap.get(t),o=d.getId(n);if((r&1<<o)==0)throw new Error(`Entity ${t} does not have that component.`);e.getArchetype(r).delete(t),r&=~(1<<o),e.maskMap.set(t,r),e.getArchetype(r).add(t);let s=e.indexMap.get(n),a=s.get(t),p=d.delete(n,a),m=s.keys().toArray().at(-1)??-1;return s.set(m,a),s.delete(t),p}static getComponent(t,n){return d.get(n,e.indexMap.get(n).get(t))}update(...t){for(let n=0,r=t.length;n<r;n++)t[n](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let n=0,r=0;if(t.and)for(let s=0,a=t.and.length;s<a;s++)n|=1<<d.getId(t.and[s]);if(t.not)for(let s=0,a=t.not.length;s<a;s++)r|=1<<d.getId(t.not[s]);let o=[];for(let s=e.archetypeMap.keys().toArray(),a=s.length,p=0;p<a;p++){let m=s[p],k=e.getArchetype(m);k.size!=0&&(m&n)==n&&(m&r)==0&&o.push(...k)}return[...this.localEntities.intersection(new Set(o))]}entityCount(){return this.localEntities.size}};var y={grav:981,hSpeedMult:1.001,pipe:{gapHeight:80,baseSpeed:100,width:30,height:1e3}};var c=document.createElement("canvas");if(!c)throw new Error("Cannot create canvas element.");c.style.imageRendering="pixelated";document.body.appendChild(c);var b=c.getContext("2d");if(!b)throw new Error("Cannot initialize 2d context.");var T={isDown:!1,justPressed:!1,justReleased:!1},u={isDown:{},justPressed:{},justReleased:{}},h={currentScore:0,bestScore:0},l={x:0,y:0,rad:0,scaleX:1,scaleY:1},g={width:10,height:10},w={x:0,y:0},M={x:0,y:0},C={},f={gapHeight:y.pipe.gapHeight};function S(e,t,n,r="white"){let o=Math.sin(t.rad),s=Math.cos(t.rad),a=e.fillStyle;e.transform(s,o,-o,s,t.x,t.y),e.fillStyle=r,e.fillRect(-n.width*.5,-n.height*.5,n.width*t.scaleX,n.height*t.scaleY),e.fillStyle=a,e.transform(s,-o,o,s,s*-t.x+o*-t.y,-o*-t.x+s*-t.y)}function O(e){b&&(D(b,"green"),e.query({and:[l,g],not:[f]}).forEach(t=>{let n=i.getComponent(t,l),r=i.getComponent(t,g);S(b,n,r)}),e.query({and:[l,g,f]}).forEach(t=>{let n=i.getComponent(t,l),r=i.getComponent(t,g),o=i.getComponent(t,f),s=(r.height-o.gapHeight)*.5;S(b,{x:n.x,y:n.y+(o.gapHeight+s)*.5,scaleX:1,scaleY:1,rad:0},{width:r.width,height:s}),S(b,{x:n.x,y:n.y-(o.gapHeight+s)*.5,scaleX:1,scaleY:1,rad:0},{width:r.width,height:s})}),b.fillText("Score: "+h.currentScore+"; Best: "+h.bestScore,0,10))}function z(e){let t=e.dtMilli/1e3;e.query({and:[l,M,w]}).forEach(n=>{let r=i.getComponent(n,l),o=i.getComponent(n,w),s=i.getComponent(n,M);o.x+=s.x*t,o.x*=y.hSpeedMult,o.y+=s.y*t,r.x+=o.x*t,r.y+=o.y*t})}function A(e){e.query({and:[C,M,w]}).forEach(t=>{let n=i.getComponent(t,M),r=i.getComponent(t,w);n.y=y.grav,(u.justPressed[" "]||T.justPressed)&&(n.y=-y.grav*20,r.x=r.y=0)})}function E(e){h.bestScore=parseInt(localStorage.getItem("best")||"0"),h.bestScore=h.currentScore>h.bestScore?h.currentScore:h.bestScore,h.currentScore=0,localStorage.setItem("best",h.bestScore.toString()),e.query({and:[C]}).forEach(t=>{F(t)}),e.query({and:[f]}).forEach(t=>{let n=i.getComponent(t,w);n.x=-y.pipe.baseSpeed,P(t)})}function W(e){e.query({and:[C,g,l]}).forEach(t=>{let n=i.getComponent(t,l),r=i.getComponent(t,g);n.y>c.height-r.height*.5&&E(e),e.query({and:[l,g,f]}).forEach(o=>{let s=i.getComponent(o,l),a=i.getComponent(o,g),p=i.getComponent(o,f);(n.x-s.x)**2<((r.width+a.width)*.5)**2&&(n.y-s.y)**2>((p.gapHeight-r.height)*.5)**2&&E(e),s.x+a.width*.5<0&&(P(o),h.currentScore++)})})}function D(e,t=""){e.setTransform(1,0,0,1,0,0);let n=e.fillStyle;e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=n}function I(e,t=0,n=0,r=0,o=10,s=10){let a=e.addEntity(),p=i.addComponent(a,l);p.x=t,p.y=n,p.rad=r;let m=i.addComponent(a,g);return m.width=o,m.height=s,i.addComponent(a,w),i.addComponent(a,M),a}function H(e){let t=I(e);return i.addComponent(t,C),t}function q(e){let t=I(e),n=i.getComponent(t,g);return i.addComponent(t,f),n.width=y.pipe.width,n.height=y.pipe.height,t}function F(e){let t=i.getComponent(e,l),n=i.getComponent(e,w),r=i.getComponent(e,M);t.x=c.width*.15,t.y=c.height*.5,n.x=n.y=r.x=r.y=0}function P(e){let t=i.getComponent(e,l),n=i.getComponent(e,g),o=i.getComponent(e,f).gapHeight;t.y=Math.random()*(c.height-o)+o*.5,t.x=c.width+n.width*.5}document.onkeydown=e=>{!u.isDown[e.key]&&(u.justPressed[e.key]=!0),u.isDown[e.key]=!0};document.onkeyup=e=>{u.isDown[e.key]=!1,u.justReleased[e.key]=!0};globalThis.window.onresize=document.body.onload=()=>{innerWidth/innerHeight<c.width/c.height?(c.style.width="100%",c.style.height=""):(c.style.width="",c.style.height="100%")};document.onpointerdown=()=>{T.isDown=!0,T.justPressed=!0};document.onpointerup=()=>{T.isDown=!1,T.justReleased=!0};var v=new i;H(v);q(v);E(v);(function e(){requestAnimationFrame(e),v.update(O,A,W,z),T.justReleased=!1,T.justPressed=!1;for(let t in u.justPressed)u.justPressed[t]=!1;for(let t in u.justReleased)u.justReleased[t]=!1})();})();
//# sourceMappingURL=out.js.map
