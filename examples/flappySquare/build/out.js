(()=>{var C=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(e){this.objectFactory=e}size(){return this.indexToKey.length}add(e){return this.keyToIndex.has(e)||(this.storage.length<=this.indexToKey.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(e,this.indexToKey.length),this.indexToKey[this.indexToKey.length]=e),this.storage[this.keyToIndex.get(e)]}remove(e){let t=this.keyToIndex.get(e),s=this.indexToKey[this.indexToKey.length-1];if(t==null||s==null)return;let o=this.storage[this.indexToKey.length-1];this.storage[this.indexToKey.length-1]=this.storage[t],this.storage[t]=o,this.indexToKey[t]=s,this.keyToIndex.set(s,t),this.indexToKey.pop(),this.keyToIndex.delete(e)}get(e){let t=this.keyToIndex.get(e);if(t==null)throw new Error("Key not found");return this.storage[t]}has(e){return this.keyToIndex.has(e)}clean(){this.storage.splice(this.indexToKey.length)}};var k=class{pools=new Map;idMap=new Map;register(e){this.pools.has(e)||(this.idMap.set(e,this.idMap.size),this.pools.set(e,new C(()=>({...e}))))}getId(e){return this.idMap.get(e)??-1}add(e,t){return Object.assign(this.pools.get(t).add(e),t)}remove(e,t){this.pools.get(t).remove(e)}get(e,t){return this.pools.get(t).get(e)}size(e){return this.pools.get(e).size()}delete(e){for(let t of this.pools)t[1].remove(e)}copy(e,t){for(let s of this.pools)s[1].has(e)&&Object.assign(s[1].add(t),s[1].get(e))}clean(){for(let e of this.pools)e[1].clean()}};function w(){return Math.random()}var T=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new k;addEntity(e=w()){return this.maskMap.set(e,0),this.getArchetype(0).add(e),e}copyEntity(e,t=w()){this.compManager.copy(e,t);let s=this.maskMap.get(e)??0;return this.maskMap.set(t,s),this.getArchetype(s).add(t),t}getArchetype(e){let t=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,t),t}deleteEntity(e){this.entitiesToDelete.push(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,t){return((this.maskMap.get(e)??0)&1<<this.compManager.getId(t))>0}addComponent(e,t,s=t){this.registerComponent(t);let o=this.maskMap.get(e)??0,i=this.compManager.getId(t);return(o&1<<i)!=0?Object.assign(this.compManager.get(e,t),s):(this.getArchetype(o).delete(e),o|=1<<i,this.maskMap.set(e,o),this.getArchetype(o).add(e),Object.assign(this.compManager.add(e,t),s))}removeComponent(e,t){this.registerComponent(t);let s=this.maskMap.get(e)??0,o=this.compManager.getId(t);(s&1<<o)!=0&&(this.getArchetype(s).delete(e),s&=~(1<<o),this.maskMap.set(e,s),this.getArchetype(s).add(e),this.compManager.remove(e,t))}getComponent(e,t){return this.compManager.get(e,t)}update(...e){for(let t=0,s=e.length;t<s;t++)e[t](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let e=this.entitiesToDelete.pop();this.compManager.delete(e);let t=this.maskMap.get(e)??0;this.maskMap.delete(e),this.getArchetype(t).delete(e)}}cleanObjectPools(){this.compManager.clean()}query(e){let t=0,s=0;if(e.and)for(let i=0,r=e.and.length;i<r;i++)t|=1<<this.compManager.getId(e.and[i]);if(e.not)for(let i=0,r=e.not.length;i<r;i++)s|=1<<this.compManager.getId(e.not[i]);let o=[];for(let i of this.archetypeMap)i[1].size>0&&(i[0]&t)==t&&(i[0]&s)==0&&o.push(...i[1]);return o}entityCount(){return this.maskMap.size}};var l={grav:981,hSpeedMult:1.001,pipe:{gapHeight:80,baseSpeed:100,width:30,height:1e3}};var a=document.createElement("canvas");if(!a)throw new Error("Cannot create canvas element.");a.style.imageRendering="pixelated";document.body.appendChild(a);var u=a.getContext("2d");if(!u)throw new Error("Cannot initialize 2d context.");var y={isDown:!1,justPressed:!1,justReleased:!1},g={isDown:{},justPressed:{},justReleased:{}},c={currentScore:0,bestScore:0},h={x:0,y:0,rad:0,scaleX:1,scaleY:1},d={width:10,height:10},f={x:0,y:0},M={x:0,y:0},S={},m={gapHeight:l.pipe.gapHeight};function j(n,e,t,s="white"){let o=Math.sin(e.rad),i=Math.cos(e.rad),r=n.fillStyle;n.transform(i,o,-o,i,e.x,e.y),n.fillStyle=s,n.fillRect(-t.width*.5,-t.height*.5,t.width*e.scaleX,t.height*e.scaleY),n.fillStyle=r,n.transform(i,-o,o,i,i*-e.x+o*-e.y,-o*-e.x+i*-e.y)}function R(n){u&&(O(u,"green"),n.query({and:[h,d],not:[m]}).forEach(e=>{let t=n.getComponent(e,h),s=n.getComponent(e,d);j(u,t,s)}),n.query({and:[h,d,m]}).forEach(e=>{let t=n.getComponent(e,h),s=n.getComponent(e,d),o=n.getComponent(e,m),i=(s.height-o.gapHeight)*.5;j(u,{x:t.x,y:t.y+(o.gapHeight+i)*.5,scaleX:1,scaleY:1,rad:0},{width:s.width,height:i}),j(u,{x:t.x,y:t.y-(o.gapHeight+i)*.5,scaleX:1,scaleY:1,rad:0},{width:s.width,height:i})}),u.fillText("Score: "+c.currentScore+"; Best: "+c.bestScore,0,10))}function A(n){let e=I/1e3;n.query({and:[h,M,f]}).forEach(t=>{let s=n.getComponent(t,h),o=n.getComponent(t,f),i=n.getComponent(t,M);o.x+=i.x*e,o.x*=l.hSpeedMult,o.y+=i.y*e,s.x+=o.x*e,s.y+=o.y*e})}function H(n){n.query({and:[S,M,f]}).forEach(e=>{let t=n.getComponent(e,M),s=n.getComponent(e,f);t.y=l.grav,(g.justPressed[" "]||y.justPressed)&&(t.y=-l.grav*20,s.x=s.y=0)})}function b(n){c.bestScore=parseInt(localStorage.getItem("best")||"0"),c.bestScore=c.currentScore>c.bestScore?c.currentScore:c.bestScore,c.currentScore=0,localStorage.setItem("best",c.bestScore.toString()),n.query({and:[S]}).forEach(e=>{X(e)}),n.query({and:[m]}).forEach(e=>{let t=n.getComponent(e,f);t.x=-l.pipe.baseSpeed,D(e)})}function z(n){n.query({and:[S,d,h]}).forEach(e=>{let t=n.getComponent(e,h),s=n.getComponent(e,d);t.y>a.height-s.height*.5&&b(n),n.query({and:[h,d,m]}).forEach(o=>{let i=n.getComponent(o,h),r=n.getComponent(o,d),x=n.getComponent(o,m);(t.x-i.x)**2<((s.width+r.width)*.5)**2&&(t.y-i.y)**2>((x.gapHeight-s.height)*.5)**2&&b(n),i.x+r.width*.5<0&&(D(o),c.currentScore++)})})}function O(n,e=""){n.setTransform(1,0,0,1,0,0);let t=n.fillStyle;n.fillStyle=e,n.fillRect(0,0,n.canvas.width,n.canvas.height),n.fillStyle=t}function K(n,e=0,t=0,s=0,o=10,i=10){let r=n.addEntity(),x=n.addComponent(r,h);x.x=e,x.y=t,x.rad=s;let E=n.addComponent(r,d);return E.width=o,E.height=i,n.addComponent(r,f),n.addComponent(r,M),r}function F(n){let e=K(n);return n.addComponent(e,S),e}function q(n){let e=K(n),t=n.getComponent(e,d);return n.addComponent(e,m),t.width=l.pipe.width,t.height=l.pipe.height,e}function X(n){let e=p.getComponent(n,h),t=p.getComponent(n,f),s=p.getComponent(n,M);e.x=a.width*.15,e.y=a.height*.5,t.x=t.y=s.x=s.y=0}function D(n){let e=p.getComponent(n,h),t=p.getComponent(n,d),o=p.getComponent(n,m).gapHeight;e.y=Math.random()*(a.height-o)+o*.5,e.x=a.width+t.width*.5}document.onkeydown=n=>{!g.isDown[n.key]&&(g.justPressed[n.key]=!0),g.isDown[n.key]=!0};document.onkeyup=n=>{g.isDown[n.key]=!1,g.justReleased[n.key]=!0};globalThis.window.onresize=document.body.onload=()=>{innerWidth/innerHeight<a.width/a.height?(a.style.width="100%",a.style.height=""):(a.style.width="",a.style.height="100%")};document.onpointerdown=()=>{y.isDown=!0,y.justPressed=!0};document.onpointerup=()=>{y.isDown=!1,y.justReleased=!0};var p=new T,I=0,v=0;F(p);q(p);b(p);(function n(){requestAnimationFrame(n),p.update(R,H,z,A),y.justReleased=!1,y.justPressed=!1;for(let e in g.justPressed)g.justPressed[e]=!1;for(let e in g.justReleased)g.justReleased[e]=!1;I=performance.now()-v,v+=I})();})();
//# sourceMappingURL=out.js.map
