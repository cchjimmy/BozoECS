(()=>{var M=class{storage=[];objectConstructor;size=0;constructor(e){this.objectConstructor=e}len(){return this.size}addObj(){let e;return this.storage[this.size]?e=this.storage[this.size]:(e=this.objectConstructor(),this.storage.push(e)),this.size++,e}findIndex(e){return this.storage.findIndex(n=>n==e)}removeObj(e){if(e>=this.size)throw new Error("Index out of range.");let n=this.storage[e];return this.storage[e]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=n,this.size--,n}getObj(e){if(e>=this.size)throw new Error("Index out of range.");return this.storage[e]}};var c=class t{static pools=new Map;static idMap=new Map;static register(e){t.idMap.set(e,t.idMap.size),t.pools.set(e,new M(()=>({...e})))}static getId(e){return t.idMap.get(e)??-1}static add(e){return t.pools.get(e).addObj()}static delete(e,n){return t.pools.get(e).removeObj(n)}static get(e,n){return t.pools.get(e).getObj(n)}static len(e){return t.pools.get(e).len()}static typeLen(){return t.pools.size}static types(){return t.pools.keys().toArray()}};var j=class t{static nextId=0;static pool=new M(()=>t.nextId++);static add(){return t.pool.addObj()}static findIndex(e){return t.pool.findIndex(e)}static delete(e){return t.pool.removeObj(e)}};var i=class t{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static removeMap=new Map;static ownerMap=new Map;timeMilli=0;dtMilli=0;localEntities=new Set;constructor(){t.worlds.push(this)}static createEntity(){let e=j.add();return t.maskMap.set(e,0),t.getArchetype(0).add(e),e}static getArchetype(e){let n=t.archetypeMap.get(e);if(n==null){let o=new Set;return t.archetypeMap.set(e,o),o}return n}static deleteEntity(e){for(let o=0,r=t.worlds.length;o<r;o++)t.worlds[o].removeEntity(e);let n=c.types();for(let o=0,r=c.typeLen();o<r;o++){if(!(t.getMask(e)&1<<o))continue;t.getRemoveFn(o)(e);let a=t.getIndices(n[o]),s=t.getOwners(n[o]),d=t.getOwner(s,s.size-1),g=t.getIndex(a,e);s.set(g,d),a.set(d,g)}t.getArchetype(t.getMask(e)).delete(e),t.maskMap.set(e,0),j.delete(j.findIndex(e))}static getRemoveFn(e){let n=t.removeMap.get(e);if(n==null)throw new Error("Component not registered.");return n}addEntity(e){return e??=t.createEntity(),this.localEntities.add(e),e}removeEntity(e){this.localEntities.delete(e)}entityExists(e){return this.localEntities.has(e)}static componentExists(e){t.indexMap.has(e)||t.registerComponent(e)}static registerComponent(e){return c.register(e),t.indexMap.set(e,new Map),t.removeMap.set(c.getId(e),n=>c.delete(e,t.getIndex(t.getIndices(e),n))),t.ownerMap.set(e,new Map),t}static hasComponent(e,n){return(t.getMask(e)&1<<c.getId(n))>0}static addComponent(e,n){t.componentExists(n);let o=t.getMask(e),r=c.getId(n);if((o&1<<r)!=0)throw new Error(`Entity ${e} already had that component.`);t.getArchetype(o).delete(e),o|=1<<r,t.maskMap.set(e,o),t.getArchetype(o).add(e);let a=c.len(n);return t.getIndices(n).set(e,a),t.getOwners(n).set(a,e),c.add(n)}static getIndices(e){let n=t.indexMap.get(e);if(n==null)throw new Error("Component not registered.");return n}static getIndex(e,n){let o=e.get(n);if(o==null)throw new Error(`Entity ${n} does not exist.`);return o}static getOwners(e){let n=t.ownerMap.get(e);if(n==null)throw new Error("Component not registered.");return n}static getOwner(e,n){let o=e.get(n);if(o==null)throw new Error("Owner not found.");return o}static removeComponent(e,n){t.componentExists(n);let o=t.getMask(e),r=c.getId(n);if((o&1<<r)==0)throw new Error(`Entity ${e} does not have that component.`);t.getArchetype(o).delete(e),o&=~(1<<r),t.maskMap.set(e,o),t.getArchetype(o).add(e);let a=t.getIndices(n),s=t.getOwners(n),d=t.getIndex(a,e),g=c.delete(n,d),y=t.getOwner(s,s.size-1);return s.set(d,y),a.set(y,d),g}static getMask(e){return t.maskMap.get(e)??-1}static getComponent(e,n){if(!t.hasComponent(e,n))throw new Error(`Entity ${e} does not have that component.`);return c.get(n,t.getIndex(t.getIndices(n),e))}update(...e){for(let n=0,o=e.length;n<o;n++)e[n](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(e){let n=0,o=0,r=0;if(e.and)for(let s=0,d=e.and.length;s<d;s++)n|=1<<c.getId(e.and[s]);if(e.or)for(let s=0,d=e.or.length;s<d;s++)o|=1<<c.getId(e.or[s]);if(e.not)for(let s=0,d=e.not.length;s<d;s++)r|=1<<c.getId(e.not[s]);let a=[];for(let s=t.archetypeMap.keys().toArray(),d=s.length,g=0,y=s[g];g<d;g++,y=s[g])(y&n)==n&&(y|o)>0&&(y&r)==0&&a.push(...this.localEntities.intersection(t.getArchetype(y)));return a}entityCount(){return this.localEntities.size}};var f={grav:981,hSpeedMult:1.001,pipe:{gapHeight:80,baseSpeed:100,width:30,height:1e3}};var l=document.createElement("canvas");if(!l)throw new Error("Cannot create canvas element.");l.style.imageRendering="pixelated";document.body.appendChild(l);var b=l.getContext("2d");if(!b)throw new Error("Cannot initialize 2d context.");var T={isDown:!1,justPressed:!1,justReleased:!1},m={isDown:{},justPressed:{},justReleased:{}},h={currentScore:0,bestScore:0},p={x:0,y:0,rad:0,scaleX:1,scaleY:1},u={width:10,height:10},x={x:0,y:0},C={x:0,y:0},v={},w={gapHeight:f.pipe.gapHeight};function I(t,e,n,o="white"){let r=Math.sin(e.rad),a=Math.cos(e.rad),s=t.fillStyle;t.transform(a,r,-r,a,e.x,e.y),t.fillStyle=o,t.fillRect(-n.width*.5,-n.height*.5,n.width*e.scaleX,n.height*e.scaleY),t.fillStyle=s,t.transform(a,-r,r,a,a*-e.x+r*-e.y,-r*-e.x+a*-e.y)}function P(t){b&&(D(b,"green"),t.query({and:[p,u],not:[w]}).forEach(e=>{let n=i.getComponent(e,p),o=i.getComponent(e,u);I(b,n,o)}),t.query({and:[p,u,w]}).forEach(e=>{let n=i.getComponent(e,p),o=i.getComponent(e,u),r=i.getComponent(e,w),a=(o.height-r.gapHeight)*.5;I(b,{x:n.x,y:n.y+(r.gapHeight+a)*.5,scaleX:1,scaleY:1,rad:0},{width:o.width,height:a}),I(b,{x:n.x,y:n.y-(r.gapHeight+a)*.5,scaleX:1,scaleY:1,rad:0},{width:o.width,height:a})}),b.fillText("Score: "+h.currentScore+"; Best: "+h.bestScore,0,10))}function z(t){let e=t.dtMilli/1e3;t.query({and:[p,C,x]}).forEach(n=>{let o=i.getComponent(n,p),r=i.getComponent(n,x),a=i.getComponent(n,C);r.x+=a.x*e,r.x*=f.hSpeedMult,r.y+=a.y*e,o.x+=r.x*e,o.y+=r.y*e})}function A(t){t.query({and:[v,C,x]}).forEach(e=>{let n=i.getComponent(e,C),o=i.getComponent(e,x);n.y=f.grav,(m.justPressed[" "]||T.justPressed)&&(n.y=-f.grav*20,o.x=o.y=0)})}function S(t){h.bestScore=parseInt(localStorage.getItem("best")||"0"),h.bestScore=h.currentScore>h.bestScore?h.currentScore:h.bestScore,h.currentScore=0,localStorage.setItem("best",h.bestScore.toString()),t.query({and:[v]}).forEach(e=>{q(e)}),t.query({and:[w]}).forEach(e=>{let n=i.getComponent(e,x);n.x=-f.pipe.baseSpeed,O(e)})}function W(t){t.query({and:[v,u,p]}).forEach(e=>{let n=i.getComponent(e,p),o=i.getComponent(e,u);n.y>l.height-o.height*.5&&S(t),t.query({and:[p,u,w]}).forEach(r=>{let a=i.getComponent(r,p),s=i.getComponent(r,u),d=i.getComponent(r,w);(n.x-a.x)**2<((o.width+s.width)*.5)**2&&(n.y-a.y)**2>((d.gapHeight-o.height)*.5)**2&&S(t),a.x+s.width*.5<0&&(O(r),h.currentScore++)})})}function D(t,e=""){t.setTransform(1,0,0,1,0,0);let n=t.fillStyle;t.fillStyle=e,t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle=n}function k(t,e=0,n=0,o=0,r=10,a=10){let s=t.addEntity(),d=i.addComponent(s,p);d.x=e,d.y=n,d.rad=o;let g=i.addComponent(s,u);return g.width=r,g.height=a,i.addComponent(s,x),i.addComponent(s,C),s}function H(t){let e=k(t);return i.addComponent(e,v),e}function F(t){let e=k(t),n=i.getComponent(e,u);return i.addComponent(e,w),n.width=f.pipe.width,n.height=f.pipe.height,e}function q(t){let e=i.getComponent(t,p),n=i.getComponent(t,x),o=i.getComponent(t,C);e.x=l.width*.15,e.y=l.height*.5,n.x=n.y=o.x=o.y=0}function O(t){let e=i.getComponent(t,p),n=i.getComponent(t,u),r=i.getComponent(t,w).gapHeight;e.y=Math.random()*(l.height-r)+r*.5,e.x=l.width+n.width*.5}document.onkeydown=t=>{!m.isDown[t.key]&&(m.justPressed[t.key]=!0),m.isDown[t.key]=!0};document.onkeyup=t=>{m.isDown[t.key]=!1,m.justReleased[t.key]=!0};globalThis.window.onresize=document.body.onload=()=>{innerWidth/innerHeight<l.width/l.height?(l.style.width="100%",l.style.height=""):(l.style.width="",l.style.height="100%")};document.onpointerdown=()=>{T.isDown=!0,T.justPressed=!0};document.onpointerup=()=>{T.isDown=!1,T.justReleased=!0};var E=new i;H(E);F(E);S(E);(function t(){requestAnimationFrame(t),E.update(P,A,W,z),T.justReleased=!1,T.justPressed=!1;for(let e in m.justPressed)m.justPressed[e]=!1;for(let e in m.justReleased)m.justReleased[e]=!1})();})();
//# sourceMappingURL=out.js.map
