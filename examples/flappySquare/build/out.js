(()=>{var k=class{storage=new Map;freeKeys=new Set;count=0;objectFactory;constructor(e){this.objectFactory=e}size(){return this.count}add(e){if(this.has(e))return this.storage.get(e);let t,n;if(this.freeKeys.has(e))n=e;else for(let o of this.freeKeys){n=o;break}return n!=null&&(this.freeKeys.delete(n),t=this.storage.get(n),this.storage.delete(n)),t=t??this.objectFactory(),this.storage.set(e,t),this.count++,t}remove(e){this.has(e)&&(this.freeKeys.add(e),this.count--)}get(e){let t=this.storage.get(e);if(t==null)throw new Error("Key not found.");return t}has(e){return this.storage.has(e)&&!this.freeKeys.has(e)}clean(){for(let e of this.freeKeys)this.storage.delete(e);this.freeKeys.clear()}};var C=class{poolMap=new Map;maskMap=new Map;register(e){this.poolMap.has(e)||(this.maskMap.set(e,1<<this.maskMap.size),this.poolMap.set(e,new k(()=>({...e}))))}getMask(e){return this.maskMap.get(e)??-1}add(e,t){return Object.assign(this.poolMap.get(t).add(e),t)}remove(e,t){this.poolMap.get(t).remove(e)}has(e,t){return this.poolMap.has(t)&&this.poolMap.get(t).has(e)}get(e,t){return this.poolMap.get(t).get(e)}size(e){return this.poolMap.get(e).size()}delete(e){for(let t of this.poolMap.entries())t[1].remove(e)}copy(e,t){for(let n of this.poolMap.entries())n[1].has(e)&&Object.assign(n[1].add(t),n[1].get(e))}clean(){for(let e of this.poolMap.entries())e[1].clean()}};function b(){return Math.random()}var w=class{maskMap=new Map;archetypeMap=new Map;compManager=new C;addEntity(e=b()){return this.maskMap.has(e)||this.maskMap.set(e,0),e}copyEntity(e,t=b()){this.compManager.copy(e,t);let n=this.maskMap.get(e)??0;return this.maskMap.set(t,n),this.getArchetype(n).add(t),t}getArchetype(e){let t=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,t),t}deleteEntity(e){this.compManager.delete(e),this.getArchetype(this.maskMap.get(e)??0).delete(e),this.maskMap.delete(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,t){return this.compManager.has(e,t)}addComponent(e,t,n=t){this.compManager.register(t);let o=this.maskMap.get(e)??0,a=this.compManager.getMask(t);return o&a?Object.assign(this.compManager.get(e,t),n):(this.getArchetype(o).delete(e),o^=a,this.maskMap.set(e,o),this.getArchetype(o).add(e),Object.assign(this.compManager.add(e,t),n))}removeComponent(e,t){this.compManager.register(t);let n=this.maskMap.get(e)??0,o=this.compManager.getMask(t);n&o^o||(this.compManager.remove(e,t),this.getArchetype(n).delete(e),n^=o,this.maskMap.set(e,n),this.getArchetype(n).add(e))}getComponent(e,t){return this.compManager.get(e,t)}update(...e){for(let t=0,n=e.length;t<n;t++)e[t](this)}cleanObjectPools(){this.compManager.clean()}query(e){let t=0,n=0;if(e.and)for(let a=0,r=e.and.length;a<r;a++)t|=this.compManager.getMask(e.and[a]);if(e.not)for(let a=0,r=e.not.length;a<r;a++)n|=this.compManager.getMask(e.not[a]);let o=[];for(let a of this.archetypeMap.entries())a[1].size>0&&(a[0]&t)==t&&(a[0]&n)==0&&o.push(...a[1]);return o}entityCount(){return this.maskMap.size}};var u={grav:981,hSpeedMult:1.001,pipe:{gapHeight:80,baseSpeed:100,width:30,height:1e3}};var i=document.createElement("canvas");if(!i)throw new Error("Cannot create canvas element.");i.style.imageRendering="pixelated";document.body.appendChild(i);var f=i.getContext("2d");if(!f)throw new Error("Cannot initialize 2d context.");var m={isDown:!1,justPressed:!1,justReleased:!1},p={isDown:{},justPressed:{},justReleased:{}},c={currentScore:0,bestScore:0},h={x:0,y:0,rad:0,scaleX:1,scaleY:1},g={width:10,height:10},y={x:0,y:0},M={x:0,y:0},S={},l={gapHeight:u.pipe.gapHeight};function j(s,e,t,n="white"){let o=Math.sin(e.rad),a=Math.cos(e.rad),r=s.fillStyle;s.transform(a,o,-o,a,e.x,e.y),s.fillStyle=n,s.fillRect(-t.width*.5,-t.height*.5,t.width*e.scaleX,t.height*e.scaleY),s.fillStyle=r,s.transform(a,-o,o,a,a*-e.x+o*-e.y,-o*-e.x+a*-e.y)}function R(s){f&&(D(f,"green"),s.query({and:[h,g],not:[l]}).forEach(e=>{let t=s.getComponent(e,h),n=s.getComponent(e,g);j(f,t,n)}),s.query({and:[h,g,l]}).forEach(e=>{let t=s.getComponent(e,h),n=s.getComponent(e,g),o=s.getComponent(e,l),a=(n.height-o.gapHeight)*.5;j(f,{x:t.x,y:t.y+(o.gapHeight+a)*.5,scaleX:1,scaleY:1,rad:0},{width:n.width,height:a}),j(f,{x:t.x,y:t.y-(o.gapHeight+a)*.5,scaleX:1,scaleY:1,rad:0},{width:n.width,height:a})}),f.fillText("Score: "+c.currentScore+"; Best: "+c.bestScore,0,10))}function H(s){let e=v/1e3;s.query({and:[h,M,y]}).forEach(t=>{let n=s.getComponent(t,h),o=s.getComponent(t,y),a=s.getComponent(t,M);o.x+=a.x*e,o.x*=u.hSpeedMult,o.y+=a.y*e,n.x+=o.x*e,n.y+=o.y*e})}function A(s){s.query({and:[S,M,y]}).forEach(e=>{let t=s.getComponent(e,M),n=s.getComponent(e,y);t.y=u.grav,(p.justPressed[" "]||m.justPressed)&&(t.y=-u.grav*20,n.x=n.y=0)})}function T(s){c.bestScore=parseInt(localStorage.getItem("best")||"0"),c.bestScore=c.currentScore>c.bestScore?c.currentScore:c.bestScore,c.currentScore=0,localStorage.setItem("best",c.bestScore.toString()),s.query({and:[S]}).forEach(e=>{X(e)}),s.query({and:[l]}).forEach(e=>{let t=s.getComponent(e,y);t.x=-u.pipe.baseSpeed,z(e)})}function F(s){s.query({and:[S,g,h]}).forEach(e=>{let t=s.getComponent(e,h),n=s.getComponent(e,g);t.y>i.height-n.height*.5&&T(s),s.query({and:[h,g,l]}).forEach(o=>{let a=s.getComponent(o,h),r=s.getComponent(o,g),x=s.getComponent(o,l);(t.x-a.x)**2<((n.width+r.width)*.5)**2&&(t.y-a.y)**2>((x.gapHeight-n.height)*.5)**2&&T(s),a.x+r.width*.5<0&&(z(o),c.currentScore++)})})}function D(s,e=""){s.setTransform(1,0,0,1,0,0);let t=s.fillStyle;s.fillStyle=e,s.fillRect(0,0,s.canvas.width,s.canvas.height),s.fillStyle=t}function K(s,e=0,t=0,n=0,o=10,a=10){let r=s.addEntity(),x=s.addComponent(r,h);x.x=e,x.y=t,x.rad=n;let I=s.addComponent(r,g);return I.width=o,I.height=a,s.addComponent(r,y),s.addComponent(r,M),r}function O(s){let e=K(s);return s.addComponent(e,S),e}function q(s){let e=K(s),t=s.getComponent(e,g);return s.addComponent(e,l),t.width=u.pipe.width,t.height=u.pipe.height,e}function X(s){let e=d.getComponent(s,h),t=d.getComponent(s,y),n=d.getComponent(s,M);e.x=i.width*.15,e.y=i.height*.5,t.x=t.y=n.x=n.y=0}function z(s){let e=d.getComponent(s,h),t=d.getComponent(s,g),o=d.getComponent(s,l).gapHeight;e.y=Math.random()*(i.height-o)+o*.5,e.x=i.width+t.width*.5}document.onkeydown=s=>{!p.isDown[s.key]&&(p.justPressed[s.key]=!0),p.isDown[s.key]=!0};document.onkeyup=s=>{p.isDown[s.key]=!1,p.justReleased[s.key]=!0};globalThis.window.onresize=document.body.onload=()=>{innerWidth/innerHeight<i.width/i.height?(i.style.width="100%",i.style.height=""):(i.style.width="",i.style.height="100%")};document.onpointerdown=()=>{m.isDown=!0,m.justPressed=!0};document.onpointerup=()=>{m.isDown=!1,m.justReleased=!0};var d=new w,v=0,E=0;O(d);q(d);T(d);(function s(){requestAnimationFrame(s),d.update(R,A,F,H),m.justReleased=!1,m.justPressed=!1;for(let e in p.justPressed)p.justPressed[e]=!1;for(let e in p.justReleased)p.justReleased[e]=!1;v=performance.now()-E,E+=v})();})();
//# sourceMappingURL=out.js.map
