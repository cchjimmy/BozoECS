var E=class{storage=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(){let t;return this.size<this.storage.length?t=this.storage[this.size]:(t=this.objectFactory(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(n=>n==t)}removeObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");let n=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=n,this.size--,n}getObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var c=class e{static pools=new Map;static idMap=new Map;static register(t){e.idMap.set(t,e.idMap.size),e.pools.set(t,new E(()=>({...t})))}static getId(t){return e.idMap.get(t)??-1}static add(t){return Object.assign(e.pools.get(t).addObj(),t)}static delete(t,n){return e.pools.get(t).removeObj(n)}static get(t,n){return e.pools.get(t).getObj(n)}static len(t){return e.pools.get(t).len()}static typeLen(){return e.pools.size}static types(){return e.pools.keys().toArray()}};var w=class e{static nextId=0;static pool=new E(()=>e.nextId++);static add(){return e.pool.addObj()}static findIndex(t){return e.pool.findIndex(t)}static delete(t){return e.pool.removeObj(t)}};var i=class e{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];localEntities=new Set;timeMilli=0;dtMilli=0;constructor(){e.worlds.push(this)}static createEntity(){let t=w.add();return e.maskMap.set(t,0),e.getArchetype(0).add(t),t}static copyEntity(t){let n=w.add(),r=c.types(),o=this.maskMap.get(t);for(let s=0,a=r.length;s<a;s++)o&1<<s&&e.addComponent(n,r[s],e.getComponent(t,r[s]));return n}static getArchetype(t){let n=e.archetypeMap.get(t)??new Set;return e.archetypeMap.set(t,n),n}static deleteEntity(t){for(let o=0,s=e.worlds.length;o<s;o++)e.worlds[o].removeEntity(t);let n=c.types(),r=e.maskMap.get(t);for(let o=0,s=n.length;o<s;o++)r&1<<o&&e.removeComponent(t,n[o]);w.delete(w.findIndex(t))}addEntity(t=e.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static registerComponent(t){return e.indexMap.has(t)||(c.register(t),e.indexMap.set(t,new Map)),e}static hasComponent(t,n){return!!(e.maskMap.get(t)&1<<c.getId(n))}static addComponent(t,n,r={}){e.registerComponent(n);let o=e.maskMap.get(t),s=c.getId(n);if((o&1<<s)!=0)throw new Error(`Entity ${t} already had that component.`);e.getArchetype(o).delete(t),o|=1<<s,e.maskMap.set(t,o),e.getArchetype(o).add(t);let a=c.len(n);return e.indexMap.get(n).set(t,a),Object.assign(c.add(n),r)}static removeComponent(t,n){e.registerComponent(n);let r=e.maskMap.get(t),o=c.getId(n);if((r&1<<o)==0)throw new Error(`Entity ${t} does not have that component.`);e.getArchetype(r).delete(t),r&=~(1<<o),e.maskMap.set(t,r),e.getArchetype(r).add(t);let s=e.indexMap.get(n),a=s.get(t),h=c.delete(n,a),m=s.keys().toArray().at(-1)??-1;return s.set(m,a),s.delete(t),h}static getComponent(t,n){return c.get(n,e.indexMap.get(n).get(t))}update(...t){for(let n=0,r=t.length;n<r;n++)t[n](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let n=0,r=0;if(t.and)for(let s=0,a=t.and.length;s<a;s++)n|=1<<c.getId(t.and[s]);if(t.not)for(let s=0,a=t.not.length;s<a;s++)r|=1<<c.getId(t.not[s]);let o=[];for(let s=e.archetypeMap.keys().toArray(),a=s.length,h=0;h<a;h++){let m=s[h],I=e.getArchetype(m);I.size!=0&&(m&n)==n&&(m&r)==0&&o.push(...I)}return[...this.localEntities.intersection(new Set(o))]}entityCount(){return this.localEntities.size}};var f={grav:981,hSpeedMult:1.001,pipe:{gapHeight:80,baseSpeed:100,width:30,height:1e3}};var d=document.createElement("canvas");if(!d)throw new Error("Cannot create canvas element.");d.style.imageRendering="pixelated";document.body.appendChild(d);var C=d.getContext("2d");if(!C)throw new Error("Cannot initialize 2d context.");var M={isDown:!1,justPressed:!1,justReleased:!1},u={isDown:{},justPressed:{},justReleased:{}},g={currentScore:0,bestScore:0},l={x:0,y:0,rad:0,scaleX:1,scaleY:1},p={width:10,height:10},x={x:0,y:0},j={x:0,y:0},b={},y={gapHeight:f.pipe.gapHeight};function k(e,t,n,r="white"){let o=Math.sin(t.rad),s=Math.cos(t.rad),a=e.fillStyle;e.transform(s,o,-o,s,t.x,t.y),e.fillStyle=r,e.fillRect(-n.width*.5,-n.height*.5,n.width*t.scaleX,n.height*t.scaleY),e.fillStyle=a,e.transform(s,-o,o,s,s*-t.x+o*-t.y,-o*-t.x+s*-t.y)}function R(e){C&&(F(C,"green"),e.query({and:[l,p],not:[y]}).forEach(t=>{let n=i.getComponent(t,l),r=i.getComponent(t,p);k(C,n,r)}),e.query({and:[l,p,y]}).forEach(t=>{let n=i.getComponent(t,l),r=i.getComponent(t,p),o=i.getComponent(t,y),s=(r.height-o.gapHeight)*.5;k(C,{x:n.x,y:n.y+(o.gapHeight+s)*.5,scaleX:1,scaleY:1,rad:0},{width:r.width,height:s}),k(C,{x:n.x,y:n.y-(o.gapHeight+s)*.5,scaleX:1,scaleY:1,rad:0},{width:r.width,height:s})}),C.fillText("Score: "+g.currentScore+"; Best: "+g.bestScore,0,10))}function A(e){let t=e.dtMilli/1e3;e.query({and:[l,j,x]}).forEach(n=>{let r=i.getComponent(n,l),o=i.getComponent(n,x),s=i.getComponent(n,j);o.x+=s.x*t,o.x*=f.hSpeedMult,o.y+=s.y*t,r.x+=o.x*t,r.y+=o.y*t})}function H(e){e.query({and:[b,j,x]}).forEach(t=>{let n=i.getComponent(t,j),r=i.getComponent(t,x);n.y=f.grav,(u.justPressed[" "]||M.justPressed)&&(n.y=-f.grav*20,r.x=r.y=0)})}function v(e){g.bestScore=parseInt(localStorage.getItem("best")||"0"),g.bestScore=g.currentScore>g.bestScore?g.currentScore:g.bestScore,g.currentScore=0,localStorage.setItem("best",g.bestScore.toString()),e.query({and:[b]}).forEach(t=>{X(t)}),e.query({and:[y]}).forEach(t=>{let n=i.getComponent(t,x);n.x=-f.pipe.baseSpeed,O(t)})}function D(e){e.query({and:[b,p,l]}).forEach(t=>{let n=i.getComponent(t,l),r=i.getComponent(t,p);n.y>d.height-r.height*.5&&v(e),e.query({and:[l,p,y]}).forEach(o=>{let s=i.getComponent(o,l),a=i.getComponent(o,p),h=i.getComponent(o,y);(n.x-s.x)**2<((r.width+a.width)*.5)**2&&(n.y-s.y)**2>((h.gapHeight-r.height)*.5)**2&&v(e),s.x+a.width*.5<0&&(O(o),g.currentScore++)})})}function F(e,t=""){e.setTransform(1,0,0,1,0,0);let n=e.fillStyle;e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=n}function z(e,t=0,n=0,r=0,o=10,s=10){let a=e.addEntity(),h=i.addComponent(a,l);h.x=t,h.y=n,h.rad=r;let m=i.addComponent(a,p);return m.width=o,m.height=s,i.addComponent(a,x),i.addComponent(a,j),a}function q(e){let t=z(e);return i.addComponent(t,b),t}function T(e){let t=z(e),n=i.getComponent(t,p);return i.addComponent(t,y),n.width=f.pipe.width,n.height=f.pipe.height,t}function X(e){let t=i.getComponent(e,l),n=i.getComponent(e,x),r=i.getComponent(e,j);t.x=d.width*.15,t.y=d.height*.5,n.x=n.y=r.x=r.y=0}function O(e){let t=i.getComponent(e,l),n=i.getComponent(e,p),o=i.getComponent(e,y).gapHeight;t.y=Math.random()*(d.height-o)+o*.5,t.x=d.width+n.width*.5}document.onkeydown=e=>{!u.isDown[e.key]&&(u.justPressed[e.key]=!0),u.isDown[e.key]=!0};document.onkeyup=e=>{u.isDown[e.key]=!1,u.justReleased[e.key]=!0};globalThis.window.onresize=document.body.onload=()=>{innerWidth/innerHeight<d.width/d.height?(d.style.width="100%",d.style.height=""):(d.style.width="",d.style.height="100%")};document.onpointerdown=()=>{M.isDown=!0,M.justPressed=!0};document.onpointerup=()=>{M.isDown=!1,M.justReleased=!0};var S=new i;q(S);T(S);v(S);(function e(){requestAnimationFrame(e),S.update(R,H,D,A),M.justReleased=!1,M.justPressed=!1;for(let t in u.justPressed)u.justPressed[t]=!1;for(let t in u.justReleased)u.justReleased[t]=!1})();
//# sourceMappingURL=out.js.map
