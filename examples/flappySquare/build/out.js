(()=>{var C=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(e){this.objectFactory=e}size(){return this.keyToIndex.size}add(e){return this.keyToIndex.has(e)?this.storage[this.keyToIndex.get(e)]:(this.storage.length<=this.keyToIndex.size&&this.storage.push(this.objectFactory()),this.keyToIndex.set(e,this.keyToIndex.size),this.indexToKey[this.keyToIndex.size-1]=e,this.storage[this.keyToIndex.get(e)])}remove(e){let t=this.keyToIndex.get(e);if(t==null)return;let o=this.indexToKey[this.keyToIndex.size-1],s=this.storage[t];this.storage[t]=this.storage[this.keyToIndex.size-1],this.storage[this.keyToIndex.size-1]=s,this.indexToKey[t]=o,this.indexToKey.pop(),this.keyToIndex.set(o,t),this.keyToIndex.delete(e)}get(e){let t=this.keyToIndex.get(e);if(t==null)throw new Error("Key not found.");return this.storage[t]}has(e){return this.keyToIndex.has(e)}clean(){this.storage.splice(this.keyToIndex.size)}};var S=class{poolMap=new Map;idMap=new Map;register(e){this.poolMap.has(e)||(this.idMap.set(e,this.idMap.size),this.poolMap.set(e,new C(()=>({...e}))))}getId(e){let t=this.idMap.get(e);return t??(this.register(e),this.idMap.get(e))}add(e,t){return Object.assign(this.poolMap.get(t).add(e),t)}remove(e,t){this.poolMap.get(t).remove(e)}has(e,t){return this.poolMap.has(t)&&this.poolMap.get(t).has(e)}get(e,t){return this.poolMap.get(t).get(e)}size(e){return this.poolMap.get(e).size()}delete(e){for(let t of this.poolMap.entries())t[1].remove(e)}copy(e,t){for(let o of this.poolMap.entries())o[1].has(e)&&Object.assign(o[1].add(t),o[1].get(e))}clean(){for(let e of this.poolMap.entries())e[1].clean()}};function T(){return Math.random()}var E=class{compEntityMap=new Map;compManager=new S;entitySet=new Set;addEntity(e=T()){return this.entitySet.add(e),e}copyEntity(e,t=T()){this.compManager.copy(e,t);for(let o of this.compEntityMap)o[1].has(e)&&o[1].add(t);return this.entitySet.add(t),t}getCompEntityMap(e){let t=this.compEntityMap.get(e)??new Set;return this.compEntityMap.set(e,t),t}deleteEntity(e){this.compManager.delete(e);for(let t of this.compEntityMap)t[1].delete(e);this.entitySet.delete(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,t){return this.compManager.has(e,t)}addComponent(e,t,o=t){this.compManager.register(t);let s=this.getCompEntityMap(this.compManager.getId(t));return s.has(e)?Object.assign(this.compManager.get(e,t),o):(s.add(e),Object.assign(this.compManager.add(e,t),o))}removeComponent(e,t){this.compManager.register(t);let o=this.getCompEntityMap(this.compManager.getId(t));o.has(e)&&o.delete(e)}getComponent(e,t){return this.compManager.get(e,t)}update(...e){for(let t=0,o=e.length;t<o;t++)e[t](this)}cleanObjectPools(){this.compManager.clean()}query(e){let t=this.entitySet;if(e.and)for(let o of e.and)t=t.intersection(this.getCompEntityMap(this.compManager.getId(o)));if(e.not)for(let o of e.not)t=t.difference(this.getCompEntityMap(this.compManager.getId(o)));return[...t]}entityCount(){return this.entitySet.size}};var y={grav:981,hSpeedMult:1.001,pipe:{gapHeight:80,baseSpeed:100,width:30,height:1e3}};var a=document.createElement("canvas");if(!a)throw new Error("Cannot create canvas element.");a.style.imageRendering="pixelated";document.body.appendChild(a);var l=a.getContext("2d");if(!l)throw new Error("Cannot initialize 2d context.");var f={isDown:!1,justPressed:!1,justReleased:!1},p={isDown:{},justPressed:{},justReleased:{}},h={currentScore:0,bestScore:0},r={x:0,y:0,rad:0,scaleX:1,scaleY:1},c={width:10,height:10},m={x:0,y:0},M={x:0,y:0},w={},u={gapHeight:y.pipe.gapHeight};function I(n,e,t,o="white"){let s=Math.sin(e.rad),i=Math.cos(e.rad),d=n.fillStyle;n.transform(i,s,-s,i,e.x,e.y),n.fillStyle=o,n.fillRect(-t.width*.5,-t.height*.5,t.width*e.scaleX,t.height*e.scaleY),n.fillStyle=d,n.transform(i,-s,s,i,i*-e.x+s*-e.y,-s*-e.x+i*-e.y)}function H(n){l&&(q(l,"green"),n.query({and:[r,c],not:[u]}).forEach(e=>{let t=n.getComponent(e,r),o=n.getComponent(e,c);I(l,t,o)}),n.query({and:[r,c,u]}).forEach(e=>{let t=n.getComponent(e,r),o=n.getComponent(e,c),s=n.getComponent(e,u),i=(o.height-s.gapHeight)*.5;I(l,{x:t.x,y:t.y+(s.gapHeight+i)*.5,scaleX:1,scaleY:1,rad:0},{width:o.width,height:i}),I(l,{x:t.x,y:t.y-(s.gapHeight+i)*.5,scaleX:1,scaleY:1,rad:0},{width:o.width,height:i})}),l.fillText("Score: "+h.currentScore+"; Best: "+h.bestScore,0,10))}function D(n){let e=k/1e3;n.query({and:[r,M,m]}).forEach(t=>{let o=n.getComponent(t,r),s=n.getComponent(t,m),i=n.getComponent(t,M);s.x+=i.x*e,s.x*=y.hSpeedMult,s.y+=i.y*e,o.x+=s.x*e,o.y+=s.y*e})}function K(n){n.query({and:[w,M,m]}).forEach(e=>{let t=n.getComponent(e,M),o=n.getComponent(e,m);t.y=y.grav,(p.justPressed[" "]||f.justPressed)&&(t.y=-y.grav*20,o.x=o.y=0)})}function j(n){h.bestScore=parseInt(localStorage.getItem("best")||"0"),h.bestScore=h.currentScore>h.bestScore?h.currentScore:h.bestScore,h.currentScore=0,localStorage.setItem("best",h.bestScore.toString()),n.query({and:[w]}).forEach(e=>{Y(e)}),n.query({and:[u]}).forEach(e=>{let t=n.getComponent(e,m);t.x=-y.pipe.baseSpeed,P(e)})}function O(n){n.query({and:[w,c,r]}).forEach(e=>{let t=n.getComponent(e,r),o=n.getComponent(e,c);t.y>a.height-o.height*.5&&j(n),n.query({and:[r,c,u]}).forEach(s=>{let i=n.getComponent(s,r),d=n.getComponent(s,c),x=n.getComponent(s,u);(t.x-i.x)**2<((o.width+d.width)*.5)**2&&(t.y-i.y)**2>((x.gapHeight-o.height)*.5)**2&&j(n),i.x+d.width*.5<0&&(P(s),h.currentScore++)})})}function q(n,e=""){n.setTransform(1,0,0,1,0,0);let t=n.fillStyle;n.fillStyle=e,n.fillRect(0,0,n.canvas.width,n.canvas.height),n.fillStyle=t}function z(n,e=0,t=0,o=0,s=10,i=10){let d=n.addEntity(),x=n.addComponent(d,r);x.x=e,x.y=t,x.rad=o;let b=n.addComponent(d,c);return b.width=s,b.height=i,n.addComponent(d,m),n.addComponent(d,M),d}function F(n){let e=z(n);return n.addComponent(e,w),e}function X(n){let e=z(n),t=n.getComponent(e,c);return n.addComponent(e,u),t.width=y.pipe.width,t.height=y.pipe.height,e}function Y(n){let e=g.getComponent(n,r),t=g.getComponent(n,m),o=g.getComponent(n,M);e.x=a.width*.15,e.y=a.height*.5,t.x=t.y=o.x=o.y=0}function P(n){let e=g.getComponent(n,r),t=g.getComponent(n,c),s=g.getComponent(n,u).gapHeight;e.y=Math.random()*(a.height-s)+s*.5,e.x=a.width+t.width*.5}document.onkeydown=n=>{!p.isDown[n.key]&&(p.justPressed[n.key]=!0),p.isDown[n.key]=!0};document.onkeyup=n=>{p.isDown[n.key]=!1,p.justReleased[n.key]=!0};globalThis.window.onresize=document.body.onload=()=>{innerWidth/innerHeight<a.width/a.height?(a.style.width="100%",a.style.height=""):(a.style.width="",a.style.height="100%")};document.onpointerdown=()=>{f.isDown=!0,f.justPressed=!0};document.onpointerup=()=>{f.isDown=!1,f.justReleased=!0};var g=new E,k=0,v=0;F(g);X(g);j(g);(function n(){requestAnimationFrame(n),g.update(H,K,O,D),f.justReleased=!1,f.justPressed=!1;for(let e in p.justPressed)p.justPressed[e]=!1;for(let e in p.justReleased)p.justReleased[e]=!1;k=performance.now()-v,v+=k})();})();
//# sourceMappingURL=out.js.map
