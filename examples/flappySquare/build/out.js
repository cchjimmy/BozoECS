(()=>{var x=class{storage=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(){let t;return this.size<this.storage.length?t=this.storage[this.size]:(t=this.objectFactory(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(n=>n==t)}removeObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");let n=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=n,this.size--,n}getObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var d=class e{static pools=new Map;static idMap=new Map;static register(t){e.idMap.set(t,e.idMap.size),e.pools.set(t,new x(()=>({...t})))}static getId(t){return e.idMap.get(t)??-1}static add(t){return Object.assign(e.pools.get(t).addObj(),t)}static delete(t,n){return e.pools.get(t).removeObj(n)}static get(t,n){return e.pools.get(t).getObj(n)}static len(t){return e.pools.get(t).len()}static typeLen(){return e.pools.size}static types(){return e.pools.keys().toArray()}};var M=class e{static nextId=0;static pool=new x(()=>e.nextId++);static add(){return e.pool.addObj()}static findIndex(t){return e.pool.findIndex(t)}static delete(t){return e.pool.removeObj(t)}};var i=class e{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];localEntities=new Set;timeMilli=0;dtMilli=0;constructor(){e.worlds.push(this)}static createEntity(){let t=M.add();return e.maskMap.set(t,0),e.getArchetype(0).add(t),t}static getArchetype(t){let n=e.archetypeMap.get(t)??new Set;return e.archetypeMap.set(t,n),n}static deleteEntity(t){for(let o=0,r=e.worlds.length;o<r;o++)e.worlds[o].removeEntity(t);let n=d.types(),s=e.maskMap.get(t);for(let o=0,r=n.length;o<r;o++)s&1<<o&&e.removeComponent(t,n[o]);M.delete(M.findIndex(t))}addEntity(t=e.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static registerComponent(t){return e.indexMap.has(t)||(d.register(t),e.indexMap.set(t,new Map)),e}static hasComponent(t,n){return!!(e.maskMap.get(t)&1<<d.getId(n))}static addComponent(t,n,s={}){e.registerComponent(n);let o=e.maskMap.get(t),r=d.getId(n);if((o&1<<r)!=0)throw new Error(`Entity ${t} already had that component.`);e.getArchetype(o).delete(t),o|=1<<r,e.maskMap.set(t,o),e.getArchetype(o).add(t);let a=d.len(n);return e.indexMap.get(n).set(t,a),Object.assign(d.add(n),s)}static removeComponent(t,n){e.registerComponent(n);let s=e.maskMap.get(t),o=d.getId(n);if((s&1<<o)==0)throw new Error(`Entity ${t} does not have that component.`);e.getArchetype(s).delete(t),s&=~(1<<o),e.maskMap.set(t,s),e.getArchetype(s).add(t);let r=e.indexMap.get(n),a=r.get(t),c=d.delete(n,a),m=r.keys().toArray().at(-1)??-1;return r.set(m,a),r.delete(t),c}static getComponent(t,n){return d.get(n,e.indexMap.get(n).get(t))}update(...t){for(let n=0,s=t.length;n<s;n++)t[n](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let n=0,s=0,o=0;if(t.and)for(let a=0,c=t.and.length;a<c;a++)n|=1<<d.getId(t.and[a]);if(t.or)for(let a=0,c=t.or.length;a<c;a++)s|=1<<d.getId(t.or[a]);if(t.not)for(let a=0,c=t.not.length;a<c;a++)o|=1<<d.getId(t.not[a]);let r=[];for(let a=e.archetypeMap.keys().toArray(),c=a.length,m=0;m<c;m++){let C=a[m],I=e.getArchetype(C);I.size>0&&(C&n)==n&&(C|s)>0&&(C&o)==0&&r.push(...this.localEntities.intersection(I))}return r}entityCount(){return this.localEntities.size}};var y={grav:981,hSpeedMult:1.001,pipe:{gapHeight:80,baseSpeed:100,width:30,height:1e3}};var l=document.createElement("canvas");if(!l)throw new Error("Cannot create canvas element.");l.style.imageRendering="pixelated";document.body.appendChild(l);var b=l.getContext("2d");if(!b)throw new Error("Cannot initialize 2d context.");var T={isDown:!1,justPressed:!1,justReleased:!1},u={isDown:{},justPressed:{},justReleased:{}},h={currentScore:0,bestScore:0},p={x:0,y:0,rad:0,scaleX:1,scaleY:1},g={width:10,height:10},w={x:0,y:0},j={x:0,y:0},v={},f={gapHeight:y.pipe.gapHeight};function E(e,t,n,s="white"){let o=Math.sin(t.rad),r=Math.cos(t.rad),a=e.fillStyle;e.transform(r,o,-o,r,t.x,t.y),e.fillStyle=s,e.fillRect(-n.width*.5,-n.height*.5,n.width*t.scaleX,n.height*t.scaleY),e.fillStyle=a,e.transform(r,-o,o,r,r*-t.x+o*-t.y,-o*-t.x+r*-t.y)}function z(e){b&&(H(b,"green"),e.query({and:[p,g],not:[f]}).forEach(t=>{let n=i.getComponent(t,p),s=i.getComponent(t,g);E(b,n,s)}),e.query({and:[p,g,f]}).forEach(t=>{let n=i.getComponent(t,p),s=i.getComponent(t,g),o=i.getComponent(t,f),r=(s.height-o.gapHeight)*.5;E(b,{x:n.x,y:n.y+(o.gapHeight+r)*.5,scaleX:1,scaleY:1,rad:0},{width:s.width,height:r}),E(b,{x:n.x,y:n.y-(o.gapHeight+r)*.5,scaleX:1,scaleY:1,rad:0},{width:s.width,height:r})}),b.fillText("Score: "+h.currentScore+"; Best: "+h.bestScore,0,10))}function A(e){let t=e.dtMilli/1e3;e.query({and:[p,j,w]}).forEach(n=>{let s=i.getComponent(n,p),o=i.getComponent(n,w),r=i.getComponent(n,j);o.x+=r.x*t,o.x*=y.hSpeedMult,o.y+=r.y*t,s.x+=o.x*t,s.y+=o.y*t})}function W(e){e.query({and:[v,j,w]}).forEach(t=>{let n=i.getComponent(t,j),s=i.getComponent(t,w);n.y=y.grav,(u.justPressed[" "]||T.justPressed)&&(n.y=-y.grav*20,s.x=s.y=0)})}function k(e){h.bestScore=parseInt(localStorage.getItem("best")||"0"),h.bestScore=h.currentScore>h.bestScore?h.currentScore:h.bestScore,h.currentScore=0,localStorage.setItem("best",h.bestScore.toString()),e.query({and:[v]}).forEach(t=>{X(t)}),e.query({and:[f]}).forEach(t=>{let n=i.getComponent(t,w);n.x=-y.pipe.baseSpeed,R(t)})}function D(e){e.query({and:[v,g,p]}).forEach(t=>{let n=i.getComponent(t,p),s=i.getComponent(t,g);n.y>l.height-s.height*.5&&k(e),e.query({and:[p,g,f]}).forEach(o=>{let r=i.getComponent(o,p),a=i.getComponent(o,g),c=i.getComponent(o,f);(n.x-r.x)**2<((s.width+a.width)*.5)**2&&(n.y-r.y)**2>((c.gapHeight-s.height)*.5)**2&&k(e),r.x+a.width*.5<0&&(R(o),h.currentScore++)})})}function H(e,t=""){e.setTransform(1,0,0,1,0,0);let n=e.fillStyle;e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=n}function P(e,t=0,n=0,s=0,o=10,r=10){let a=e.addEntity(),c=i.addComponent(a,p);c.x=t,c.y=n,c.rad=s;let m=i.addComponent(a,g);return m.width=o,m.height=r,i.addComponent(a,w),i.addComponent(a,j),a}function F(e){let t=P(e);return i.addComponent(t,v),t}function q(e){let t=P(e),n=i.getComponent(t,g);return i.addComponent(t,f),n.width=y.pipe.width,n.height=y.pipe.height,t}function X(e){let t=i.getComponent(e,p),n=i.getComponent(e,w),s=i.getComponent(e,j);t.x=l.width*.15,t.y=l.height*.5,n.x=n.y=s.x=s.y=0}function R(e){let t=i.getComponent(e,p),n=i.getComponent(e,g),o=i.getComponent(e,f).gapHeight;t.y=Math.random()*(l.height-o)+o*.5,t.x=l.width+n.width*.5}document.onkeydown=e=>{!u.isDown[e.key]&&(u.justPressed[e.key]=!0),u.isDown[e.key]=!0};document.onkeyup=e=>{u.isDown[e.key]=!1,u.justReleased[e.key]=!0};globalThis.window.onresize=document.body.onload=()=>{innerWidth/innerHeight<l.width/l.height?(l.style.width="100%",l.style.height=""):(l.style.width="",l.style.height="100%")};document.onpointerdown=()=>{T.isDown=!0,T.justPressed=!0};document.onpointerup=()=>{T.isDown=!1,T.justReleased=!0};var S=new i;F(S);q(S);k(S);(function e(){requestAnimationFrame(e),S.update(z,W,D,A),T.justReleased=!1,T.justPressed=!1;for(let t in u.justPressed)u.justPressed[t]=!1;for(let t in u.justReleased)u.justReleased[t]=!1})();})();
//# sourceMappingURL=out.js.map
