(()=>{var y=class{reserve;active;objectConstructor;constructor(t){this.reserve=[],this.active=[],this.objectConstructor=t}addObj(){return this.active.push(this.reserve.pop()??this.objectConstructor()),this.active[this.active.length-1]}findIndex(t){return this.active.findIndex(n=>n==t)}removeObj(t){let n=this.active[t];return this.active[t]=this.active[this.active.length-1],this.active.length--,this.reserve.push(n),n}getObj(t){return this.active[t]}len(){return this.active.length}};var T=class{static id=-1;owner=-1},f=class{pools=[];register(t){t.id==-1&&(t.id=this.pools.length),this.pools[t.id]??=new y(()=>new t)}isRegistered(t){return!!this.pools[t.id]}add(t){return this.pools[t.id].addObj()}delete(t,n){return this.pools[t.id].removeObj(n)}get(t,n){return this.pools[t.id].getObj(n)}len(t){return this.pools[t.id].len()}};var x=class{nextId=0;pool=new y(()=>this.nextId++);add(){return this.pool.addObj()}findIndex(t){return this.pool.findIndex(t)}delete(t){return this.pool.removeObj(t)}};var l=class e{static indices=[];static components=new f;static entities=new x;static entityMasks=[];static archetypes={0:new Set};static worlds=[];time=0;dt=0;localEntities=new Set;constructor(){e.worlds.push(this)}static createEntity(){let t=e.entities.add();return e.indices[t]=[],e.entityMasks[t]=0,e.archetypes[e.entityMasks[t]].add(t),t}static deleteEntity(t){for(let n of e.worlds)n.removeEntity(t);for(let n=0,o=e.components.pools.length;n<o;n++){if(!(e.entityMasks[t]&1<<n))continue;let s=e.components.pools[n].removeObj(e.indices[t][n]).constructor.prototype;e.indices[e.components.get(s,t).owner][n]=e.indices[t][n]}e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]=0,e.entities.delete(e.entities.findIndex(t))}addEntity(t){return t??=e.createEntity(),this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){if(!this.localEntities.has(t))throw new Error(`Entity ${t} does not exist.`)}static componentExists(t){e.components.isRegistered(t)||e.components.register(t)}static registerComponent(t){return e.components.register(t),e}static hasComponent(t,n){return(e.entityMasks[t]&1<<n.id)>0}static addComponent(t,n){if(e.componentExists(n),e.hasComponent(t,n))throw new Error(`Entity ${t} already had this component.`);e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]|=1<<n.id,e.archetypes[e.entityMasks[t]]??=new Set,e.archetypes[e.entityMasks[t]].add(t),e.indices[t][n.id]=e.components.len(n);let o=e.components.add(n);return o.owner=t,o}static removeComponent(t,n){if(e.componentExists(n),!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have component ${n.name}.`);e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]&=~(1<<n.id),e.archetypes[e.entityMasks[t]]??=new Set,e.archetypes[e.entityMasks[t]].add(t);let o=e.components.delete(n,e.indices[t][n.id]),s=e.components.get(n,e.indices[t][n.id]).owner;return e.indices[s][n.id]=e.indices[t][n.id],o}getComponent(t,n){if(this.entityExists(t),e.componentExists(n),!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have component ${n.name}.`);return e.components.get(n,e.indices[t][n.id])}update(...t){for(let n of t)n(this,this.dt/1e3);this.dt=performance.now()-this.time,this.time+=this.dt}query(t){let n=0,o=0,s=0;if(t.and)for(let r=0,c=t.and.length;r<c;r++)n|=1<<t.and[r].id;if(t.or)for(let r=0,c=t.or.length;r<c;r++)o|=1<<t.or[r].id;if(t.not)for(let r=0,c=t.not.length;r<c;r++)s|=1<<t.not[r].id;let i=[];for(let r in e.archetypes){let c=parseInt(r);(c&n)==n&&(c|o)>0&&(c&s)==0&&i.push(...this.localEntities.intersection(e.archetypes[r]))}return i}};function h(e,t){return Math.random()*(t-e)+e}var d=document.createElement("canvas"),a=d.getContext("2d");document.body.appendChild(d);var v=1e3;function b(){d.width=innerWidth,d.height=innerHeight}b();globalThis.window.onresize=b;document.body.style.margin="0px";document.body.style.userSelect="none";document.body.style.overflow="hidden";document.body.style.touchAction="none";var g=new l,p=class extends T{x=0;y=0},m=class extends T{x=0;y=0},u=class extends T{radius=10;color="green"};l.registerComponent(p).registerComponent(m).registerComponent(u);function C(e,t){if(!a)return;let n=`FPS: ${(1/t).toFixed(0)}`,o=30,s=10,i=5,r=a.fillStyle;a.font=`${o}px serif`;let c=a.measureText(n);a.fillStyle="white",a.fillRect(s,s,2*i+c.width,2*i+c.emHeightAscent),a.fillStyle="black",a.fillText(n,i+s,i+s+c.emHeightAscent),a.fillStyle=r}function w(e,t){if(!a)return;let n=2*Math.PI;a.fillRect(0,0,d.width,d.height);let o=a.strokeStyle;e.query({and:[p,u]}).forEach(s=>{let i=e.getComponent(s,p),r=e.getComponent(s,u);a.strokeStyle=r.color,a.beginPath(),a.arc(i.x,i.y,r.radius,0,n),a.stroke()}),a.strokeStyle=o}function E(e,t){e.query({and:[p,m]}).forEach(n=>{let o=e.getComponent(n,p),s=e.getComponent(n,m);o.x+=s.x*t,o.y+=s.y*t})}function k(e,t){e.query({and:[p,m,u]}).forEach(n=>{let o=e.getComponent(n,p),s=e.getComponent(n,m),i=e.getComponent(n,u);(o.x-i.radius<0||o.x+i.radius>d.width)&&(s.x*=-1,o.x=o.x<d.width*.5?i.radius:d.width-i.radius),(o.y-i.radius<0||o.y+i.radius>d.height)&&(s.y*=-1,o.y=o.y<d.height*.5?i.radius:d.height-i.radius)})}function M(){let e=g.addEntity(),t=l.addComponent(e,p),n=l.addComponent(e,m),o=l.addComponent(e,u),s=100;return t.x=h(0,d.width),t.y=h(0,d.height),n.x=h(-s,s),n.y=h(-s,s),o.radius=h(10,30),o.color=`rgb(${h(0,255)}, ${h(0,255)}, ${h(0,255)})`,e}for(let e=0;e<v;++e)M();(function e(){g.update(w,E,k,C),requestAnimationFrame(e)})();})();
