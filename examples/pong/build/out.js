(()=>{var T=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(e){this.objectFactory=e}size(){return this.keyToIndex.size}add(e){return this.keyToIndex.has(e)?this.storage[this.keyToIndex.get(e)]:(this.storage.length<=this.keyToIndex.size&&this.storage.push(this.objectFactory()),this.keyToIndex.set(e,this.keyToIndex.size),this.indexToKey[this.keyToIndex.size-1]=e,this.storage[this.keyToIndex.get(e)])}remove(e){let t=this.keyToIndex.get(e);if(t==null)return;let n=this.indexToKey[this.keyToIndex.size-1],i=this.storage[t];this.storage[t]=this.storage[this.keyToIndex.size-1],this.storage[this.keyToIndex.size-1]=i,this.indexToKey[t]=n,this.indexToKey.pop(),this.keyToIndex.set(n,t),this.keyToIndex.delete(e)}get(e){let t=this.keyToIndex.get(e);if(t==null)throw new Error("Key not found.");return this.storage[t]}has(e){return this.keyToIndex.has(e)}clean(){this.storage.splice(this.keyToIndex.size)}};var b=class{poolMap=new Map;idMap=new Map;register(e){this.poolMap.has(e)||(this.idMap.set(e,this.idMap.size),this.poolMap.set(e,new T(()=>({...e}))))}getId(e){let t=this.idMap.get(e);return t??(this.register(e),this.idMap.get(e))}add(e,t){return Object.assign(this.poolMap.get(t).add(e),t)}remove(e,t){this.poolMap.get(t).remove(e)}has(e,t){return this.poolMap.has(t)&&this.poolMap.get(t).has(e)}get(e,t){return this.poolMap.get(t).get(e)}size(e){return this.poolMap.get(e).size()}delete(e){for(let t of this.poolMap.entries())t[1].remove(e)}copy(e,t){for(let n of this.poolMap.entries())n[1].has(e)&&Object.assign(n[1].add(t),n[1].get(e))}clean(){for(let e of this.poolMap.entries())e[1].clean()}};function I(){return Math.random()}var k=class{compEntityMap=new Map;compManager=new b;entitySet=new Set;addEntity(e=I()){return this.entitySet.add(e),e}copyEntity(e,t=I()){this.compManager.copy(e,t);for(let n of this.compEntityMap)n[1].has(e)&&n[1].add(t);return this.entitySet.add(t),t}getCompEntityMap(e){let t=this.compEntityMap.get(e)??new Set;return this.compEntityMap.set(e,t),t}deleteEntity(e){this.compManager.delete(e);for(let t of this.compEntityMap)t[1].delete(e);this.entitySet.delete(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,t){return this.compManager.has(e,t)}addComponent(e,t,n=t){this.compManager.register(t);let i=this.getCompEntityMap(this.compManager.getId(t));return i.has(e)?Object.assign(this.compManager.get(e,t),n):(i.add(e),Object.assign(this.compManager.add(e,t),n))}removeComponent(e,t){this.compManager.register(t);let n=this.getCompEntityMap(this.compManager.getId(t));n.has(e)&&(n.delete(e),this.compManager.remove(e,t))}getComponent(e,t){return this.compManager.get(e,t)}update(...e){for(let t=0,n=e.length;t<n;t++)e[t](this)}cleanObjectPools(){this.compManager.clean()}query(e){let t=this.entitySet,n={and:[],not:[]};Object.assign(n,e);for(let i of n.and)t=t.intersection(this.getCompEntityMap(this.compManager.getId(i)));for(let i of n.not)t=t.difference(this.getCompEntityMap(this.compManager.getId(i)));return[...t]}entityCount(){return this.entitySet.size}};var a={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var l=document.querySelector("canvas"),c=l?.getContext("2d"),u={width:1,height:1,color:"white"},p={x:0,y:0},x={x:0,y:0},C={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},S={isLeft:!0},d=new k;function B(o){o.query({and:[x,S]}).forEach(e=>{let t=o.getComponent(e,x),n=o.getComponent(e,S);t.y=0,n.isLeft?(m.w&&(t.y-=1),m.s&&(t.y+=1)):(m.ArrowUp&&(t.y-=1),m.ArrowDown&&(t.y+=1));for(let i of Object.values(v)){if(c){let s=c.fillStyle;c.fillStyle="green",c.fillRect(i.x,i.y,20,20),c.fillStyle=s}if(i.x<a.playArea.width*.5){if(!n.isLeft)continue}else if(n.isLeft)continue;i.y<a.playArea.height*.5&&(t.y-=1),i.y>a.playArea.height*.5&&(t.y+=1)}t.y=t.y/Math.abs(t.y||1)*a.paddle.speed})}function $(){!c||!l||c.fillRect(0,0,l.width,l.height)}function F(o){let e=z/1e3;o.query({and:[p,x]}).forEach(t=>{let n=o.getComponent(t,p),i=o.getComponent(t,x);n.x+=i.x*e,n.y+=i.y*e})}function H(o){c&&o.query({and:[u,p]}).forEach(e=>{let t=o.getComponent(e,p),n=o.getComponent(e,u),i=c.fillStyle;c.fillStyle=n.color,c.fillRect(Math.floor(t.x-n.width*.5),Math.floor(t.y-n.height*.5),n.width,n.height),c.fillStyle=i})}function W(o){c&&o.query({and:[C,p]}).forEach(e=>{let t=o.getComponent(e,C),n=o.getComponent(e,p);c.font=`${t.fontSize}px serif`;let i=c.measureText(t.content),s=c.fillStyle;c.fillStyle=t.backgroundColor,c.fillRect(n.x,n.y,t.padding*2+i.width,t.padding*2+i.fontBoundingBoxAscent),c.fillStyle=t.color,c.fillText(t.content,n.x+t.padding,n.y+t.padding+i.fontBoundingBoxAscent),c.fillStyle=s})}function G(o){let e=o.query({and:[p,u]});e.forEach(t=>{let n=o.getComponent(t,p),i=o.getComponent(t,u);e.forEach(s=>{if(s==t)return;let h=o.getComponent(s,p),g=o.getComponent(s,u);(n.x-h.x)**2<((i.width+g.width)*.5)**2&&(n.y-h.y)**2<((i.height+g.height)*.5)**2&&Y(t,s)})})}function N(o){let e=o.getComponent(A,p),t=o.getComponent(A,u);e.x-t.width>a.playArea.width&&(w.left++,j()),e.x+t.width<0&&(w.right++,j())}function R(o,e,t){let n=E(o,e,a.paddle.width,a.paddle.height),i=d.addComponent(n,S);return i.isLeft=t,n}function E(o,e,t,n,i="white"){let s=d.addEntity(),h=d.addComponent(s,p),g=d.addComponent(s,u);return d.addComponent(s,x),h.x=o,h.y=e,g.width=t,g.height=n,g.color=i,s}function V(o,e=0,t=0,n="black",i=20,s="rgba(0,0,0,0)"){let h=d.addEntity(),g=d.addComponent(h,C),M=d.addComponent(h,p);return g.content=o,g.color=n,g.fontSize=i,g.backgroundColor=s,M.x=e,M.y=t,h}l&&(l.width=a.playArea.width,l.height=a.playArea.height);var m={};globalThis.onkeydown=o=>{m[o.key]=!0};globalThis.onkeyup=o=>{delete m[o.key]};var v={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=o=>{if(!l)return;let e=l.getBoundingClientRect();for(let t=0,n=o.changedTouches.length;t<n;t++){let i=v[o.changedTouches[t].identifier]={x:o.changedTouches[t].clientX,y:o.changedTouches[t].clientY};i.x-=e.left,i.y-=e.top,innerWidth/innerHeight<l.width/l.height?(i.x*=l.width/innerWidth,i.y*=l.width/innerWidth):(i.x*=l.height/innerHeight,i.y*=l.height/innerHeight)}};globalThis.window.ontouchend=o=>{for(let e=0,t=o.changedTouches.length;e<t;e++)delete v[o.changedTouches[e].identifier]};E(a.playArea.width*.5,a.playArea.height*0,a.playArea.width,10);E(a.playArea.width*.5,a.playArea.height*1,a.playArea.width,10);var A=E(a.playArea.width*.5,a.playArea.height*.5,a.ball.width,a.ball.height),D=R(a.playArea.width*a.paddle.padding,a.playArea.height*.5,!0),U=R(a.playArea.width*(1-a.paddle.padding),a.playArea.height*.5,!1);function q(){let o=d.getComponent(A,x),e=d.getComponent(A,p);e.x=a.playArea.width*.5,e.y=a.playArea.height*.5,o.x=a.ball.speed,o.y=0;let t=Math.random()*40/180*Math.PI;t*=Math.random()>.5?1:-1,t+=Math.random()>.5?Math.PI:0,X(o,t);let n=d.getComponent(D,p),i=d.getComponent(U,p);n.y=a.playArea.height*.5,i.y=a.playArea.height*.5}function X(o,e){let t=Math.sin(e),n=Math.cos(e),i=o.x,s=o.y;o.x=n*i-t*s,o.y=t*i+n*s}function j(){let o=d.getComponent(K,C);o.content=`${w.left} : ${w.right}`,q()}function Y(o,e){let t=d.getComponent(o,p),n=d.getComponent(e,p),i=d.getComponent(o,u),s=d.getComponent(e,u),h=d.getComponent(o,x),g=d.getComponent(e,x),M=(h.x**2+h.y**2)**.5,y=h.x/M,f=h.y/M,r=0;y!=0&&(r=(n.x-(s.width+i.width)*.5-t.x)/y,t.x<n.x&&r<0&&t.y+r*f<n.y+(s.height+i.height)*.5&&t.y+r*f>n.y-(s.height+i.height)*.5&&(t.x+=r*y,t.y+=r*f,h.x>0&&(h.x*=-1),h.y+=g.y),r=(n.x+(s.width+i.width)*.5-t.x)/y,t.x>n.x&&r<0&&t.y+r*f<n.y+(s.height+i.height)*.5&&t.y+r*f>n.y-(s.height+i.height)*.5&&(t.x+=r*y,t.y+=r*f,h.x<0&&(h.x*=-1),h.y+=g.y)),f!=0&&(r=(n.y-(s.height+i.height)*.5-t.y)/f,t.y<n.y&&r<0&&t.x+r*y<n.x+(s.width+i.width)*.5&&t.x+r*y>n.x-(s.width+i.width)*.5&&(t.x+=r*y,t.y+=r*f,h.y>0&&(h.y*=-1)),r=(n.y+(s.height+i.height)*.5-t.y)/f,t.y>n.y&&r<0&&t.x+r*y<n.x+(s.width+i.width)*.5&&t.x+r*y>n.x-(s.width+i.width)*.5&&(t.x+=r*y,t.y+=r*f,h.y<0&&(h.y*=-1)))}var w={left:0,right:0},K=V(`${w.left} : ${w.right}`),L=d.getComponent(K,C);L.color="white";L.fontSize=40;var z=0,P=0;q();(function o(){d.update($,H,W,F,B,G,N),z=performance.now()-P,P+=z,requestAnimationFrame(o)})();})();
//# sourceMappingURL=out.js.map
