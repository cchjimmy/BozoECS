(()=>{var b=class{storage=[];objectConstructor;size=0;constructor(t){this.objectConstructor=t}len(){return this.size}addObj(){let t;return this.storage[this.size]?t=this.storage[this.size]:(t=this.objectConstructor(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(e=>e==t)}removeObj(t){if(t>=this.size)throw new Error("Index out of range.");let e=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=e,this.size--,e}getObj(t){if(t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var p=class n{static pools=new Map;static idMap=new Map;static register(t){n.idMap.set(t,n.idMap.size),n.pools.set(t,new b(()=>Object.assign({},t)))}static getId(t){let e=n.idMap.get(t);if(e==null)throw new Error("Component not registered.");return e}static add(t){return n.pools.get(t).addObj()}static delete(t,e){return n.pools.get(t).removeObj(e)}static get(t,e){return n.pools.get(t).getObj(e)}static len(t){return n.pools.get(t).len()}static typeLen(){return n.pools.size}static types(){return n.pools.keys().toArray()}};var T=class n{static nextId=0;static pool=new b(()=>n.nextId++);static add(){return n.pool.addObj()}static findIndex(t){return n.pool.findIndex(t)}static delete(t){return n.pool.removeObj(t)}};var a=class n{static indexMap=new Map;static entityMasks=[];static archetypeMap=new Map;static worlds=[];static removeMap=new Map;static ownerMap=new Map;timeMilli=0;dtMilli=0;localEntities=new Set;constructor(){n.worlds.push(this)}static createEntity(){let t=T.add();return n.entityMasks[t]=0,n.getArchetype(0).add(t),t}static getArchetype(t){let e=n.archetypeMap.get(t);if(e==null){let o=new Set;return n.archetypeMap.set(t,o),o}return e}static deleteEntity(t){for(let o=0,i=n.worlds.length;o<i;o++)n.worlds[o].removeEntity(t);let e=p.types();for(let o=0,i=p.typeLen();o<i;o++){if(!(n.entityMasks[t]&1<<o))continue;n.getRemoveFn(o)(t);let s=n.getIndices(e[o]),r=n.getOwners(e[o]),l=r[r.length-1];r[s[t]]=l,s[l]=s[t]}n.getArchetype(n.entityMasks[t]).delete(t),n.entityMasks[t]=0,T.delete(T.findIndex(t))}static getRemoveFn(t){let e=n.removeMap.get(t);if(e==null)throw new Error("Component not registered.");return e}addEntity(t){return t??=n.createEntity(),this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){if(!this.localEntities.has(t))throw new Error(`Entity ${t} does not exist.`)}static componentExists(t){n.indexMap.has(t)||n.registerComponent(t)}static registerComponent(t){return p.register(t),n.indexMap.set(t,[]),n.removeMap.set(p.getId(t),e=>p.delete(t,this.getIndices(t)[e])),n.ownerMap.set(t,[]),n}static hasComponent(t,e){return(n.entityMasks[t]&1<<p.getId(e))>0}static addComponent(t,e){if(n.componentExists(e),n.hasComponent(t,e))throw new Error(`Entity ${t} already had this component.`);n.getArchetype(n.entityMasks[t]).delete(t),n.entityMasks[t]|=1<<p.getId(e),n.getArchetype(n.entityMasks[t]).add(t);let o=p.len(e);return n.getIndices(e)[t]=o,n.getOwners(e)[o]=t,p.add(e)}static getIndices(t){let e=n.indexMap.get(t);if(e==null)throw new Error("Component not registered.");return e}static getOwners(t){let e=n.ownerMap.get(t);if(e==null)throw new Error("Component not registered.");return e}static removeComponent(t,e){if(n.componentExists(e),!n.hasComponent(t,e))throw new Error(`Entity ${t} does not have this component.`);n.getArchetype(n.entityMasks[t]).delete(t),n.entityMasks[t]&=~(1<<p.getId(e)),n.getArchetype(n.entityMasks[t]).add(t);let o=n.getIndices(e),i=n.getOwners(e),s=p.delete(e,o[t]),r=i[i.length-1];return i[o[t]]=r,o[r]=o[t],s}static getComponent(t,e){if(!n.hasComponent(t,e))throw new Error(`Entity ${t} does not have this component.`);return p.get(e,n.getIndices(e)[t])}update(...t){for(let e=0,o=t.length;e<o;e++)t[e](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let e=0,o=0,i=0;if(t.and)for(let r=0,l=t.and.length;r<l;r++)e|=1<<p.getId(t.and[r]);if(t.or)for(let r=0,l=t.or.length;r<l;r++)o|=1<<p.getId(t.or[r]);if(t.not)for(let r=0,l=t.not.length;r<l;r++)i|=1<<p.getId(t.not[r]);let s=[];for(let r=n.archetypeMap.keys().toArray(),l=r.length,u=0,g=r[u];u<l;u++,g=r[u])(g&e)==e&&(g|o)>0&&(g&i)==0&&s.push(...this.localEntities.intersection(n.getArchetype(g)));return s}entityCount(){return this.localEntities.size}};var d={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var f=document.querySelector("canvas"),h=f?.getContext("2d"),m={width:1,height:1,color:"white"},y={x:0,y:0},x={x:0,y:0},E={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},k={isLeft:!0},j=new a;function L(n){n.query({and:[x,k]}).forEach(t=>{let e=a.getComponent(t,x),o=a.getComponent(t,k);e.y=0,o.isLeft?(M.w&&(e.y-=1),M.s&&(e.y+=1)):(M.ArrowUp&&(e.y-=1),M.ArrowDown&&(e.y+=1));for(let i of Object.values(I)){if(h){let s=h.fillStyle;h.fillStyle="green",h.fillRect(i.x,i.y,20,20),h.fillStyle=s}if(i.x<d.playArea.width*.5){if(!o.isLeft)continue}else if(o.isLeft)continue;i.y<d.playArea.height*.5&&(e.y-=1),i.y>d.playArea.height*.5&&(e.y+=1)}e.y=e.y/Math.abs(e.y||1)*d.paddle.speed})}function $(){!h||!f||h.fillRect(0,0,f.width,f.height)}function B(n){let t=n.dtMilli/1e3;n.query({and:[y,x]}).forEach(e=>{let o=a.getComponent(e,y),i=a.getComponent(e,x);o.x+=i.x*t,o.y+=i.y*t})}function F(n){h&&n.query({and:[m,y]}).forEach(t=>{let e=a.getComponent(t,y),o=a.getComponent(t,m),i=h.fillStyle;h.fillStyle=o.color,h.fillRect(Math.floor(e.x-o.width*.5),Math.floor(e.y-o.height*.5),o.width,o.height),h.fillStyle=i})}function H(n){h&&n.query({and:[E,y]}).forEach(t=>{let e=a.getComponent(t,E),o=a.getComponent(t,y);h.font=`${e.fontSize}px serif`;let i=h.measureText(e.content),s=h.fillStyle;h.fillStyle=e.backgroundColor,h.fillRect(o.x,o.y,e.padding*2+i.width,e.padding*2+i.fontBoundingBoxAscent),h.fillStyle=e.color,h.fillText(e.content,o.x+e.padding,o.y+e.padding+i.fontBoundingBoxAscent),h.fillStyle=s})}function q(n){let t=n.query({and:[y,m]});t.forEach(e=>{let o=a.getComponent(e,y),i=a.getComponent(e,m);t.forEach(s=>{if(s==e)return;let r=a.getComponent(s,y),l=a.getComponent(s,m);(o.x-r.x)**2<((i.width+l.width)*.5)**2&&(o.y-r.y)**2<((i.height+l.height)*.5)**2&&U(e,s)})})}function G(){let n=a.getComponent(v,y),t=a.getComponent(v,m);n.x-t.width>d.playArea.width&&(C.left++,S()),n.x+t.width<0&&(C.right++,S())}function O(n,t,e){let o=A(n,t,d.paddle.width,d.paddle.height),i=a.addComponent(o,k);return i.isLeft=e,j.addEntity(o)}function A(n,t,e,o,i="white"){let s=a.createEntity(),r=a.addComponent(s,y),l=a.addComponent(s,x),u=a.addComponent(s,m);return r.x=n,r.y=t,u.width=e,u.height=o,u.color=i,j.addEntity(s)}function N(n,t=0,e=0,o="black",i=20,s="rgba(0,0,0,0)"){let r=a.createEntity(),l=a.addComponent(r,E),u=a.addComponent(r,y);return l.content=n,l.color=o,l.fontSize=i,l.backgroundColor=s,u.x=t,u.y=e,j.addEntity(r)}f&&(f.width=d.playArea.width,f.height=d.playArea.height);var M={};globalThis.onkeydown=n=>{M[n.key]=!0};globalThis.onkeyup=n=>{delete M[n.key]};var I={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=n=>{if(!f)return;let t=f.getBoundingClientRect();for(let e=0,o=n.changedTouches.length;e<o;e++){let i=I[n.changedTouches[e].identifier]={x:n.changedTouches[e].clientX,y:n.changedTouches[e].clientY};i.x-=t.left,i.y-=t.top,innerWidth/innerHeight<f.width/f.height?(i.x*=f.width/innerWidth,i.y*=f.width/innerWidth):(i.x*=f.height/innerHeight,i.y*=f.height/innerHeight)}};globalThis.window.ontouchend=n=>{for(let t=0,e=n.changedTouches.length;t<e;t++)delete I[n.changedTouches[t].identifier]};A(d.playArea.width*.5,d.playArea.height*0,d.playArea.width,10);A(d.playArea.width*.5,d.playArea.height*1,d.playArea.width,10);var v=A(d.playArea.width*.5,d.playArea.height*.5,d.ball.width,d.ball.height),V=O(d.playArea.width*d.paddle.padding,d.playArea.height*.5,!0),D=O(d.playArea.width*(1-d.paddle.padding),d.playArea.height*.5,!1);function P(){let n=a.getComponent(v,x),t=a.getComponent(v,y);t.x=d.playArea.width*.5,t.y=d.playArea.height*.5,n.x=d.ball.speed,n.y=0;let e=Math.random()*40/180*Math.PI;e*=Math.random()>.5?1:-1,e+=Math.random()>.5?Math.PI:0,K(n,e);let o=a.getComponent(V,y),i=a.getComponent(D,y);o.y=d.playArea.height*.5,i.y=d.playArea.height*.5}function K(n,t){let e=Math.sin(t),o=Math.cos(t),i=n.x,s=n.y;n.x=o*i-e*s,n.y=e*i+o*s}function S(){let n=a.getComponent(z,E);n.content=`${C.left} : ${C.right}`,P()}function U(n,t){let e=a.getComponent(n,y),o=a.getComponent(t,y),i=a.getComponent(n,m),s=a.getComponent(t,m),r=a.getComponent(n,x),l=a.getComponent(t,x),u=(r.x**2+r.y**2)**.5,g=r.x/u,w=r.y/u,c=0;g!=0&&(c=(o.x-(s.width+i.width)*.5-e.x)/g,e.x<o.x&&c<0&&e.y+c*w<o.y+(s.height+i.height)*.5&&e.y+c*w>o.y-(s.height+i.height)*.5&&(e.x+=c*g,e.y+=c*w,r.x>0&&(r.x*=-1),r.y+=l.y),c=(o.x+(s.width+i.width)*.5-e.x)/g,e.x>o.x&&c<0&&e.y+c*w<o.y+(s.height+i.height)*.5&&e.y+c*w>o.y-(s.height+i.height)*.5&&(e.x+=c*g,e.y+=c*w,r.x<0&&(r.x*=-1),r.y+=l.y)),w!=0&&(c=(o.y-(s.height+i.height)*.5-e.y)/w,e.y<o.y&&c<0&&e.x+c*g<o.x+(s.width+i.width)*.5&&e.x+c*g>o.x-(s.width+i.width)*.5&&(e.x+=c*g,e.y+=c*w,r.y>0&&(r.y*=-1)),c=(o.y+(s.height+i.height)*.5-e.y)/w,e.y>o.y&&c<0&&e.x+c*g<o.x+(s.width+i.width)*.5&&e.x+c*g>o.x-(s.width+i.width)*.5&&(e.x+=c*g,e.y+=c*w,r.y<0&&(r.y*=-1)))}var C={left:0,right:0},z=N(`${C.left} : ${C.right}`),R=a.getComponent(z,E);R.color="white";R.fontSize=40;P();(function n(){j.update($,F,H,B,L,q,G),requestAnimationFrame(n)})();})();
//# sourceMappingURL=out.js.map
