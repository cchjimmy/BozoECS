(()=>{var b=class{storage=[];indices=new Map;objectFactory;size=0;constructor(e){this.objectFactory=e}len(){return this.size}addObj(e){let t;return this.size<this.storage.length?t=this.storage[this.size]:(t=this.objectFactory(),this.storage.push(t)),this.indices.set(e,this.size),this.size++,t}removeObj(e){let t=this.indices.get(e)??-1;if(t<0||t>=this.size)return!1;let i=this.storage[t];this.storage[t]=this.storage[this.size-1],this.storage[this.size-1]=i;for(let[o,s]of this.indices)if(s==this.size-1){this.indices.set(o,t);break}return this.indices.delete(e),this.size--,!0}getObj(e){let t=this.indices.get(e)??-1;if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var d=class n{static pools=new Map;static idMap=new Map;static register(e){n.pools.has(e)||(n.idMap.set(e,n.idMap.size),n.pools.set(e,new b(()=>({...e}))))}static getId(e){return n.idMap.get(e)??-1}static add(e,t){return Object.assign(n.pools.get(t).addObj(e),t)}static delete(e,t){return n.pools.get(t).removeObj(e)}static get(e,t){return n.pools.get(t).getObj(e)}static len(e){return n.pools.get(e).len()}static typeLen(){return n.pools.size}static types(){return n.pools.keys().toArray()}};var a=class n{static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static entitiesToDelete=[];localEntities=new Set;constructor(){n.worlds.push(this)}static createEntity(){let e=Math.random();return n.maskMap.set(e,0),n.getArchetype(0).add(e),e}static copyEntity(e){let t=Math.random(),i=d.types(),o=this.maskMap.get(e)??0;n.maskMap.set(t,o),n.getArchetype(o).add(t);for(let s=0,r=i.length;s<r;s++)o&1<<s&&Object.assign(d.add(t,i[s]),d.get(e,i[s]));return t}static getArchetype(e){let t=n.archetypeMap.get(e)??new Set;return n.archetypeMap.set(e,t),t}static deleteEntity(e){n.entitiesToDelete.push(e)}addEntity(e=n.createEntity()){return this.localEntities.add(e),e}removeEntity(e){this.localEntities.delete(e)}static registerComponent(e){return d.register(e),n}static hasComponent(e,t){return((n.maskMap.get(e)??0)&1<<d.getId(t))>0}static addComponent(e,t,i=t){n.registerComponent(t);let o=n.maskMap.get(e)??0,s=d.getId(t);return(o&1<<s)!=0?Object.assign(d.get(e,t),i):(n.getArchetype(o).delete(e),o|=1<<s,n.maskMap.set(e,o),n.getArchetype(o).add(e),Object.assign(d.add(e,t),i))}static removeComponent(e,t){n.registerComponent(t);let i=n.maskMap.get(e)??0,o=d.getId(t);return(i&1<<o)==0?!1:(n.getArchetype(i).delete(e),i&=~(1<<o),n.maskMap.set(e,i),n.getArchetype(i).add(e),d.delete(e,t))}static getComponent(e,t){return d.get(e,t)}update(...e){for(let t=0,i=e.length;t<i;t++)e[t](this);for(;n.entitiesToDelete.length;){let t=n.entitiesToDelete.pop();for(let s=0,r=n.worlds.length;s<r;s++)n.worlds[s].localEntities.delete(t);let i=d.types(),o=n.maskMap.get(t)??0;n.getArchetype(o).delete(t);for(let s=0,r=i.length;s<r;s++)o&1<<s&&d.delete(t,i[s])}}query(e){let t=0,i=0;if(e.and)for(let s=0,r=e.and.length;s<r;s++)t|=1<<d.getId(e.and[s]);if(e.not)for(let s=0,r=e.not.length;s<r;s++)i|=1<<d.getId(e.not[s]);let o=[];for(let s=n.archetypeMap.keys().toArray(),r=s.length,p=0;p<r;p++){let u=s[p],f=n.getArchetype(u);f.size!=0&&(u&t)==t&&(u&i)==0&&o.push(...f)}return[...this.localEntities.intersection(new Set(o))]}entityCount(){return this.localEntities.size}};var c={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var y=document.querySelector("canvas"),l=y?.getContext("2d"),m={width:1,height:1,color:"white"},g={x:0,y:0},x={x:0,y:0},A={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},z={isLeft:!0},E=new a;function D(n){n.query({and:[x,z]}).forEach(e=>{let t=a.getComponent(e,x),i=a.getComponent(e,z);t.y=0,i.isLeft?(C.w&&(t.y-=1),C.s&&(t.y+=1)):(C.ArrowUp&&(t.y-=1),C.ArrowDown&&(t.y+=1));for(let o of Object.values(j)){if(l){let s=l.fillStyle;l.fillStyle="green",l.fillRect(o.x,o.y,20,20),l.fillStyle=s}if(o.x<c.playArea.width*.5){if(!i.isLeft)continue}else if(i.isLeft)continue;o.y<c.playArea.height*.5&&(t.y-=1),o.y>c.playArea.height*.5&&(t.y+=1)}t.y=t.y/Math.abs(t.y||1)*c.paddle.speed})}function $(){!l||!y||l.fillRect(0,0,y.width,y.height)}function F(n){let e=S/1e3;n.query({and:[g,x]}).forEach(t=>{let i=a.getComponent(t,g),o=a.getComponent(t,x);i.x+=o.x*e,i.y+=o.y*e})}function q(n){l&&n.query({and:[m,g]}).forEach(e=>{let t=a.getComponent(e,g),i=a.getComponent(e,m),o=l.fillStyle;l.fillStyle=i.color,l.fillRect(Math.floor(t.x-i.width*.5),Math.floor(t.y-i.height*.5),i.width,i.height),l.fillStyle=o})}function H(n){l&&n.query({and:[A,g]}).forEach(e=>{let t=a.getComponent(e,A),i=a.getComponent(e,g);l.font=`${t.fontSize}px serif`;let o=l.measureText(t.content),s=l.fillStyle;l.fillStyle=t.backgroundColor,l.fillRect(i.x,i.y,t.padding*2+o.width,t.padding*2+o.fontBoundingBoxAscent),l.fillStyle=t.color,l.fillText(t.content,i.x+t.padding,i.y+t.padding+o.fontBoundingBoxAscent),l.fillStyle=s})}function W(n){let e=n.query({and:[g,m]});e.forEach(t=>{let i=a.getComponent(t,g),o=a.getComponent(t,m);e.forEach(s=>{if(s==t)return;let r=a.getComponent(s,g),p=a.getComponent(s,m);(i.x-r.x)**2<((o.width+p.width)*.5)**2&&(i.y-r.y)**2<((o.height+p.height)*.5)**2&&Y(t,s)})})}function G(){let n=a.getComponent(k,g),e=a.getComponent(k,m);n.x-e.width>c.playArea.width&&(M.left++,v()),n.x+e.width<0&&(M.right++,v())}function O(n,e,t){let i=T(n,e,c.paddle.width,c.paddle.height),o=a.addComponent(i,z);return o.isLeft=t,E.addEntity(i)}function T(n,e,t,i,o="white"){let s=a.createEntity(),r=a.addComponent(s,g),p=a.addComponent(s,x),u=a.addComponent(s,m);return r.x=n,r.y=e,u.width=t,u.height=i,u.color=o,E.addEntity(s)}function N(n,e=0,t=0,i="black",o=20,s="rgba(0,0,0,0)"){let r=a.createEntity(),p=a.addComponent(r,A),u=a.addComponent(r,g);return p.content=n,p.color=i,p.fontSize=o,p.backgroundColor=s,u.x=e,u.y=t,E.addEntity(r)}y&&(y.width=c.playArea.width,y.height=c.playArea.height);var C={};globalThis.onkeydown=n=>{C[n.key]=!0};globalThis.onkeyup=n=>{delete C[n.key]};var j={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=n=>{if(!y)return;let e=y.getBoundingClientRect();for(let t=0,i=n.changedTouches.length;t<i;t++){let o=j[n.changedTouches[t].identifier]={x:n.changedTouches[t].clientX,y:n.changedTouches[t].clientY};o.x-=e.left,o.y-=e.top,innerWidth/innerHeight<y.width/y.height?(o.x*=y.width/innerWidth,o.y*=y.width/innerWidth):(o.x*=y.height/innerHeight,o.y*=y.height/innerHeight)}};globalThis.window.ontouchend=n=>{for(let e=0,t=n.changedTouches.length;e<t;e++)delete j[n.changedTouches[e].identifier]};T(c.playArea.width*.5,c.playArea.height*0,c.playArea.width,10);T(c.playArea.width*.5,c.playArea.height*1,c.playArea.width,10);var k=T(c.playArea.width*.5,c.playArea.height*.5,c.ball.width,c.ball.height),V=O(c.playArea.width*c.paddle.padding,c.playArea.height*.5,!0),U=O(c.playArea.width*(1-c.paddle.padding),c.playArea.height*.5,!1);function P(){let n=a.getComponent(k,x),e=a.getComponent(k,g);e.x=c.playArea.width*.5,e.y=c.playArea.height*.5,n.x=c.ball.speed,n.y=0;let t=Math.random()*40/180*Math.PI;t*=Math.random()>.5?1:-1,t+=Math.random()>.5?Math.PI:0,X(n,t);let i=a.getComponent(V,g),o=a.getComponent(U,g);i.y=c.playArea.height*.5,o.y=c.playArea.height*.5}function X(n,e){let t=Math.sin(e),i=Math.cos(e),o=n.x,s=n.y;n.x=i*o-t*s,n.y=t*o+i*s}function v(){let n=a.getComponent(R,A);n.content=`${M.left} : ${M.right}`,P()}function Y(n,e){let t=a.getComponent(n,g),i=a.getComponent(e,g),o=a.getComponent(n,m),s=a.getComponent(e,m),r=a.getComponent(n,x),p=a.getComponent(e,x),u=(r.x**2+r.y**2)**.5,f=r.x/u,w=r.y/u,h=0;f!=0&&(h=(i.x-(s.width+o.width)*.5-t.x)/f,t.x<i.x&&h<0&&t.y+h*w<i.y+(s.height+o.height)*.5&&t.y+h*w>i.y-(s.height+o.height)*.5&&(t.x+=h*f,t.y+=h*w,r.x>0&&(r.x*=-1),r.y+=p.y),h=(i.x+(s.width+o.width)*.5-t.x)/f,t.x>i.x&&h<0&&t.y+h*w<i.y+(s.height+o.height)*.5&&t.y+h*w>i.y-(s.height+o.height)*.5&&(t.x+=h*f,t.y+=h*w,r.x<0&&(r.x*=-1),r.y+=p.y)),w!=0&&(h=(i.y-(s.height+o.height)*.5-t.y)/w,t.y<i.y&&h<0&&t.x+h*f<i.x+(s.width+o.width)*.5&&t.x+h*f>i.x-(s.width+o.width)*.5&&(t.x+=h*f,t.y+=h*w,r.y>0&&(r.y*=-1)),h=(i.y+(s.height+o.height)*.5-t.y)/w,t.y>i.y&&h<0&&t.x+h*f<i.x+(s.width+o.width)*.5&&t.x+h*f>i.x-(s.width+o.width)*.5&&(t.x+=h*f,t.y+=h*w,r.y<0&&(r.y*=-1)))}var M={left:0,right:0},R=N(`${M.left} : ${M.right}`),L=a.getComponent(R,A);L.color="white";L.fontSize=40;var S=0,I=0;P();(function n(){E.update($,q,H,F,D,W,G),S=performance.now()-I,I+=S,requestAnimationFrame(n)})();})();
//# sourceMappingURL=out.js.map
