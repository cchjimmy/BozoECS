(()=>{var k=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;size=0;constructor(e){this.objectFactory=e}len(){return this.size}add(e){let t=this.keyToIndex.get(e);return t!=null?this.storage[t]:(this.size>=this.storage.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(e,this.size),this.indexToKey[this.size]=e,this.size++,this.storage[this.size-1])}remove(e){let t=this.keyToIndex.get(e)??-1,n=this.indexToKey[this.size-1];if(t<0||t>=this.size||!n)return!1;let o=this.storage[t];return this.storage[t]=this.storage[this.size-1],this.storage[this.size-1]=o,this.keyToIndex.set(n,t),this.keyToIndex.delete(e),this.indexToKey[t]=n,this.size--,!0}get(e){let t=this.keyToIndex.get(e)??-1;if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}has(e){return this.keyToIndex.has(e)}clean(){this.storage.splice(this.size),this.indexToKey.splice(this.size);for(let e of this.keyToIndex.keys()){let t=this.keyToIndex.get(e)??-1;(t<0||t>=this.size)&&this.keyToIndex.delete(e)}}};var A=class{pools=new Map;idMap=new Map;register(e){this.pools.has(e)||(this.idMap.set(e,this.idMap.size),this.pools.set(e,new k(()=>({...e}))))}getId(e){return this.idMap.get(e)??-1}add(e,t){return Object.assign(this.pools.get(t).add(e),t)}remove(e,t){return this.pools.get(t).remove(e)}get(e,t){return this.pools.get(t).get(e)}len(e){return this.pools.get(e).len()}delete(e){for(let t of this.pools.values())t.remove(e)}copy(e,t){for(let n of this.pools.values()){let o=n;o.has(e)&&Object.assign(o.add(t),o.get(e))}}clean(){for(let e of this.pools.values())e.clean()}};function I(){return Math.random()}var T=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new A;frameCount=0;cleanUpMinutes=5;constructor(e=5){this.cleanUpMinutes=e}createEntity(){let e=I();return this.maskMap.set(e,0),this.getArchetype(0).add(e),e}copyEntity(e,t=I()){this.compManager.copy(e,t);let n=this.maskMap.get(e)??0;return this.maskMap.set(t,n),this.getArchetype(n).add(t),t}getArchetype(e){let t=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,t),t}deleteEntity(e){this.entitiesToDelete.push(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,t){return((this.maskMap.get(e)??0)&1<<this.compManager.getId(t))>0}addComponent(e,t,n=t){this.registerComponent(t);let o=this.maskMap.get(e)??0,s=this.compManager.getId(t);return(o&1<<s)!=0?Object.assign(this.compManager.get(e,t),n):(this.getArchetype(o).delete(e),o|=1<<s,this.maskMap.set(e,o),this.getArchetype(o).add(e),Object.assign(this.compManager.add(e,t),n))}removeComponent(e,t){this.registerComponent(t);let n=this.maskMap.get(e)??0,o=this.compManager.getId(t);return(n&1<<o)==0?!1:(this.getArchetype(n).delete(e),n&=~(1<<o),this.maskMap.set(e,n),this.getArchetype(n).add(e),this.compManager.remove(e,t))}getComponent(e,t){return this.compManager.get(e,t)}update(...e){for(let t=0,n=e.length;t<n;t++)e[t](this);this.commitEntityDeletion(),this.frameCount%(this.cleanUpMinutes*60*60)==0&&this.cleanObjectPools(),this.frameCount++}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let e=this.entitiesToDelete.pop();this.compManager.delete(e);let t=this.maskMap.get(e)??0;this.maskMap.delete(e),this.getArchetype(t).delete(e)}}cleanObjectPools(){this.compManager.clean()}query(e){let t=0,n=0;if(e.and)for(let s=0,h=e.and.length;s<h;s++)t|=1<<this.compManager.getId(e.and[s]);if(e.not)for(let s=0,h=e.not.length;s<h;s++)n|=1<<this.compManager.getId(e.not[s]);let o=[];for(let s of this.archetypeMap.keys()){let h=this.getArchetype(s);h.size>0&&(s&t)==t&&(s&n)==0&&o.push(...h)}return[...new Set(o)]}entityCount(){return this.maskMap.size}};var a={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var p=document.querySelector("canvas"),c=p?.getContext("2d"),m={width:1,height:1,color:"white"},d={x:0,y:0},x={x:0,y:0},C={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},v={isLeft:!0},l=new T;function K(i){i.query({and:[x,v]}).forEach(e=>{let t=i.getComponent(e,x),n=i.getComponent(e,v);t.y=0,n.isLeft?(w.w&&(t.y-=1),w.s&&(t.y+=1)):(w.ArrowUp&&(t.y-=1),w.ArrowDown&&(t.y+=1));for(let o of Object.values(E)){if(c){let s=c.fillStyle;c.fillStyle="green",c.fillRect(o.x,o.y,20,20),c.fillStyle=s}if(o.x<a.playArea.width*.5){if(!n.isLeft)continue}else if(n.isLeft)continue;o.y<a.playArea.height*.5&&(t.y-=1),o.y>a.playArea.height*.5&&(t.y+=1)}t.y=t.y/Math.abs(t.y||1)*a.paddle.speed})}function $(){!c||!p||c.fillRect(0,0,p.width,p.height)}function F(i){let e=S/1e3;i.query({and:[d,x]}).forEach(t=>{let n=i.getComponent(t,d),o=i.getComponent(t,x);n.x+=o.x*e,n.y+=o.y*e})}function U(i){c&&i.query({and:[m,d]}).forEach(e=>{let t=i.getComponent(e,d),n=i.getComponent(e,m),o=c.fillStyle;c.fillStyle=n.color,c.fillRect(Math.floor(t.x-n.width*.5),Math.floor(t.y-n.height*.5),n.width,n.height),c.fillStyle=o})}function q(i){c&&i.query({and:[C,d]}).forEach(e=>{let t=i.getComponent(e,C),n=i.getComponent(e,d);c.font=`${t.fontSize}px serif`;let o=c.measureText(t.content),s=c.fillStyle;c.fillStyle=t.backgroundColor,c.fillRect(n.x,n.y,t.padding*2+o.width,t.padding*2+o.fontBoundingBoxAscent),c.fillStyle=t.color,c.fillText(t.content,n.x+t.padding,n.y+t.padding+o.fontBoundingBoxAscent),c.fillStyle=s})}function H(i){let e=i.query({and:[d,m]});e.forEach(t=>{let n=i.getComponent(t,d),o=i.getComponent(t,m);e.forEach(s=>{if(s==t)return;let h=i.getComponent(s,d),g=i.getComponent(s,m);(n.x-h.x)**2<((o.width+g.width)*.5)**2&&(n.y-h.y)**2<((o.height+g.height)*.5)**2&&Y(t,s)})})}function W(i){let e=i.getComponent(b,d),t=i.getComponent(b,m);e.x-t.width>a.playArea.width&&(M.left++,P()),e.x+t.width<0&&(M.right++,P())}function R(i,e,t){let n=z(i,e,a.paddle.width,a.paddle.height),o=l.addComponent(n,v);return o.isLeft=t,n}function z(i,e,t,n,o="white"){let s=l.createEntity(),h=l.addComponent(s,d),g=l.addComponent(s,x),u=l.addComponent(s,m);return h.x=i,h.y=e,u.width=t,u.height=n,u.color=o,s}function G(i,e=0,t=0,n="black",o=20,s="rgba(0,0,0,0)"){let h=l.createEntity(),g=l.addComponent(h,C),u=l.addComponent(h,d);return g.content=i,g.color=n,g.fontSize=o,g.backgroundColor=s,u.x=e,u.y=t,h}p&&(p.width=a.playArea.width,p.height=a.playArea.height);var w={};globalThis.onkeydown=i=>{w[i.key]=!0};globalThis.onkeyup=i=>{delete w[i.key]};var E={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=i=>{if(!p)return;let e=p.getBoundingClientRect();for(let t=0,n=i.changedTouches.length;t<n;t++){let o=E[i.changedTouches[t].identifier]={x:i.changedTouches[t].clientX,y:i.changedTouches[t].clientY};o.x-=e.left,o.y-=e.top,innerWidth/innerHeight<p.width/p.height?(o.x*=p.width/innerWidth,o.y*=p.width/innerWidth):(o.x*=p.height/innerHeight,o.y*=p.height/innerHeight)}};globalThis.window.ontouchend=i=>{for(let e=0,t=i.changedTouches.length;e<t;e++)delete E[i.changedTouches[e].identifier]};z(a.playArea.width*.5,a.playArea.height*0,a.playArea.width,10);z(a.playArea.width*.5,a.playArea.height*1,a.playArea.width,10);var b=z(a.playArea.width*.5,a.playArea.height*.5,a.ball.width,a.ball.height),N=R(a.playArea.width*a.paddle.padding,a.playArea.height*.5,!0),V=R(a.playArea.width*(1-a.paddle.padding),a.playArea.height*.5,!1);function D(){let i=l.getComponent(b,x),e=l.getComponent(b,d);e.x=a.playArea.width*.5,e.y=a.playArea.height*.5,i.x=a.ball.speed,i.y=0;let t=Math.random()*40/180*Math.PI;t*=Math.random()>.5?1:-1,t+=Math.random()>.5?Math.PI:0,X(i,t);let n=l.getComponent(N,d),o=l.getComponent(V,d);n.y=a.playArea.height*.5,o.y=a.playArea.height*.5}function X(i,e){let t=Math.sin(e),n=Math.cos(e),o=i.x,s=i.y;i.x=n*o-t*s,i.y=t*o+n*s}function P(){let i=l.getComponent(L,C);i.content=`${M.left} : ${M.right}`,D()}function Y(i,e){let t=l.getComponent(i,d),n=l.getComponent(e,d),o=l.getComponent(i,m),s=l.getComponent(e,m),h=l.getComponent(i,x),g=l.getComponent(e,x),u=(h.x**2+h.y**2)**.5,y=h.x/u,f=h.y/u,r=0;y!=0&&(r=(n.x-(s.width+o.width)*.5-t.x)/y,t.x<n.x&&r<0&&t.y+r*f<n.y+(s.height+o.height)*.5&&t.y+r*f>n.y-(s.height+o.height)*.5&&(t.x+=r*y,t.y+=r*f,h.x>0&&(h.x*=-1),h.y+=g.y),r=(n.x+(s.width+o.width)*.5-t.x)/y,t.x>n.x&&r<0&&t.y+r*f<n.y+(s.height+o.height)*.5&&t.y+r*f>n.y-(s.height+o.height)*.5&&(t.x+=r*y,t.y+=r*f,h.x<0&&(h.x*=-1),h.y+=g.y)),f!=0&&(r=(n.y-(s.height+o.height)*.5-t.y)/f,t.y<n.y&&r<0&&t.x+r*y<n.x+(s.width+o.width)*.5&&t.x+r*y>n.x-(s.width+o.width)*.5&&(t.x+=r*y,t.y+=r*f,h.y>0&&(h.y*=-1)),r=(n.y+(s.height+o.height)*.5-t.y)/f,t.y>n.y&&r<0&&t.x+r*y<n.x+(s.width+o.width)*.5&&t.x+r*y>n.x-(s.width+o.width)*.5&&(t.x+=r*y,t.y+=r*f,h.y<0&&(h.y*=-1)))}var M={left:0,right:0},L=G(`${M.left} : ${M.right}`),O=l.getComponent(L,C);O.color="white";O.fontSize=40;var S=0,j=0;D();(function i(){l.update($,U,q,F,K,H,W),S=performance.now()-j,j+=S,requestAnimationFrame(i)})();})();
//# sourceMappingURL=out.js.map
