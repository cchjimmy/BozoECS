(()=>{var k=class{storage=[];indices=new Map;objectFactory;size=0;constructor(e){this.objectFactory=e}len(){return this.size}add(e){let t=this.indices.get(e);return t!=null?this.storage[t]:(this.size>=this.storage.length&&this.storage.push(this.objectFactory()),this.indices.set(e,this.size),this.size++,this.storage[this.size-1])}remove(e){let t=this.indices.get(e)??-1;if(t<0||t>=this.size)return!1;let o=this.storage[t];this.storage[t]=this.storage[this.size-1],this.storage[this.size-1]=o;for(let[i,s]of this.indices)if(s==this.size-1){this.indices.set(i,t);break}return this.indices.delete(e),this.size--,!0}get(e){let t=this.indices.get(e)??-1;if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}has(e){return this.indices.has(e)}};function b(){return Math.random()}var p=class n{static pools=new Map;static idMap=new Map;static register(e){n.pools.has(e)||(n.idMap.set(e,n.idMap.size),n.pools.set(e,new k(()=>({...e}))))}static getId(e){return n.idMap.get(e)??-1}static add(e,t){return Object.assign(n.pools.get(t).add(e),t)}static remove(e,t){return n.pools.get(t).remove(e)}static get(e,t){return n.pools.get(t).get(e)}static len(e){return n.pools.get(e).len()}static delete(e){for(let t of this.pools){let o=t[1];o.has(e)&&o.remove(e)}}static copy(e){let t=b();for(let o of this.pools){let i=o[1];i.has(e)&&Object.assign(i.add(t),i.get(e))}return t}};var a=class n{static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static entitiesToDelete=[];localEntities=new Set;constructor(){n.worlds.push(this)}static createEntity(){let e=b();return n.maskMap.set(e,0),n.getArchetype(0).add(e),e}static copyEntity(e){let t=p.copy(e),o=this.maskMap.get(e)??0;return this.maskMap.set(t,o),this.getArchetype(o).add(t),t}static getArchetype(e){let t=n.archetypeMap.get(e)??new Set;return n.archetypeMap.set(e,t),t}static deleteEntity(e){n.entitiesToDelete.push(e)}addEntity(e=n.createEntity()){return this.localEntities.add(e),e}removeEntity(e){this.localEntities.delete(e)}static registerComponent(e){return p.register(e),n}static hasComponent(e,t){return((n.maskMap.get(e)??0)&1<<p.getId(t))>0}static addComponent(e,t,o=t){n.registerComponent(t);let i=n.maskMap.get(e)??0,s=p.getId(t);return(i&1<<s)!=0?Object.assign(p.get(e,t),o):(n.getArchetype(i).delete(e),i|=1<<s,n.maskMap.set(e,i),n.getArchetype(i).add(e),Object.assign(p.add(e,t),o))}static removeComponent(e,t){n.registerComponent(t);let o=n.maskMap.get(e)??0,i=p.getId(t);return(o&1<<i)==0?!1:(n.getArchetype(o).delete(e),o&=~(1<<i),n.maskMap.set(e,o),n.getArchetype(o).add(e),p.remove(e,t))}static getComponent(e,t){return p.get(e,t)}update(...e){for(let t=0,o=e.length;t<o;t++)e[t](this);for(;n.entitiesToDelete.length;){let t=n.entitiesToDelete.pop();for(let i=0,s=n.worlds.length;i<s;i++)n.worlds[i].localEntities.delete(t);p.delete(t);let o=n.maskMap.get(t)??0;n.maskMap.delete(t),n.getArchetype(o).delete(t)}}query(e){let t=0,o=0;if(e.and)for(let s=0,h=e.and.length;s<h;s++)t|=1<<p.getId(e.and[s]);if(e.not)for(let s=0,h=e.not.length;s<h;s++)o|=1<<p.getId(e.not[s]);let i=[];for(let s=n.archetypeMap.keys().toArray(),h=s.length,g=0;g<h;g++){let u=s[g],f=n.getArchetype(u);f.size!=0&&(u&t)==t&&(u&o)==0&&i.push(...f)}return[...this.localEntities.intersection(new Set(i))]}entityCount(){return this.localEntities.size}};var r={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var y=document.querySelector("canvas"),l=y?.getContext("2d"),m={width:1,height:1,color:"white"},d={x:0,y:0},x={x:0,y:0},A={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},v={isLeft:!0},T=new a;function $(n){n.query({and:[x,v]}).forEach(e=>{let t=a.getComponent(e,x),o=a.getComponent(e,v);t.y=0,o.isLeft?(C.w&&(t.y-=1),C.s&&(t.y+=1)):(C.ArrowUp&&(t.y-=1),C.ArrowDown&&(t.y+=1));for(let i of Object.values(I)){if(l){let s=l.fillStyle;l.fillStyle="green",l.fillRect(i.x,i.y,20,20),l.fillStyle=s}if(i.x<r.playArea.width*.5){if(!o.isLeft)continue}else if(o.isLeft)continue;i.y<r.playArea.height*.5&&(t.y-=1),i.y>r.playArea.height*.5&&(t.y+=1)}t.y=t.y/Math.abs(t.y||1)*r.paddle.speed})}function F(){!l||!y||l.fillRect(0,0,y.width,y.height)}function q(n){let e=S/1e3;n.query({and:[d,x]}).forEach(t=>{let o=a.getComponent(t,d),i=a.getComponent(t,x);o.x+=i.x*e,o.y+=i.y*e})}function H(n){l&&n.query({and:[m,d]}).forEach(e=>{let t=a.getComponent(e,d),o=a.getComponent(e,m),i=l.fillStyle;l.fillStyle=o.color,l.fillRect(Math.floor(t.x-o.width*.5),Math.floor(t.y-o.height*.5),o.width,o.height),l.fillStyle=i})}function W(n){l&&n.query({and:[A,d]}).forEach(e=>{let t=a.getComponent(e,A),o=a.getComponent(e,d);l.font=`${t.fontSize}px serif`;let i=l.measureText(t.content),s=l.fillStyle;l.fillStyle=t.backgroundColor,l.fillRect(o.x,o.y,t.padding*2+i.width,t.padding*2+i.fontBoundingBoxAscent),l.fillStyle=t.color,l.fillText(t.content,o.x+t.padding,o.y+t.padding+i.fontBoundingBoxAscent),l.fillStyle=s})}function G(n){let e=n.query({and:[d,m]});e.forEach(t=>{let o=a.getComponent(t,d),i=a.getComponent(t,m);e.forEach(s=>{if(s==t)return;let h=a.getComponent(s,d),g=a.getComponent(s,m);(o.x-h.x)**2<((i.width+g.width)*.5)**2&&(o.y-h.y)**2<((i.height+g.height)*.5)**2&&J(t,s)})})}function N(){let n=a.getComponent(E,d),e=a.getComponent(E,m);n.x-e.width>r.playArea.width&&(M.left++,P()),n.x+e.width<0&&(M.right++,P())}function j(n,e,t){let o=z(n,e,r.paddle.width,r.paddle.height),i=a.addComponent(o,v);return i.isLeft=t,T.addEntity(o)}function z(n,e,t,o,i="white"){let s=a.createEntity(),h=a.addComponent(s,d),g=a.addComponent(s,x),u=a.addComponent(s,m);return h.x=n,h.y=e,u.width=t,u.height=o,u.color=i,T.addEntity(s)}function V(n,e=0,t=0,o="black",i=20,s="rgba(0,0,0,0)"){let h=a.createEntity(),g=a.addComponent(h,A),u=a.addComponent(h,d);return g.content=n,g.color=o,g.fontSize=i,g.backgroundColor=s,u.x=e,u.y=t,T.addEntity(h)}y&&(y.width=r.playArea.width,y.height=r.playArea.height);var C={};globalThis.onkeydown=n=>{C[n.key]=!0};globalThis.onkeyup=n=>{delete C[n.key]};var I={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=n=>{if(!y)return;let e=y.getBoundingClientRect();for(let t=0,o=n.changedTouches.length;t<o;t++){let i=I[n.changedTouches[t].identifier]={x:n.changedTouches[t].clientX,y:n.changedTouches[t].clientY};i.x-=e.left,i.y-=e.top,innerWidth/innerHeight<y.width/y.height?(i.x*=y.width/innerWidth,i.y*=y.width/innerWidth):(i.x*=y.height/innerHeight,i.y*=y.height/innerHeight)}};globalThis.window.ontouchend=n=>{for(let e=0,t=n.changedTouches.length;e<t;e++)delete I[n.changedTouches[e].identifier]};z(r.playArea.width*.5,r.playArea.height*0,r.playArea.width,10);z(r.playArea.width*.5,r.playArea.height*1,r.playArea.width,10);var E=z(r.playArea.width*.5,r.playArea.height*.5,r.ball.width,r.ball.height),U=j(r.playArea.width*r.paddle.padding,r.playArea.height*.5,!0),X=j(r.playArea.width*(1-r.paddle.padding),r.playArea.height*.5,!1);function L(){let n=a.getComponent(E,x),e=a.getComponent(E,d);e.x=r.playArea.width*.5,e.y=r.playArea.height*.5,n.x=r.ball.speed,n.y=0;let t=Math.random()*40/180*Math.PI;t*=Math.random()>.5?1:-1,t+=Math.random()>.5?Math.PI:0,Y(n,t);let o=a.getComponent(U,d),i=a.getComponent(X,d);o.y=r.playArea.height*.5,i.y=r.playArea.height*.5}function Y(n,e){let t=Math.sin(e),o=Math.cos(e),i=n.x,s=n.y;n.x=o*i-t*s,n.y=t*i+o*s}function P(){let n=a.getComponent(B,A);n.content=`${M.left} : ${M.right}`,L()}function J(n,e){let t=a.getComponent(n,d),o=a.getComponent(e,d),i=a.getComponent(n,m),s=a.getComponent(e,m),h=a.getComponent(n,x),g=a.getComponent(e,x),u=(h.x**2+h.y**2)**.5,f=h.x/u,w=h.y/u,c=0;f!=0&&(c=(o.x-(s.width+i.width)*.5-t.x)/f,t.x<o.x&&c<0&&t.y+c*w<o.y+(s.height+i.height)*.5&&t.y+c*w>o.y-(s.height+i.height)*.5&&(t.x+=c*f,t.y+=c*w,h.x>0&&(h.x*=-1),h.y+=g.y),c=(o.x+(s.width+i.width)*.5-t.x)/f,t.x>o.x&&c<0&&t.y+c*w<o.y+(s.height+i.height)*.5&&t.y+c*w>o.y-(s.height+i.height)*.5&&(t.x+=c*f,t.y+=c*w,h.x<0&&(h.x*=-1),h.y+=g.y)),w!=0&&(c=(o.y-(s.height+i.height)*.5-t.y)/w,t.y<o.y&&c<0&&t.x+c*f<o.x+(s.width+i.width)*.5&&t.x+c*f>o.x-(s.width+i.width)*.5&&(t.x+=c*f,t.y+=c*w,h.y>0&&(h.y*=-1)),c=(o.y+(s.height+i.height)*.5-t.y)/w,t.y>o.y&&c<0&&t.x+c*f<o.x+(s.width+i.width)*.5&&t.x+c*f>o.x-(s.width+i.width)*.5&&(t.x+=c*f,t.y+=c*w,h.y<0&&(h.y*=-1)))}var M={left:0,right:0},B=V(`${M.left} : ${M.right}`),D=a.getComponent(B,A);D.color="white";D.fontSize=40;var S=0,R=0;L();(function n(){T.update(F,H,W,q,$,G,N),S=performance.now()-R,R+=S,requestAnimationFrame(n)})();})();
//# sourceMappingURL=out.js.map
