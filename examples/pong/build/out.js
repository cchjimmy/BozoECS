var M=class{storage=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(){let t;return this.size<this.storage.length?t=this.storage[this.size]:(t=this.objectFactory(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(e=>e==t)}removeObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");let e=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=e,this.size--,e}getObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var y=class o{static pools=new Map;static idMap=new Map;static register(t){o.idMap.set(t,o.idMap.size),o.pools.set(t,new M(()=>({...t})))}static getId(t){return o.idMap.get(t)??-1}static add(t){return Object.assign(o.pools.get(t).addObj(),t)}static delete(t,e){return o.pools.get(t).removeObj(e)}static get(t,e){return o.pools.get(t).getObj(e)}static len(t){return o.pools.get(t).len()}static typeLen(){return o.pools.size}static types(){return o.pools.keys().toArray()}};var C=class o{static nextId=0;static pool=new M(()=>o.nextId++);static add(){return o.pool.addObj()}static findIndex(t){return o.pool.findIndex(t)}static delete(t){return o.pool.removeObj(t)}};var a=class o{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];localEntities=new Set;timeMilli=0;dtMilli=0;constructor(){o.worlds.push(this)}static createEntity(){let t=C.add();return o.maskMap.set(t,0),o.getArchetype(0).add(t),t}static copyEntity(t){let e=C.add(),i=y.types(),n=this.maskMap.get(t);for(let s=0,r=i.length;s<r;s++)n&1<<s&&o.addComponent(e,i[s],o.getComponent(t,i[s]));return e}static getArchetype(t){let e=o.archetypeMap.get(t)??new Set;return o.archetypeMap.set(t,e),e}static deleteEntity(t){for(let n=0,s=o.worlds.length;n<s;n++)o.worlds[n].removeEntity(t);let e=y.types(),i=o.maskMap.get(t);for(let n=0,s=e.length;n<s;n++)i&1<<n&&o.removeComponent(t,e[n]);C.delete(C.findIndex(t))}addEntity(t=o.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static registerComponent(t){return o.indexMap.has(t)||(y.register(t),o.indexMap.set(t,new Map)),o}static hasComponent(t,e){return!!(o.maskMap.get(t)&1<<y.getId(e))}static addComponent(t,e,i={}){o.registerComponent(e);let n=o.maskMap.get(t),s=y.getId(e);if((n&1<<s)!=0)throw new Error(`Entity ${t} already had that component.`);o.getArchetype(n).delete(t),n|=1<<s,o.maskMap.set(t,n),o.getArchetype(n).add(t);let r=y.len(e);return o.indexMap.get(e).set(t,r),Object.assign(y.add(e),i)}static removeComponent(t,e){o.registerComponent(e);let i=o.maskMap.get(t),n=y.getId(e);if((i&1<<n)==0)throw new Error(`Entity ${t} does not have that component.`);o.getArchetype(i).delete(t),i&=~(1<<n),o.maskMap.set(t,i),o.getArchetype(i).add(t);let s=o.indexMap.get(e),r=s.get(t),d=y.delete(e,r),g=s.keys().toArray().at(-1)??-1;return s.set(g,r),s.delete(t),d}static getComponent(t,e){return y.get(e,o.indexMap.get(e).get(t))}update(...t){for(let e=0,i=t.length;e<i;e++)t[e](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let e=0,i=0;if(t.and)for(let s=0,r=t.and.length;s<r;s++)e|=1<<y.getId(t.and[s]);if(t.not)for(let s=0,r=t.not.length;s<r;s++)i|=1<<y.getId(t.not[s]);let n=[];for(let s=o.archetypeMap.keys().toArray(),r=s.length,d=0;d<r;d++){let g=s[d],u=o.getArchetype(g);u.size!=0&&(g&e)==e&&(g&i)==0&&n.push(...u)}return[...this.localEntities.intersection(new Set(n))]}entityCount(){return this.localEntities.size}};var h={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var f=document.querySelector("canvas"),c=f?.getContext("2d"),m={width:1,height:1,color:"white"},p={x:0,y:0},x={x:0,y:0},E={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},S={isLeft:!0},v=new a;function $(o){o.query({and:[x,S]}).forEach(t=>{let e=a.getComponent(t,x),i=a.getComponent(t,S);e.y=0,i.isLeft?(A.w&&(e.y-=1),A.s&&(e.y+=1)):(A.ArrowUp&&(e.y-=1),A.ArrowDown&&(e.y+=1));for(let n of Object.values(T)){if(c){let s=c.fillStyle;c.fillStyle="green",c.fillRect(n.x,n.y,20,20),c.fillStyle=s}if(n.x<h.playArea.width*.5){if(!i.isLeft)continue}else if(i.isLeft)continue;n.y<h.playArea.height*.5&&(e.y-=1),n.y>h.playArea.height*.5&&(e.y+=1)}e.y=e.y/Math.abs(e.y||1)*h.paddle.speed})}function B(){!c||!f||c.fillRect(0,0,f.width,f.height)}function F(o){let t=o.dtMilli/1e3;o.query({and:[p,x]}).forEach(e=>{let i=a.getComponent(e,p),n=a.getComponent(e,x);i.x+=n.x*t,i.y+=n.y*t})}function q(o){c&&o.query({and:[m,p]}).forEach(t=>{let e=a.getComponent(t,p),i=a.getComponent(t,m),n=c.fillStyle;c.fillStyle=i.color,c.fillRect(Math.floor(e.x-i.width*.5),Math.floor(e.y-i.height*.5),i.width,i.height),c.fillStyle=n})}function H(o){c&&o.query({and:[E,p]}).forEach(t=>{let e=a.getComponent(t,E),i=a.getComponent(t,p);c.font=`${e.fontSize}px serif`;let n=c.measureText(e.content),s=c.fillStyle;c.fillStyle=e.backgroundColor,c.fillRect(i.x,i.y,e.padding*2+n.width,e.padding*2+n.fontBoundingBoxAscent),c.fillStyle=e.color,c.fillText(e.content,i.x+e.padding,i.y+e.padding+n.fontBoundingBoxAscent),c.fillStyle=s})}function W(o){let t=o.query({and:[p,m]});t.forEach(e=>{let i=a.getComponent(e,p),n=a.getComponent(e,m);t.forEach(s=>{if(s==e)return;let r=a.getComponent(s,p),d=a.getComponent(s,m);(i.x-r.x)**2<((n.width+d.width)*.5)**2&&(i.y-r.y)**2<((n.height+d.height)*.5)**2&&X(e,s)})})}function G(){let o=a.getComponent(k,p),t=a.getComponent(k,m);o.x-t.width>h.playArea.width&&(b.left++,j()),o.x+t.width<0&&(b.right++,j())}function z(o,t,e){let i=I(o,t,h.paddle.width,h.paddle.height),n=a.addComponent(i,S);return n.isLeft=e,v.addEntity(i)}function I(o,t,e,i,n="white"){let s=a.createEntity(),r=a.addComponent(s,p),d=a.addComponent(s,x),g=a.addComponent(s,m);return r.x=o,r.y=t,g.width=e,g.height=i,g.color=n,v.addEntity(s)}function N(o,t=0,e=0,i="black",n=20,s="rgba(0,0,0,0)"){let r=a.createEntity(),d=a.addComponent(r,E),g=a.addComponent(r,p);return d.content=o,d.color=i,d.fontSize=n,d.backgroundColor=s,g.x=t,g.y=e,v.addEntity(r)}f&&(f.width=h.playArea.width,f.height=h.playArea.height);var A={};globalThis.onkeydown=o=>{A[o.key]=!0};globalThis.onkeyup=o=>{delete A[o.key]};var T={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=o=>{if(!f)return;let t=f.getBoundingClientRect();for(let e=0,i=o.changedTouches.length;e<i;e++){let n=T[o.changedTouches[e].identifier]={x:o.changedTouches[e].clientX,y:o.changedTouches[e].clientY};n.x-=t.left,n.y-=t.top,innerWidth/innerHeight<f.width/f.height?(n.x*=f.width/innerWidth,n.y*=f.width/innerWidth):(n.x*=f.height/innerHeight,n.y*=f.height/innerHeight)}};globalThis.window.ontouchend=o=>{for(let t=0,e=o.changedTouches.length;t<e;t++)delete T[o.changedTouches[t].identifier]};I(h.playArea.width*.5,h.playArea.height*0,h.playArea.width,10);I(h.playArea.width*.5,h.playArea.height*1,h.playArea.width,10);var k=I(h.playArea.width*.5,h.playArea.height*.5,h.ball.width,h.ball.height),V=z(h.playArea.width*h.paddle.padding,h.playArea.height*.5,!0),D=z(h.playArea.width*(1-h.paddle.padding),h.playArea.height*.5,!1);function O(){let o=a.getComponent(k,x),t=a.getComponent(k,p);t.x=h.playArea.width*.5,t.y=h.playArea.height*.5,o.x=h.ball.speed,o.y=0;let e=Math.random()*40/180*Math.PI;e*=Math.random()>.5?1:-1,e+=Math.random()>.5?Math.PI:0,U(o,e);let i=a.getComponent(V,p),n=a.getComponent(D,p);i.y=h.playArea.height*.5,n.y=h.playArea.height*.5}function U(o,t){let e=Math.sin(t),i=Math.cos(t),n=o.x,s=o.y;o.x=i*n-e*s,o.y=e*n+i*s}function j(){let o=a.getComponent(P,E);o.content=`${b.left} : ${b.right}`,O()}function X(o,t){let e=a.getComponent(o,p),i=a.getComponent(t,p),n=a.getComponent(o,m),s=a.getComponent(t,m),r=a.getComponent(o,x),d=a.getComponent(t,x),g=(r.x**2+r.y**2)**.5,u=r.x/g,w=r.y/g,l=0;u!=0&&(l=(i.x-(s.width+n.width)*.5-e.x)/u,e.x<i.x&&l<0&&e.y+l*w<i.y+(s.height+n.height)*.5&&e.y+l*w>i.y-(s.height+n.height)*.5&&(e.x+=l*u,e.y+=l*w,r.x>0&&(r.x*=-1),r.y+=d.y),l=(i.x+(s.width+n.width)*.5-e.x)/u,e.x>i.x&&l<0&&e.y+l*w<i.y+(s.height+n.height)*.5&&e.y+l*w>i.y-(s.height+n.height)*.5&&(e.x+=l*u,e.y+=l*w,r.x<0&&(r.x*=-1),r.y+=d.y)),w!=0&&(l=(i.y-(s.height+n.height)*.5-e.y)/w,e.y<i.y&&l<0&&e.x+l*u<i.x+(s.width+n.width)*.5&&e.x+l*u>i.x-(s.width+n.width)*.5&&(e.x+=l*u,e.y+=l*w,r.y>0&&(r.y*=-1)),l=(i.y+(s.height+n.height)*.5-e.y)/w,e.y>i.y&&l<0&&e.x+l*u<i.x+(s.width+n.width)*.5&&e.x+l*u>i.x-(s.width+n.width)*.5&&(e.x+=l*u,e.y+=l*w,r.y<0&&(r.y*=-1)))}var b={left:0,right:0},P=N(`${b.left} : ${b.right}`),R=a.getComponent(P,E);R.color="white";R.fontSize=40;O();(function o(){v.update(B,q,H,F,$,W,G),requestAnimationFrame(o)})();
//# sourceMappingURL=out.js.map
