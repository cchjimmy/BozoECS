(()=>{var b=class{storage=[];objectConstructor;size=0;constructor(t){this.objectConstructor=t}len(){return this.size}addObj(){let t;return this.storage[this.size]?t=this.storage[this.size]:(t=this.objectConstructor(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(e=>e==t)}removeObj(t){if(t>=this.size)throw new Error("Index out of range.");let e=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=e,this.size--,e}getObj(t){if(t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var y=class n{static pools=new Map;static idMap=new Map;static register(t){n.idMap.set(t,n.idMap.size),n.pools.set(t,new b(()=>Object.assign({},t)))}static getId(t){return n.idMap.get(t)??-1}static add(t){return n.pools.get(t).addObj()}static delete(t,e){return n.pools.get(t).removeObj(e)}static get(t,e){return n.pools.get(t).getObj(e)}static len(t){return n.pools.get(t).len()}static typeLen(){return n.pools.size}static types(){return n.pools.keys().toArray()}};var T=class n{static nextId=0;static pool=new b(()=>n.nextId++);static add(){return n.pool.addObj()}static findIndex(t){return n.pool.findIndex(t)}static delete(t){return n.pool.removeObj(t)}};var a=class n{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static removeMap=new Map;static ownerMap=new Map;timeMilli=0;dtMilli=0;localEntities=new Set;constructor(){n.worlds.push(this)}static createEntity(){let t=T.add();return n.maskMap.set(t,0),n.getArchetype(0).add(t),t}static getArchetype(t){let e=n.archetypeMap.get(t);if(e==null){let o=new Set;return n.archetypeMap.set(t,o),o}return e}static deleteEntity(t){for(let o=0,i=n.worlds.length;o<i;o++)n.worlds[o].removeEntity(t);let e=y.types();for(let o=0,i=y.typeLen();o<i;o++){if(!(n.getMask(t)&1<<o))continue;n.getRemoveFn(o)(t);let s=n.getIndices(e[o]),r=n.getOwners(e[o]),c=n.getOwner(r,r.size-1),g=n.getIndex(s,t);r.set(g,c),s.set(c,g)}n.getArchetype(n.getMask(t)).delete(t),n.maskMap.set(t,0),T.delete(T.findIndex(t))}static getRemoveFn(t){let e=n.removeMap.get(t);if(e==null)throw new Error("Component not registered.");return e}addEntity(t){return t??=n.createEntity(),this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static componentExists(t){n.indexMap.has(t)||n.registerComponent(t)}static registerComponent(t){return y.register(t),n.indexMap.set(t,new Map),n.removeMap.set(y.getId(t),e=>y.delete(t,n.getIndex(n.getIndices(t),e))),n.ownerMap.set(t,new Map),n}static hasComponent(t,e){return(n.getMask(t)&1<<y.getId(e))>0}static addComponent(t,e){n.componentExists(e);let o=n.getMask(t),i=y.getId(e);if((o&1<<i)!=0)throw new Error(`Entity ${t} already had that component.`);n.getArchetype(o).delete(t),o|=1<<i,n.maskMap.set(t,o),n.getArchetype(o).add(t);let s=y.len(e);return n.getIndices(e).set(t,s),n.getOwners(e).set(s,t),y.add(e)}static getIndices(t){let e=n.indexMap.get(t);if(e==null)throw new Error("Component not registered.");return e}static getIndex(t,e){let o=t.get(e);if(o==null)throw new Error(`Entity ${e} does not exist.`);return o}static getOwners(t){let e=n.ownerMap.get(t);if(e==null)throw new Error("Component not registered.");return e}static getOwner(t,e){let o=t.get(e);if(o==null)throw new Error("Owner not found.");return o}static removeComponent(t,e){n.componentExists(e);let o=n.getMask(t),i=y.getId(e);if((o&1<<i)==0)throw new Error(`Entity ${t} does not have that component.`);n.getArchetype(o).delete(t),o&=~(1<<i),n.maskMap.set(t,o),n.getArchetype(o).add(t);let s=n.getIndices(e),r=n.getOwners(e),c=n.getIndex(s,t),g=y.delete(e,c),p=n.getOwner(r,r.size-1);return r.set(c,p),s.set(p,c),g}static getMask(t){return n.maskMap.get(t)??-1}static getComponent(t,e){if(!n.hasComponent(t,e))throw new Error(`Entity ${t} does not have that component.`);return y.get(e,n.getIndex(n.getIndices(e),t))}update(...t){for(let e=0,o=t.length;e<o;e++)t[e](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let e=0,o=0,i=0;if(t.and)for(let r=0,c=t.and.length;r<c;r++)e|=1<<y.getId(t.and[r]);if(t.or)for(let r=0,c=t.or.length;r<c;r++)o|=1<<y.getId(t.or[r]);if(t.not)for(let r=0,c=t.not.length;r<c;r++)i|=1<<y.getId(t.not[r]);let s=[];for(let r=n.archetypeMap.keys().toArray(),c=r.length,g=0,p=r[g];g<c;g++,p=r[g])(p&e)==e&&(p|o)>0&&(p&i)==0&&s.push(...this.localEntities.intersection(n.getArchetype(p)));return s}entityCount(){return this.localEntities.size}};var d={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var f=document.querySelector("canvas"),h=f?.getContext("2d"),w={width:1,height:1,color:"white"},u={x:0,y:0},x={x:0,y:0},v={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},k={isLeft:!0},j=new a;function L(n){n.query({and:[x,k]}).forEach(t=>{let e=a.getComponent(t,x),o=a.getComponent(t,k);e.y=0,o.isLeft?(M.w&&(e.y-=1),M.s&&(e.y+=1)):(M.ArrowUp&&(e.y-=1),M.ArrowDown&&(e.y+=1));for(let i of Object.values(I)){if(h){let s=h.fillStyle;h.fillStyle="green",h.fillRect(i.x,i.y,20,20),h.fillStyle=s}if(i.x<d.playArea.width*.5){if(!o.isLeft)continue}else if(o.isLeft)continue;i.y<d.playArea.height*.5&&(e.y-=1),i.y>d.playArea.height*.5&&(e.y+=1)}e.y=e.y/Math.abs(e.y||1)*d.paddle.speed})}function $(){!h||!f||h.fillRect(0,0,f.width,f.height)}function B(n){let t=n.dtMilli/1e3;n.query({and:[u,x]}).forEach(e=>{let o=a.getComponent(e,u),i=a.getComponent(e,x);o.x+=i.x*t,o.y+=i.y*t})}function F(n){h&&n.query({and:[w,u]}).forEach(t=>{let e=a.getComponent(t,u),o=a.getComponent(t,w),i=h.fillStyle;h.fillStyle=o.color,h.fillRect(Math.floor(e.x-o.width*.5),Math.floor(e.y-o.height*.5),o.width,o.height),h.fillStyle=i})}function H(n){h&&n.query({and:[v,u]}).forEach(t=>{let e=a.getComponent(t,v),o=a.getComponent(t,u);h.font=`${e.fontSize}px serif`;let i=h.measureText(e.content),s=h.fillStyle;h.fillStyle=e.backgroundColor,h.fillRect(o.x,o.y,e.padding*2+i.width,e.padding*2+i.fontBoundingBoxAscent),h.fillStyle=e.color,h.fillText(e.content,o.x+e.padding,o.y+e.padding+i.fontBoundingBoxAscent),h.fillStyle=s})}function q(n){let t=n.query({and:[u,w]});t.forEach(e=>{let o=a.getComponent(e,u),i=a.getComponent(e,w);t.forEach(s=>{if(s==e)return;let r=a.getComponent(s,u),c=a.getComponent(s,w);(o.x-r.x)**2<((i.width+c.width)*.5)**2&&(o.y-r.y)**2<((i.height+c.height)*.5)**2&&U(e,s)})})}function G(){let n=a.getComponent(E,u),t=a.getComponent(E,w);n.x-t.width>d.playArea.width&&(C.left++,O()),n.x+t.width<0&&(C.right++,O())}function S(n,t,e){let o=A(n,t,d.paddle.width,d.paddle.height),i=a.addComponent(o,k);return i.isLeft=e,j.addEntity(o)}function A(n,t,e,o,i="white"){let s=a.createEntity(),r=a.addComponent(s,u),c=a.addComponent(s,x),g=a.addComponent(s,w);return r.x=n,r.y=t,g.width=e,g.height=o,g.color=i,j.addEntity(s)}function N(n,t=0,e=0,o="black",i=20,s="rgba(0,0,0,0)"){let r=a.createEntity(),c=a.addComponent(r,v),g=a.addComponent(r,u);return c.content=n,c.color=o,c.fontSize=i,c.backgroundColor=s,g.x=t,g.y=e,j.addEntity(r)}f&&(f.width=d.playArea.width,f.height=d.playArea.height);var M={};globalThis.onkeydown=n=>{M[n.key]=!0};globalThis.onkeyup=n=>{delete M[n.key]};var I={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=n=>{if(!f)return;let t=f.getBoundingClientRect();for(let e=0,o=n.changedTouches.length;e<o;e++){let i=I[n.changedTouches[e].identifier]={x:n.changedTouches[e].clientX,y:n.changedTouches[e].clientY};i.x-=t.left,i.y-=t.top,innerWidth/innerHeight<f.width/f.height?(i.x*=f.width/innerWidth,i.y*=f.width/innerWidth):(i.x*=f.height/innerHeight,i.y*=f.height/innerHeight)}};globalThis.window.ontouchend=n=>{for(let t=0,e=n.changedTouches.length;t<e;t++)delete I[n.changedTouches[t].identifier]};A(d.playArea.width*.5,d.playArea.height*0,d.playArea.width,10);A(d.playArea.width*.5,d.playArea.height*1,d.playArea.width,10);var E=A(d.playArea.width*.5,d.playArea.height*.5,d.ball.width,d.ball.height),V=S(d.playArea.width*d.paddle.padding,d.playArea.height*.5,!0),D=S(d.playArea.width*(1-d.paddle.padding),d.playArea.height*.5,!1);function z(){let n=a.getComponent(E,x),t=a.getComponent(E,u);t.x=d.playArea.width*.5,t.y=d.playArea.height*.5,n.x=d.ball.speed,n.y=0;let e=Math.random()*40/180*Math.PI;e*=Math.random()>.5?1:-1,e+=Math.random()>.5?Math.PI:0,K(n,e);let o=a.getComponent(V,u),i=a.getComponent(D,u);o.y=d.playArea.height*.5,i.y=d.playArea.height*.5}function K(n,t){let e=Math.sin(t),o=Math.cos(t),i=n.x,s=n.y;n.x=o*i-e*s,n.y=e*i+o*s}function O(){let n=a.getComponent(P,v);n.content=`${C.left} : ${C.right}`,z()}function U(n,t){let e=a.getComponent(n,u),o=a.getComponent(t,u),i=a.getComponent(n,w),s=a.getComponent(t,w),r=a.getComponent(n,x),c=a.getComponent(t,x),g=(r.x**2+r.y**2)**.5,p=r.x/g,m=r.y/g,l=0;p!=0&&(l=(o.x-(s.width+i.width)*.5-e.x)/p,e.x<o.x&&l<0&&e.y+l*m<o.y+(s.height+i.height)*.5&&e.y+l*m>o.y-(s.height+i.height)*.5&&(e.x+=l*p,e.y+=l*m,r.x>0&&(r.x*=-1),r.y+=c.y),l=(o.x+(s.width+i.width)*.5-e.x)/p,e.x>o.x&&l<0&&e.y+l*m<o.y+(s.height+i.height)*.5&&e.y+l*m>o.y-(s.height+i.height)*.5&&(e.x+=l*p,e.y+=l*m,r.x<0&&(r.x*=-1),r.y+=c.y)),m!=0&&(l=(o.y-(s.height+i.height)*.5-e.y)/m,e.y<o.y&&l<0&&e.x+l*p<o.x+(s.width+i.width)*.5&&e.x+l*p>o.x-(s.width+i.width)*.5&&(e.x+=l*p,e.y+=l*m,r.y>0&&(r.y*=-1)),l=(o.y+(s.height+i.height)*.5-e.y)/m,e.y>o.y&&l<0&&e.x+l*p<o.x+(s.width+i.width)*.5&&e.x+l*p>o.x-(s.width+i.width)*.5&&(e.x+=l*p,e.y+=l*m,r.y<0&&(r.y*=-1)))}var C={left:0,right:0},P=N(`${C.left} : ${C.right}`),R=a.getComponent(P,v);R.color="white";R.fontSize=40;z();(function n(){j.update($,F,H,B,L,q,G),requestAnimationFrame(n)})();})();
//# sourceMappingURL=out.js.map
