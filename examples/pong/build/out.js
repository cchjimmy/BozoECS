(()=>{var w=class{reserve;active;objectConstructor;constructor(t){this.reserve=[],this.active=[],this.objectConstructor=t}addObj(){return this.active.push(this.reserve.pop()??this.objectConstructor()),this.active[this.active.length-1]}findIndex(t){return this.active.findIndex(n=>n==t)}removeObj(t){let n=this.active[t];return this.active[t]=this.active[this.active.length-1],this.active.length--,this.reserve.push(n),n}getObj(t){return this.active[t]}len(){return this.active.length}};var T=class{static id=-1;owner=-1},A=class{pools=[];register(t){t.id==-1&&(t.id=this.pools.length),this.pools[t.id]??=new w(()=>new t)}isRegistered(t){return!!this.pools[t.id]}add(t){return this.pools[t.id].addObj()}delete(t,n){return this.pools[t.id].removeObj(n)}get(t,n){return this.pools[t.id].getObj(n)}len(t){return this.pools[t.id].len()}};var I=class{nextId=0;pool=new w(()=>this.nextId++);add(){return this.pool.addObj()}findIndex(t){return this.pool.findIndex(t)}delete(t){return this.pool.removeObj(t)}};var l=class e{static indices=[];static components=new A;static entities=new I;static entityMasks=[];static archetypes={0:new Set};static worlds=[];time=0;dt=0;localEntities=new Set;constructor(){e.worlds.push(this)}static createEntity(){let t=e.entities.add();return e.indices[t]=[],e.entityMasks[t]=0,e.archetypes[e.entityMasks[t]].add(t),t}static deleteEntity(t){for(let n of e.worlds)n.removeEntity(t);for(let n=0,o=e.components.pools.length;n<o;n++){if(!(e.entityMasks[t]&1<<n))continue;let i=e.components.pools[n].removeObj(e.indices[t][n]).constructor.prototype;e.indices[e.components.get(i,t).owner][n]=e.indices[t][n]}e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]=0,e.entities.delete(e.entities.findIndex(t))}addEntity(t){return t??=e.createEntity(),this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){if(!this.localEntities.has(t))throw new Error(`Entity ${t} does not exist.`)}static componentExists(t){if(!e.components.isRegistered(t))throw new Error(`Component ${t.name} is not registered.`)}static registerComponent(t){return e.components.register(t),e}static hasComponent(t,n){return(e.entityMasks[t]&1<<n.id)>0}static addComponent(t,n){if(e.componentExists(n),e.hasComponent(t,n))throw new Error(`Entity ${t} already had this component.`);e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]|=1<<n.id,e.archetypes[e.entityMasks[t]]??=new Set,e.archetypes[e.entityMasks[t]].add(t),e.indices[t][n.id]=e.components.len(n);let o=e.components.add(n);return o.owner=t,o}static removeComponent(t,n){if(e.componentExists(n),!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have component ${n.name}.`);e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]&=~(1<<n.id),e.archetypes[e.entityMasks[t]]??=new Set,e.archetypes[e.entityMasks[t]].add(t);let o=e.components.delete(n,e.indices[t][n.id]),i=e.components.get(n,e.indices[t][n.id]).owner;return e.indices[i][n.id]=e.indices[t][n.id],o}getComponent(t,n){if(this.entityExists(t),e.componentExists(n),!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have component ${n.name}.`);return e.components.get(n,e.indices[t][n.id])}update(...t){for(let n of t)n(this,this.dt/1e3);this.dt=performance.now()-this.time,this.time+=this.dt}query(t){let n=0,o=0,i=0;if(t.and)for(let s=0,a=t.and.length;s<a;s++)n|=1<<t.and[s].id;if(t.or)for(let s=0,a=t.or.length;s<a;s++)o|=1<<t.or[s].id;if(t.not)for(let s=0,a=t.not.length;s<a;s++)i|=1<<t.not[s].id;let r=[];for(let s in e.archetypes){let a=parseInt(s);(a&n)==n&&(a|o)>0&&(a&i)==0&&r.push(...this.localEntities.intersection(e.archetypes[s]))}return r}};var d={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var b=document.querySelector("canvas"),h=b?.getContext("2d"),y=class extends T{width=1;height=1;color="white"},p=class extends T{x=0;y=0},m=class extends T{x=0;y=0},C=class extends T{content="";fontSize=20;margin=3;color="black";backgroundColor="white"},E=class extends T{isLeft=!0},u=new l;l.registerComponent(y).registerComponent(m).registerComponent(p).registerComponent(C).registerComponent(E);function L(e){e.query({and:[m,E]}).forEach(t=>{let n=e.getComponent(t,m),o=e.getComponent(t,E);n.y=0,o.isLeft?(v.w&&(n.y+=-d.paddle.speed),v.s&&(n.y+=d.paddle.speed)):(v.ArrowUp&&(n.y+=-d.paddle.speed),v.ArrowDown&&(n.y+=d.paddle.speed))})}function z(){!h||!b||h.fillRect(0,0,b.width,b.height)}function q(e,t){let n=e.getComponent(M,m);n.x+=t,n.y+=t,e.query({and:[p,m]}).forEach(o=>{let i=e.getComponent(o,p),r=e.getComponent(o,m);i.x+=r.x*t,i.y+=r.y*t})}function G(e){h&&e.query({and:[y,p]}).forEach(t=>{let n=e.getComponent(t,p),o=e.getComponent(t,y),i=h.fillStyle;h.fillStyle=o.color,h.fillRect(Math.floor(n.x-o.width*.5),Math.floor(n.y-o.height*.5),o.width,o.height),h.fillStyle=i})}function N(e,t){h&&e.query({and:[C,p]}).forEach(n=>{let o=e.getComponent(n,C),i=e.getComponent(n,p);h.font=`${o.fontSize}px serif`;let r=h.measureText(o.content),s=h.fillStyle;h.fillStyle=o.backgroundColor,h.fillRect(i.x,i.y,o.margin*2+r.width,o.margin*2+r.fontBoundingBoxAscent),h.fillStyle=o.color,h.fillText(o.content,i.x+o.margin,i.y+o.margin+r.fontBoundingBoxAscent),h.fillStyle=s})}function D(e){let t=e.query({and:[p,y]});t.forEach(n=>{let o=e.getComponent(n,p),i=e.getComponent(n,y);t.forEach(r=>{if(r==n)return;let s=e.getComponent(r,p),a=e.getComponent(r,y);(o.x-s.x)**2<((i.width+a.width)*.5)**2&&(o.y-s.y)**2<((i.height+a.height)*.5)**2&&J(e,n,r)})})}function F(e){let t=e.getComponent(M,p),n=e.getComponent(M,y);t.x-n.width>d.playArea.width&&(k.left++,$()),t.x+n.width<0&&(k.right++,$())}function O(e,t,n){let o=S(e,t,d.paddle.width,d.paddle.height),i=l.addComponent(o,E);return i.isLeft=n,u.addEntity(o)}function S(e,t,n,o,i="white"){let r=l.createEntity(),s=l.addComponent(r,p),a=l.addComponent(r,m),x=l.addComponent(r,y);return s.x=e,s.y=t,x.width=n,x.height=o,x.color=i,u.addEntity(r)}function K(e,t=0,n=0,o="black",i=20,r="rgba(0,0,0,0)"){let s=l.createEntity(),a=l.addComponent(s,C),x=l.addComponent(s,p);return a.content=e,a.color=o,a.fontSize=i,a.backgroundColor=r,x.x=t,x.y=n,u.addEntity(s)}b&&(b.width=d.playArea.width,b.height=d.playArea.height);var v={};globalThis.onkeydown=e=>{v[e.key]=!0};globalThis.onkeyup=e=>{delete v[e.key]};S(d.playArea.width*.5,d.playArea.height*0,d.playArea.width,10);S(d.playArea.width*.5,d.playArea.height*1,d.playArea.width,10);var M=S(d.playArea.width*.5,d.playArea.height*.5,d.ball.width,d.ball.height),U=O(d.playArea.width*d.paddle.padding,d.playArea.height*.5,!0),V=O(d.playArea.width*(1-d.paddle.padding),d.playArea.height*.5,!1);function R(){let e=u.getComponent(M,m),t=u.getComponent(M,p);t.x=d.playArea.width*.5,t.y=d.playArea.height*.5,e.x=d.ball.speed,e.y=0;let n=Math.random()*40/180*Math.PI;n*=Math.random()>.5?1:-1,n+=Math.random()>.5?Math.PI:0,H(e,n);let o=u.getComponent(U,p),i=u.getComponent(V,p);o.y=d.playArea.height*.5,i.y=d.playArea.height*.5}function H(e,t){let n=Math.sin(t),o=Math.cos(t),i=e.x,r=e.y;e.x=o*i-n*r,e.y=n*i+o*r}function $(){let e=u.getComponent(W,C);e.content=`${k.left} : ${k.right}`,R()}function J(e,t,n){let o=e.getComponent(t,p),i=e.getComponent(n,p),r=e.getComponent(t,y),s=e.getComponent(n,y),a=e.getComponent(t,m),x=e.getComponent(n,m),j=(a.x**2+a.y**2)**.5,f=a.x/j,g=a.y/j,c=0;f!=0&&(c=(i.x-(s.width+r.width)*.5-o.x)/f,o.x<i.x&&c<0&&o.y+c*g<i.y+(s.height+r.height)*.5&&o.y+c*g>i.y-(s.height+r.height)*.5&&(o.x+=c*f,o.y+=c*g,a.x>0&&(a.x*=-1),a.y+=x.y),c=(i.x+(s.width+r.width)*.5-o.x)/f,o.x>i.x&&c<0&&o.y+c*g<i.y+(s.height+r.height)*.5&&o.y+c*g>i.y-(s.height+r.height)*.5&&(o.x+=c*f,o.y+=c*g,a.x<0&&(a.x*=-1),a.y+=x.y)),g!=0&&(c=(i.y-(s.height+r.height)*.5-o.y)/g,o.y<i.y&&c<0&&o.x+c*f<i.x+(s.width+r.width)*.5&&o.x+c*f>i.x-(s.width+r.width)*.5&&(o.x+=c*f,o.y+=c*g,a.y>0&&(a.y*=-1)),c=(i.y+(s.height+r.height)*.5-o.y)/g,o.y>i.y&&c<0&&o.x+c*f<i.x+(s.width+r.width)*.5&&o.x+c*f>i.x-(s.width+r.width)*.5&&(o.x+=c*f,o.y+=c*g,a.y<0&&(a.y*=-1)))}var k={left:0,right:0},W=K(`${k.left} : ${k.right}`),P=u.getComponent(W,C);P.color="white";P.fontSize=40;R();(function e(){u.update(z,G,N,q,L,D,F),requestAnimationFrame(e)})();})();
//# sourceMappingURL=out.js.map
