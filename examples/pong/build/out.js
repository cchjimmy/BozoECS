(()=>{var w=class{reserve;active;objectConstructor;constructor(t){this.reserve=[],this.active=[],this.objectConstructor=t}addObj(){return this.active.push(this.reserve.pop()??this.objectConstructor()),this.active[this.active.length-1]}findIndex(t){return this.active.findIndex(n=>n==t)}removeObj(t){let n=this.active[t];return this.active[t]=this.active[this.active.length-1],this.active.length--,this.reserve.push(n),n}getObj(t){return this.active[t]}len(){return this.active.length}};var C=class{static id=-1;owner=-1},A=class{pools=[];register(t){t.id==-1&&(t.id=this.pools.length),this.pools[t.id]??=new w(()=>new t)}isRegistered(t){return!!this.pools[t.id]}add(t){return this.pools[t.id].addObj()}delete(t,n){return this.pools[t.id].removeObj(n)}get(t,n){return this.pools[t.id].getObj(n)}len(t){return this.pools[t.id].len()}};var S=class{nextId=0;pool=new w(()=>this.nextId++);add(){return this.pool.addObj()}findIndex(t){return this.pool.findIndex(t)}delete(t){return this.pool.removeObj(t)}};var y=class e{static indices=[];static components=new A;static entities=new S;static entityMasks=[];static archetypes={0:new Set};static worlds=[];time=0;dt=0;localEntities=new Set;constructor(){e.worlds.push(this)}static createEntity(){let t=e.entities.add();return e.indices[t]=[],e.entityMasks[t]=0,e.archetypes[e.entityMasks[t]].add(t),t}static deleteEntity(t){for(let n of e.worlds)n.removeEntity(t);for(let n=0,o=e.components.pools.length;n<o;n++){if(!(e.entityMasks[t]&1<<n))continue;let i=e.components.pools[n].removeObj(e.indices[t][n]).constructor.prototype;e.indices[e.components.get(i,t).owner][n]=e.indices[t][n]}e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]=0,e.entities.delete(e.entities.findIndex(t))}addEntity(t){return t??=e.createEntity(),this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){if(!this.localEntities.has(t))throw new Error(`Entity ${t} does not exist.`)}static componentExists(t){e.components.isRegistered(t)||e.components.register(t)}static registerComponent(t){return e.components.register(t),e}static hasComponent(t,n){return(e.entityMasks[t]&1<<n.id)>0}static addComponent(t,n){if(e.componentExists(n),e.hasComponent(t,n))throw new Error(`Entity ${t} already had this component.`);e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]|=1<<n.id,e.archetypes[e.entityMasks[t]]??=new Set,e.archetypes[e.entityMasks[t]].add(t),e.indices[t][n.id]=e.components.len(n);let o=e.components.add(n);return o.owner=t,o}static removeComponent(t,n){if(e.componentExists(n),!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have component ${n.name}.`);e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]&=~(1<<n.id),e.archetypes[e.entityMasks[t]]??=new Set,e.archetypes[e.entityMasks[t]].add(t);let o=e.components.delete(n,e.indices[t][n.id]),i=e.components.get(n,e.indices[t][n.id]).owner;return e.indices[i][n.id]=e.indices[t][n.id],o}getComponent(t,n){if(this.entityExists(t),e.componentExists(n),!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have component ${n.name}.`);return e.components.get(n,e.indices[t][n.id])}update(...t){for(let n of t)n(this,this.dt/1e3);this.dt=performance.now()-this.time,this.time+=this.dt}query(t){let n=0,o=0,i=0;if(t.and)for(let s=0,d=t.and.length;s<d;s++)n|=1<<t.and[s].id;if(t.or)for(let s=0,d=t.or.length;s<d;s++)o|=1<<t.or[s].id;if(t.not)for(let s=0,d=t.not.length;s<d;s++)i|=1<<t.not[s].id;let r=[];for(let s in e.archetypes){let d=parseInt(s);(d&n)==n&&(d|o)>0&&(d&i)==0&&r.push(...this.localEntities.intersection(e.archetypes[s]))}return r}};var a={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var l=document.querySelector("canvas"),h=l?.getContext("2d"),f=class extends C{width=1;height=1;color="white"},p=class extends C{x=0;y=0},g=class extends C{x=0;y=0},b=class extends C{content="";fontSize=20;padding=3;color="black";backgroundColor="white"},E=class extends C{isLeft=!0},x=new y;y.registerComponent(f).registerComponent(g).registerComponent(p).registerComponent(b).registerComponent(E);function z(e){e.query({and:[g,E]}).forEach(t=>{let n=e.getComponent(t,g),o=e.getComponent(t,E);n.y=0;let i=!1,r=!1;o.isLeft?(v.w&&(n.y+=-a.paddle.speed,i=!0),v.s&&(n.y+=a.paddle.speed,r=!0)):(v.ArrowUp&&(n.y+=-a.paddle.speed,i=!0),v.ArrowDown&&(n.y+=a.paddle.speed,r=!0));for(let s of Object.values(j)){if(h){let d=h.fillStyle;h.fillStyle="green",h.fillRect(s.x,s.y,20,20),h.fillStyle=d}if(s.x<a.playArea.width*.5){if(!o.isLeft)continue}else if(o.isLeft)continue;if(s.y<a.playArea.height*.5){if(r)continue;n.y-=a.paddle.speed,r=!0}if(s.y>a.playArea.height*.5){if(i)continue;n.y+=a.paddle.speed,i=!0}}})}function H(){!h||!l||h.fillRect(0,0,l.width,l.height)}function q(e,t){let n=e.getComponent(M,g);n.x+=t,n.y+=t,e.query({and:[p,g]}).forEach(o=>{let i=e.getComponent(o,p),r=e.getComponent(o,g);i.x+=r.x*t,i.y+=r.y*t})}function D(e){h&&e.query({and:[f,p]}).forEach(t=>{let n=e.getComponent(t,p),o=e.getComponent(t,f),i=h.fillStyle;h.fillStyle=o.color,h.fillRect(Math.floor(n.x-o.width*.5),Math.floor(n.y-o.height*.5),o.width,o.height),h.fillStyle=i})}function G(e,t){h&&e.query({and:[b,p]}).forEach(n=>{let o=e.getComponent(n,b),i=e.getComponent(n,p);h.font=`${o.fontSize}px serif`;let r=h.measureText(o.content),s=h.fillStyle;h.fillStyle=o.backgroundColor,h.fillRect(i.x,i.y,o.padding*2+r.width,o.padding*2+r.fontBoundingBoxAscent),h.fillStyle=o.color,h.fillText(o.content,i.x+o.padding,i.y+o.padding+r.fontBoundingBoxAscent),h.fillStyle=s})}function N(e){let t=e.query({and:[p,f]});t.forEach(n=>{let o=e.getComponent(n,p),i=e.getComponent(n,f);t.forEach(r=>{if(r==n)return;let s=e.getComponent(r,p),d=e.getComponent(r,f);(o.x-s.x)**2<((i.width+d.width)*.5)**2&&(o.y-s.y)**2<((i.height+d.height)*.5)**2&&Y(e,n,r)})})}function U(e){let t=e.getComponent(M,p),n=e.getComponent(M,f);t.x-n.width>a.playArea.width&&(k.left++,W()),t.x+n.width<0&&(k.right++,W())}function O(e,t,n){let o=I(e,t,a.paddle.width,a.paddle.height),i=y.addComponent(o,E);return i.isLeft=n,x.addEntity(o)}function I(e,t,n,o,i="white"){let r=y.createEntity(),s=y.addComponent(r,p),d=y.addComponent(r,g),T=y.addComponent(r,f);return s.x=e,s.y=t,T.width=n,T.height=o,T.color=i,x.addEntity(r)}function F(e,t=0,n=0,o="black",i=20,r="rgba(0,0,0,0)"){let s=y.createEntity(),d=y.addComponent(s,b),T=y.addComponent(s,p);return d.content=e,d.color=o,d.fontSize=i,d.backgroundColor=r,T.x=t,T.y=n,x.addEntity(s)}l&&(l.width=a.playArea.width,l.height=a.playArea.height);var v={};globalThis.onkeydown=e=>{v[e.key]=!0};globalThis.onkeyup=e=>{delete v[e.key]};var j={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=e=>{if(!l)return;let t=l.getBoundingClientRect();for(let n=0,o=e.changedTouches.length;n<o;n++){let i=j[e.changedTouches[n].identifier]={x:e.changedTouches[n].clientX,y:e.changedTouches[n].clientY};i.x-=t.left,i.y-=t.top,innerWidth/innerHeight<l.width/l.height?(i.x*=l.width/innerWidth,i.y*=l.width/innerWidth):(i.x*=l.height/innerHeight,i.y*=l.height/innerHeight)}};globalThis.window.ontouchend=e=>{for(let t=0,n=e.changedTouches.length;t<n;t++)delete j[e.changedTouches[t].identifier]};I(a.playArea.width*.5,a.playArea.height*0,a.playArea.width,10);I(a.playArea.width*.5,a.playArea.height*1,a.playArea.width,10);var M=I(a.playArea.width*.5,a.playArea.height*.5,a.ball.width,a.ball.height),K=O(a.playArea.width*a.paddle.padding,a.playArea.height*.5,!0),V=O(a.playArea.width*(1-a.paddle.padding),a.playArea.height*.5,!1);function $(){let e=x.getComponent(M,g),t=x.getComponent(M,p);t.x=a.playArea.width*.5,t.y=a.playArea.height*.5,e.x=a.ball.speed,e.y=0;let n=Math.random()*40/180*Math.PI;n*=Math.random()>.5?1:-1,n+=Math.random()>.5?Math.PI:0,X(e,n);let o=x.getComponent(K,p),i=x.getComponent(V,p);o.y=a.playArea.height*.5,i.y=a.playArea.height*.5}function X(e,t){let n=Math.sin(t),o=Math.cos(t),i=e.x,r=e.y;e.x=o*i-n*r,e.y=n*i+o*r}function W(){let e=x.getComponent(P,b);e.content=`${k.left} : ${k.right}`,$()}function Y(e,t,n){let o=e.getComponent(t,p),i=e.getComponent(n,p),r=e.getComponent(t,f),s=e.getComponent(n,f),d=e.getComponent(t,g),T=e.getComponent(n,g),R=(d.x**2+d.y**2)**.5,m=d.x/R,u=d.y/R,c=0;m!=0&&(c=(i.x-(s.width+r.width)*.5-o.x)/m,o.x<i.x&&c<0&&o.y+c*u<i.y+(s.height+r.height)*.5&&o.y+c*u>i.y-(s.height+r.height)*.5&&(o.x+=c*m,o.y+=c*u,d.x>0&&(d.x*=-1),d.y+=T.y),c=(i.x+(s.width+r.width)*.5-o.x)/m,o.x>i.x&&c<0&&o.y+c*u<i.y+(s.height+r.height)*.5&&o.y+c*u>i.y-(s.height+r.height)*.5&&(o.x+=c*m,o.y+=c*u,d.x<0&&(d.x*=-1),d.y+=T.y)),u!=0&&(c=(i.y-(s.height+r.height)*.5-o.y)/u,o.y<i.y&&c<0&&o.x+c*m<i.x+(s.width+r.width)*.5&&o.x+c*m>i.x-(s.width+r.width)*.5&&(o.x+=c*m,o.y+=c*u,d.y>0&&(d.y*=-1)),c=(i.y+(s.height+r.height)*.5-o.y)/u,o.y>i.y&&c<0&&o.x+c*m<i.x+(s.width+r.width)*.5&&o.x+c*m>i.x-(s.width+r.width)*.5&&(o.x+=c*m,o.y+=c*u,d.y<0&&(d.y*=-1)))}var k={left:0,right:0},P=F(`${k.left} : ${k.right}`),L=x.getComponent(P,b);L.color="white";L.fontSize=40;$();(function e(){x.update(H,D,G,q,z,N,U),requestAnimationFrame(e)})();})();
