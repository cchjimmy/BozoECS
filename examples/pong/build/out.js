(()=>{var A=class{storage=[];map=new Map;objectFactory;constructor(e){this.objectFactory=e}size(){return this.map.size}add(e){let t=this.map.get(e);return t||(this.storage.push(this.objectFactory()),this.map.set(e,this.storage[this.storage.length-1]),this.storage[this.storage.length-1])}remove(e){this.map.delete(e)}get(e){let t=this.map.get(e);if(!t)throw new Error("Key not found");return t}has(e){return this.map.has(e)}clean(){this.storage.splice(this.map.size)}};var b=class{pools=new Map;idMap=new Map;register(e){this.pools.has(e)||(this.idMap.set(e,this.idMap.size),this.pools.set(e,new A(()=>({...e}))))}getId(e){return this.idMap.get(e)??-1}add(e,t){return Object.assign(this.pools.get(t).add(e),t)}remove(e,t){this.pools.get(t).remove(e)}get(e,t){return this.pools.get(t).get(e)}size(e){return this.pools.get(e).size()}delete(e){for(let t of this.pools.values())t.remove(e)}copy(e,t){for(let n of this.pools.values())n.has(e)&&Object.assign(n.add(t),n.get(e))}clean(){for(let e of this.pools.values())e.clean()}};function S(){return Math.random()}var k=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new b;addEntity(e=S()){return this.maskMap.set(e,0),this.getArchetype(0).add(e),e}copyEntity(e,t=S()){this.compManager.copy(e,t);let n=this.maskMap.get(e)??0;return this.maskMap.set(t,n),this.getArchetype(n).add(t),t}getArchetype(e){let t=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,t),t}deleteEntity(e){this.entitiesToDelete.push(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,t){return((this.maskMap.get(e)??0)&1<<this.compManager.getId(t))>0}addComponent(e,t,n=t){this.registerComponent(t);let i=this.maskMap.get(e)??0,a=this.compManager.getId(t);return(i&1<<a)!=0?Object.assign(this.compManager.get(e,t),n):(this.getArchetype(i).delete(e),i|=1<<a,this.maskMap.set(e,i),this.getArchetype(i).add(e),Object.assign(this.compManager.add(e,t),n))}removeComponent(e,t){this.registerComponent(t);let n=this.maskMap.get(e)??0,i=this.compManager.getId(t);if((n&1<<i)==0)return!1;this.getArchetype(n).delete(e),n&=~(1<<i),this.maskMap.set(e,n),this.getArchetype(n).add(e),this.compManager.remove(e,t)}getComponent(e,t){return this.compManager.get(e,t)}update(...e){for(let t=0,n=e.length;t<n;t++)e[t](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let e=this.entitiesToDelete.pop();this.compManager.delete(e);let t=this.maskMap.get(e)??0;this.maskMap.delete(e),this.getArchetype(t).delete(e)}}cleanObjectPools(){this.compManager.clean()}query(e){let t=0,n=0;if(e.and)for(let a=0,s=e.and.length;a<s;a++)t|=1<<this.compManager.getId(e.and[a]);if(e.not)for(let a=0,s=e.not.length;a<s;a++)n|=1<<this.compManager.getId(e.not[a]);let i=[];return this.archetypeMap.forEach((a,s)=>{let p=a;p.size>0&&(s&t)==t&&(s&n)==0&&i.push(...p)}),[...new Set(i)]}entityCount(){return this.maskMap.size}};var h={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var g=document.querySelector("canvas"),c=g?.getContext("2d"),m={width:1,height:1,color:"white"},d={x:0,y:0},u={x:0,y:0},C={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},E={isLeft:!0},l=new k;function $(o){o.query({and:[u,E]}).forEach(e=>{let t=o.getComponent(e,u),n=o.getComponent(e,E);t.y=0,n.isLeft?(x.w&&(t.y-=1),x.s&&(t.y+=1)):(x.ArrowUp&&(t.y-=1),x.ArrowDown&&(t.y+=1));for(let i of Object.values(P)){if(c){let a=c.fillStyle;c.fillStyle="green",c.fillRect(i.x,i.y,20,20),c.fillStyle=a}if(i.x<h.playArea.width*.5){if(!n.isLeft)continue}else if(n.isLeft)continue;i.y<h.playArea.height*.5&&(t.y-=1),i.y>h.playArea.height*.5&&(t.y+=1)}t.y=t.y/Math.abs(t.y||1)*h.paddle.speed})}function F(){!c||!g||c.fillRect(0,0,g.width,g.height)}function q(o){let e=z/1e3;o.query({and:[d,u]}).forEach(t=>{let n=o.getComponent(t,d),i=o.getComponent(t,u);n.x+=i.x*e,n.y+=i.y*e})}function H(o){c&&o.query({and:[m,d]}).forEach(e=>{let t=o.getComponent(e,d),n=o.getComponent(e,m),i=c.fillStyle;c.fillStyle=n.color,c.fillRect(Math.floor(t.x-n.width*.5),Math.floor(t.y-n.height*.5),n.width,n.height),c.fillStyle=i})}function W(o){c&&o.query({and:[C,d]}).forEach(e=>{let t=o.getComponent(e,C),n=o.getComponent(e,d);c.font=`${t.fontSize}px serif`;let i=c.measureText(t.content),a=c.fillStyle;c.fillStyle=t.backgroundColor,c.fillRect(n.x,n.y,t.padding*2+i.width,t.padding*2+i.fontBoundingBoxAscent),c.fillStyle=t.color,c.fillText(t.content,n.x+t.padding,n.y+t.padding+i.fontBoundingBoxAscent),c.fillStyle=a})}function G(o){let e=o.query({and:[d,m]});e.forEach(t=>{let n=o.getComponent(t,d),i=o.getComponent(t,m);e.forEach(a=>{if(a==t)return;let s=o.getComponent(a,d),p=o.getComponent(a,m);(n.x-s.x)**2<((i.width+p.width)*.5)**2&&(n.y-s.y)**2<((i.height+p.height)*.5)**2&&Y(t,a)})})}function N(o){let e=o.getComponent(T,d),t=o.getComponent(T,m);e.x-t.width>h.playArea.width&&(w.left++,j()),e.x+t.width<0&&(w.right++,j())}function R(o,e,t){let n=v(o,e,h.paddle.width,h.paddle.height),i=l.addComponent(n,E);return i.isLeft=t,n}function v(o,e,t,n,i="white"){let a=l.addEntity(),s=l.addComponent(a,d),p=l.addComponent(a,m);return l.addComponent(a,u),s.x=o,s.y=e,p.width=t,p.height=n,p.color=i,a}function V(o,e=0,t=0,n="black",i=20,a="rgba(0,0,0,0)"){let s=l.addEntity(),p=l.addComponent(s,C),M=l.addComponent(s,d);return p.content=o,p.color=n,p.fontSize=i,p.backgroundColor=a,M.x=e,M.y=t,s}g&&(g.width=h.playArea.width,g.height=h.playArea.height);var x={};globalThis.onkeydown=o=>{x[o.key]=!0};globalThis.onkeyup=o=>{delete x[o.key]};var P={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=o=>{if(!g)return;let e=g.getBoundingClientRect();for(let t=0,n=o.changedTouches.length;t<n;t++){let i=P[o.changedTouches[t].identifier]={x:o.changedTouches[t].clientX,y:o.changedTouches[t].clientY};i.x-=e.left,i.y-=e.top,innerWidth/innerHeight<g.width/g.height?(i.x*=g.width/innerWidth,i.y*=g.width/innerWidth):(i.x*=g.height/innerHeight,i.y*=g.height/innerHeight)}};globalThis.window.ontouchend=o=>{for(let e=0,t=o.changedTouches.length;e<t;e++)delete P[o.changedTouches[e].identifier]};v(h.playArea.width*.5,h.playArea.height*0,h.playArea.width,10);v(h.playArea.width*.5,h.playArea.height*1,h.playArea.width,10);var T=v(h.playArea.width*.5,h.playArea.height*.5,h.ball.width,h.ball.height),K=R(h.playArea.width*h.paddle.padding,h.playArea.height*.5,!0),U=R(h.playArea.width*(1-h.paddle.padding),h.playArea.height*.5,!1);function D(){let o=l.getComponent(T,u),e=l.getComponent(T,d);e.x=h.playArea.width*.5,e.y=h.playArea.height*.5,o.x=h.ball.speed,o.y=0;let t=Math.random()*40/180*Math.PI;t*=Math.random()>.5?1:-1,t+=Math.random()>.5?Math.PI:0,X(o,t);let n=l.getComponent(K,d),i=l.getComponent(U,d);n.y=h.playArea.height*.5,i.y=h.playArea.height*.5}function X(o,e){let t=Math.sin(e),n=Math.cos(e),i=o.x,a=o.y;o.x=n*i-t*a,o.y=t*i+n*a}function j(){let o=l.getComponent(L,C);o.content=`${w.left} : ${w.right}`,D()}function Y(o,e){let t=l.getComponent(o,d),n=l.getComponent(e,d),i=l.getComponent(o,m),a=l.getComponent(e,m),s=l.getComponent(o,u),p=l.getComponent(e,u),M=(s.x**2+s.y**2)**.5,y=s.x/M,f=s.y/M,r=0;y!=0&&(r=(n.x-(a.width+i.width)*.5-t.x)/y,t.x<n.x&&r<0&&t.y+r*f<n.y+(a.height+i.height)*.5&&t.y+r*f>n.y-(a.height+i.height)*.5&&(t.x+=r*y,t.y+=r*f,s.x>0&&(s.x*=-1),s.y+=p.y),r=(n.x+(a.width+i.width)*.5-t.x)/y,t.x>n.x&&r<0&&t.y+r*f<n.y+(a.height+i.height)*.5&&t.y+r*f>n.y-(a.height+i.height)*.5&&(t.x+=r*y,t.y+=r*f,s.x<0&&(s.x*=-1),s.y+=p.y)),f!=0&&(r=(n.y-(a.height+i.height)*.5-t.y)/f,t.y<n.y&&r<0&&t.x+r*y<n.x+(a.width+i.width)*.5&&t.x+r*y>n.x-(a.width+i.width)*.5&&(t.x+=r*y,t.y+=r*f,s.y>0&&(s.y*=-1)),r=(n.y+(a.height+i.height)*.5-t.y)/f,t.y>n.y&&r<0&&t.x+r*y<n.x+(a.width+i.width)*.5&&t.x+r*y>n.x-(a.width+i.width)*.5&&(t.x+=r*y,t.y+=r*f,s.y<0&&(s.y*=-1)))}var w={left:0,right:0},L=V(`${w.left} : ${w.right}`),B=l.getComponent(L,C);B.color="white";B.fontSize=40;var z=0,I=0;D();(function o(){l.update(F,H,W,q,$,G,N),z=performance.now()-I,I+=z,requestAnimationFrame(o)})();})();
//# sourceMappingURL=out.js.map
