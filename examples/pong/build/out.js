(()=>{var w=class{storage=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(){let t;return this.size<this.storage.length?t=this.storage[this.size]:(t=this.objectFactory(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(e=>e==t)}removeObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");let e=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=e,this.size--,e}getObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var u=class n{static pools=new Map;static idMap=new Map;static register(t){n.idMap.set(t,n.idMap.size),n.pools.set(t,new w(()=>({...t})))}static getId(t){return n.idMap.get(t)??-1}static add(t){return Object.assign(n.pools.get(t).addObj(),t)}static delete(t,e){return n.pools.get(t).removeObj(e)}static get(t,e){return n.pools.get(t).getObj(e)}static len(t){return n.pools.get(t).len()}static typeLen(){return n.pools.size}static types(){return n.pools.keys().toArray()}};var T=class n{static nextId=0;static pool=new w(()=>n.nextId++);static add(){return n.pool.addObj()}static findIndex(t){return n.pool.findIndex(t)}static delete(t){return n.pool.removeObj(t)}};var s=class n{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];localEntities=new Set;timeMilli=0;dtMilli=0;constructor(){n.worlds.push(this)}static createEntity(){let t=T.add();return n.maskMap.set(t,0),n.getArchetype(0).add(t),t}static getArchetype(t){let e=n.archetypeMap.get(t)??new Set;return n.archetypeMap.set(t,e),e}static deleteEntity(t){for(let o=0,r=n.worlds.length;o<r;o++)n.worlds[o].removeEntity(t);let e=u.types(),i=n.maskMap.get(t);for(let o=0,r=e.length;o<r;o++)i&1<<o&&n.removeComponent(t,e[o]);T.delete(T.findIndex(t))}addEntity(t=n.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static registerComponent(t){return n.indexMap.has(t)||(u.register(t),n.indexMap.set(t,new Map)),n}static hasComponent(t,e){return!!(n.maskMap.get(t)&1<<u.getId(e))}static addComponent(t,e,i={}){n.registerComponent(e);let o=n.maskMap.get(t),r=u.getId(e);if((o&1<<r)!=0)throw new Error(`Entity ${t} already had that component.`);n.getArchetype(o).delete(t),o|=1<<r,n.maskMap.set(t,o),n.getArchetype(o).add(t);let a=u.len(e);return n.indexMap.get(e).set(t,a),Object.assign(u.add(e),i)}static removeComponent(t,e){n.registerComponent(e);let i=n.maskMap.get(t),o=u.getId(e);if((i&1<<o)==0)throw new Error(`Entity ${t} does not have that component.`);n.getArchetype(i).delete(t),i&=~(1<<o),n.maskMap.set(t,i),n.getArchetype(i).add(t);let r=n.indexMap.get(e),a=r.get(t),c=u.delete(e,a),y=r.keys().toArray().at(-1)??-1;return r.set(y,a),r.delete(t),c}static getComponent(t,e){return u.get(e,n.indexMap.get(e).get(t))}update(...t){for(let e=0,i=t.length;e<i;e++)t[e](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let e=0,i=0,o=0;if(t.and)for(let a=0,c=t.and.length;a<c;a++)e|=1<<u.getId(t.and[a]);if(t.or)for(let a=0,c=t.or.length;a<c;a++)i|=1<<u.getId(t.or[a]);if(t.not)for(let a=0,c=t.not.length;a<c;a++)o|=1<<u.getId(t.not[a]);let r=[];for(let a=n.archetypeMap.keys().toArray(),c=a.length,y=0;y<c;y++){let g=a[y],m=n.getArchetype(g);m.size>0&&(g&e)==e&&(g|i)>0&&(g&o)==0&&r.push(...this.localEntities.intersection(m))}return r}entityCount(){return this.localEntities.size}};var l={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var f=document.querySelector("canvas"),h=f?.getContext("2d"),b={width:1,height:1,color:"white"},p={x:0,y:0},x={x:0,y:0},A={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},E={isLeft:!0},v=new s;function L(n){n.query({and:[x,E]}).forEach(t=>{let e=s.getComponent(t,x),i=s.getComponent(t,E);e.y=0,i.isLeft?(M.w&&(e.y-=1),M.s&&(e.y+=1)):(M.ArrowUp&&(e.y-=1),M.ArrowDown&&(e.y+=1));for(let o of Object.values(I)){if(h){let r=h.fillStyle;h.fillStyle="green",h.fillRect(o.x,o.y,20,20),h.fillStyle=r}if(o.x<l.playArea.width*.5){if(!i.isLeft)continue}else if(i.isLeft)continue;o.y<l.playArea.height*.5&&(e.y-=1),o.y>l.playArea.height*.5&&(e.y+=1)}e.y=e.y/Math.abs(e.y||1)*l.paddle.speed})}function $(){!h||!f||h.fillRect(0,0,f.width,f.height)}function B(n){let t=n.dtMilli/1e3;n.query({and:[p,x]}).forEach(e=>{let i=s.getComponent(e,p),o=s.getComponent(e,x);i.x+=o.x*t,i.y+=o.y*t})}function F(n){h&&n.query({and:[b,p]}).forEach(t=>{let e=s.getComponent(t,p),i=s.getComponent(t,b),o=h.fillStyle;h.fillStyle=i.color,h.fillRect(Math.floor(e.x-i.width*.5),Math.floor(e.y-i.height*.5),i.width,i.height),h.fillStyle=o})}function H(n){h&&n.query({and:[A,p]}).forEach(t=>{let e=s.getComponent(t,A),i=s.getComponent(t,p);h.font=`${e.fontSize}px serif`;let o=h.measureText(e.content),r=h.fillStyle;h.fillStyle=e.backgroundColor,h.fillRect(i.x,i.y,e.padding*2+o.width,e.padding*2+o.fontBoundingBoxAscent),h.fillStyle=e.color,h.fillText(e.content,i.x+e.padding,i.y+e.padding+o.fontBoundingBoxAscent),h.fillStyle=r})}function q(n){let t=n.query({and:[p,b]});t.forEach(e=>{let i=s.getComponent(e,p),o=s.getComponent(e,b);t.forEach(r=>{if(r==e)return;let a=s.getComponent(r,p),c=s.getComponent(r,b);(i.x-a.x)**2<((o.width+c.width)*.5)**2&&(i.y-a.y)**2<((o.height+c.height)*.5)**2&&U(e,r)})})}function G(){let n=s.getComponent(j,p),t=s.getComponent(j,b);n.x-t.width>l.playArea.width&&(C.left++,S()),n.x+t.width<0&&(C.right++,S())}function P(n,t,e){let i=k(n,t,l.paddle.width,l.paddle.height),o=s.addComponent(i,E);return o.isLeft=e,v.addEntity(i)}function k(n,t,e,i,o="white"){let r=s.createEntity(),a=s.addComponent(r,p),c=s.addComponent(r,x),y=s.addComponent(r,b);return a.x=n,a.y=t,y.width=e,y.height=i,y.color=o,v.addEntity(r)}function N(n,t=0,e=0,i="black",o=20,r="rgba(0,0,0,0)"){let a=s.createEntity(),c=s.addComponent(a,A),y=s.addComponent(a,p);return c.content=n,c.color=i,c.fontSize=o,c.backgroundColor=r,y.x=t,y.y=e,v.addEntity(a)}f&&(f.width=l.playArea.width,f.height=l.playArea.height);var M={};globalThis.onkeydown=n=>{M[n.key]=!0};globalThis.onkeyup=n=>{delete M[n.key]};var I={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=n=>{if(!f)return;let t=f.getBoundingClientRect();for(let e=0,i=n.changedTouches.length;e<i;e++){let o=I[n.changedTouches[e].identifier]={x:n.changedTouches[e].clientX,y:n.changedTouches[e].clientY};o.x-=t.left,o.y-=t.top,innerWidth/innerHeight<f.width/f.height?(o.x*=f.width/innerWidth,o.y*=f.width/innerWidth):(o.x*=f.height/innerHeight,o.y*=f.height/innerHeight)}};globalThis.window.ontouchend=n=>{for(let t=0,e=n.changedTouches.length;t<e;t++)delete I[n.changedTouches[t].identifier]};k(l.playArea.width*.5,l.playArea.height*0,l.playArea.width,10);k(l.playArea.width*.5,l.playArea.height*1,l.playArea.width,10);var j=k(l.playArea.width*.5,l.playArea.height*.5,l.ball.width,l.ball.height),V=P(l.playArea.width*l.paddle.padding,l.playArea.height*.5,!0),D=P(l.playArea.width*(1-l.paddle.padding),l.playArea.height*.5,!1);function z(){let n=s.getComponent(j,x),t=s.getComponent(j,p);t.x=l.playArea.width*.5,t.y=l.playArea.height*.5,n.x=l.ball.speed,n.y=0;let e=Math.random()*40/180*Math.PI;e*=Math.random()>.5?1:-1,e+=Math.random()>.5?Math.PI:0,K(n,e);let i=s.getComponent(V,p),o=s.getComponent(D,p);i.y=l.playArea.height*.5,o.y=l.playArea.height*.5}function K(n,t){let e=Math.sin(t),i=Math.cos(t),o=n.x,r=n.y;n.x=i*o-e*r,n.y=e*o+i*r}function S(){let n=s.getComponent(O,A);n.content=`${C.left} : ${C.right}`,z()}function U(n,t){let e=s.getComponent(n,p),i=s.getComponent(t,p),o=s.getComponent(n,b),r=s.getComponent(t,b),a=s.getComponent(n,x),c=s.getComponent(t,x),y=(a.x**2+a.y**2)**.5,g=a.x/y,m=a.y/y,d=0;g!=0&&(d=(i.x-(r.width+o.width)*.5-e.x)/g,e.x<i.x&&d<0&&e.y+d*m<i.y+(r.height+o.height)*.5&&e.y+d*m>i.y-(r.height+o.height)*.5&&(e.x+=d*g,e.y+=d*m,a.x>0&&(a.x*=-1),a.y+=c.y),d=(i.x+(r.width+o.width)*.5-e.x)/g,e.x>i.x&&d<0&&e.y+d*m<i.y+(r.height+o.height)*.5&&e.y+d*m>i.y-(r.height+o.height)*.5&&(e.x+=d*g,e.y+=d*m,a.x<0&&(a.x*=-1),a.y+=c.y)),m!=0&&(d=(i.y-(r.height+o.height)*.5-e.y)/m,e.y<i.y&&d<0&&e.x+d*g<i.x+(r.width+o.width)*.5&&e.x+d*g>i.x-(r.width+o.width)*.5&&(e.x+=d*g,e.y+=d*m,a.y>0&&(a.y*=-1)),d=(i.y+(r.height+o.height)*.5-e.y)/m,e.y>i.y&&d<0&&e.x+d*g<i.x+(r.width+o.width)*.5&&e.x+d*g>i.x-(r.width+o.width)*.5&&(e.x+=d*g,e.y+=d*m,a.y<0&&(a.y*=-1)))}var C={left:0,right:0},O=N(`${C.left} : ${C.right}`),R=s.getComponent(O,A);R.color="white";R.fontSize=40;z();(function n(){v.update($,F,H,B,L,q,G),requestAnimationFrame(n)})();})();
//# sourceMappingURL=out.js.map
