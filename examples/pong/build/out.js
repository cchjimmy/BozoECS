(()=>{var w=class{storage=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(){let t;return this.size<this.storage.length?t=this.storage[this.size]:(t=this.objectFactory(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(e=>e==t)}removeObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");let e=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=e,this.size--,e}getObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var f=class n{static pools=new Map;static idMap=new Map;static register(t){n.idMap.set(t,n.idMap.size),n.pools.set(t,new w(()=>({...t})))}static getId(t){return n.idMap.get(t)??-1}static add(t){return Object.assign(n.pools.get(t).addObj(),t)}static delete(t,e){return n.pools.get(t).removeObj(e)}static get(t,e){return n.pools.get(t).getObj(e)}static len(t){return n.pools.get(t).len()}static typeLen(){return n.pools.size}static types(){return n.pools.keys().toArray()}};var T=class n{static nextId=0;static pool=new w(()=>n.nextId++);static add(){return n.pool.addObj()}static findIndex(t){return n.pool.findIndex(t)}static delete(t){return n.pool.removeObj(t)}};var a=class n{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];localEntities=new Set;timeMilli=0;dtMilli=0;constructor(){n.worlds.push(this)}static createEntity(){let t=T.add();return n.maskMap.set(t,0),n.getArchetype(0).add(t),t}static getArchetype(t){let e=n.archetypeMap.get(t)??new Set;return n.archetypeMap.set(t,e),e}static deleteEntity(t){for(let o=0,r=n.worlds.length;o<r;o++)n.worlds[o].removeEntity(t);let e=f.types(),i=n.maskMap.get(t);for(let o=0,r=e.length;o<r;o++)i&1<<o&&n.removeComponent(t,e[o]);T.delete(T.findIndex(t))}addEntity(t=n.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static registerComponent(t){return n.indexMap.has(t)||(f.register(t),n.indexMap.set(t,new Map)),n}static hasComponent(t,e){return!!(n.maskMap.get(t)&1<<f.getId(e))}static addComponent(t,e,i={}){n.registerComponent(e);let o=n.maskMap.get(t),r=f.getId(e);if((o&1<<r)!=0)throw new Error(`Entity ${t} already had that component.`);n.getArchetype(o).delete(t),o|=1<<r,n.maskMap.set(t,o),n.getArchetype(o).add(t);let s=f.len(e);return n.indexMap.get(e).set(t,s),Object.assign(f.add(e),i)}static removeComponent(t,e){n.registerComponent(e);let i=n.maskMap.get(t),o=f.getId(e);if((i&1<<o)==0)throw new Error(`Entity ${t} does not have that component.`);n.getArchetype(i).delete(t),i&=~(1<<o),n.maskMap.set(t,i),n.getArchetype(i).add(t);let r=n.indexMap.get(e),s=r.get(t),h=f.delete(e,s),y=r.keys().toArray().at(-1)??-1;return r.set(y,s),r.delete(t),h}static getComponent(t,e){return f.get(e,n.indexMap.get(e).get(t))}update(...t){for(let e=0,i=t.length;e<i;e++)t[e](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let e=0,i=0;if(t.and)for(let r=0,s=t.and.length;r<s;r++)e|=1<<f.getId(t.and[r]);if(t.not)for(let r=0,s=t.not.length;r<s;r++)i|=1<<f.getId(t.not[r]);let o=[];for(let r=n.archetypeMap.keys().toArray(),s=r.length,h=0;h<s;h++){let y=r[h],u=n.getArchetype(y);u.size!=0&&(y&e)==e&&(y&i)==0&&o.push(...u)}return[...this.localEntities.intersection(new Set(o))]}entityCount(){return this.localEntities.size}};var l={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var g=document.querySelector("canvas"),c=g?.getContext("2d"),b={width:1,height:1,color:"white"},p={x:0,y:0},x={x:0,y:0},A={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},k={isLeft:!0},v=new a;function L(n){n.query({and:[x,k]}).forEach(t=>{let e=a.getComponent(t,x),i=a.getComponent(t,k);e.y=0,i.isLeft?(M.w&&(e.y-=1),M.s&&(e.y+=1)):(M.ArrowUp&&(e.y-=1),M.ArrowDown&&(e.y+=1));for(let o of Object.values(S)){if(c){let r=c.fillStyle;c.fillStyle="green",c.fillRect(o.x,o.y,20,20),c.fillStyle=r}if(o.x<l.playArea.width*.5){if(!i.isLeft)continue}else if(i.isLeft)continue;o.y<l.playArea.height*.5&&(e.y-=1),o.y>l.playArea.height*.5&&(e.y+=1)}e.y=e.y/Math.abs(e.y||1)*l.paddle.speed})}function $(){!c||!g||c.fillRect(0,0,g.width,g.height)}function B(n){let t=n.dtMilli/1e3;n.query({and:[p,x]}).forEach(e=>{let i=a.getComponent(e,p),o=a.getComponent(e,x);i.x+=o.x*t,i.y+=o.y*t})}function q(n){c&&n.query({and:[b,p]}).forEach(t=>{let e=a.getComponent(t,p),i=a.getComponent(t,b),o=c.fillStyle;c.fillStyle=i.color,c.fillRect(Math.floor(e.x-i.width*.5),Math.floor(e.y-i.height*.5),i.width,i.height),c.fillStyle=o})}function F(n){c&&n.query({and:[A,p]}).forEach(t=>{let e=a.getComponent(t,A),i=a.getComponent(t,p);c.font=`${e.fontSize}px serif`;let o=c.measureText(e.content),r=c.fillStyle;c.fillStyle=e.backgroundColor,c.fillRect(i.x,i.y,e.padding*2+o.width,e.padding*2+o.fontBoundingBoxAscent),c.fillStyle=e.color,c.fillText(e.content,i.x+e.padding,i.y+e.padding+o.fontBoundingBoxAscent),c.fillStyle=r})}function H(n){let t=n.query({and:[p,b]});t.forEach(e=>{let i=a.getComponent(e,p),o=a.getComponent(e,b);t.forEach(r=>{if(r==e)return;let s=a.getComponent(r,p),h=a.getComponent(r,b);(i.x-s.x)**2<((o.width+h.width)*.5)**2&&(i.y-s.y)**2<((o.height+h.height)*.5)**2&&U(e,r)})})}function G(){let n=a.getComponent(j,p),t=a.getComponent(j,b);n.x-t.width>l.playArea.width&&(C.left++,I()),n.x+t.width<0&&(C.right++,I())}function P(n,t,e){let i=E(n,t,l.paddle.width,l.paddle.height),o=a.addComponent(i,k);return o.isLeft=e,v.addEntity(i)}function E(n,t,e,i,o="white"){let r=a.createEntity(),s=a.addComponent(r,p),h=a.addComponent(r,x),y=a.addComponent(r,b);return s.x=n,s.y=t,y.width=e,y.height=i,y.color=o,v.addEntity(r)}function N(n,t=0,e=0,i="black",o=20,r="rgba(0,0,0,0)"){let s=a.createEntity(),h=a.addComponent(s,A),y=a.addComponent(s,p);return h.content=n,h.color=i,h.fontSize=o,h.backgroundColor=r,y.x=t,y.y=e,v.addEntity(s)}g&&(g.width=l.playArea.width,g.height=l.playArea.height);var M={};globalThis.onkeydown=n=>{M[n.key]=!0};globalThis.onkeyup=n=>{delete M[n.key]};var S={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=n=>{if(!g)return;let t=g.getBoundingClientRect();for(let e=0,i=n.changedTouches.length;e<i;e++){let o=S[n.changedTouches[e].identifier]={x:n.changedTouches[e].clientX,y:n.changedTouches[e].clientY};o.x-=t.left,o.y-=t.top,innerWidth/innerHeight<g.width/g.height?(o.x*=g.width/innerWidth,o.y*=g.width/innerWidth):(o.x*=g.height/innerHeight,o.y*=g.height/innerHeight)}};globalThis.window.ontouchend=n=>{for(let t=0,e=n.changedTouches.length;t<e;t++)delete S[n.changedTouches[t].identifier]};E(l.playArea.width*.5,l.playArea.height*0,l.playArea.width,10);E(l.playArea.width*.5,l.playArea.height*1,l.playArea.width,10);var j=E(l.playArea.width*.5,l.playArea.height*.5,l.ball.width,l.ball.height),V=P(l.playArea.width*l.paddle.padding,l.playArea.height*.5,!0),D=P(l.playArea.width*(1-l.paddle.padding),l.playArea.height*.5,!1);function z(){let n=a.getComponent(j,x),t=a.getComponent(j,p);t.x=l.playArea.width*.5,t.y=l.playArea.height*.5,n.x=l.ball.speed,n.y=0;let e=Math.random()*40/180*Math.PI;e*=Math.random()>.5?1:-1,e+=Math.random()>.5?Math.PI:0,K(n,e);let i=a.getComponent(V,p),o=a.getComponent(D,p);i.y=l.playArea.height*.5,o.y=l.playArea.height*.5}function K(n,t){let e=Math.sin(t),i=Math.cos(t),o=n.x,r=n.y;n.x=i*o-e*r,n.y=e*o+i*r}function I(){let n=a.getComponent(O,A);n.content=`${C.left} : ${C.right}`,z()}function U(n,t){let e=a.getComponent(n,p),i=a.getComponent(t,p),o=a.getComponent(n,b),r=a.getComponent(t,b),s=a.getComponent(n,x),h=a.getComponent(t,x),y=(s.x**2+s.y**2)**.5,u=s.x/y,m=s.y/y,d=0;u!=0&&(d=(i.x-(r.width+o.width)*.5-e.x)/u,e.x<i.x&&d<0&&e.y+d*m<i.y+(r.height+o.height)*.5&&e.y+d*m>i.y-(r.height+o.height)*.5&&(e.x+=d*u,e.y+=d*m,s.x>0&&(s.x*=-1),s.y+=h.y),d=(i.x+(r.width+o.width)*.5-e.x)/u,e.x>i.x&&d<0&&e.y+d*m<i.y+(r.height+o.height)*.5&&e.y+d*m>i.y-(r.height+o.height)*.5&&(e.x+=d*u,e.y+=d*m,s.x<0&&(s.x*=-1),s.y+=h.y)),m!=0&&(d=(i.y-(r.height+o.height)*.5-e.y)/m,e.y<i.y&&d<0&&e.x+d*u<i.x+(r.width+o.width)*.5&&e.x+d*u>i.x-(r.width+o.width)*.5&&(e.x+=d*u,e.y+=d*m,s.y>0&&(s.y*=-1)),d=(i.y+(r.height+o.height)*.5-e.y)/m,e.y>i.y&&d<0&&e.x+d*u<i.x+(r.width+o.width)*.5&&e.x+d*u>i.x-(r.width+o.width)*.5&&(e.x+=d*u,e.y+=d*m,s.y<0&&(s.y*=-1)))}var C={left:0,right:0},O=N(`${C.left} : ${C.right}`),R=a.getComponent(O,A);R.color="white";R.fontSize=40;z();(function n(){v.update($,q,F,B,L,H,G),requestAnimationFrame(n)})();})();
//# sourceMappingURL=out.js.map
