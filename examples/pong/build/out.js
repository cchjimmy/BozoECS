(()=>{var C=class{storage=new Map;freeKeys=new Set;count=0;objectFactory;constructor(e){this.objectFactory=e}size(){return this.count}add(e){if(this.has(e))return this.storage.get(e);let t,o;if(this.freeKeys.has(e))o=e;else for(let n of this.freeKeys){o=n;break}return o!=null&&(this.freeKeys.delete(o),t=this.storage.get(o),this.storage.delete(o)),t=t??this.objectFactory(),this.storage.set(e,t),this.count++,t}remove(e){this.has(e)&&(this.freeKeys.add(e),this.count--)}get(e){let t=this.storage.get(e);if(t==null)throw new Error("Key not found.");return t}has(e){return this.storage.has(e)&&!this.freeKeys.has(e)}clean(){for(let e of this.freeKeys)this.storage.delete(e);this.freeKeys.clear()}};var T=class{poolMap=new Map;maskMap=new Map;register(e){this.poolMap.has(e)||(this.maskMap.set(e,1<<this.maskMap.size),this.poolMap.set(e,new C(()=>({...e}))))}getMask(e){return this.maskMap.get(e)??-1}add(e,t){return Object.assign(this.poolMap.get(t).add(e),t)}remove(e,t){this.poolMap.get(t).remove(e)}has(e,t){return this.poolMap.has(t)&&this.poolMap.get(t).has(e)}get(e,t){return this.poolMap.get(t).get(e)}size(e){return this.poolMap.get(e).size()}delete(e){for(let t of this.poolMap.entries())t[1].remove(e)}copy(e,t){for(let o of this.poolMap.entries())o[1].has(e)&&Object.assign(o[1].add(t),o[1].get(e))}clean(){for(let e of this.poolMap.entries())e[1].clean()}};function z(){return Math.random()}var A=class{maskMap=new Map;archetypeMap=new Map;compManager=new T;addEntity(e=z()){return this.maskMap.has(e)||this.maskMap.set(e,0),e}copyEntity(e,t=z()){this.compManager.copy(e,t);let o=this.maskMap.get(e)??0;return this.maskMap.set(t,o),this.getArchetype(o).add(t),t}getArchetype(e){let t=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,t),t}deleteEntity(e){this.compManager.delete(e),this.getArchetype(this.maskMap.get(e)??0).delete(e),this.maskMap.delete(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,t){return this.compManager.has(e,t)}addComponent(e,t,o=t){this.compManager.register(t);let n=this.maskMap.get(e)??0,s=this.compManager.getMask(t);return n&s?Object.assign(this.compManager.get(e,t),o):(this.getArchetype(n).delete(e),n^=s,this.maskMap.set(e,n),this.getArchetype(n).add(e),Object.assign(this.compManager.add(e,t),o))}removeComponent(e,t){this.compManager.register(t);let o=this.maskMap.get(e)??0,n=this.compManager.getMask(t);o&n^n||(this.compManager.remove(e,t),this.getArchetype(o).delete(e),o^=n,this.maskMap.set(e,o),this.getArchetype(o).add(e))}getComponent(e,t){return this.compManager.get(e,t)}update(...e){for(let t=0,o=e.length;t<o;t++)e[t](this)}cleanObjectPools(){this.compManager.clean()}query(e){let t=0,o=0;if(e.and)for(let s=0,h=e.and.length;s<h;s++)t|=this.compManager.getMask(e.and[s]);if(e.not)for(let s=0,h=e.not.length;s<h;s++)o|=this.compManager.getMask(e.not[s]);let n=[];for(let s of this.archetypeMap.entries())s[1].size>0&&(s[0]&t)==t&&(s[0]&o)==0&&n.push(...s[1]);return n}entityCount(){return this.maskMap.size}};var a={playArea:{width:600,height:400},paddle:{speed:200,width:10,height:70,padding:.1},ball:{speed:200,width:10,height:10}};var g=document.querySelector("canvas"),c=g?.getContext("2d"),u={width:1,height:1,color:"white"},l={x:0,y:0},x={x:0,y:0},k={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},v={isLeft:!0},d=new A;function $(i){i.query({and:[x,v]}).forEach(e=>{let t=i.getComponent(e,x),o=i.getComponent(e,v);t.y=0,o.isLeft?(m.w&&(t.y-=1),m.s&&(t.y+=1)):(m.ArrowUp&&(t.y-=1),m.ArrowDown&&(t.y+=1));for(let n of Object.values(S)){if(c){let s=c.fillStyle;c.fillStyle="green",c.fillRect(n.x,n.y,20,20),c.fillStyle=s}if(n.x<a.playArea.width*.5){if(!o.isLeft)continue}else if(o.isLeft)continue;n.y<a.playArea.height*.5&&(t.y-=1),n.y>a.playArea.height*.5&&(t.y+=1)}t.y=t.y/Math.abs(t.y||1)*a.paddle.speed})}function O(){!c||!g||c.fillRect(0,0,g.width,g.height)}function q(i){let e=K/1e3;i.query({and:[l,x]}).forEach(t=>{let o=i.getComponent(t,l),n=i.getComponent(t,x);o.x+=n.x*e,o.y+=n.y*e})}function H(i){c&&i.query({and:[u,l]}).forEach(e=>{let t=i.getComponent(e,l),o=i.getComponent(e,u),n=c.fillStyle;c.fillStyle=o.color,c.fillRect(Math.floor(t.x-o.width*.5),Math.floor(t.y-o.height*.5),o.width,o.height),c.fillStyle=n})}function W(i){c&&i.query({and:[k,l]}).forEach(e=>{let t=i.getComponent(e,k),o=i.getComponent(e,l);c.font=`${t.fontSize}px serif`;let n=c.measureText(t.content),s=c.fillStyle;c.fillStyle=t.backgroundColor,c.fillRect(o.x,o.y,t.padding*2+n.width,t.padding*2+n.fontBoundingBoxAscent),c.fillStyle=t.color,c.fillText(t.content,o.x+t.padding,o.y+t.padding+n.fontBoundingBoxAscent),c.fillStyle=s})}function G(i){let e=i.query({and:[l,u]});e.forEach(t=>{let o=i.getComponent(t,l),n=i.getComponent(t,u);e.forEach(s=>{if(s==t)return;let h=i.getComponent(s,l),p=i.getComponent(s,u);(o.x-h.x)**2<((n.width+p.width)*.5)**2&&(o.y-h.y)**2<((n.height+p.height)*.5)**2&&Y(t,s)})})}function N(i){let e=i.getComponent(b,l),t=i.getComponent(b,u);e.x-t.width>a.playArea.width&&(M.left++,E()),e.x+t.width<0&&(M.right++,E())}function P(i,e,t){let o=I(i,e,a.paddle.width,a.paddle.height),n=d.addComponent(o,v);return n.isLeft=t,o}function I(i,e,t,o,n="white"){let s=d.addEntity(),h=d.addComponent(s,l),p=d.addComponent(s,u);return d.addComponent(s,x),h.x=i,h.y=e,p.width=t,p.height=o,p.color=n,s}function V(i,e=0,t=0,o="black",n=20,s="rgba(0,0,0,0)"){let h=d.addEntity(),p=d.addComponent(h,k),w=d.addComponent(h,l);return p.content=i,p.color=o,p.fontSize=n,p.backgroundColor=s,w.x=e,w.y=t,h}g&&(g.width=a.playArea.width,g.height=a.playArea.height);var m={};globalThis.onkeydown=i=>{m[i.key]=!0};globalThis.onkeyup=i=>{delete m[i.key]};var S={};globalThis.window.ontouchmove=globalThis.window.ontouchstart=i=>{if(!g)return;let e=g.getBoundingClientRect();for(let t=0,o=i.changedTouches.length;t<o;t++){let n=S[i.changedTouches[t].identifier]={x:i.changedTouches[t].clientX,y:i.changedTouches[t].clientY};n.x-=e.left,n.y-=e.top,innerWidth/innerHeight<g.width/g.height?(n.x*=g.width/innerWidth,n.y*=g.width/innerWidth):(n.x*=g.height/innerHeight,n.y*=g.height/innerHeight)}};globalThis.window.ontouchend=i=>{for(let e=0,t=i.changedTouches.length;e<t;e++)delete S[i.changedTouches[e].identifier]};I(a.playArea.width*.5,a.playArea.height*0,a.playArea.width,10);I(a.playArea.width*.5,a.playArea.height*1,a.playArea.width,10);var b=I(a.playArea.width*.5,a.playArea.height*.5,a.ball.width,a.ball.height),D=P(a.playArea.width*a.paddle.padding,a.playArea.height*.5,!0),U=P(a.playArea.width*(1-a.paddle.padding),a.playArea.height*.5,!1);function R(){let i=d.getComponent(b,x),e=d.getComponent(b,l);e.x=a.playArea.width*.5,e.y=a.playArea.height*.5,i.x=a.ball.speed,i.y=0;let t=Math.random()*40/180*Math.PI;t*=Math.random()>.5?1:-1,t+=Math.random()>.5?Math.PI:0,X(i,t);let o=d.getComponent(D,l),n=d.getComponent(U,l);o.y=a.playArea.height*.5,n.y=a.playArea.height*.5}function X(i,e){let t=Math.sin(e),o=Math.cos(e),n=i.x,s=i.y;i.x=o*n-t*s,i.y=t*n+o*s}function E(){let i=d.getComponent(F,k);i.content=`${M.left} : ${M.right}`,R()}function Y(i,e){let t=d.getComponent(i,l),o=d.getComponent(e,l),n=d.getComponent(i,u),s=d.getComponent(e,u),h=d.getComponent(i,x),p=d.getComponent(e,x),w=(h.x**2+h.y**2)**.5,y=h.x/w,f=h.y/w,r=0;y!=0&&(r=(o.x-(s.width+n.width)*.5-t.x)/y,t.x<o.x&&r<0&&t.y+r*f<o.y+(s.height+n.height)*.5&&t.y+r*f>o.y-(s.height+n.height)*.5&&(t.x+=r*y,t.y+=r*f,h.x>0&&(h.x*=-1),h.y+=p.y),r=(o.x+(s.width+n.width)*.5-t.x)/y,t.x>o.x&&r<0&&t.y+r*f<o.y+(s.height+n.height)*.5&&t.y+r*f>o.y-(s.height+n.height)*.5&&(t.x+=r*y,t.y+=r*f,h.x<0&&(h.x*=-1),h.y+=p.y)),f!=0&&(r=(o.y-(s.height+n.height)*.5-t.y)/f,t.y<o.y&&r<0&&t.x+r*y<o.x+(s.width+n.width)*.5&&t.x+r*y>o.x-(s.width+n.width)*.5&&(t.x+=r*y,t.y+=r*f,h.y>0&&(h.y*=-1)),r=(o.y+(s.height+n.height)*.5-t.y)/f,t.y>o.y&&r<0&&t.x+r*y<o.x+(s.width+n.width)*.5&&t.x+r*y>o.x-(s.width+n.width)*.5&&(t.x+=r*y,t.y+=r*f,h.y<0&&(h.y*=-1)))}var M={left:0,right:0},F=V(`${M.left} : ${M.right}`),L=d.getComponent(F,k);L.color="white";L.fontSize=40;var K=0,j=0;R();(function i(){d.update(O,H,W,q,$,G,N),K=performance.now()-j,j+=K,requestAnimationFrame(i)})();})();
//# sourceMappingURL=out.js.map
