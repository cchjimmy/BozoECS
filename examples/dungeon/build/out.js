(()=>{var p=class{storage=new Map;freeKeys=new Set;count=0;objectFactory;constructor(e){this.objectFactory=e}size(){return this.count}add(e){if(this.has(e))return this.storage.get(e);let s,n;if(this.freeKeys.has(e))n=e;else for(let o of this.freeKeys){n=o;break}return n!=null&&(this.freeKeys.delete(n),s=this.storage.get(n),this.storage.delete(n)),s=s??this.objectFactory(),this.storage.set(e,s),this.count++,s}remove(e){this.has(e)&&(this.freeKeys.add(e),this.count--)}get(e){let s=this.storage.get(e);if(s==null)throw new Error("Key not found.");return s}has(e){return this.storage.has(e)&&!this.freeKeys.has(e)}clean(){for(let e of this.freeKeys)this.storage.delete(e);this.freeKeys.clear()}};var g=class{poolMap=new Map;maskMap=new Map;register(e){this.poolMap.has(e)||(this.maskMap.set(e,1<<this.maskMap.size),this.poolMap.set(e,new p(()=>({...e}))))}getMask(e){return this.maskMap.get(e)??-1}add(e,s){return Object.assign(this.poolMap.get(s).add(e),s)}remove(e,s){this.poolMap.get(s).remove(e)}has(e,s){return this.poolMap.has(s)&&this.poolMap.get(s).has(e)}get(e,s){return this.poolMap.get(s).get(e)}size(e){return this.poolMap.get(e).size()}delete(e){for(let s of this.poolMap.entries())s[1].remove(e)}copy(e,s){for(let n of this.poolMap.entries())n[1].has(e)&&Object.assign(n[1].add(s),n[1].get(e))}clean(){for(let e of this.poolMap.entries())e[1].clean()}};function y(){return Math.random()}var u=class{maskMap=new Map;archetypeMap=new Map;compManager=new g;addEntity(e=y()){return this.maskMap.has(e)||this.maskMap.set(e,0),e}copyEntity(e,s=y()){this.compManager.copy(e,s);let n=this.maskMap.get(e)??0;return this.maskMap.set(s,n),this.getArchetype(n).add(s),s}getArchetype(e){let s=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,s),s}deleteEntity(e){this.compManager.delete(e),this.getArchetype(this.maskMap.get(e)??0).delete(e),this.maskMap.delete(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,s){return this.compManager.has(e,s)}addComponent(e,s,n=s){this.compManager.register(s);let o=this.maskMap.get(e)??0,i=this.compManager.getMask(s);return o&i?Object.assign(this.compManager.get(e,s),n):(this.getArchetype(o).delete(e),o^=i,this.maskMap.set(e,o),this.getArchetype(o).add(e),Object.assign(this.compManager.add(e,s),n))}removeComponent(e,s){this.compManager.register(s);let n=this.maskMap.get(e)??0,o=this.compManager.getMask(s);n&o^o||(this.compManager.remove(e,s),this.getArchetype(n).delete(e),n^=o,this.maskMap.set(e,n),this.getArchetype(n).add(e))}getComponent(e,s){return this.compManager.get(e,s)}update(...e){for(let s=0,n=e.length;s<n;s++)e[s](this)}cleanObjectPools(){this.compManager.clean()}query(e){let s=0,n=0;if(e.and)for(let i=0,h=e.and.length;i<h;i++)s|=this.compManager.getMask(e.and[i]);if(e.not)for(let i=0,h=e.not.length;i<h;i++)n|=this.compManager.getMask(e.not[i]);let o=[];for(let i of this.archetypeMap.entries())i[1].size>0&&(i[0]&s)==s&&(i[0]&n)==0&&o.push(...i[1]);return o}entityCount(){return this.maskMap.size}};var r={x:0,y:0,rad:0,scaleX:0,scaleY:0},l={x:0,y:0},d={width:10,height:10},M={zoom:4},w={},a=v(),T=K(),c=z(),j=[],x=P();function v(){let t=document.querySelector("canvas")??document.createElement("canvas");if(!t)throw new Error("Cannot create canvas element.");let e=t.getContext("2d");if(!e)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(t),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<t.width/t.height?(t.style.width="100%",t.style.height=""):(t.style.width="",t.style.height="100%")},{canvas:t,ctx:e}}function z(){let t={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=e=>{!t.isDown[e.key]&&(t.justPressed[e.key]=!0),t.isDown[e.key]=!0},globalThis.onkeyup=e=>{t.isDown[e.key]=!1,t.justReleased[e.key]=!0},t}function I(t){for(let e in t.justPressed)t.justPressed[e]=!1;for(let e in t.justReleased)t.justReleased[e]=!1}function K(){let t={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=e=>{t.x=e.x,t.y=e.y,Object.assign(t.pressPos,t),t.isDown=t.justPressed=!0},globalThis.onpointerup=e=>{t.x=e.x,t.y=e.y,Object.assign(t.releasePos,t),t.isDown=!1,t.justReleased=!0},globalThis.onpointermove=e=>{t.x=e.x,t.y=e.y},t}function E(t){t.justPressed=!1,t.justReleased=!1}function P(){return{dtMilli:0,timeMilli:0}}function D(t){t.dtMilli=performance.now()-t.timeMilli,t.timeMilli+=t.dtMilli}function R(t){let e=a.ctx.fillStyle;a.ctx.fillStyle="white",a.ctx.beginPath(),t.query({and:[r,d]}).forEach(s=>{let n=t.getComponent(s,r),o=t.getComponent(s,d);a.ctx.rect(n.x-o.width*.5,n.y-o.height*.5,o.width,o.height)}),a.ctx.fill(),a.ctx.transform(1,0,0,-1,0,0),a.ctx.drawImage(j[0],0,0,10,10,0,0,10,10),a.ctx.transform(1,0,0,-1,0,0),a.ctx.fillStyle=e}function S(t){t.query({and:[l,w]}).forEach(e=>{let s=t.getComponent(e,l);s.x=+!!c.isDown.d-+!!c.isDown.a,s.y=+!!c.isDown.w-+!!c.isDown.s;let n=100;s.x*=n,s.y*=n,T.justPressed&&console.log("action")})}function A(t){t.query({and:[r,l]}).forEach(e=>{let s=t.getComponent(e,r),n=t.getComponent(e,l);s.x+=n.x*x.dtMilli/1e3,s.y+=n.y*x.dtMilli/1e3})}function F(t){t.query({and:[r,M]}).forEach(e=>{let s=t.getComponent(e,r),n=t.getComponent(e,M);a.ctx.setTransform(n.zoom,0,0,-n.zoom,-s.x*n.zoom+a.canvas.width*.5,s.y*n.zoom+a.canvas.height*.5)})}function C(t,e=0,s=0,n=0,o=d.width,i=d.height){let h=t.addEntity(),m=t.addComponent(h,r);m.x=e,m.y=s,m.rad=n;let k=t.addComponent(h,d);return k.width=o,k.height=i,h}function U(t){let e=t.addEntity();return t.addComponent(e,r),t.addComponent(e,l),t.addComponent(e,w),t.addComponent(e,M),e}a.canvas.style.imageRendering="pixelated";a.ctx.imageSmoothingEnabled=!1;var b=new Image;b.src="./assets/roguelike_atlas.png";j.push(b);var f=new u;U(f);C(f,10,10);C(f,-10,-10);(function t(){let e=a.ctx.fillStyle;a.ctx.fillStyle="blue",a.ctx.resetTransform(),a.ctx.fillRect(0,0,a.canvas.width,a.canvas.height),a.ctx.fillStyle=e,f.update(F,R,S,A),E(T),I(c),D(x),requestAnimationFrame(t)})();})();
//# sourceMappingURL=out.js.map
