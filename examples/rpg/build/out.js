(()=>{var g=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;size=0;constructor(e){this.objectFactory=e}len(){return this.size}add(e){let t=this.keyToIndex.get(e);return t!=null?this.storage[t]:(this.size>=this.storage.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(e,this.size),this.indexToKey[this.size]=e,this.size++,this.storage[this.size-1])}remove(e){let t=this.keyToIndex.get(e)??-1,o=this.indexToKey[this.size-1];if(t<0||t>=this.size||!o)return!1;let n=this.storage[t];return this.storage[t]=this.storage[this.size-1],this.storage[this.size-1]=n,this.keyToIndex.set(o,t),this.keyToIndex.delete(e),this.indexToKey[t]=o,this.size--,!0}get(e){let t=this.keyToIndex.get(e)??-1;if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}has(e){return this.keyToIndex.has(e)}clean(){this.storage.splice(this.size),this.indexToKey.splice(this.size);for(let e of this.keyToIndex.keys()){let t=this.keyToIndex.get(e)??-1;(t<0||t>=this.size)&&this.keyToIndex.delete(e)}}};var u=class{pools=new Map;idMap=new Map;register(e){this.pools.has(e)||(this.idMap.set(e,this.idMap.size),this.pools.set(e,new g(()=>({...e}))))}getId(e){return this.idMap.get(e)??-1}add(e,t){return Object.assign(this.pools.get(t).add(e),t)}remove(e,t){return this.pools.get(t).remove(e)}get(e,t){return this.pools.get(t).get(e)}len(e){return this.pools.get(e).len()}delete(e){for(let t of this.pools.values())t.remove(e)}copy(e,t){for(let o of this.pools.values()){let n=o;n.has(e)&&Object.assign(n.add(t),n.get(e))}}clean(){for(let e of this.pools.values())e.clean()}};function f(){return Math.random()}var a=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new u;frameCount=0;cleanUpMinutes=5;constructor(e=5){this.cleanUpMinutes=e}createEntity(){let e=f();return this.maskMap.set(e,0),this.getArchetype(0).add(e),e}copyEntity(e,t=f()){this.compManager.copy(e,t);let o=this.maskMap.get(e)??0;return this.maskMap.set(t,o),this.getArchetype(o).add(t),t}getArchetype(e){let t=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,t),t}deleteEntity(e){this.entitiesToDelete.push(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,t){return((this.maskMap.get(e)??0)&1<<this.compManager.getId(t))>0}addComponent(e,t,o=t){this.registerComponent(t);let n=this.maskMap.get(e)??0,r=this.compManager.getId(t);return(n&1<<r)!=0?Object.assign(this.compManager.get(e,t),o):(this.getArchetype(n).delete(e),n|=1<<r,this.maskMap.set(e,n),this.getArchetype(n).add(e),Object.assign(this.compManager.add(e,t),o))}removeComponent(e,t){this.registerComponent(t);let o=this.maskMap.get(e)??0,n=this.compManager.getId(t);return(o&1<<n)==0?!1:(this.getArchetype(o).delete(e),o&=~(1<<n),this.maskMap.set(e,o),this.getArchetype(o).add(e),this.compManager.remove(e,t))}getComponent(e,t){return this.compManager.get(e,t)}update(...e){for(let t=0,o=e.length;t<o;t++)e[t](this);this.commitEntityDeletion(),this.frameCount%(this.cleanUpMinutes*60*60)==0&&this.cleanObjectPools(),this.frameCount++}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let e=this.entitiesToDelete.pop();this.compManager.delete(e);let t=this.maskMap.get(e)??0;this.maskMap.delete(e),this.getArchetype(t).delete(e)}}cleanObjectPools(){this.compManager.clean()}query(e){let t=0,o=0;if(e.and)for(let r=0,h=e.and.length;r<h;r++)t|=1<<this.compManager.getId(e.and[r]);if(e.not)for(let r=0,h=e.not.length;r<h;r++)o|=1<<this.compManager.getId(e.not[r]);let n=[];for(let r of this.archetypeMap.keys()){let h=this.getArchetype(r);h.size>0&&(r&t)==t&&(r&o)==0&&n.push(...h)}return[...new Set(n)]}entityCount(){return this.maskMap.size}};var c={x:0,y:0,rad:0,scaleX:0,scaleY:0},p={x:0,y:0},d={width:10,height:10},x={zoom:4},k={},i=b(),C=D(),l=v(),T=[],M=E();function b(){let s=document.querySelector("canvas")??document.createElement("canvas");if(!s)throw new Error("Cannot create canvas element.");let e=s.getContext("2d");if(!e)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(s),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<s.width/s.height?(s.style.width="100%",s.style.height=""):(s.style.width="",s.style.height="100%")},{canvas:s,ctx:e}}function v(){let s={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=e=>{!s.isDown[e.key]&&(s.justPressed[e.key]=!0),s.isDown[e.key]=!0},globalThis.onkeyup=e=>{s.isDown[e.key]=!1,s.justReleased[e.key]=!0},s}function I(s){for(let e in s.justPressed)s.justPressed[e]=!1;for(let e in s.justReleased)s.justReleased[e]=!1}function D(){let s={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=e=>{s.x=e.x,s.y=e.y,Object.assign(s.pressPos,s),s.isDown=s.justPressed=!0},globalThis.onpointerup=e=>{s.x=e.x,s.y=e.y,Object.assign(s.releasePos,s),s.isDown=!1,s.justReleased=!0},globalThis.onpointermove=e=>{s.x=e.x,s.y=e.y},s}function P(s){s.justPressed=!1,s.justReleased=!1}function E(){return{dtMilli:0,timeMilli:0}}function A(s){s.dtMilli=performance.now()-s.timeMilli,s.timeMilli+=s.dtMilli}function R(s){let e=i.ctx.fillStyle;i.ctx.fillStyle="white",i.ctx.beginPath(),s.query({and:[c,d]}).forEach(t=>{let o=a.getComponent(t,c),n=a.getComponent(t,d);i.ctx.rect(o.x-n.width*.5,o.y-n.height*.5,n.width,n.height)}),i.ctx.fill(),i.ctx.transform(1,0,0,-1,0,0),i.ctx.drawImage(T[0],0,0,10,10,0,0,10,10),i.ctx.transform(1,0,0,-1,0,0),i.ctx.fillStyle=e}function S(s){s.query({and:[p,k]}).forEach(e=>{let t=a.getComponent(e,p);t.x=+!!l.isDown.d-+!!l.isDown.a,t.y=+!!l.isDown.w-+!!l.isDown.s;let o=100;t.x*=o,t.y*=o,C.justPressed&&console.log("action")})}function U(s){s.query({and:[c,p]}).forEach(e=>{let t=a.getComponent(e,c),o=a.getComponent(e,p);t.x+=o.x*M.dtMilli/1e3,t.y+=o.y*M.dtMilli/1e3})}function K(s){s.query({and:[c,x]}).forEach(e=>{let t=a.getComponent(e,c),o=a.getComponent(e,x);i.ctx.setTransform(o.zoom,0,0,-o.zoom,-t.x*o.zoom+i.canvas.width*.5,t.y*o.zoom+i.canvas.height*.5)})}function j(s,e=0,t=0,o=0,n=d.width,r=d.height){let h=s.addEntity(),y=a.addComponent(h,c);y.x=e,y.y=t,y.rad=o;let w=a.addComponent(h,d);return w.width=n,w.height=r,h}function O(s){let e=s.addEntity();return a.addComponent(e,c),a.addComponent(e,p),a.addComponent(e,k),a.addComponent(e,x),e}i.canvas.style.imageRendering="pixelated";i.ctx.imageSmoothingEnabled=!1;var z=new Image;z.src="./assets/roguelike_atlas.png";T.push(z);var m=new a;O(m);j(m,10,10);j(m,-10,-10);(function s(){let e=i.ctx.fillStyle;i.ctx.fillStyle="blue",i.ctx.resetTransform(),i.ctx.fillRect(0,0,i.canvas.width,i.canvas.height),i.ctx.fillStyle=e,m.update(K,R,S,U),P(C),I(l),A(M),requestAnimationFrame(s)})();})();
//# sourceMappingURL=out.js.map
