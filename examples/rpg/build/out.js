(()=>{var g=class{storage=[];map=new Map;objectFactory;constructor(t){this.objectFactory=t}size(){return this.map.size}add(t){let s=this.map.get(t);return s||(this.storage.push(this.objectFactory()),this.map.set(t,this.storage[this.storage.length-1]),this.storage[this.storage.length-1])}remove(t){this.map.delete(t)}get(t){let s=this.map.get(t);if(!s)throw new Error("Key not found");return s}has(t){return this.map.has(t)}clean(){this.storage.splice(this.map.size)}};var m=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new g(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,s){return Object.assign(this.pools.get(s).add(t),s)}remove(t,s){this.pools.get(s).remove(t)}get(t,s){return this.pools.get(s).get(t)}size(t){return this.pools.get(t).size()}delete(t){for(let s of this.pools.values())s.remove(t)}copy(t,s){for(let n of this.pools.values())n.has(t)&&Object.assign(n.add(s),n.get(t))}clean(){for(let t of this.pools.values())t.clean()}};function y(){return Math.random()}var u=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new m;addEntity(t=y()){return this.maskMap.set(t,0),this.getArchetype(0).add(t),t}copyEntity(t,s=y()){this.compManager.copy(t,s);let n=this.maskMap.get(t)??0;return this.maskMap.set(s,n),this.getArchetype(n).add(s),s}getArchetype(t){let s=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,s),s}deleteEntity(t){this.entitiesToDelete.push(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,s){return((this.maskMap.get(t)??0)&1<<this.compManager.getId(s))>0}addComponent(t,s,n=s){this.registerComponent(s);let a=this.maskMap.get(t)??0,i=this.compManager.getId(s);return(a&1<<i)!=0?Object.assign(this.compManager.get(t,s),n):(this.getArchetype(a).delete(t),a|=1<<i,this.maskMap.set(t,a),this.getArchetype(a).add(t),Object.assign(this.compManager.add(t,s),n))}removeComponent(t,s){this.registerComponent(s);let n=this.maskMap.get(t)??0,a=this.compManager.getId(s);if((n&1<<a)==0)return!1;this.getArchetype(n).delete(t),n&=~(1<<a),this.maskMap.set(t,n),this.getArchetype(n).add(t),this.compManager.remove(t,s)}getComponent(t,s){return this.compManager.get(t,s)}update(...t){for(let s=0,n=t.length;s<n;s++)t[s](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let t=this.entitiesToDelete.pop();this.compManager.delete(t);let s=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(s).delete(t)}}cleanObjectPools(){this.compManager.clean()}query(t){let s=0,n=0;if(t.and)for(let i=0,r=t.and.length;i<r;i++)s|=1<<this.compManager.getId(t.and[i]);if(t.not)for(let i=0,r=t.not.length;i<r;i++)n|=1<<this.compManager.getId(t.not[i]);let a=[];return this.archetypeMap.forEach((i,r)=>{let h=i;h.size>0&&(r&s)==s&&(r&n)==0&&a.push(...h)}),[...new Set(a)]}entityCount(){return this.maskMap.size}};var c={x:0,y:0,rad:0,scaleX:0,scaleY:0},d={x:0,y:0},p={width:10,height:10},M={zoom:4},C={},o=D(),j=T(),l=E(),k=[],x=I();function D(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function E(){let e={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!e.isDown[t.key]&&(e.justPressed[t.key]=!0),e.isDown[t.key]=!0},globalThis.onkeyup=t=>{e.isDown[t.key]=!1,e.justReleased[t.key]=!0},e}function P(e){for(let t in e.justPressed)e.justPressed[t]=!1;for(let t in e.justReleased)e.justReleased[t]=!1}function T(){let e={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{e.x=t.x,e.y=t.y,Object.assign(e.pressPos,e),e.isDown=e.justPressed=!0},globalThis.onpointerup=t=>{e.x=t.x,e.y=t.y,Object.assign(e.releasePos,e),e.isDown=!1,e.justReleased=!0},globalThis.onpointermove=t=>{e.x=t.x,e.y=t.y},e}function z(e){e.justPressed=!1,e.justReleased=!1}function I(){return{dtMilli:0,timeMilli:0}}function R(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function A(e){let t=o.ctx.fillStyle;o.ctx.fillStyle="white",o.ctx.beginPath(),e.query({and:[c,p]}).forEach(s=>{let n=e.getComponent(s,c),a=e.getComponent(s,p);o.ctx.rect(n.x-a.width*.5,n.y-a.height*.5,a.width,a.height)}),o.ctx.fill(),o.ctx.transform(1,0,0,-1,0,0),o.ctx.drawImage(k[0],0,0,10,10,0,0,10,10),o.ctx.transform(1,0,0,-1,0,0),o.ctx.fillStyle=t}function S(e){e.query({and:[d,C]}).forEach(t=>{let s=e.getComponent(t,d);s.x=+!!l.isDown.d-+!!l.isDown.a,s.y=+!!l.isDown.w-+!!l.isDown.s;let n=100;s.x*=n,s.y*=n,j.justPressed&&console.log("action")})}function O(e){e.query({and:[c,d]}).forEach(t=>{let s=e.getComponent(t,c),n=e.getComponent(t,d);s.x+=n.x*x.dtMilli/1e3,s.y+=n.y*x.dtMilli/1e3})}function U(e){e.query({and:[c,M]}).forEach(t=>{let s=e.getComponent(t,c),n=e.getComponent(t,M);o.ctx.setTransform(n.zoom,0,0,-n.zoom,-s.x*n.zoom+o.canvas.width*.5,s.y*n.zoom+o.canvas.height*.5)})}function v(e,t=0,s=0,n=0,a=p.width,i=p.height){let r=e.addEntity(),h=e.addComponent(r,c);h.x=t,h.y=s,h.rad=n;let w=e.addComponent(r,p);return w.width=a,w.height=i,r}function F(e){let t=e.addEntity();return e.addComponent(t,c),e.addComponent(t,d),e.addComponent(t,C),e.addComponent(t,M),t}o.canvas.style.imageRendering="pixelated";o.ctx.imageSmoothingEnabled=!1;var b=new Image;b.src="./assets/roguelike_atlas.png";k.push(b);var f=new u;F(f);v(f,10,10);v(f,-10,-10);(function e(){let t=o.ctx.fillStyle;o.ctx.fillStyle="blue",o.ctx.resetTransform(),o.ctx.fillRect(0,0,o.canvas.width,o.canvas.height),o.ctx.fillStyle=t,f.update(U,A,S,O),z(j),P(l),R(x),requestAnimationFrame(e)})();})();
//# sourceMappingURL=out.js.map
