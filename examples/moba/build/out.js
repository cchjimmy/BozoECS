(()=>{var I=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}add(t){let e=this.keyToIndex.get(t);return e!=null?this.storage[e]:(this.size>=this.storage.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.size),this.indexToKey[this.size]=t,this.size++,this.storage[this.size-1])}remove(t){let e=this.keyToIndex.get(t)??-1,o=this.indexToKey[this.size-1];if(e<0||e>=this.size||!o)return!1;let s=this.storage[e];return this.storage[e]=this.storage[this.size-1],this.storage[this.size-1]=s,this.keyToIndex.set(o,e),this.keyToIndex.delete(t),this.indexToKey[e]=o,this.size--,!0}get(t){let e=this.keyToIndex.get(t)??-1;if(e<0||e>=this.size)throw new Error("Index out of range.");return this.storage[e]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.size),this.indexToKey.splice(this.size);for(let t of this.keyToIndex.keys()){let e=this.keyToIndex.get(t)??-1;(e<0||e>=this.size)&&this.keyToIndex.delete(t)}}};var w=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new I(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,e){return Object.assign(this.pools.get(e).add(t),e)}remove(t,e){return this.pools.get(e).remove(t)}get(t,e){return this.pools.get(e).get(t)}len(t){return this.pools.get(t).len()}delete(t){for(let e of this.pools.values())e.remove(t)}copy(t,e){for(let o of this.pools.values()){let s=o;s.has(t)&&Object.assign(s.add(e),s.get(t))}}clean(){for(let t of this.pools.values())t.clean()}};function O(){return Math.random()}var S=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new w;addEntity(t=O()){return this.maskMap.set(t,0),this.getArchetype(0).add(t),t}copyEntity(t,e=O()){this.compManager.copy(t,e);let o=this.maskMap.get(t)??0;return this.maskMap.set(e,o),this.getArchetype(o).add(e),e}getArchetype(t){let e=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,e),e}deleteEntity(t){this.entitiesToDelete.push(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,e){return((this.maskMap.get(t)??0)&1<<this.compManager.getId(e))>0}addComponent(t,e,o=e){this.registerComponent(e);let s=this.maskMap.get(t)??0,a=this.compManager.getId(e);return(s&1<<a)!=0?Object.assign(this.compManager.get(t,e),o):(this.getArchetype(s).delete(t),s|=1<<a,this.maskMap.set(t,s),this.getArchetype(s).add(t),Object.assign(this.compManager.add(t,e),o))}removeComponent(t,e){this.registerComponent(e);let o=this.maskMap.get(t)??0,s=this.compManager.getId(e);return(o&1<<s)==0?!1:(this.getArchetype(o).delete(t),o&=~(1<<s),this.maskMap.set(t,o),this.getArchetype(o).add(t),this.compManager.remove(t,e))}getComponent(t,e){return this.compManager.get(t,e)}update(...t){for(let e=0,o=t.length;e<o;e++)t[e](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let t=this.entitiesToDelete.pop();this.compManager.delete(t);let e=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(e).delete(t)}}cleanObjectPools(){this.compManager.clean()}query(t){let e=0,o=0;if(t.and)for(let a=0,i=t.and.length;a<i;a++)e|=1<<this.compManager.getId(t.and[a]);if(t.not)for(let a=0,i=t.not.length;a<i;a++)o|=1<<this.compManager.getId(t.not[a]);let s=[];return this.archetypeMap.forEach((a,i)=>{let r=a;r.size>0&&(i&e)==e&&(i&o)==0&&s.push(...r)}),[...new Set(s)]}entityCount(){return this.maskMap.size}};var p={viewport:{width:800,height:400},entities:{player:{healthPoint:10,moveSpeed:20},minion:{healthPoint:15,spawnRate:2},turrent:{healthPoint:100,abilityPower:100}}};var D=function(n){return n[n.Root=0]="Root",n[n.NE=1]="NE",n[n.NW=2]="NW",n[n.SE=3]="SE",n[n.SW=4]="SW",n}(D||{}),A=class{storage={};changed=[];bounds={};maxDepth=10;constructor(t,e=10){this.bounds[D.Root]=t,this.maxDepth=e,this.storage[D.Root]=new Set}index(t,e=D.Root.toString()){if(e.length>=this.maxDepth)return e;let o=this.bounds[e];for(let s=0;s<4;s++)if(this.bounds[e+s.toString()]??={cx:o.cx+o.width/4*(s%2==0?1:-1),cy:o.cy+o.height/4*(s<1?1:-1),width:o.width/2,height:o.height/2},this.contain(this.bounds[e+s.toString()],t))return this.index(t,e+s.toString());return e}insert(t){let e=this.index(t);this.storage[e]??=new Set,this.storage[e].add(t)}queryRange(t){return[...this.storage[this.index(t)]]}update(){for(let t in this.storage)for(let e of this.storage[t].values())this.contain(this.bounds[t],e)||this.changed.push(e);for(;this.changed.length;){let t=this.changed.pop();t&&this.insert(t)}}contain(t,e){return(t.cx-e.cx)**2<((t.width-e.width)/2)**2&&(t.cy-e.cy)**2<((t.height-e.height)/2)**2}intersect(t,e){return(t.cx-e.cx)**2<((t.width+e.width)/2)**2&&(t.cy-e.cy)**2<((t.height+e.height)/2)**2}};var q={attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},b={current:0,max:0},C={callback:new Function},h={x:0,y:0,rad:0,scaleX:1,scaleY:1},v={x:0,y:0},$={};var T={},W={spreadRadians:0,particleEntity:-1,particleLifetimeSeconds:1,speed:1,emit:!1,particleTransition:function(n,t,e){let o=n.getComponent(t,h);o.scaleX=o.scaleY=-(e**2)+1}},f={zoom:20,tilt:0,isActive:!1,targetEntity:-1},g={width:1,height:1,offsetX:.5,offsetY:.5},F={src:""},B={hovered:!1,pressed:!1,clicked:!1},P={fill:"white",stroke:"black"},X={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},E={timeMilli:0,reset:!1,stop:!1},z={targetX:0,targetY:0},c=Z(),u=et(),J=Q(),R=ot(),K=!0;function Z(){let n=document.querySelector("canvas")??document.createElement("canvas");if(!n)throw new Error("Cannot create canvas element.");let t=n.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(n),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<n.width/n.height?(n.style.width="100%",n.style.height=""):(n.style.width="",n.style.height="100%")},{canvas:n,ctx:t}}function Q(){let n={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!n.isDown[t.key]&&(n.justPressed[t.key]=!0),n.isDown[t.key]=!0},globalThis.onkeyup=t=>{n.isDown[t.key]=!1,n.justReleased[t.key]=!0},n}function tt(n){for(let t in n.justPressed)n.justPressed[t]=!1;for(let t in n.justReleased)n.justReleased[t]=!1}function et(){let n={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(n.x=t.x,n.y=t.y,Object.assign(n.pressPos,n),n.isDown=n.justPressed=!0)},globalThis.onpointerup=t=>{n.x=t.x,n.y=t.y,Object.assign(n.releasePos,n),n.isDown=!1,n.justReleased=!0},globalThis.onpointermove=t=>{n.x=t.x,n.y=t.y},n}function nt(n){n.justPressed=!1,n.justReleased=!1}function ot(){return{dtMilli:0,timeMilli:0}}function st(n){n.dtMilli=performance.now()-n.timeMilli,n.timeMilli+=n.dtMilli}function it(n){let t=n.query({and:[f,h]}).find(s=>n.getComponent(s,f).isActive);if(!t)return;let e=n.getComponent(t,f),o=n.getComponent(t,h);n.query({and:[g,h]}).forEach(s=>{n.removeComponent(s,T);let a=n.getComponent(s,g),i=n.getComponent(s,h);kt(o.x,o.y,c.canvas.width/e.zoom,c.canvas.height/e.zoom,i.x+a.offsetX+a.width/2,i.y+a.offsetY+a.height/2,a.width,a.height)&&n.addComponent(s,T)})}function at(n){n.query({and:[W,h]}).forEach(t=>{let e=n.getComponent(t,W);if(!e.emit||!n.hasComponent(e.particleEntity,h))return;e.emit=!1;let o=n.getComponent(t,h),s=n.copyEntity(e.particleEntity),a=n.getComponent(s,h);Object.assign(a,o);let i=n.addComponent(s,E),r=o.rad+(Math.random()*2-1)*e.spreadRadians*.5;a.rad=r,n.addComponent(s,v,{x:Math.cos(r)*e.speed,y:Math.sin(r)*e.speed}),n.addComponent(s,C).callback=()=>{if(i.timeMilli<e.particleLifetimeSeconds*1e3){e.particleTransition(n,s,i.timeMilli/1e3/e.particleLifetimeSeconds);return}n.deleteEntity(s)}})}function ct(n){let t=n.query({and:[f,h]}).find(a=>n.getComponent(a,f).isActive);if(t==null)return;let e=n.getComponent(t,f),o=n.getComponent(t,h),s=Y(u.pressPos,c.canvas);n.query({and:[z,$]}).forEach(a=>{if(!u.justPressed||!K)return;let i=n.getComponent(a,z),r=Et(s,o,e.tilt,e.zoom);i.targetX=r.x,i.targetY=r.y})}function rt(n){n.query({and:[z,h,v,q]}).forEach(t=>{let e=n.getComponent(t,z),o=n.getComponent(t,h),s=n.getComponent(t,v),a=n.getComponent(t,q),i=e.targetX-o.x,r=e.targetY-o.y,d=(i*i+r*r)**.5;if(d==0)return;let m=a.moveSpeed*R.dtMilli/1e3*2,x=d>m?a.moveSpeed:a.moveSpeed*d/m;s.x=i/d*x,s.y=r/d*x})}function ht(n){n.query({and:[E,C]}).forEach(t=>n.getComponent(t,C).callback(t)),n.query({and:[E]}).forEach(t=>{let e=n.getComponent(t,E);e.reset&&(e.timeMilli=0),e.reset=!1,e.stop||(e.timeMilli+=R.dtMilli)})}function dt(n){n.query({and:[X,h]}).forEach(t=>{let e=n.getComponent(t,X),o=n.getComponent(t,h);c.ctx.font=`${e.fontSize}px serif`;let s=c.ctx.fillStyle,a=e.content.split(`
`);for(let i=0,r=a.length;i<r;i++){let d=c.ctx.measureText(a[i]);c.ctx.fillStyle=e.backgroundColor,c.ctx.fillRect(o.x,o.y+i*(2*e.padding)+i*d.fontBoundingBoxAscent,e.padding*2+d.width,e.padding*2+d.fontBoundingBoxAscent),c.ctx.fillStyle=e.color,c.ctx.fillText(a[i],o.x+e.padding,o.y+i*(2*e.padding)+(i+1)*d.fontBoundingBoxAscent)}c.ctx.fillStyle=s})}function U(n){n.query({and:[h,g,P,T]}).forEach(t=>{let e=n.getComponent(t,h),o=n.getComponent(t,g),s=n.getComponent(t,P),a=c.ctx.fillStyle,i=c.ctx.strokeStyle;c.ctx.fillStyle=s.fill,c.ctx.strokeStyle=s.stroke;let r=Math.cos(e.rad),d=Math.sin(e.rad);c.ctx.transform(r,d,-d,r,e.x,e.y),c.ctx.fillRect(o.offsetX*e.scaleX,o.offsetY*e.scaleY,o.width*e.scaleX,o.height*e.scaleY),c.ctx.strokeRect(o.offsetX*e.scaleX,o.offsetY*e.scaleY,o.width*e.scaleX,o.height*e.scaleY),c.ctx.transform(r,-d,d,r,r*-e.x+d*-e.y,-d*-e.x+r*-e.y),c.ctx.fillStyle=a,c.ctx.strokeStyle=i})}function lt(n){let t=n.query({and:[f,h]}).find(i=>n.getComponent(i,f).isActive);if(!t)return;c.ctx.resetTransform();let e=n.getComponent(t,f),o=n.getComponent(t,h);if(e.targetEntity!=-1&&n.hasComponent(e.targetEntity,h)){let i=n.getComponent(e.targetEntity,h);Object.assign(o,i)}let s=Math.sin(e.tilt)*e.zoom,a=Math.cos(e.tilt)*e.zoom;c.ctx.transform(a,s,-s,a,a*-o.x-s*-o.y+c.ctx.canvas.width*.5,s*-o.x+a*-o.y+c.ctx.canvas.height*.5)}function pt(n){let t=R.dtMilli/1e3;n.query({and:[h,v]}).forEach(e=>{let o=n.getComponent(e,h),s=n.getComponent(e,v);o.x+=s.x*t,o.y+=s.y*t})}function N(n){n.query({and:[F,h]}).forEach(t=>{let e=n.getComponent(t,F),o=n.getComponent(t,h),s=n.hasComponent(t,g)&&n.getComponent(t,g),a=new Image;a.src=e.src;let i=s?s.width:a.width,r=s?s.height:a.height,d=i/a.width,m=r/a.height;c.ctx.transform(d,0,0,m,0,0),c.ctx.drawImage(a,(o.x-i/2)/d,(o.y-r/2)/m),c.ctx.transform(1/d,0,0,1/m,0,0)})}function gt(n){let t=Y(u.pressPos,c.canvas),e=Y(u.releasePos,c.canvas),o=Y({x:u.x,y:u.y},c.canvas);n.query({and:[B,h,g,C]}).forEach(s=>{let a=n.getComponent(s,h),i=n.getComponent(s,B),r=n.getComponent(s,g),d=n.getComponent(s,C),m=(t.x-a.x)**2<(r.width/2)**2&&(t.y-a.y)**2<(r.height/2)**2;i.hovered=(o.x-a.x)**2<(r.width/2)**2&&(o.y-a.y)**2<(r.height/2)**2,i.pressed=i.hovered&&u.isDown&&m,i.clicked=u.justReleased&&m&&(e.x-a.x)**2<(r.width/2)**2&&(e.y-a.y)**2<(r.height/2)**2,d.callback(s)})}function mt(n){n.query({and:[T,b,h,g]}).forEach(t=>{let e=n.getComponent(t,h),o=n.getComponent(t,g),s=n.getComponent(t,b),a=Math.cos(e.rad),i=Math.sin(e.rad),r=c.ctx.strokeStyle,d=c.ctx.fillStyle,m=c.ctx.lineWidth;c.ctx.fillStyle="black";let x=o.width*1.5,M=-x/2,k=o.offsetY*e.scaleY-1;c.ctx.fillRect(e.x+a*M-i*k,e.y+i*M+a*k,x,.3),c.ctx.fillStyle="green",c.ctx.fillRect(e.x+a*M-i*k,e.y+i*M+a*k,x*(s.current/s.max),.3),c.ctx.strokeStyle="black",c.ctx.lineWidth=.1,c.ctx.strokeRect(e.x+a*M-i*k,e.y+i*M+a*k,x,.3),c.ctx.strokeStyle=r,c.ctx.fillStyle=d,c.ctx.lineWidth=m})}function ft(n,t,e=0,o=0,s=1,a=1){let i=n.addEntity();return n.addComponent(i,h,{x:e,y:o}),n.addComponent(i,F,{src:t}),n.addComponent(i,g,{width:s,height:a}),i}function H(n,t=0,e=0,o=1,s=1,a=-o/2,i=-s/2){let r=n.addEntity();return n.addComponent(r,h,{x:t,y:e}),n.addComponent(r,g,{width:o,height:s,offsetX:a,offsetY:i}),n.addComponent(r,P),n.addComponent(r,T),r}function ut(n,t=0,e=0,o=10,s=10,a=i=>{let r=y.getComponent(i,B),d=y.getComponent(i,P);d.fill="grey",r.hovered&&(K=!1,d.fill="lightgrey"),r.pressed&&(d.fill="red"),r.clicked&&(d.fill="green")}){let i=H(n,t,e,o,s);return n.addComponent(i,B),n.addComponent(i,P),n.addComponent(i,C,{callback:a}),n.addComponent(i,X,{content:"Button",backgroundColor:"transparent",color:"white"}),i}function yt(n,t=0,e=0){let o=H(n,t,e,1,1);return n.addComponent(o,v),n.addComponent(o,q,{...p.entities.player}),n.addComponent(o,b,{max:p.entities.player.healthPoint,current:p.entities.player.healthPoint}),n.addComponent(o,$),n.addComponent(o,z,{targetX:t,targetY:e}),o}function xt(n,t,e){let o=H(n,t,e,3,10,-1.5,-10);return n.addComponent(o,q,{...p.entities.turrent}),n.addComponent(o,b,{max:p.entities.turrent.healthPoint,current:p.entities.turrent.healthPoint}),o}function Ct(n,t,e){let o=n.addEntity();return n.addComponent(o,f,{zoom:30}),n.addComponent(o,h,{x:t,y:e}),o}function Mt(n="#424242"){let t=c.ctx.fillStyle;c.ctx.fillStyle=n,c.ctx.fillRect(0,0,c.canvas.width,c.canvas.height),c.ctx.fillStyle=t}function kt(n,t,e,o,s,a,i,r){return(n-s)**2<((e+i)/2)**2&&(t-a)**2<((o+r)/2)**2}function Et(n,t,e,o){let s=Math.cos(e),a=Math.sin(e),i={x:0,y:0},r=n.x-p.viewport.width/2,d=n.y-p.viewport.height/2;return i.x=s*r+a*d,i.y=-a*r+s*d,i.x/=o,i.y/=o,i.x+=t.x,i.y+=t.y,i}function vt(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function Y(n,t){let e={x:0,y:0},o=t.getBoundingClientRect();return e.x=n.x-o.left,e.y=n.y-o.top,innerWidth/innerHeight<t.width/t.height?(e.x*=t.width/innerWidth,e.y*=t.width/innerWidth):(e.x*=t.height/innerHeight,e.y*=t.height/innerHeight),e}c.canvas.width=p.viewport.width;c.canvas.height=p.viewport.height;c.canvas.style.imageRendering="pixelated";c.ctx.lineWidth=.1;var l=new S,j=xt(l,10,0);l.addComponent(j,W,{particleEntity:j,speed:20,spreadRadians:Math.PI*.25});l.addComponent(j,E);l.addComponent(j,C).callback=n=>{let t=l.getComponent(n,E);t.timeMilli<50||(t.reset=!0,l.getComponent(n,W).emit=!0)};for(let n=0;n<2;n++)l.getComponent(l.copyEntity(j),h).y+=15*(n+1);var G=yt(l,0,0);l.getComponent(G,b).current*=.6;var Ot=ft(l,"./assets/Map_of_MOBA.svg",0,0,300,300),St=Ct(l,0,0),L=l.getComponent(St,f);L.targetEntity=G;L.isActive=!0;L.zoom=15;var Ft=new A({cx:0,cy:0,width:1e10,height:1e10}),y=new S;ut(y,p.viewport.width*.9,p.viewport.height*.8,p.viewport.height*.3,p.viewport.height*.3);var _=y.addEntity(),bt=y.addComponent(_,X,{content:"test string",backgroundColor:"white"});y.addComponent(_,h);(function n(){requestAnimationFrame(n),bt.content=`FPS: ${Math.ceil(1e3/R.dtMilli)}
Entity count: ${l.entityCount()}
Device type: ${vt()}`,Mt(),l.update(lt,it,N,U,mt),c.ctx.resetTransform(),y.update(N,U,dt),y.update(gt),l.update(ht,rt,ct,at,pt),nt(u),tt(J),st(R),K=!0})();})();
//# sourceMappingURL=out.js.map
