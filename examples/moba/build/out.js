(()=>{var T=class{storage=[];objectConstructor;size=0;constructor(t){this.objectConstructor=t}len(){return this.size}addObj(){let t;return this.storage[this.size]?t=this.storage[this.size]:(t=this.objectConstructor(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(e=>e==t)}removeObj(t){if(t>=this.size)throw new Error("Index out of range.");let e=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=e,this.size--,e}getObj(t){if(t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var p=class n{static pools=new Map;static idMap=new Map;static register(t){n.idMap.set(t,n.idMap.size),n.pools.set(t,new T(()=>Object.assign({},t)))}static getId(t){let e=n.idMap.get(t);if(e==null)throw new Error("Component not registered.");return e}static add(t){return n.pools.get(t).addObj()}static delete(t,e){return n.pools.get(t).removeObj(e)}static get(t,e){return n.pools.get(t).getObj(e)}static len(t){return n.pools.get(t).len()}static typeLen(){return n.pools.size}static types(){return n.pools.keys().toArray()}};var b=class n{static nextId=0;static pool=new T(()=>n.nextId++);static add(){return n.pool.addObj()}static findIndex(t){return n.pool.findIndex(t)}static delete(t){return n.pool.removeObj(t)}};var a=class n{static indexMap=new Map;static entityMasks=[];static archetypeMap=new Map;static worlds=[];static removeMap=new Map;static ownerMap=new Map;timeMilli=0;dtMilli=0;localEntities=new Set;constructor(){n.worlds.push(this)}static createEntity(){let t=b.add();return n.entityMasks[t]=0,n.getArchetype(0).add(t),t}static getArchetype(t){let e=n.archetypeMap.get(t);if(e==null){let o=new Set;return n.archetypeMap.set(t,o),o}return e}static deleteEntity(t){for(let o=0,s=n.worlds.length;o<s;o++)n.worlds[o].removeEntity(t);let e=p.types();for(let o=0,s=p.typeLen();o<s;o++){if(!(n.entityMasks[t]&1<<o))continue;n.getRemoveFn(o)(t);let r=n.getIndices(e[o]),i=n.getOwners(e[o]),c=i[i.length-1];i[r[t]]=c,r[c]=r[t]}n.getArchetype(n.entityMasks[t]).delete(t),n.entityMasks[t]=0,b.delete(b.findIndex(t))}static getRemoveFn(t){let e=n.removeMap.get(t);if(e==null)throw new Error("Component not registered.");return e}addEntity(t){return t??=n.createEntity(),this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){if(!this.localEntities.has(t))throw new Error(`Entity ${t} does not exist.`)}static componentExists(t){n.indexMap.has(t)||n.registerComponent(t)}static registerComponent(t){return p.register(t),n.indexMap.set(t,[]),n.removeMap.set(p.getId(t),e=>p.delete(t,this.getIndices(t)[e])),n.ownerMap.set(t,[]),n}static hasComponent(t,e){return(n.entityMasks[t]&1<<p.getId(e))>0}static addComponent(t,e){if(n.componentExists(e),n.hasComponent(t,e))throw new Error(`Entity ${t} already had this component.`);n.getArchetype(n.entityMasks[t]).delete(t),n.entityMasks[t]|=1<<p.getId(e),n.getArchetype(n.entityMasks[t]).add(t);let o=p.len(e);return n.getIndices(e)[t]=o,n.getOwners(e)[o]=t,p.add(e)}static getIndices(t){let e=n.indexMap.get(t);if(e==null)throw new Error("Component not registered.");return e}static getOwners(t){let e=n.ownerMap.get(t);if(e==null)throw new Error("Component not registered.");return e}static removeComponent(t,e){if(n.componentExists(e),!n.hasComponent(t,e))throw new Error(`Entity ${t} does not have this component.`);n.getArchetype(n.entityMasks[t]).delete(t),n.entityMasks[t]&=~(1<<p.getId(e)),n.getArchetype(n.entityMasks[t]).add(t);let o=n.getIndices(e),s=n.getOwners(e),r=p.delete(e,o[t]),i=s[s.length-1];return s[o[t]]=i,o[i]=o[t],r}static getComponent(t,e){if(!n.hasComponent(t,e))throw new Error(`Entity ${t} does not have this component.`);return p.get(e,n.getIndices(e)[t])}update(...t){for(let e=0,o=t.length;e<o;e++)t[e](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let e=0,o=0,s=0;if(t.and)for(let i=0,c=t.and.length;i<c;i++)e|=1<<p.getId(t.and[i]);if(t.or)for(let i=0,c=t.or.length;i<c;i++)o|=1<<p.getId(t.or[i]);if(t.not)for(let i=0,c=t.not.length;i<c;i++)s|=1<<p.getId(t.not[i]);let r=[];for(let i=n.archetypeMap.keys().toArray(),c=i.length,l=0,g=i[l];l<c;l++,g=i[l])(g&e)==e&&(g|o)>0&&(g&s)==0&&r.push(...this.localEntities.intersection(n.getArchetype(g)));return r}entityCount(){return this.localEntities.size}};var u={viewport:{width:800,height:400},player:{speed:20}};var y={x:0,y:0},x={x:0,y:0},A={},v={zoom:1,tilt:0,isActive:!1},w={width:2,height:2},j={src:""},M={hovered:!1,pressed:!1,clicked:!1,callback:n=>{}},C={fill:"white",stroke:"black"};function P(n,t,e,o){let s=n.fillStyle,r=n.strokeStyle;n.fillStyle=o.fill,n.strokeStyle=o.stroke;let i=new Path2D(`M ${t.x-e.width*.5} ${t.y-e.height*.5} h ${e.width} v ${e.height} h ${-e.width} Z`);n.fill(i),n.stroke(i),n.fillStyle=s,n.strokeStyle=r}function E(n){h&&n.query({and:[y,w,C]}).forEach(t=>{let e=a.getComponent(t,y),o=a.getComponent(t,w),s=a.getComponent(t,C);P(h,e,o,s)})}function O(){if(!h)return;let n=h.fillStyle;h.fillStyle="#424242",h.fillRect(0,0,h.canvas.width,h.canvas.height),h.fillStyle=n}function R(n){n.query({and:[A,x],or:[v]}).forEach(t=>{let e=a.getComponent(t,x);e.x=0,e.y=0,(f.w||f.ArrowUp)&&e.y--,(f.a||f.ArrowLeft)&&e.x--,(f.s||f.ArrowDown)&&e.y++,(f.d||f.ArrowRight)&&e.x++;let o=(e.x**2+e.y**2)**.5;if(o!=0&&(e.x=e.x/o*u.player.speed,e.y=e.y/o*u.player.speed),!a.hasComponent(t,v))return;let s=a.getComponent(t,v),r=n.dtMilli/1e3;f.q&&(s.tilt-=5*r),f.e&&(s.tilt+=5*r)})}function B(n){n.query({and:[v,y,x]}).forEach(t=>{let e=a.getComponent(t,v);if(!h||!e.isActive)return;let o=a.getComponent(t,y),s=Math.sin(e.tilt),r=Math.cos(e.tilt),i=-o.x*e.zoom,c=-o.y*e.zoom;h.transform(r*e.zoom,-s*e.zoom,s*e.zoom,r*e.zoom,r*i+s*c+h.canvas.width*.5,-s*i+r*c+h.canvas.height*.5);let l=a.getComponent(t,x),g=l.x,k=l.y;l.x=r*g-s*k,l.y=s*g+r*k})}function $(n){let t=n.dtMilli/1e3;n.query({and:[y,x]}).forEach(e=>{let o=a.getComponent(e,y),s=a.getComponent(e,x);o.x+=s.x*t,o.y+=s.y*t})}function I(n){h&&n.query({and:[j,y],or:[w]}).forEach(t=>{let e=a.getComponent(t,j),o=a.getComponent(t,y),s=a.hasComponent(t,w)&&a.getComponent(t,w),r=new Image;r.src=e.src;let i=s?s.width:r.width,c=s?s.height:r.height,l=i/r.width,g=c/r.height;h.transform(l,0,0,g,0,0),h.drawImage(r,(o.x-i/2)/l,(o.y-c/2)/g),h.transform(1/l,0,0,1/g,0,0)})}function D(n){n.query({and:[M,y,w]}).forEach(t=>{let e=a.getComponent(t,y),o=a.getComponent(t,M),s=a.getComponent(t,w),r=(d.pressPos.x-e.x)**2<(s.width/2)**2&&(d.pressPos.y-e.y)**2<(s.height/2)**2;o.hovered=(d.x-e.x)**2<(s.width/2)**2&&(d.y-e.y)**2<(s.height/2)**2,o.pressed=o.hovered&&d.isDown&&r,o.clicked=d.justReleased&&r&&(d.releasePos.x-e.x)**2<(s.width/2)**2&&(d.releasePos.y-e.y)**2<(s.height/2)**2,o.callback(t)})}function q(){h&&h.setTransform(1,0,0,1,0,0)}function S(n,t,e=0,o=0,s=1,r=1){let i=n.addEntity(),c=a.addComponent(i,y),l=a.addComponent(i,j),g=a.addComponent(i,w);return c.x=e,c.y=o,l.src=t,g.width=s,g.height=r,i}function z(n,t=0,e=0){let o=n.addEntity(),s=a.addComponent(o,y);a.addComponent(o,x),a.addComponent(o,w);let r=a.addComponent(o,C);return r.fill="green",s.x=t,s.y=e,o}function F(n,t=0,e=0,o=10,s=10,r=()=>{}){let i=n.addEntity(),c=a.addComponent(i,y),l=a.addComponent(i,w),g=a.addComponent(i,M);return a.addComponent(i,C),c.x=t,c.y=e,l.width=o,l.height=s,g.callback=r,i}function H(n,t,e,o){let s=Math.cos(e),r=Math.sin(e),i={x:0,y:0},c=n.x-u.viewport.width/2,l=n.y-u.viewport.height/2;return i.x=s*c-r*l,i.y=r*c+s*l,i.x/=o,i.y/=o,i.x+=t.x,i.y+=t.y,i}var m=document.querySelector("canvas"),h=m?.getContext("2d"),f={},d={x:0,y:0,isDown:!1,pressPos:{x:0,y:0},justReleased:!1,releasePos:{x:0,y:0}};if(m&&h){m.width=u.viewport.width,m.height=u.viewport.height,m.style.imageRendering="pixelated",h.lineWidth=.1,document.onkeydown=i=>{f[i.key]=!0},document.onkeyup=i=>{delete f[i.key]},document.onpointermove=i=>{let c=m.getBoundingClientRect();d.x=i.x-c.left,d.y=i.y-c.top,innerWidth/innerHeight<m.width/m.height?(d.x*=m.width/innerWidth,d.y*=m.width/innerWidth):(d.x*=m.height/innerHeight,d.y*=m.height/innerHeight)},document.onpointerdown=()=>{d.isDown=!0,d.pressPos.x=d.x,d.pressPos.y=d.y},document.onpointerup=()=>{d.isDown=!1,d.justReleased=!0,d.releasePos.x=d.x,d.releasePos.y=d.y},document.body.append(m);let n=new a,t=z(n,0,0),e=a.getComponent(t,w);e.width=1,e.height=1;let o=a.addComponent(t,v);o.zoom=30,o.isActive=!0,a.addComponent(t,A),S(n,"./assets/Map_of_MOBA.svg",0,0,300,300);let s=z(n,0,0),r=new a;F(r,u.viewport.width*.9,u.viewport.height*.8,u.viewport.height*.3,u.viewport.height*.3,i=>{a.getComponent(i,M).clicked&&console.log("clicked")}),S(r,"./assets/Map_of_MOBA.svg",u.viewport.width*.1,u.viewport.height*.2,u.viewport.height*.3,u.viewport.height*.3),function i(){O();let c=a.getComponent(s,y),l=H(d,a.getComponent(t,y),o.tilt,o.zoom);c.x=l.x,c.y=l.y,n.update(R,B,I,E,$),q(),r.update(I,E,D),d.justReleased=!1,requestAnimationFrame(i)}()}})();
//# sourceMappingURL=out.js.map
