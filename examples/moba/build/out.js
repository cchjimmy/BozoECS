(()=>{var P=class{storage=[];indices=new Map;objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}add(t){let e=this.indices.get(t);return e!=null?this.storage[e]:(this.size>=this.storage.length&&this.storage.push(this.objectFactory()),this.indices.set(t,this.size),this.size++,this.storage[this.size-1])}remove(t){let e=this.indices.get(t)??-1;if(e<0||e>=this.size)return!1;let o=this.storage[e];this.storage[e]=this.storage[this.size-1],this.storage[this.size-1]=o;for(let[i,r]of this.indices)if(r==this.size-1){this.indices.set(i,e);break}return this.indices.delete(t),this.size--,!0}get(t){let e=this.indices.get(t)??-1;if(e<0||e>=this.size)throw new Error("Index out of range.");return this.storage[e]}has(t){return this.indices.has(t)}};function T(){return Math.random()}var h=class n{static pools=new Map;static idMap=new Map;static register(t){n.pools.has(t)||(n.idMap.set(t,n.idMap.size),n.pools.set(t,new P(()=>({...t}))))}static getId(t){return n.idMap.get(t)??-1}static add(t,e){return Object.assign(n.pools.get(e).add(t),e)}static remove(t,e){return n.pools.get(e).remove(t)}static get(t,e){return n.pools.get(e).get(t)}static len(t){return n.pools.get(t).len()}static delete(t){for(let e of this.pools){let o=e[1];o.has(t)&&o.remove(t)}}static copy(t){let e=T();for(let o of this.pools){let i=o[1];i.has(t)&&Object.assign(i.add(e),i.get(t))}return e}};var s=class n{static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static entitiesToDelete=[];localEntities=new Set;constructor(){n.worlds.push(this)}static createEntity(){let t=T();return n.maskMap.set(t,0),n.getArchetype(0).add(t),t}static copyEntity(t){let e=h.copy(t),o=this.maskMap.get(t)??0;return this.maskMap.set(e,o),this.getArchetype(o).add(e),e}static getArchetype(t){let e=n.archetypeMap.get(t)??new Set;return n.archetypeMap.set(t,e),e}static deleteEntity(t){n.entitiesToDelete.push(t)}addEntity(t=n.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}static registerComponent(t){return h.register(t),n}static hasComponent(t,e){return((n.maskMap.get(t)??0)&1<<h.getId(e))>0}static addComponent(t,e,o=e){n.registerComponent(e);let i=n.maskMap.get(t)??0,r=h.getId(e);return(i&1<<r)!=0?Object.assign(h.get(t,e),o):(n.getArchetype(i).delete(t),i|=1<<r,n.maskMap.set(t,i),n.getArchetype(i).add(t),Object.assign(h.add(t,e),o))}static removeComponent(t,e){n.registerComponent(e);let o=n.maskMap.get(t)??0,i=h.getId(e);return(o&1<<i)==0?!1:(n.getArchetype(o).delete(t),o&=~(1<<i),n.maskMap.set(t,o),n.getArchetype(o).add(t),h.remove(t,e))}static getComponent(t,e){return h.get(t,e)}update(...t){for(let e=0,o=t.length;e<o;e++)t[e](this);for(;n.entitiesToDelete.length;){let e=n.entitiesToDelete.pop();for(let i=0,r=n.worlds.length;i<r;i++)n.worlds[i].localEntities.delete(e);h.delete(e);let o=n.maskMap.get(e)??0;n.maskMap.delete(e),n.getArchetype(o).delete(e)}}query(t){let e=0,o=0;if(t.and)for(let r=0,c=t.and.length;r<c;r++)e|=1<<h.getId(t.and[r]);if(t.not)for(let r=0,c=t.not.length;r<c;r++)o|=1<<h.getId(t.not[r]);let i=[];for(let r=n.archetypeMap.keys().toArray(),c=r.length,l=0;l<c;l++){let d=r[l],u=n.getArchetype(d);u.size!=0&&(d&e)==e&&(d&o)==0&&i.push(...u)}return[...this.localEntities.intersection(new Set(i))]}entityCount(){return this.localEntities.size}};var g={viewport:{width:800,height:400},entities:{player:{healthPoint:10,moveSpeed:20},minion:{healthPoint:15,spawnRate:2},turrent:{healthPoint:100,abilityPower:100}}};var j={attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},M={current:0,max:0},C={callback:new Function},p={x:0,y:0,rad:0,scaleX:1,scaleY:1},k={x:0,y:0},H={};var v={},z={spread:0,particleEntity:-1,particleLifetimeSeconds:1,speed:1,emit:!1,particleTransition:function(n,t){let e=s.getComponent(n,p);e.scaleX=e.scaleY=-(t**2)+1}},m={zoom:20,tilt:0,isActive:!1,targetEntity:-1},f={width:1,height:1,offsetX:.5,offsetY:.5},D={src:""},A={hovered:!1,pressed:!1,clicked:!1},R={fill:"white",stroke:"black"},I={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},w={timeMilli:0,reset:!1,stop:!1},b={targetX:0,targetY:0},a=K(),y=N(),G=V(),S=Z();function K(){let n=document.querySelector("canvas")??document.createElement("canvas");if(!n)throw new Error("Cannot create canvas element.");let t=n.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(n),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<n.width/n.height?(n.style.width="100%",n.style.height=""):(n.style.width="",n.style.height="100%")},{canvas:n,ctx:t}}function V(){let n={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!n.isDown[t.key]&&(n.justPressed[t.key]=!0),n.isDown[t.key]=!0},globalThis.onkeyup=t=>{n.isDown[t.key]=!1,n.justReleased[t.key]=!0},n}function J(n){for(let t in n.justPressed)n.justPressed[t]=!1;for(let t in n.justReleased)n.justReleased[t]=!1}function N(){let n={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(n.x=t.x,n.y=t.y,Object.assign(n.pressPos,n),n.isDown=n.justPressed=!0)},globalThis.onpointerup=t=>{n.x=t.x,n.y=t.y,Object.assign(n.releasePos,n),n.isDown=!1,n.justReleased=!0},globalThis.onpointermove=t=>{n.x=t.x,n.y=t.y},n}function Q(n){n.justPressed=!1,n.justReleased=!1}function Z(){return{dtMilli:0,timeMilli:0}}function _(n){n.dtMilli=performance.now()-n.timeMilli,n.timeMilli+=n.dtMilli}function tt(n){let t=n.query({and:[m,p]}).find(i=>s.getComponent(i,m).isActive);if(!t)return;let e=s.getComponent(t,m),o=s.getComponent(t,p);n.query({and:[f,p]}).forEach(i=>{s.removeComponent(i,v);let r=s.getComponent(i,f),c=s.getComponent(i,p);ut(o.x,o.y,a.canvas.width/e.zoom,a.canvas.height/e.zoom,c.x+r.offsetX+r.width/2,c.y+r.offsetY+r.height/2,r.width,r.height)&&s.addComponent(i,v)})}function et(n){n.query({and:[z,p]}).forEach(t=>{let e=s.getComponent(t,z);if(!e.emit||!s.hasComponent(e.particleEntity,p))return;e.emit=!1;let o=s.getComponent(t,p),i=s.copyEntity(e.particleEntity),r=s.getComponent(i,p);Object.assign(r,o),n.addEntity(i);let c=s.addComponent(i,w),l=Math.random()>.5,d=o.rad+Math.random()*e.spread*Math.PI*(-1*+l+ +!l);r.rad=d,s.addComponent(i,k,{x:Math.cos(d)*e.speed,y:Math.sin(d)*e.speed}),s.addComponent(i,C).callback=()=>{if(c.timeMilli<e.particleLifetimeSeconds*1e3){e.particleTransition(i,c.timeMilli/1e3/e.particleLifetimeSeconds);return}s.deleteEntity(i)}})}function nt(n){let t=n.query({and:[m,p]}).find(r=>s.getComponent(r,m).isActive);if(t==null)return;let e=s.getComponent(t,m),o=s.getComponent(t,p),i=X(y.pressPos,a.canvas);n.query({and:[b,H]}).forEach(r=>{let c=s.getComponent(r,b);if(!y.justPressed)return;let l=yt(i,o,e.tilt,e.zoom);c.targetX=l.x,c.targetY=l.y})}function ot(n){n.query({and:[b,p,k,j]}).forEach(t=>{let e=s.getComponent(t,b),o=s.getComponent(t,p),i=s.getComponent(t,k),r=s.getComponent(t,j),c=e.targetX-o.x,l=e.targetY-o.y,d=(c*c+l*l)**.5;if(d==0)return;let u=r.moveSpeed*S.dtMilli/1e3*2,W=d>u?r.moveSpeed:r.moveSpeed*d/u;i.x=c/d*W,i.y=l/d*W})}function st(n){n.query({and:[w,C]}).forEach(t=>s.getComponent(t,C).callback(t)),n.query({and:[w]}).forEach(t=>{let e=s.getComponent(t,w);e.reset&&(e.timeMilli=0),e.reset=!1,e.stop||(e.timeMilli+=S.dtMilli)})}function it(n){n.query({and:[I,p]}).forEach(t=>{let e=s.getComponent(t,I),o=s.getComponent(t,p);a.ctx.font=`${e.fontSize}px serif`;let i=a.ctx.fillStyle,r=e.content.split(`
`);for(let c=0,l=r.length;c<l;c++){let d=a.ctx.measureText(r[c]);a.ctx.fillStyle=e.backgroundColor,a.ctx.fillRect(o.x,o.y+c*(2*e.padding)+c*d.fontBoundingBoxAscent,e.padding*2+d.width,e.padding*2+d.fontBoundingBoxAscent),a.ctx.fillStyle=e.color,a.ctx.fillText(r[c],o.x+e.padding,o.y+c*(2*e.padding)+(c+1)*d.fontBoundingBoxAscent)}a.ctx.fillStyle=i})}function O(n){n.query({and:[p,f,R,v]}).forEach(t=>{let e=s.getComponent(t,p),o=s.getComponent(t,f),i=s.getComponent(t,R),r=a.ctx.fillStyle,c=a.ctx.strokeStyle;a.ctx.fillStyle=i.fill,a.ctx.strokeStyle=i.stroke;let l=Math.cos(e.rad),d=Math.sin(e.rad);a.ctx.transform(l,d,-d,l,e.x,e.y),a.ctx.fillRect(o.offsetX*e.scaleX,o.offsetY*e.scaleY,o.width*e.scaleX,o.height*e.scaleY),a.ctx.strokeRect(o.offsetX*e.scaleX,o.offsetY*e.scaleY,o.width*e.scaleX,o.height*e.scaleY),a.ctx.transform(l,-d,d,l,l*-e.x+d*-e.y,-d*-e.x+l*-e.y),a.ctx.fillStyle=r,a.ctx.strokeStyle=c})}function rt(n){let t=n.query({and:[m,p]}).find(c=>s.getComponent(c,m).isActive);if(!t)return;a.ctx.resetTransform();let e=s.getComponent(t,m),o=s.getComponent(t,p);if(e.targetEntity!=-1&&s.hasComponent(e.targetEntity,p)){let c=s.getComponent(e.targetEntity,p);Object.assign(o,c)}let i=Math.sin(e.tilt)*e.zoom,r=Math.cos(e.tilt)*e.zoom;a.ctx.transform(r,i,-i,r,r*-o.x-i*-o.y+a.ctx.canvas.width*.5,i*-o.x+r*-o.y+a.ctx.canvas.height*.5)}function ct(n){let t=S.dtMilli/1e3;n.query({and:[p,k]}).forEach(e=>{let o=s.getComponent(e,p),i=s.getComponent(e,k);o.x+=i.x*t,o.y+=i.y*t})}function F(n){n.query({and:[D,p]}).forEach(t=>{let e=s.getComponent(t,D),o=s.getComponent(t,p),i=s.hasComponent(t,f)&&s.getComponent(t,f),r=new Image;r.src=e.src;let c=i?i.width:r.width,l=i?i.height:r.height,d=c/r.width,u=l/r.height;a.ctx.transform(d,0,0,u,0,0),a.ctx.drawImage(r,(o.x-c/2)/d,(o.y-l/2)/u),a.ctx.transform(1/d,0,0,1/u,0,0)})}function at(n){let t=X(y.pressPos,a.canvas),e=X(y.releasePos,a.canvas);n.query({and:[A,p,f,C]}).forEach(o=>{let i=s.getComponent(o,p),r=s.getComponent(o,A),c=s.getComponent(o,f),l=s.getComponent(o,C),d=(t.x-i.x)**2<(c.width/2)**2&&(t.y-i.y)**2<(c.height/2)**2;r.hovered=(y.x-i.x)**2<(c.width/2)**2&&(y.y-i.y)**2<(c.height/2)**2,r.pressed=r.hovered&&y.isDown&&d,r.clicked=y.justReleased&&d&&(e.x-i.x)**2<(c.width/2)**2&&(e.y-i.y)**2<(c.height/2)**2,l.callback(o)})}function dt(n){n.query({and:[v,M,p,f]}).forEach(t=>{let e=s.getComponent(t,p),o=s.getComponent(t,f),i=s.getComponent(t,M),r=a.ctx.strokeStyle,c=a.ctx.fillStyle,l=a.ctx.lineWidth;a.ctx.fillStyle="black";let d=o.width*1.5;a.ctx.fillRect(e.x-d/2,e.y+o.offsetY*e.scaleY-1,d,.3),a.ctx.fillStyle="green",a.ctx.fillRect(e.x-d/2,e.y+o.offsetY*e.scaleY-1,d*(i.current/i.max),.3),a.ctx.strokeStyle="black",a.ctx.lineWidth=.1,a.ctx.strokeRect(e.x-d/2,e.y+o.offsetY*e.scaleY-1,d,.3),a.ctx.strokeStyle=r,a.ctx.fillStyle=c,a.ctx.lineWidth=l})}function lt(n,t,e=0,o=0,i=1,r=1){let c=n.addEntity();return s.addComponent(c,p,{x:e,y:o}),s.addComponent(c,D,{src:t}),s.addComponent(c,f,{width:i,height:r}),c}function q(n,t=0,e=0,o=1,i=1,r=-o/2,c=-i/2){let l=n.addEntity();return s.addComponent(l,p,{x:t,y:e}),s.addComponent(l,f,{width:o,height:i,offsetX:r,offsetY:c}),s.addComponent(l,R),s.addComponent(l,v),l}function pt(n,t=0,e=0,o=10,i=10,r=c=>{}){let c=q(n,t,e,o,i);return s.addComponent(c,A),s.addComponent(c,R),s.addComponent(c,C,{callback:r}),c}function ht(n,t=0,e=0){let o=q(n,t,e,1,1);return s.addComponent(o,k),s.addComponent(o,j,{...g.entities.player}),s.addComponent(o,M,{max:g.entities.player.healthPoint,current:g.entities.player.healthPoint}),s.addComponent(o,H),s.addComponent(o,b,{targetX:t,targetY:e}),o}function gt(n,t,e){let o=q(n,t,e,3,10,-1.5,-10);return s.addComponent(o,j,{...g.entities.turrent}),s.addComponent(o,M,{max:g.entities.turrent.healthPoint,current:g.entities.turrent.healthPoint}),o}function ft(n,t,e){let o=n.addEntity();return s.addComponent(o,m,{zoom:30}),s.addComponent(o,p,{x:t,y:e}),o}function mt(n="#424242"){let t=a.ctx.fillStyle;a.ctx.fillStyle=n,a.ctx.fillRect(0,0,a.canvas.width,a.canvas.height),a.ctx.fillStyle=t}function ut(n,t,e,o,i,r,c,l){return(n-i)**2<((e+c)/2)**2&&(t-r)**2<((o+l)/2)**2}function yt(n,t,e,o){let i=Math.cos(e),r=Math.sin(e),c={x:0,y:0},l=n.x-g.viewport.width/2,d=n.y-g.viewport.height/2;return c.x=i*l+r*d,c.y=-r*l+i*d,c.x/=o,c.y/=o,c.x+=t.x,c.y+=t.y,c}function xt(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function X(n,t){let e={x:0,y:0},o=t.getBoundingClientRect();return e.x=n.x-o.left,e.y=n.y-o.top,innerWidth/innerHeight<t.width/t.height?(e.x*=t.width/innerWidth,e.y*=t.width/innerWidth):(e.x*=t.height/innerHeight,e.y*=t.height/innerHeight),e}a.canvas.width=g.viewport.width;a.canvas.height=g.viewport.height;a.canvas.style.imageRendering="pixelated";a.ctx.lineWidth=.1;var x=new s,E=gt(x,10,0);s.addComponent(E,z,{particleEntity:E,speed:20,spread:.2});s.addComponent(E,w);s.addComponent(E,C).callback=()=>{let n=s.getComponent(E,w);n.timeMilli<100||(n.reset=!0,s.getComponent(E,z).emit=!0)};var U=ht(x,0,0);s.getComponent(U,M).current*=.6;var Dt=lt(x,"./assets/Map_of_MOBA.svg",0,0,300,300),Ct=ft(x,0,0),B=s.getComponent(Ct,m);B.targetEntity=U;B.isActive=!0;B.zoom=15;var Y=new s;pt(Y,g.viewport.width*.9,g.viewport.height*.8,g.viewport.height*.3,g.viewport.height*.3,n=>{s.getComponent(n,A).clicked&&console.log("clicked")});var L=Y.addEntity(),wt=s.addComponent(L,I,{content:"test string",backgroundColor:"white"});s.addComponent(L,p);(function n(){wt.content=`FPS: ${Math.ceil(1e3/S.dtMilli)}
Entity count: ${x.entityCount()}
Device type: ${xt()}`,mt(),x.update(rt,tt,F,O,dt),a.ctx.resetTransform(),Y.update(F,O,it),Y.update(at),x.update(st,ot,nt,et,ct),Q(y),J(G),_(S),requestAnimationFrame(n)})();})();
//# sourceMappingURL=out.js.map
