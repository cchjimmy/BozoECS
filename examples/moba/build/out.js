(()=>{var P=class{storage=[];indices=new Map;objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(t){let e;return this.size<this.storage.length?e=this.storage[this.size]:(e=this.objectFactory(),this.storage.push(e)),this.indices.set(t,this.size),this.size++,e}removeObj(t){let e=this.indices.get(t)??-1;if(e<0||e>=this.size)return!1;let o=this.storage[e];this.storage[e]=this.storage[this.size-1],this.storage[this.size-1]=o;for(let[r,i]of this.indices)if(i==this.size-1){this.indices.set(r,e);break}return this.indices.delete(t),this.size--,!0}getObj(t){let e=this.indices.get(t)??-1;if(e<0||e>=this.size)throw new Error("Index out of range.");return this.storage[e]}};var h=class n{static pools=new Map;static idMap=new Map;static register(t){n.pools.has(t)||(n.idMap.set(t,n.idMap.size),n.pools.set(t,new P(()=>({...t}))))}static getId(t){return n.idMap.get(t)??-1}static add(t,e){return Object.assign(n.pools.get(e).addObj(t),e)}static delete(t,e){return n.pools.get(e).removeObj(t)}static get(t,e){return n.pools.get(e).getObj(t)}static len(t){return n.pools.get(t).len()}static typeLen(){return n.pools.size}static types(){return n.pools.keys().toArray()}};var s=class n{static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static entitiesToDelete=[];localEntities=new Set;constructor(){n.worlds.push(this)}static createEntity(){let t=Math.random();return n.maskMap.set(t,0),n.getArchetype(0).add(t),t}static copyEntity(t){let e=Math.random(),o=h.types(),r=this.maskMap.get(t)??0;n.maskMap.set(e,r),n.getArchetype(r).add(e);for(let i=0,c=o.length;i<c;i++)r&1<<i&&Object.assign(h.add(e,o[i]),h.get(t,o[i]));return e}static getArchetype(t){let e=n.archetypeMap.get(t)??new Set;return n.archetypeMap.set(t,e),e}static deleteEntity(t){n.entitiesToDelete.push(t)}addEntity(t=n.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}static registerComponent(t){return h.register(t),n}static hasComponent(t,e){return((n.maskMap.get(t)??0)&1<<h.getId(e))>0}static addComponent(t,e,o=e){n.registerComponent(e);let r=n.maskMap.get(t)??0,i=h.getId(e);return(r&1<<i)!=0?Object.assign(h.get(t,e),o):(n.getArchetype(r).delete(t),r|=1<<i,n.maskMap.set(t,r),n.getArchetype(r).add(t),Object.assign(h.add(t,e),o))}static removeComponent(t,e){n.registerComponent(e);let o=n.maskMap.get(t)??0,r=h.getId(e);return(o&1<<r)==0?!1:(n.getArchetype(o).delete(t),o&=~(1<<r),n.maskMap.set(t,o),n.getArchetype(o).add(t),h.delete(t,e))}static getComponent(t,e){return h.get(t,e)}update(...t){for(let e=0,o=t.length;e<o;e++)t[e](this);for(;n.entitiesToDelete.length;){let e=n.entitiesToDelete.pop();for(let i=0,c=n.worlds.length;i<c;i++)n.worlds[i].localEntities.delete(e);let o=h.types(),r=n.maskMap.get(e)??0;n.maskMap.delete(e),n.getArchetype(r).delete(e);for(let i=0,c=o.length;i<c;i++)r&1<<i&&h.delete(e,o[i])}}query(t){let e=0,o=0;if(t.and)for(let i=0,c=t.and.length;i<c;i++)e|=1<<h.getId(t.and[i]);if(t.not)for(let i=0,c=t.not.length;i<c;i++)o|=1<<h.getId(t.not[i]);let r=[];for(let i=n.archetypeMap.keys().toArray(),c=i.length,d=0;d<c;d++){let l=i[d],u=n.getArchetype(l);u.size!=0&&(l&e)==e&&(l&o)==0&&r.push(...u)}return[...this.localEntities.intersection(new Set(r))]}entityCount(){return this.localEntities.size}};var g={viewport:{width:800,height:400},entities:{player:{healthPoint:10,moveSpeed:20},minion:{healthPoint:15,spawnRate:2},turrent:{healthPoint:100,abilityPower:100}}};var j={attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},b={current:0,max:0},C={callback:new Function},p={x:0,y:0,rad:0,scaleX:1,scaleY:1},M={x:0,y:0},F={};var v={},T={spread:0,particleEntity:-1,particleLifetimeSeconds:1,speed:1,emit:!1,particleTransition:function(n,t){let e=s.getComponent(n,p);e.scaleX=e.scaleY=-(t**2)+1}},m={zoom:20,tilt:0,isActive:!1,targetEntity:-1},f={width:1,height:1,offsetX:.5,offsetY:.5},Y={src:""},z={hovered:!1,pressed:!1,clicked:!1},A={fill:"white",stroke:"black"},D={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},k={timeMilli:0,reset:!1,stop:!1},w={targetX:0,targetY:0},a=G(),y=J(),$=K(),S=Q();function G(){let n=document.querySelector("canvas")??document.createElement("canvas");if(!n)throw new Error("Cannot create canvas element.");let t=n.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(n),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<n.width/n.height?(n.style.width="100%",n.style.height=""):(n.style.width="",n.style.height="100%")},{canvas:n,ctx:t}}function K(){let n={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!n.isDown[t.key]&&(n.justPressed[t.key]=!0),n.isDown[t.key]=!0},globalThis.onkeyup=t=>{n.isDown[t.key]=!1,n.justReleased[t.key]=!0},n}function V(n){for(let t in n.justPressed)n.justPressed[t]=!1;for(let t in n.justReleased)n.justReleased[t]=!1}function J(){let n={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(n.x=t.x,n.y=t.y,Object.assign(n.pressPos,n),n.isDown=n.justPressed=!0)},globalThis.onpointerup=t=>{n.x=t.x,n.y=t.y,Object.assign(n.releasePos,n),n.isDown=!1,n.justReleased=!0},globalThis.onpointermove=t=>{n.x=t.x,n.y=t.y},n}function N(n){n.justPressed=!1,n.justReleased=!1}function Q(){return{dtMilli:0,timeMilli:0}}function Z(n){n.dtMilli=performance.now()-n.timeMilli,n.timeMilli+=n.dtMilli}function _(n){let t=n.query({and:[m,p]}).find(r=>s.getComponent(r,m).isActive);if(!t)return;let e=s.getComponent(t,m),o=s.getComponent(t,p);n.query({and:[f,p]}).forEach(r=>{s.removeComponent(r,v);let i=s.getComponent(r,f),c=s.getComponent(r,p);ut(o.x,o.y,a.canvas.width/e.zoom,a.canvas.height/e.zoom,c.x+i.offsetX+i.width/2,c.y+i.offsetY+i.height/2,i.width,i.height)&&s.addComponent(r,v)})}function tt(n){n.query({and:[T,p]}).forEach(t=>{let e=s.getComponent(t,T);if(!e.emit||!s.hasComponent(e.particleEntity,p))return;e.emit=!1;let o=s.getComponent(t,p),r=s.copyEntity(e.particleEntity),i=s.getComponent(r,p);Object.assign(i,o),n.addEntity(r);let c=s.addComponent(r,k),d=Math.random()>.5,l=o.rad+Math.random()*e.spread*Math.PI*(-1*+d+ +!d);i.rad=l,s.addComponent(r,M,{x:Math.cos(l)*e.speed,y:Math.sin(l)*e.speed}),s.addComponent(r,C).callback=()=>{if(c.timeMilli<e.particleLifetimeSeconds*1e3){e.particleTransition(r,c.timeMilli/1e3/e.particleLifetimeSeconds);return}s.deleteEntity(r)}})}function et(n){let t=n.query({and:[m,p]}).find(i=>s.getComponent(i,m).isActive);if(t==null)return;let e=s.getComponent(t,m),o=s.getComponent(t,p),r=O(y.pressPos,a.canvas);n.query({and:[w,F]}).forEach(i=>{let c=s.getComponent(i,w);if(!y.justPressed)return;let d=yt(r,o,e.tilt,e.zoom);c.targetX=d.x,c.targetY=d.y})}function nt(n){n.query({and:[w,p,M,j]}).forEach(t=>{let e=s.getComponent(t,w),o=s.getComponent(t,p),r=s.getComponent(t,M),i=s.getComponent(t,j),c=e.targetX-o.x,d=e.targetY-o.y,l=(c*c+d*d)**.5;if(l==0)return;let u=i.moveSpeed*S.dtMilli/1e3*2,q=l>u?i.moveSpeed:i.moveSpeed*l/u;r.x=c/l*q,r.y=d/l*q})}function ot(n){n.query({and:[k,C]}).forEach(t=>s.getComponent(t,C).callback(t)),n.query({and:[k]}).forEach(t=>{let e=s.getComponent(t,k);e.reset&&(e.timeMilli=0),e.reset=!1,e.stop||(e.timeMilli+=S.dtMilli)})}function st(n){n.query({and:[D,p]}).forEach(t=>{let e=s.getComponent(t,D),o=s.getComponent(t,p);a.ctx.font=`${e.fontSize}px serif`;let r=a.ctx.fillStyle,i=e.content.split(`
`);for(let c=0,d=i.length;c<d;c++){let l=a.ctx.measureText(i[c]);a.ctx.fillStyle=e.backgroundColor,a.ctx.fillRect(o.x,o.y+c*(2*e.padding)+c*l.fontBoundingBoxAscent,e.padding*2+l.width,e.padding*2+l.fontBoundingBoxAscent),a.ctx.fillStyle=e.color,a.ctx.fillText(i[c],o.x+e.padding,o.y+c*(2*e.padding)+(c+1)*l.fontBoundingBoxAscent)}a.ctx.fillStyle=r})}function B(n){n.query({and:[p,f,A,v]}).forEach(t=>{let e=s.getComponent(t,p),o=s.getComponent(t,f),r=s.getComponent(t,A),i=a.ctx.fillStyle,c=a.ctx.strokeStyle;a.ctx.fillStyle=r.fill,a.ctx.strokeStyle=r.stroke;let d=Math.cos(e.rad),l=Math.sin(e.rad);a.ctx.transform(d,l,-l,d,e.x,e.y),a.ctx.fillRect(o.offsetX*e.scaleX,o.offsetY*e.scaleY,o.width*e.scaleX,o.height*e.scaleY),a.ctx.strokeRect(o.offsetX*e.scaleX,o.offsetY*e.scaleY,o.width*e.scaleX,o.height*e.scaleY),a.ctx.transform(d,-l,l,d,d*-e.x+l*-e.y,-l*-e.x+d*-e.y),a.ctx.fillStyle=i,a.ctx.strokeStyle=c})}function it(n){let t=a.ctx.fillStyle;a.ctx.fillStyle="red",n.query({and:[w]}).forEach(e=>{let o=s.getComponent(e,w);a.ctx.fillRect(o.targetX-.5,o.targetY-.5,1,1)}),a.ctx.fillStyle=t}function rt(n){let t=n.query({and:[m,p]}).find(c=>s.getComponent(c,m).isActive);if(!t)return;a.ctx.resetTransform();let e=s.getComponent(t,m),o=s.getComponent(t,p);if(e.targetEntity!=-1&&s.hasComponent(e.targetEntity,p)){let c=s.getComponent(e.targetEntity,p);Object.assign(o,c)}let r=Math.sin(e.tilt)*e.zoom,i=Math.cos(e.tilt)*e.zoom;a.ctx.transform(i,r,-r,i,i*-o.x-r*-o.y+a.ctx.canvas.width*.5,r*-o.x+i*-o.y+a.ctx.canvas.height*.5)}function ct(n){let t=S.dtMilli/1e3;n.query({and:[p,M]}).forEach(e=>{let o=s.getComponent(e,p),r=s.getComponent(e,M);o.x+=r.x*t,o.y+=r.y*t})}function W(n){n.query({and:[Y,p]}).forEach(t=>{let e=s.getComponent(t,Y),o=s.getComponent(t,p),r=s.hasComponent(t,f)&&s.getComponent(t,f),i=new Image;i.src=e.src;let c=r?r.width:i.width,d=r?r.height:i.height,l=c/i.width,u=d/i.height;a.ctx.transform(l,0,0,u,0,0),a.ctx.drawImage(i,(o.x-c/2)/l,(o.y-d/2)/u),a.ctx.transform(1/l,0,0,1/u,0,0)})}function at(n){let t=O(y.pressPos,a.canvas),e=O(y.releasePos,a.canvas);n.query({and:[z,p,f,C]}).forEach(o=>{let r=s.getComponent(o,p),i=s.getComponent(o,z),c=s.getComponent(o,f),d=s.getComponent(o,C),l=(t.x-r.x)**2<(c.width/2)**2&&(t.y-r.y)**2<(c.height/2)**2;i.hovered=(y.x-r.x)**2<(c.width/2)**2&&(y.y-r.y)**2<(c.height/2)**2,i.pressed=i.hovered&&y.isDown&&l,i.clicked=y.justReleased&&l&&(e.x-r.x)**2<(c.width/2)**2&&(e.y-r.y)**2<(c.height/2)**2,d.callback(o)})}function lt(n){n.query({and:[v,b,p,f]}).forEach(t=>{let e=s.getComponent(t,p),o=s.getComponent(t,f),r=s.getComponent(t,b),i=a.ctx.strokeStyle,c=a.ctx.fillStyle,d=a.ctx.lineWidth;a.ctx.fillStyle="black";let l=o.width*1.5;a.ctx.fillRect(e.x-l/2,e.y+o.offsetY*e.scaleY-1,l,.3),a.ctx.fillStyle="green",a.ctx.fillRect(e.x-l/2,e.y+o.offsetY*e.scaleY-1,l*(r.current/r.max),.3),a.ctx.strokeStyle="black",a.ctx.lineWidth=.1,a.ctx.strokeRect(e.x-l/2,e.y+o.offsetY*e.scaleY-1,l,.3),a.ctx.strokeStyle=i,a.ctx.fillStyle=c,a.ctx.lineWidth=d})}function dt(n,t,e=0,o=0,r=1,i=1){let c=n.addEntity();return s.addComponent(c,p,{x:e,y:o}),s.addComponent(c,Y,{src:t}),s.addComponent(c,f,{width:r,height:i}),c}function I(n,t=0,e=0,o=1,r=1,i=-o/2,c=-r/2){let d=n.addEntity();return s.addComponent(d,p,{x:t,y:e}),s.addComponent(d,f,{width:o,height:r,offsetX:i,offsetY:c}),s.addComponent(d,A),s.addComponent(d,v),d}function pt(n,t=0,e=0,o=10,r=10,i=c=>{}){let c=I(n,t,e,o,r);return s.addComponent(c,z),s.addComponent(c,A),s.addComponent(c,C,{callback:i}),c}function ht(n,t=0,e=0){let o=I(n,t,e,1,1);return s.addComponent(o,M),s.addComponent(o,j,{...g.entities.player}),s.addComponent(o,b,{max:g.entities.player.healthPoint,current:g.entities.player.healthPoint}),s.addComponent(o,F),s.addComponent(o,w,{targetX:t,targetY:e}),o}function gt(n,t,e){let o=I(n,t,e,3,10,-1.5,-10);return s.addComponent(o,j,{...g.entities.turrent}),s.addComponent(o,b,{max:g.entities.turrent.healthPoint,current:g.entities.turrent.healthPoint}),o}function ft(n,t,e){let o=n.addEntity();return s.addComponent(o,m,{zoom:30}),s.addComponent(o,p,{x:t,y:e}),o}function mt(n="#424242"){let t=a.ctx.fillStyle;a.ctx.fillStyle=n,a.ctx.fillRect(0,0,a.canvas.width,a.canvas.height),a.ctx.fillStyle=t}function ut(n,t,e,o,r,i,c,d){return(n-r)**2<((e+c)/2)**2&&(t-i)**2<((o+d)/2)**2}function yt(n,t,e,o){let r=Math.cos(e),i=Math.sin(e),c={x:0,y:0},d=n.x-g.viewport.width/2,l=n.y-g.viewport.height/2;return c.x=r*d+i*l,c.y=-i*d+r*l,c.x/=o,c.y/=o,c.x+=t.x,c.y+=t.y,c}function xt(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function O(n,t){let e={x:0,y:0},o=t.getBoundingClientRect();return e.x=n.x-o.left,e.y=n.y-o.top,innerWidth/innerHeight<t.width/t.height?(e.x*=t.width/innerWidth,e.y*=t.width/innerWidth):(e.x*=t.height/innerHeight,e.y*=t.height/innerHeight),e}a.canvas.width=g.viewport.width;a.canvas.height=g.viewport.height;a.canvas.style.imageRendering="pixelated";a.ctx.lineWidth=.1;var x=new s,E=gt(x,10,0);s.addComponent(E,T,{particleEntity:E,speed:20,spread:.2});s.addComponent(E,k);s.addComponent(E,C).callback=()=>{let n=s.getComponent(E,k);n.timeMilli<100||(n.reset=!0,s.getComponent(E,T).emit=!0)};var H=ht(x,0,0);s.getComponent(H,b).current*=.6;var At=dt(x,"./assets/Map_of_MOBA.svg",0,0,300,300),Ct=ft(x,0,0),X=s.getComponent(Ct,m);X.targetEntity=H;X.isActive=!0;X.zoom=15;var R=new s;pt(R,g.viewport.width*.9,g.viewport.height*.8,g.viewport.height*.3,g.viewport.height*.3,n=>{s.getComponent(n,z).clicked&&console.log("clicked")});var U=R.addEntity(),wt=s.addComponent(U,D,{content:"test string",backgroundColor:"white"});s.addComponent(U,p);(function n(){wt.content=`FPS: ${Math.ceil(1e3/S.dtMilli)}
Entity count: ${x.entityCount()}
Device type: ${xt()}`,mt(),x.update(rt,_,W,B,it,lt),a.ctx.resetTransform(),R.update(W,B,st),R.update(at),x.update(ot,nt,et,tt,ct),N(y),V($),Z(S),requestAnimationFrame(n)})();})();
//# sourceMappingURL=out.js.map
