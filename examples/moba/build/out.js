(()=>{var T=class{storage=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(){let t;return this.size<this.storage.length?t=this.storage[this.size]:(t=this.objectFactory(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(n=>n==t)}removeObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");let n=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=n,this.size--,n}getObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var u=class e{static pools=new Map;static idMap=new Map;static register(t){e.idMap.set(t,e.idMap.size),e.pools.set(t,new T(()=>({...t})))}static getId(t){return e.idMap.get(t)??-1}static add(t){return Object.assign(e.pools.get(t).addObj(),t)}static delete(t,n){return e.pools.get(t).removeObj(n)}static get(t,n){return e.pools.get(t).getObj(n)}static len(t){return e.pools.get(t).len()}static typeLen(){return e.pools.size}static types(){return e.pools.keys().toArray()}};var x=class e{static nextId=0;static pool=new T(()=>e.nextId++);static add(){return e.pool.addObj()}static findIndex(t){return e.pool.findIndex(t)}static delete(t){return e.pool.removeObj(t)}};var a=class e{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];localEntities=new Set;timeMilli=0;dtMilli=0;constructor(){e.worlds.push(this)}static createEntity(){let t=x.add();return e.maskMap.set(t,0),e.getArchetype(0).add(t),t}static getArchetype(t){let n=e.archetypeMap.get(t)??new Set;return e.archetypeMap.set(t,n),n}static deleteEntity(t){for(let o=0,r=e.worlds.length;o<r;o++)e.worlds[o].removeEntity(t);let n=u.types(),i=e.maskMap.get(t);for(let o=0,r=n.length;o<r;o++)i&1<<o&&e.removeComponent(t,n[o]);x.delete(x.findIndex(t))}addEntity(t=e.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static registerComponent(t){return e.indexMap.has(t)||(u.register(t),e.indexMap.set(t,new Map)),e}static hasComponent(t,n){return!!(e.maskMap.get(t)&1<<u.getId(n))}static addComponent(t,n,i={}){e.registerComponent(n);let o=e.maskMap.get(t),r=u.getId(n);if((o&1<<r)!=0)throw new Error(`Entity ${t} already had that component.`);e.getArchetype(o).delete(t),o|=1<<r,e.maskMap.set(t,o),e.getArchetype(o).add(t);let s=u.len(n);return e.indexMap.get(n).set(t,s),Object.assign(u.add(n),i)}static removeComponent(t,n){e.registerComponent(n);let i=e.maskMap.get(t),o=u.getId(n);if((i&1<<o)==0)throw new Error(`Entity ${t} does not have that component.`);e.getArchetype(i).delete(t),i&=~(1<<o),e.maskMap.set(t,i),e.getArchetype(i).add(t);let r=e.indexMap.get(n),s=r.get(t),d=u.delete(n,s),c=r.keys().toArray().at(-1)??-1;return r.set(c,s),r.delete(t),d}static getComponent(t,n){return u.get(n,e.indexMap.get(n).get(t))}update(...t){for(let n=0,i=t.length;n<i;n++)t[n](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let n=0,i=0,o=0;if(t.and)for(let s=0,d=t.and.length;s<d;s++)n|=1<<u.getId(t.and[s]);if(t.or)for(let s=0,d=t.or.length;s<d;s++)i|=1<<u.getId(t.or[s]);if(t.not)for(let s=0,d=t.not.length;s<d;s++)o|=1<<u.getId(t.not[s]);let r=[];for(let s=e.archetypeMap.keys().toArray(),d=s.length,c=0;c<d;c++){let h=s[c],b=e.getArchetype(h);b.size>0&&(h&n)==n&&(h|i)>0&&(h&o)==0&&r.push(...this.localEntities.intersection(b))}return r}entityCount(){return this.localEntities.size}};var g={viewport:{width:800,height:400},player:{speed:20},minions:{speed:20,spawnRate:2}};var k={kp:0,ki:0,kd:0,prevErr:0,accumErr:0,result:function(e,t){if(t==0)return 0;this.accumErr+=e;let n=this.kp*e+this.ki*this.accumErr+this.kd*(e-this.prevErr)/t;return this.prevErr=e,n},reset:function(){this.prevErr=this.accumErr=0}},j={healthPoint:0,attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},C={callback:new Function},m={x:0,y:0,rad:0,scaleX:1,scaleY:1},w={x:0,y:0},$={},v={zoom:20,tilt:0,isActive:!1},y={width:2,height:2},W={src:""},E={hovered:!1,pressed:!1,clicked:!1},S={fill:"white",stroke:"black"},I={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},O={timeMilli:0,reset:!1,stop:!1},M={targetX:0,targetY:0},p={x:0,y:0,isDown:!1,pressPos:{x:0,y:0},justPressed:!1,justReleased:!1,releasePos:{x:0,y:0}},P={};function X(e){let t,n;e.query({and:[v,m]}).forEach(i=>{let o=a.getComponent(i,v);o.isActive&&(t=o,n=a.getComponent(i,m),P.q&&(t.tilt+=1*e.dtMilli/1e3),P.e&&(t.tilt-=1*e.dtMilli/1e3))}),e.query({and:[M,$]}).forEach(i=>{if(!t||!n)return;let o=a.getComponent(i,M);if(p.justPressed){let r=_({x:p.x,y:p.y},n,t.tilt,t.zoom);o.targetX=r.x,o.targetY=r.y}})}function Y(e){e.query({and:[M,m,w,j],or:[k]}).forEach(t=>{let n=a.getComponent(t,M),i=a.getComponent(t,m),o=a.getComponent(t,w),r=a.getComponent(t,j),s=n.targetX-i.x,d=n.targetY-i.y,c=(s*s+d*d)**.5;if(c==0)return;let h=r.moveSpeed*e.dtMilli/1e3*2,b=c>h?r.moveSpeed:r.moveSpeed*c/h;if(a.hasComponent(t,k)){let z=a.getComponent(t,k),A=(o.x*o.x+o.y*o.y)**.5;c>h?(z.reset(),b=r.moveSpeed):b=A+z.result(-A,e.dtMilli/1e3)}o.x=s/c*b,o.y=d/c*b})}function H(e){e.query({and:[O],or:[C]}).forEach(t=>{a.hasComponent(t,C)&&a.getComponent(t,C).callback(t);let n=a.getComponent(t,O);n.reset&&(n.timeMilli=0),n.reset=!1,n.stop||(n.timeMilli+=e.dtMilli)})}function G(e){l&&e.query({and:[I,m]}).forEach(t=>{let n=a.getComponent(t,I),i=a.getComponent(t,m);l.font=`${n.fontSize}px serif`;let o=l.fillStyle,r=n.content.split(`
`);for(let s=0,d=r.length;s<d;s++){let c=l.measureText(r[s]);l.fillStyle=n.backgroundColor,l.fillRect(i.x,i.y+s*(2*n.padding)+s*c.fontBoundingBoxAscent,n.padding*2+c.width,n.padding*2+c.fontBoundingBoxAscent),l.fillStyle=n.color,l.fillText(r[s],i.x+n.padding,i.y+s*(2*n.padding)+(s+1)*c.fontBoundingBoxAscent)}l.fillStyle=o})}function K(e,t,n,i){let o=e.fillStyle,r=e.strokeStyle;e.fillStyle=i.fill,e.strokeStyle=i.stroke;let s=new Path2D(`M ${t.x-n.width*.5} ${t.y-n.height*.5} h ${n.width} v ${n.height} h ${-n.width} Z`);e.fill(s),e.stroke(s),e.fillStyle=o,e.strokeStyle=r}function R(e){l&&e.query({and:[m,y,S]}).forEach(t=>{let n=a.getComponent(t,m),i=a.getComponent(t,y),o=a.getComponent(t,S);K(l,n,i,o)})}function L(e="#424242"){if(!l)return;let t=l.fillStyle;l.fillStyle=e,l.fillRect(0,0,l.canvas.width,l.canvas.height),l.fillStyle=t}function U(e){l&&e.query({and:[v,m]}).forEach(t=>{let n=a.getComponent(t,v);if(!n.isActive)return;let i=a.getComponent(t,m),o=Math.sin(n.tilt),r=Math.cos(n.tilt),s=-i.x*n.zoom,d=-i.y*n.zoom;l.transform(r*n.zoom,-o*n.zoom,o*n.zoom,r*n.zoom,r*s+o*d+l.canvas.width*.5,-o*s+r*d+l.canvas.height*.5)})}function V(e){let t=e.dtMilli/1e3;e.query({and:[m,w]}).forEach(n=>{let i=a.getComponent(n,m),o=a.getComponent(n,w);i.x+=o.x*t,i.y+=o.y*t})}function B(e){l&&e.query({and:[W,m],or:[y]}).forEach(t=>{let n=a.getComponent(t,W),i=a.getComponent(t,m),o=a.hasComponent(t,y)&&a.getComponent(t,y),r=new Image;r.src=n.src;let s=o?o.width:r.width,d=o?o.height:r.height,c=s/r.width,h=d/r.height;l.transform(c,0,0,h,0,0),l.drawImage(r,(i.x-s/2)/c,(i.y-d/2)/h),l.transform(1/c,0,0,1/h,0,0)})}function J(e){e.query({and:[E,m,y,C]}).forEach(t=>{let n=a.getComponent(t,m),i=a.getComponent(t,E),o=a.getComponent(t,y),r=a.getComponent(t,C),s=(p.pressPos.x-n.x)**2<(o.width/2)**2&&(p.pressPos.y-n.y)**2<(o.height/2)**2;i.hovered=(p.x-n.x)**2<(o.width/2)**2&&(p.y-n.y)**2<(o.height/2)**2,i.pressed=i.hovered&&p.isDown&&s,i.clicked=p.justReleased&&s&&(p.releasePos.x-n.x)**2<(o.width/2)**2&&(p.releasePos.y-n.y)**2<(o.height/2)**2,r.callback(t)})}function D(e,t,n=0,i=0,o=1,r=1){let s=e.addEntity(),d=a.addComponent(s,m),c=a.addComponent(s,W),h=a.addComponent(s,y);return d.x=n,d.y=i,c.src=t,h.width=o,h.height=r,s}function q(e,t=0,n=0){let i=e.addEntity(),o=a.addComponent(i,m);a.addComponent(i,y);let r=a.addComponent(i,S);return r.fill="green",o.x=t,o.y=n,i}function N(e,t=0,n=0,i=10,o=10,r=()=>{}){let s=e.addEntity(),d=a.addComponent(s,m),c=a.addComponent(s,y),h=a.addComponent(s,E);a.addComponent(s,S),d.x=t,d.y=n,c.width=i,c.height=o;let b=a.addComponent(s,C);return b.callback=r,s}function Q(e){let t=q(e,0,0),n=a.getComponent(t,y);n.width=1,n.height=1,a.addComponent(t,w);let i=a.addComponent(t,j);i.moveSpeed=g.player.speed,a.addComponent(t,$),a.addComponent(t,M);let o=a.addComponent(t,k);return o.kp=.5,o.ki=.001,o.kd=0,t}function Z(e,t,n){let i=q(e,t,n);return a.addComponent(i,j),i}function _(e,t,n,i){let o=Math.cos(n),r=Math.sin(n),s={x:0,y:0},d=e.x-g.viewport.width/2,c=e.y-g.viewport.height/2;return s.x=o*d-r*c,s.y=r*d+o*c,s.x/=i,s.y/=i,s.x+=t.x,s.y+=t.y,s}function tt(e){e.setTransform(1,0,0,1,0,0)}function et(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}var f=document.querySelector("canvas"),l=f?.getContext("2d");if(f&&l){f.width=g.viewport.width,f.height=g.viewport.height,f.style.imageRendering="pixelated",l.lineWidth=.1,document.onkeydown=c=>{P[c.key]=!0},document.onkeyup=c=>{delete P[c.key]},document.onpointermove=c=>{let h=f.getBoundingClientRect();p.x=c.x-h.left,p.y=c.y-h.top,innerWidth/innerHeight<f.width/f.height?(p.x*=f.width/innerWidth,p.y*=f.width/innerWidth):(p.x*=f.height/innerHeight,p.y*=f.height/innerHeight)},document.onpointerdown=c=>{c.target==f&&(p.isDown=!0,p.justPressed=!0,Object.assign(p.pressPos,p))},document.onpointerup=()=>{p.isDown=!1,p.justReleased=!0,Object.assign(p.releasePos,p)},document.body.append(f);let e=new a,t=Q(e),n=Z(e,10,0),i=D(e,"./assets/Map_of_MOBA.svg",0,0,300,300),o=a.addComponent(t,v);o.zoom=30,o.isActive=!0;let r=new a;N(r,g.viewport.width*.9,g.viewport.height*.8,g.viewport.height*.3,g.viewport.height*.3,c=>{a.getComponent(c,E).clicked&&console.log("clicked")}),D(r,"./assets/Map_of_MOBA.svg",g.viewport.width*.1,g.viewport.height*.2,g.viewport.height*.3,g.viewport.height*.3);let s=r.addEntity(),d=a.addComponent(s,I,{content:"test string",backgroundColor:"white"});a.addComponent(s,m),function c(){L(),d.content=`FPS: ${Math.ceil(1e3/e.dtMilli)}
Entity count: ${e.entityCount()}
Device type: ${et()}`,e.update(H,U,Y,X,B,R,V),tt(l),r.update(B,R,G,J),p.justReleased=!1,p.justPressed=!1,requestAnimationFrame(c)}()}})();
//# sourceMappingURL=out.js.map
