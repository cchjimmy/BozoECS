var M=class{storage=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(){let t;return this.size<this.storage.length?t=this.storage[this.size]:(t=this.objectFactory(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(n=>n==t)}removeObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");let n=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=n,this.size--,n}getObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var u=class e{static pools=new Map;static idMap=new Map;static register(t){e.idMap.set(t,e.idMap.size),e.pools.set(t,new M(()=>({...t})))}static getId(t){return e.idMap.get(t)??-1}static add(t){return Object.assign(e.pools.get(t).addObj(),t)}static delete(t,n){return e.pools.get(t).removeObj(n)}static get(t,n){return e.pools.get(t).getObj(n)}static len(t){return e.pools.get(t).len()}static typeLen(){return e.pools.size}static types(){return e.pools.keys().toArray()}};var w=class e{static nextId=0;static pool=new M(()=>e.nextId++);static add(){return e.pool.addObj()}static findIndex(t){return e.pool.findIndex(t)}static delete(t){return e.pool.removeObj(t)}};var a=class e{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];localEntities=new Set;timeMilli=0;dtMilli=0;constructor(){e.worlds.push(this)}static createEntity(){let t=w.add();return e.maskMap.set(t,0),e.getArchetype(0).add(t),t}static copyEntity(t){let n=w.add(),o=u.types(),i=this.maskMap.get(t);for(let s=0,r=o.length;s<r;s++)i&1<<s&&e.addComponent(n,o[s],e.getComponent(t,o[s]));return n}static getArchetype(t){let n=e.archetypeMap.get(t)??new Set;return e.archetypeMap.set(t,n),n}static deleteEntity(t){for(let i=0,s=e.worlds.length;i<s;i++)e.worlds[i].removeEntity(t);let n=u.types(),o=e.maskMap.get(t);for(let i=0,s=n.length;i<s;i++)o&1<<i&&e.removeComponent(t,n[i]);w.delete(w.findIndex(t))}addEntity(t=e.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static registerComponent(t){return e.indexMap.has(t)||(u.register(t),e.indexMap.set(t,new Map)),e}static hasComponent(t,n){return!!(e.maskMap.get(t)&1<<u.getId(n))}static addComponent(t,n,o={}){e.registerComponent(n);let i=e.maskMap.get(t),s=u.getId(n);if((i&1<<s)!=0)throw new Error(`Entity ${t} already had that component.`);e.getArchetype(i).delete(t),i|=1<<s,e.maskMap.set(t,i),e.getArchetype(i).add(t);let r=u.len(n);return e.indexMap.get(n).set(t,r),Object.assign(u.add(n),o)}static removeComponent(t,n){e.registerComponent(n);let o=e.maskMap.get(t),i=u.getId(n);if((o&1<<i)==0)throw new Error(`Entity ${t} does not have that component.`);e.getArchetype(o).delete(t),o&=~(1<<i),e.maskMap.set(t,o),e.getArchetype(o).add(t);let s=e.indexMap.get(n),r=s.get(t),h=u.delete(n,r),d=s.keys().toArray().at(-1)??-1;return s.set(d,r),s.delete(t),h}static getComponent(t,n){return u.get(n,e.indexMap.get(n).get(t))}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let n=0,o=0;if(t.and)for(let s=0,r=t.and.length;s<r;s++)n|=1<<u.getId(t.and[s]);if(t.not)for(let s=0,r=t.not.length;s<r;s++)o|=1<<u.getId(t.not[s]);let i=[];for(let s=e.archetypeMap.keys().toArray(),r=s.length,h=0;h<r;h++){let d=s[h],m=e.getArchetype(d);m.size!=0&&(d&n)==n&&(d&o)==0&&i.push(...m)}return[...this.localEntities.intersection(new Set(i))]}entityCount(){return this.localEntities.size}};var y={viewport:{width:800,height:400},player:{speed:20},minions:{speed:20,spawnRate:2}};var b={healthPoint:0,attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},E={callback:new Function},p={x:0,y:0,rad:0,scaleX:1,scaleY:1},v={x:0,y:0},B={};var k={zoom:20,tilt:0,isActive:!1,targetEntity:-1},C={width:2,height:2},j={src:""},S={hovered:!1,pressed:!1,clicked:!1},P={fill:"white",stroke:"black"},I={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},A={timeMilli:0,reset:!1,stop:!1},x={targetX:0,targetY:0},l={x:0,y:0,isDown:!1,pressPos:{x:0,y:0},justPressed:!1,justReleased:!1,releasePos:{x:0,y:0}},z={};function q(e){let t,n;e.query({and:[k,p]}).forEach(o=>{let i=a.getComponent(o,k);i.isActive&&(t=i,n=a.getComponent(o,p))}),e.query({and:[x,B]}).forEach(o=>{if(!t||!n)return;let i=a.getComponent(o,x);if(!l.justPressed)return;let s=tt(l.pressPos,n,t.tilt,t.zoom);i.targetX=s.x,i.targetY=s.y})}function F(e){e.query({and:[x,p,v,b]}).forEach(t=>{let n=a.getComponent(t,x),o=a.getComponent(t,p),i=a.getComponent(t,v),s=a.getComponent(t,b),r=n.targetX-o.x,h=n.targetY-o.y,d=(r*r+h*h)**.5;if(d==0)return;let m=s.moveSpeed*e.dtMilli/1e3*2,g=d>m?s.moveSpeed:s.moveSpeed*d/m;i.x=r/d*g,i.y=h/d*g})}function Y(e){e.query({and:[A]}).forEach(t=>{a.hasComponent(t,E)&&a.getComponent(t,E).callback(t);let n=a.getComponent(t,A);n.reset&&(n.timeMilli=0),n.reset=!1,n.stop||(n.timeMilli+=e.dtMilli)})}function W(e){c&&e.query({and:[I,p]}).forEach(t=>{let n=a.getComponent(t,I),o=a.getComponent(t,p);c.font=`${n.fontSize}px serif`;let i=c.fillStyle,s=n.content.split(`
`);for(let r=0,h=s.length;r<h;r++){let d=c.measureText(s[r]);c.fillStyle=n.backgroundColor,c.fillRect(o.x,o.y+r*(2*n.padding)+r*d.fontBoundingBoxAscent,n.padding*2+d.width,n.padding*2+d.fontBoundingBoxAscent),c.fillStyle=n.color,c.fillText(s[r],o.x+n.padding,o.y+r*(2*n.padding)+(r+1)*d.fontBoundingBoxAscent)}c.fillStyle=i})}function H(e,t,n,o){let i=e.fillStyle,s=e.strokeStyle;e.fillStyle=o.fill,e.strokeStyle=o.stroke;let r=new Path2D(`M ${t.x-n.width*.5*t.scaleX} ${t.y-n.height*.5*t.scaleY} h ${n.width*t.scaleX} v ${n.height*t.scaleY} h ${-n.width*t.scaleX} Z`);e.fill(r),e.stroke(r),e.fillStyle=i,e.strokeStyle=s}function T(e){c&&e.query({and:[p,C,P]}).forEach(t=>{let n=a.getComponent(t,p),o=a.getComponent(t,C),i=a.getComponent(t,P);H(c,n,o,i)})}function G(e){if(!c)return;let t=c.fillStyle;c.fillStyle="red",e.query({and:[x]}).forEach(n=>{let o=a.getComponent(n,x);c.fillRect(o.targetX-.5,o.targetY-.5,1,1)}),c.fillStyle=t}function L(e="#424242"){if(!c)return;let t=c.fillStyle;c.fillStyle=e,c.fillRect(0,0,c.canvas.width,c.canvas.height),c.fillStyle=t}function K(e){c&&e.query({and:[k,p]}).forEach(t=>{let n=a.getComponent(t,k);if(!n.isActive)return;D(c);let o=a.getComponent(t,p);if(n.targetEntity!=-1){let r=a.getComponent(n.targetEntity,p);Object.assign(o,r)}let i=Math.sin(n.tilt)*n.zoom,s=Math.cos(n.tilt)*n.zoom;c.transform(s,i,-i,s,s*-o.x-i*-o.y+c.canvas.width*.5,i*-o.x+s*-o.y+c.canvas.height*.5)})}function U(e){let t=e.dtMilli/1e3;e.query({and:[p,v]}).forEach(n=>{let o=a.getComponent(n,p),i=a.getComponent(n,v);o.x+=i.x*t,o.y+=i.y*t})}function O(e){c&&e.query({and:[j,p]}).forEach(t=>{let n=a.getComponent(t,j),o=a.getComponent(t,p),i=a.hasComponent(t,C)&&a.getComponent(t,C),s=new Image;s.src=n.src;let r=i?i.width:s.width,h=i?i.height:s.height,d=r/s.width,m=h/s.height;c.transform(d,0,0,m,0,0),c.drawImage(s,(o.x-r/2)/d,(o.y-h/2)/m),c.transform(1/d,0,0,1/m,0,0)})}function V(e){e.query({and:[S,p,C,E]}).forEach(t=>{let n=a.getComponent(t,p),o=a.getComponent(t,S),i=a.getComponent(t,C),s=a.getComponent(t,E),r=(l.pressPos.x-n.x)**2<(i.width/2)**2&&(l.pressPos.y-n.y)**2<(i.height/2)**2;o.hovered=(l.x-n.x)**2<(i.width/2)**2&&(l.y-n.y)**2<(i.height/2)**2,o.pressed=o.hovered&&l.isDown&&r,o.clicked=l.justReleased&&r&&(l.releasePos.x-n.x)**2<(i.width/2)**2&&(l.releasePos.y-n.y)**2<(i.height/2)**2,s.callback(t)})}function J(e,t,n=0,o=0,i=1,s=1){let r=e.addEntity();return a.addComponent(r,p,{x:n,y:o}),a.addComponent(r,j,{src:t}),a.addComponent(r,C,{width:i,height:s}),r}function $(e,t=0,n=0,o=1,i=1){let s=e.addEntity();return a.addComponent(s,p,{x:t,y:n}),a.addComponent(s,C,{width:o,height:i}),a.addComponent(s,P,{fill:"green"}),s}function N(e,t=0,n=0,o=10,i=10,s=r=>{}){let r=e.addEntity();return a.addComponent(r,p,{x:t,y:n}),a.addComponent(r,C,{width:o,height:i}),a.addComponent(r,S),a.addComponent(r,P),a.addComponent(r,E,{callback:s}),r}function Q(e,t=0,n=0){let o=$(e,t,n,1,1);return a.addComponent(o,v),a.addComponent(o,b,{moveSpeed:y.player.speed}),a.addComponent(o,B),a.addComponent(o,x,{targetX:t,targetY:n}),o}function Z(e,t,n){let o=$(e,t,n,3,10);return a.addComponent(o,b),o}function _(e,t,n){let o=e.addEntity();return a.addComponent(o,k,{zoom:30}),a.addComponent(o,p,{x:t,y:n}),o}function tt(e,t,n,o){let i=Math.cos(n),s=Math.sin(n),r={x:0,y:0},h=e.x-y.viewport.width/2,d=e.y-y.viewport.height/2;return r.x=i*h+s*d,r.y=-s*h+i*d,r.x/=o,r.y/=o,r.x+=t.x,r.y+=t.y,r}function D(e){e.setTransform(1,0,0,1,0,0)}function et(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function R(e){if(!f)return;let t=f.getBoundingClientRect();l.x=e.x-t.left,l.y=e.y-t.top,innerWidth/innerHeight<f.width/f.height?(l.x*=f.width/innerWidth,l.y*=f.width/innerWidth):(l.x*=f.height/innerHeight,l.y*=f.height/innerHeight)}var f=document.querySelector("canvas"),c=f?.getContext("2d");if(f&&c){f.width=y.viewport.width,f.height=y.viewport.height,f.style.imageRendering="pixelated",c.lineWidth=.1,document.onkeydown=g=>{z[g.key]=!0},document.onkeyup=g=>{z[g.key]=!1},document.onpointerdown=g=>{g.target==f&&(l.isDown=!0,l.justPressed=!0,R(g),Object.assign(l.pressPos,l))},document.onpointerup=g=>{l.isDown=!1,l.justReleased=!0,R(g),Object.assign(l.releasePos,l)},document.body.append(f);let e=new a,t=Q(e,0,0),n=a.copyEntity(t);a.getComponent(n,p).x+=5,e.addEntity(n);let o=Z(e,10,0),i=J(e,"./assets/Map_of_MOBA.svg",0,0,300,300),s=_(e,0,0),r=a.getComponent(s,k);r.targetEntity=t,r.isActive=!0;let h=new a;N(h,y.viewport.width*.9,y.viewport.height*.8,y.viewport.height*.3,y.viewport.height*.3,g=>{a.getComponent(g,S).clicked&&console.log("clicked")});let d=h.addEntity(),m=a.addComponent(d,I,{content:"test string",backgroundColor:"white"});a.addComponent(d,p),function g(){L(),m.content=`FPS: ${Math.ceil(1e3/e.dtMilli)}
Entity count: ${e.entityCount()}
Device type: ${et()}`,e.update(Y,K,F,q,O,T,G,U),D(c),h.update(O,T,W,V),l.justReleased=!1,l.justPressed=!1,requestAnimationFrame(g)}()}
//# sourceMappingURL=out.js.map
