(()=>{var A=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(e){this.objectFactory=e}size(){return this.keyToIndex.size}add(e){return this.keyToIndex.has(e)?this.storage[this.keyToIndex.get(e)]:(this.storage.length<=this.keyToIndex.size&&this.storage.push(this.objectFactory()),this.keyToIndex.set(e,this.keyToIndex.size),this.indexToKey[this.keyToIndex.size-1]=e,this.storage[this.keyToIndex.get(e)])}remove(e){let n=this.keyToIndex.get(e);if(n==null)return;let o=this.indexToKey[this.keyToIndex.size-1],i=this.storage[n];this.storage[n]=this.storage[this.keyToIndex.size-1],this.storage[this.keyToIndex.size-1]=i,this.indexToKey[n]=o,this.indexToKey.pop(),this.keyToIndex.set(o,n),this.keyToIndex.delete(e)}get(e){let n=this.keyToIndex.get(e);if(n==null)throw new Error("Key not found.");return this.storage[n]}has(e){return this.keyToIndex.has(e)}clean(){this.storage.splice(this.keyToIndex.size)}};var q=class{poolMap=new Map;maskMap=new Map;register(e){this.poolMap.has(e)||(this.maskMap.set(e,1<<this.maskMap.size),this.poolMap.set(e,new A(()=>({...e}))))}getMask(e){let n=this.maskMap.get(e);return n??(this.register(e),this.maskMap.get(e))}add(e,n){return Object.assign(this.poolMap.get(n).add(e),n)}remove(e,n){this.poolMap.get(n).remove(e)}has(e,n){return this.poolMap.has(n)&&this.poolMap.get(n).has(e)}get(e,n){return this.poolMap.get(n).get(e)}size(e){return this.poolMap.get(e).size()}delete(e){for(let n of this.poolMap.entries())n[1].remove(e)}copy(e,n){for(let o of this.poolMap.entries())o[1].has(e)&&Object.assign(o[1].add(n),o[1].get(e))}clean(){for(let e of this.poolMap.entries())e[1].clean()}};function K(){return Math.random()}var j=class{maskMap=new Map;archetypeMap=new Map;compManager=new q;addEntity(e=K()){return this.maskMap.has(e)||this.maskMap.set(e,0),e}copyEntity(e,n=K()){this.compManager.copy(e,n);let o=this.maskMap.get(e)??0;return this.maskMap.set(n,o),this.getArchetype(o).add(n),n}getArchetype(e){let n=this.archetypeMap.get(e)??new Set;return this.archetypeMap.set(e,n),n}deleteEntity(e){this.compManager.delete(e),this.getArchetype(this.maskMap.get(e)??0).delete(e),this.maskMap.delete(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,n){return this.compManager.has(e,n)}addComponent(e,n,o=n){this.compManager.register(n);let i=this.maskMap.get(e)??0,a=this.compManager.getMask(n);return i&a?Object.assign(this.compManager.get(e,n),o):(this.getArchetype(i).delete(e),i^=a,this.maskMap.set(e,i),this.getArchetype(i).add(e),Object.assign(this.compManager.add(e,n),o))}removeComponent(e,n){this.compManager.register(n);let o=this.maskMap.get(e)??0,i=this.compManager.getMask(n);o&i^i||(this.compManager.remove(e,n),this.getArchetype(o).delete(e),o^=i,this.maskMap.set(e,o),this.getArchetype(o).add(e))}getComponent(e,n){return this.compManager.get(e,n)}update(...e){for(let n=0,o=e.length;n<o;n++)e[n](this)}cleanObjectPools(){this.compManager.clean()}query(e){let n=0,o=0;if(e.and)for(let a=0,s=e.and.length;a<s;a++)n|=this.compManager.getMask(e.and[a]);if(e.not)for(let a=0,s=e.not.length;a<s;a++)o|=this.compManager.getMask(e.not[a]);let i=[];for(let a of this.archetypeMap.entries())a[1].size>0&&(a[0]&n)==n&&(a[0]&o)==0&&i.push(...a[1]);return i}entityCount(){return this.maskMap.size}};var l={viewport:{width:800,height:400},entities:{player:{healthPoint:10,moveSpeed:20},minion:{healthPoint:15,spawnRate:1},turrent:{healthPoint:100,abilityPower:100}}};var B={attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},b={current:0,max:0},v={callback:t=>{}},h={x:0,y:0,rad:0,scaleX:1,scaleY:1},T={x:0,y:0},Y={},z={},H={spreadRadians:0,particleEntity:-1,particleLifetimeSeconds:1,particleSpeed:1,emit:!1,particleTransition:function(t,e,n){let o=t.getComponent(e,h);o.scaleX=o.scaleY=-((2*n-1)**10)+1}},y={zoom:20,tilt:0,isActive:!1,targetEntity:-1},m={width:1,height:1,x:-.5,y:-.5},w={image:new Image},O={hovered:!1,pressed:!1,clicked:!1},E={fill:"white",stroke:"black"},X={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},k={timeMilli:0,reset:!1,stop:!1},I={targetX:0,targetY:0},r=Q(),C=et(),N=Z(),M=ot();function Q(){let t=document.querySelector("canvas")??document.createElement("canvas");if(!t)throw new Error("Cannot create canvas element.");let e=t.getContext("2d");if(!e)throw new Error("Cannot initialize context 2d.");return!document.querySelector("canvas")&&document.body.appendChild(t),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<t.width/t.height?(t.style.width="100%",t.style.height=""):(t.style.width="",t.style.height="100%")},{canvas:t,ctx:e}}function Z(){let t={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=e=>{!t.isDown[e.key]&&(t.justPressed[e.key]=!0),t.isDown[e.key]=!0},globalThis.onkeyup=e=>{t.isDown[e.key]=!1,t.justReleased[e.key]=!0},t}function tt(t){for(let e in t.justPressed)t.justPressed[e]=!1;for(let e in t.justReleased)t.justReleased[e]=!1}function et(){let t={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=e=>{e.target instanceof HTMLCanvasElement&&(t.x=e.x,t.y=e.y,Object.assign(t.pressPos,t),t.isDown=t.justPressed=!0)},globalThis.onpointerup=e=>{t.x=e.x,t.y=e.y,Object.assign(t.releasePos,t),t.isDown=!1,t.justReleased=!0},globalThis.onpointermove=e=>{t.x=e.x,t.y=e.y},t}function nt(t){t.justPressed=!1,t.justReleased=!1}function ot(){return{dtMilli:0,timeMilli:0,dtSeconds:0,timeSeconds:0}}function st(t){t.dtMilli=performance.now()-t.timeMilli,t.timeMilli+=t.dtMilli,t.dtSeconds=t.dtMilli/1e3,t.timeSeconds=t.timeMilli/1e3}function it(t){let e=t.query({and:[y,h]}).find(i=>t.getComponent(i,y).isActive);if(!e)return;let n=t.getComponent(e,y),o=t.getComponent(e,h);t.query({and:[m,h]}).forEach(i=>{let a=t.getComponent(i,m),s=t.getComponent(i,h);vt(o.x,o.y,r.canvas.width/n.zoom,r.canvas.height/n.zoom,s.x+a.x+a.width/2,s.y+a.y+a.height/2,a.width,a.height)?t.addComponent(i,z):t.removeComponent(i,z)})}function at(t){t.query({and:[H,h]}).forEach(e=>{let n=t.getComponent(e,H);if(!n.emit)return;n.emit=!1;let o=t.getComponent(e,h),i=t.copyEntity(n.particleEntity);t.addComponent(i,h,o);let a=t.addComponent(i,k),s=o.rad+n.spreadRadians*(Math.random()-.5);t.addComponent(i,T,{x:Math.cos(s)*n.particleSpeed,y:Math.sin(s)*n.particleSpeed}),t.addComponent(i,v).callback=()=>{if(a.timeMilli<n.particleLifetimeSeconds*1e3){n.particleTransition(t,i,a.timeMilli/1e3/n.particleLifetimeSeconds);return}t.deleteEntity(i)}})}function ct(t){let e=t.query({and:[y,h]}).find(a=>t.getComponent(a,y).isActive);if(e==null)return;let n=t.getComponent(e,y),o=t.getComponent(e,h),i=D(C.pressPos,r.canvas);t.query({and:[I,Y]}).forEach(a=>{if(!C.justPressed)return;let s=t.getComponent(a,I),c=Tt(i,o,n.tilt,n.zoom);s.targetX=c.x,s.targetY=c.y})}function rt(t){t.query({and:[I,h,T,B]}).forEach(e=>{let n=t.getComponent(e,I),o=t.getComponent(e,h),i=t.getComponent(e,T),a=t.getComponent(e,B),s=n.targetX-o.x,c=n.targetY-o.y,d=(s*s+c*c)**.5;if(d==0)return;let u=a.moveSpeed*M.dtSeconds*2,g=d>u?a.moveSpeed:a.moveSpeed*d/u;i.x=s/d*g,i.y=c/d*g})}function ht(t){t.query({and:[k]}).forEach(e=>{let n=t.getComponent(e,k);n.reset&&(n.timeMilli=0),n.reset=!1,n.stop||(n.timeMilli+=M.dtMilli)})}function W(t){for(let e of t.query({and:[v]}))t.getComponent(e,v).callback(e)}function dt(t){let e=r.ctx.fillStyle;t.query({and:[X,h]}).forEach(n=>{let o=t.getComponent(n,X),i=t.getComponent(n,h);r.ctx.font=`${o.fontSize}px serif`;let a=o.content.split(`
`);r.ctx.fillStyle=o.backgroundColor;for(let s=0,c=a.length;s<c;s++){let d=r.ctx.measureText(a[s]);r.ctx.fillRect(i.x,i.y+s*(2*o.padding)+s*d.fontBoundingBoxAscent,o.padding*2+d.width,o.padding*2+d.fontBoundingBoxAscent)}r.ctx.fillStyle=o.color;for(let s=0,c=a.length;s<c;s++){let d=r.ctx.measureText(a[s]);r.ctx.fillText(a[s],i.x+o.padding,i.y+s*(2*o.padding)+(s+1)*d.fontBoundingBoxAscent)}}),r.ctx.fillStyle=e}function $(t){let e=t.query({and:[h,m,E,z]});for(let n of e){let o=t.getComponent(n,h),i=t.getComponent(n,m),a=t.getComponent(n,E);r.ctx.fillStyle=a.stroke;let s=Math.cos(o.rad),c=Math.sin(o.rad);r.ctx.transform(s,c,-c,s,o.x,o.y),r.ctx.fillRect(i.x*o.scaleX-.5,i.y*o.scaleY-.5,i.width*o.scaleX+1,i.height*o.scaleY+1),r.ctx.transform(s,-c,c,s,s*-o.x+c*-o.y,-c*-o.x+s*-o.y)}for(let n of e){let o=t.getComponent(n,h),i=t.getComponent(n,m),a=t.getComponent(n,E);r.ctx.fillStyle=a.fill;let s=Math.cos(o.rad),c=Math.sin(o.rad);r.ctx.transform(s,c,-c,s,o.x,o.y),r.ctx.fillRect(i.x*o.scaleX,i.y*o.scaleY,i.width*o.scaleX,i.height*o.scaleY),r.ctx.transform(s,-c,c,s,s*-o.x+c*-o.y,-c*-o.x+s*-o.y)}}function pt(t){let e=t.query({and:[y,h]}).find(s=>t.getComponent(s,y).isActive);if(!e)return;r.ctx.resetTransform();let n=t.getComponent(e,y),o=t.getComponent(e,h);if(n.targetEntity!=-1&&t.hasComponent(n.targetEntity,h)){let s=t.getComponent(n.targetEntity,h);Object.assign(o,s)}let i=Math.sin(n.tilt)*n.zoom,a=Math.cos(n.tilt)*n.zoom;r.ctx.transform(a,i,-i,a,a*-o.x-i*-o.y+r.ctx.canvas.width*.5,i*-o.x+a*-o.y+r.ctx.canvas.height*.5)}function lt(t){t.query({and:[h,T]}).forEach(e=>{let n=t.getComponent(e,h),o=t.getComponent(e,T);n.x+=o.x*M.dtSeconds,n.y+=o.y*M.dtSeconds})}function L(t){t.query({and:[w,h]}).forEach(e=>{let n=t.getComponent(e,w),o=t.getComponent(e,h),i=n.image,a=i.width,s=i.height,c=0,d=0;if(t.hasComponent(e,m)){let R=t.getComponent(e,m);a=R.width,s=R.height,c=R.x,d=R.y}let u=a/i.width,g=s/i.height,f=Math.cos(o.rad),x=Math.sin(o.rad);r.ctx.transform(f*u,x*u,-x*g,f*g,o.x,o.y),r.ctx.drawImage(i,c,d),r.ctx.transform(f/u,-x/u,x/g,f/g,(f*-o.x+x*-o.y)/g,(-x*-o.x+f*-o.y)/g)})}function gt(t){let e=D(C.pressPos,r.canvas),n=D(C.releasePos,r.canvas),o=D({x:C.x,y:C.y},r.canvas);t.query({and:[O,h,m]}).forEach(i=>{let a=t.getComponent(i,h),s=t.getComponent(i,O),c=t.getComponent(i,m),d=(e.x-a.x)**2<(c.width/2)**2&&(e.y-a.y)**2<(c.height/2)**2;s.hovered=(o.x-a.x)**2<(c.width/2)**2&&(o.y-a.y)**2<(c.height/2)**2,s.pressed=s.hovered&&C.isDown&&d,s.clicked=C.justReleased&&d&&(n.x-a.x)**2<(c.width/2)**2&&(n.y-a.y)**2<(c.height/2)**2})}function mt(t){let i=t.query({and:[z,b,h,m]});r.ctx.fillStyle="black",r.ctx.beginPath();for(let a of i){let s=t.getComponent(a,h),c=t.getComponent(a,m),d=Math.cos(s.rad),u=Math.sin(s.rad),g=-(c.width*1.5)/2,f=-.3/2+c.y-1;r.ctx.rect(s.x-.2/2+d*g-u*f,s.y-.2/2+u*g+d*f,c.width*1.5+.2,.3+.2)}r.ctx.fill(),r.ctx.fillStyle="green",r.ctx.beginPath();for(let a of i){let s=t.getComponent(a,h),c=t.getComponent(a,m),d=t.getComponent(a,b),u=Math.cos(s.rad),g=Math.sin(s.rad),f=-(c.width*1.5)/2,x=-.3/2+c.y-1;r.ctx.rect(s.x+u*f-g*x,s.y+g*f+u*x,c.width*1.5*(d.current/d.max),.3)}r.ctx.fill()}function ut(t){let e=ft(t,-152,152),n=[-138,110,-110,138,-118,118];for(let o=0,i=n.length;o<i;o+=2)U(t,n[o],n[o+1],e),U(t,-n[o],-n[o+1],e)}function ft(t,e,n){let o=P(t);return t.addComponent(o,h,{x:e,y:n}),t.addComponent(o,b,{current:l.entities.minion.healthPoint,max:l.entities.minion.healthPoint}),o}function U(t,e,n,o){let i=t.addEntity();return t.addComponent(i,h,{x:e,y:n}),t.addComponent(i,H,{particleLifetimeSeconds:10,particleEntity:o}),t.addComponent(i,k),t.addComponent(i,v,{callback:a=>{let s=t.getComponent(a,k);s.timeMilli<1e3/l.entities.minion.spawnRate||(s.reset=!0,t.getComponent(a,H).emit=!0)}}),i}function yt(t){let e=[-10,10,-60,60,-108,108,-138,92,-138,0,-138,-110,-92,138,0,138,110,138];for(let n=0,o=e.length;n<o;n+=2)G(t,e[n],e[n+1]),G(t,-e[n],-e[n+1])}function xt(t){P(t,-128,128,10,10),P(t,128,-128,10,10)}function Ct(t,e,n=0,o=0,i=1,a=1){let s=t.addEntity();t.addComponent(s,h,{x:n,y:o});let c=new Image;return c.src=e,t.addComponent(s,w,{image:c}),t.addComponent(s,m,{width:i,height:a}),s}function P(t,e=0,n=0,o=1,i=1,a=-o/2,s=-i/2){let c=t.addEntity();return t.addComponent(c,h,{x:e,y:n}),t.addComponent(c,m,{width:o,height:i,x:a,y:s}),t.addComponent(c,E),t.addComponent(c,z),c}function Mt(t,e=0,n=0,o=10,i=10,a=s=>{let c=t.getComponent(s,O),d=t.getComponent(s,E);d.fill="grey",c.hovered&&(d.fill="lightgrey"),c.pressed&&(d.fill="red"),c.clicked&&(d.fill="green")}){let s=P(t,e,n,o,i);return t.addComponent(s,O),t.addComponent(s,E),t.addComponent(s,v,{callback:a}),t.addComponent(s,X,{content:"Button",backgroundColor:"transparent",color:"white"}),s}function kt(t,e=0,n=0){let o=P(t,e,n,1,1);return t.addComponent(o,T),t.addComponent(o,B,{...l.entities.player}),t.addComponent(o,b,{max:l.entities.player.healthPoint,current:l.entities.player.healthPoint}),t.addComponent(o,Y),t.addComponent(o,I,{targetX:e,targetY:n}),o}function G(t,e,n){let o=P(t,e,n,3,10,-1.5,-10);return t.addComponent(o,B,{...l.entities.turrent}),t.addComponent(o,b,{max:l.entities.turrent.healthPoint,current:l.entities.turrent.healthPoint}),o}function Et(t,e,n){let o=t.addEntity();return t.addComponent(o,y,{zoom:30}),t.addComponent(o,h,{x:e,y:n}),o}function bt(t="#424242"){let e=r.ctx.fillStyle;r.ctx.fillStyle=t,r.ctx.fillRect(0,0,r.canvas.width,r.canvas.height),r.ctx.fillStyle=e}function vt(t,e,n,o,i,a,s,c){return(t-i)**2<((n+s)/2)**2&&(e-a)**2<((o+c)/2)**2}function Tt(t,e,n,o){let i=Math.cos(n),a=Math.sin(n),s={x:0,y:0},c=t.x-l.viewport.width/2,d=t.y-l.viewport.height/2;return s.x=i*c+a*d,s.y=-a*c+i*d,s.x/=o,s.y/=o,s.x+=e.x,s.y+=e.y,s}function Pt(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function D(t,e){let n={x:0,y:0},o=e.getBoundingClientRect();return n.x=t.x-o.left,n.y=t.y-o.top,innerWidth/innerHeight<e.width/e.height?(n.x*=e.width/innerWidth,n.y*=e.width/innerWidth):(n.x*=e.height/innerHeight,n.y*=e.height/innerHeight),n}r.canvas.width=l.viewport.width;r.canvas.height=l.viewport.height;r.ctx.lineWidth=.1;var p=new j;kt(p,-146,146);yt(p);xt(p);ut(p);Ct(p,"./assets/Map_of_MOBA.svg",-150,-150,300,300);var St=Et(p,0,0),F=p.getComponent(St,y);F.targetEntity=p.query({and:[Y]})[0];F.isActive=!0;F.zoom=15;var _=p.addEntity();p.addComponent(_,k);p.addComponent(_,v,{callback:t=>{let e=p.getComponent(t,k);e.timeMilli<1e3*60*5||(e.reset=!0,p.cleanObjectPools())}});var S=new j;Mt(S,l.viewport.width*.9,l.viewport.height*.8,l.viewport.height*.3,l.viewport.height*.3);var V=S.addEntity(),jt=S.addComponent(V,X,{content:"test string",backgroundColor:"white"});S.addComponent(V,h);(function t(){requestAnimationFrame(t);let e=p.query({and:[Y]})[0];p.getComponent(e,b).current*=.99**M.timeSeconds;let n=p.getComponent(e,h);jt.content=`FPS: ${Math.ceil(1e3/M.dtMilli)}
Entity count: ${p.entityCount()}
Device type: ${Pt()}
Pos: (${Math.floor(n.x)}, ${Math.floor(n.y)})`,bt(),p.update(pt,it,L,$,mt),r.ctx.resetTransform(),S.update(L,$,dt),S.update(gt,W),p.update(at,rt,ct,ht,W,lt),nt(C),tt(N),st(M)})();})();
//# sourceMappingURL=out.js.map
