(()=>{var A=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(t){this.objectFactory=t}size(){return this.keyToIndex.size}add(t){return this.keyToIndex.has(t)||(this.storage.length<=this.keyToIndex.size&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.keyToIndex.size),this.indexToKey[this.keyToIndex.size-1]=t),this.storage[this.keyToIndex.get(t)]}remove(t){let n=this.keyToIndex.get(t);if(n==null)return;let o=this.storage[n];this.storage[n]=this.storage[this.keyToIndex.size-1],this.storage[this.keyToIndex.size-1]=o;let s=this.indexToKey[this.keyToIndex.size-1];this.indexToKey[n]=s,this.indexToKey.pop(),this.keyToIndex.set(s,n),this.keyToIndex.delete(t)}get(t){let n=this.keyToIndex.get(t);if(n==null)throw new Error("Key not found.");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.keyToIndex.size)}};var Y=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new A(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,n){return Object.assign(this.pools.get(n).add(t),n)}remove(t,n){this.pools.get(n).remove(t)}has(t,n){return this.pools.has(n)&&this.pools.get(n).has(t)}get(t,n){return this.pools.get(n).get(t)}size(t){return this.pools.get(t).size()}delete(t){for(let n of this.pools)n[1].remove(t)}copy(t,n){for(let o of this.pools)o[1].has(t)&&Object.assign(o[1].add(n),o[1].get(t))}clean(){for(let t of this.pools)t[1].clean()}};function F(){return Math.random()}var S=class{maskMap=new Map;archetypeMap=new Map;compManager=new Y;addEntity(t=F()){return this.maskMap.has(t)||(this.maskMap.set(t,0),this.getArchetype(0).add(t)),t}copyEntity(t,n=F()){this.compManager.copy(t,n);let o=this.maskMap.get(t)??0;return this.maskMap.set(n,o),this.getArchetype(o).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return this.compManager.has(t,n)}addComponent(t,n,o=n){this.registerComponent(n);let s=this.maskMap.get(t)??0,i=this.compManager.getId(n);return s&1<<i?Object.assign(this.compManager.get(t,n),o):(this.getArchetype(s).delete(t),s^=1<<i,this.maskMap.set(t,s),this.getArchetype(s).add(t),Object.assign(this.compManager.add(t,n),o))}removeComponent(t,n){this.registerComponent(n);let o=this.maskMap.get(t)??0,s=this.compManager.getId(n);(o&1<<s)!=0&&(this.compManager.remove(t,n),this.getArchetype(o).delete(t),o^=1<<s,this.maskMap.set(t,o),this.getArchetype(o).add(t))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this)}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,o=0;if(t.and)for(let i=0,a=t.and.length;i<a;i++)n|=1<<this.compManager.getId(t.and[i]);if(t.not)for(let i=0,a=t.not.length;i<a;i++)o|=1<<this.compManager.getId(t.not[i]);let s=[];for(let i of this.archetypeMap)i[1].size>0&&(i[0]&n)==n&&(i[0]&o)==0&&s.push(...i[1]);return s}entityCount(){return this.maskMap.size}};var g={viewport:{width:800,height:400},entities:{player:{healthPoint:10,moveSpeed:20},minion:{healthPoint:15,spawnRate:2},turrent:{healthPoint:100,abilityPower:100}}};var D=function(e){return e[e.Root=0]="Root",e[e.NE=1]="NE",e[e.NW=2]="NW",e[e.SE=3]="SE",e[e.SW=4]="SW",e}(D||{}),q=class{storage={};changed=[];bounds={};maxDepth=10;constructor(t,n=10){this.bounds[D.Root]=t,this.maxDepth=n,this.storage[D.Root]=new Set}index(t,n=D.Root.toString()){if(n.length>=this.maxDepth)return n;let o=this.bounds[n];for(let s=0;s<4;s++)if(this.bounds[n+s.toString()]??={cx:o.cx+o.width/4*(s%2==0?1:-1),cy:o.cy+o.height/4*(s<1?1:-1),width:o.width/2,height:o.height/2},this.contain(this.bounds[n+s.toString()],t))return this.index(t,n+s.toString());return n}insert(t){let n=this.index(t);this.storage[n]??=new Set,this.storage[n].add(t)}queryRange(t){return[...this.storage[this.index(t)]]}update(){for(let t in this.storage)for(let n of this.storage[t].values())this.contain(this.bounds[t],n)||this.changed.push(n);for(;this.changed.length;){let t=this.changed.pop();t&&this.insert(t)}}contain(t,n){return(t.cx-n.cx)**2<((t.width-n.width)/2)**2&&(t.cy-n.cy)**2<((t.height-n.height)/2)**2}intersect(t,n){return(t.cx-n.cx)**2<((t.width+n.width)/2)**2&&(t.cy-n.cy)**2<((t.height+n.height)/2)**2}};var B={attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},P={current:0,max:0},k={callback:new Function},h={x:0,y:0,rad:0,scaleX:1,scaleY:1},v={x:0,y:0},_={};var b={},T={spreadRadians:0,particleEntity:-1,particleLifetimeSeconds:1,speed:1,emit:!1,particleTransition:function(e,t,n){let o=e.getComponent(t,h);o.scaleX=o.scaleY=-((2*n-1)**10)+1}},x={zoom:20,tilt:0,isActive:!1,targetEntity:-1},y={width:1,height:1,offsetX:.5,offsetY:.5},K={src:""},O={hovered:!1,pressed:!1,clicked:!1},j={fill:"white",stroke:"black"},W={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},M={timeMilli:0,reset:!1,stop:!1},I={targetX:0,targetY:0},r=tt(),C=ot(),Q=et(),R=it(),H=!0;function tt(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return!document.querySelector("canvas")&&document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function et(){let e={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!e.isDown[t.key]&&(e.justPressed[t.key]=!0),e.isDown[t.key]=!0},globalThis.onkeyup=t=>{e.isDown[t.key]=!1,e.justReleased[t.key]=!0},e}function nt(e){for(let t in e.justPressed)e.justPressed[t]=!1;for(let t in e.justReleased)e.justReleased[t]=!1}function ot(){let e={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.x=t.x,e.y=t.y,Object.assign(e.pressPos,e),e.isDown=e.justPressed=!0)},globalThis.onpointerup=t=>{e.x=t.x,e.y=t.y,Object.assign(e.releasePos,e),e.isDown=!1,e.justReleased=!0},globalThis.onpointermove=t=>{e.x=t.x,e.y=t.y},e}function st(e){e.justPressed=!1,e.justReleased=!1}function it(){return{dtMilli:0,timeMilli:0}}function at(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function ct(e){let t=e.query({and:[x,h]}).find(s=>e.getComponent(s,x).isActive);if(!t)return;let n=e.getComponent(t,x),o=e.getComponent(t,h);e.query({and:[y,h]}).forEach(s=>{let i=e.getComponent(s,y),a=e.getComponent(s,h);Et(o.x,o.y,r.canvas.width/n.zoom,r.canvas.height/n.zoom,a.x+i.offsetX+i.width/2,a.y+i.offsetY+i.height/2,i.width,i.height)?e.addComponent(s,b):e.removeComponent(s,b)})}function rt(e){e.query({and:[b,T,h]}).forEach(t=>{let n=e.getComponent(t,T);if(!n.emit||!e.hasComponent(n.particleEntity,h))return;n.emit=!1;let o=e.getComponent(t,h),s=e.copyEntity(n.particleEntity),i=e.getComponent(s,h);Object.assign(i,o);let a=e.addComponent(s,M);i.rad=o.rad+n.spreadRadians*(Math.random()-.5),e.addComponent(s,v,{x:Math.cos(i.rad)*n.speed,y:Math.sin(i.rad)*n.speed}),e.addComponent(s,k).callback=()=>{if(a.timeMilli<n.particleLifetimeSeconds*1e3){n.particleTransition(e,s,a.timeMilli/1e3/n.particleLifetimeSeconds);return}e.deleteEntity(s)}})}function ht(e){let t=e.query({and:[x,h]}).find(i=>e.getComponent(i,x).isActive);if(t==null)return;let n=e.getComponent(t,x),o=e.getComponent(t,h),s=X(C.pressPos,r.canvas);e.query({and:[I,_]}).forEach(i=>{if(!C.justPressed||!H)return;let a=e.getComponent(i,I),c=vt(s,o,n.tilt,n.zoom);a.targetX=c.x,a.targetY=c.y})}function dt(e){e.query({and:[I,h,v,B]}).forEach(t=>{let n=e.getComponent(t,I),o=e.getComponent(t,h),s=e.getComponent(t,v),i=e.getComponent(t,B),a=n.targetX-o.x,c=n.targetY-o.y,d=(a*a+c*c)**.5;if(d==0)return;let l=i.moveSpeed*R.dtMilli/1e3*2,f=d>l?i.moveSpeed:i.moveSpeed*d/l;s.x=a/d*f,s.y=c/d*f})}function pt(e){e.query({and:[M,k]}).forEach(t=>e.getComponent(t,k).callback(t)),e.query({and:[M]}).forEach(t=>{let n=e.getComponent(t,M);n.reset&&(n.timeMilli=0),n.reset=!1,n.stop||(n.timeMilli+=R.dtMilli)})}function lt(e){let t=r.ctx.fillStyle;e.query({and:[W,h]}).forEach(n=>{let o=e.getComponent(n,W),s=e.getComponent(n,h);r.ctx.font=`${o.fontSize}px serif`;let i=o.content.split(`
`);r.ctx.fillStyle=o.backgroundColor;for(let a=0,c=i.length;a<c;a++){let d=r.ctx.measureText(i[a]);r.ctx.fillRect(s.x,s.y+a*(2*o.padding)+a*d.fontBoundingBoxAscent,o.padding*2+d.width,o.padding*2+d.fontBoundingBoxAscent)}r.ctx.fillStyle=o.color;for(let a=0,c=i.length;a<c;a++){let d=r.ctx.measureText(i[a]);r.ctx.fillText(i[a],s.x+o.padding,s.y+a*(2*o.padding)+(a+1)*d.fontBoundingBoxAscent)}}),r.ctx.fillStyle=t}function N(e){let t=r.ctx.fillStyle,n=r.ctx.strokeStyle;e.query({and:[h,y,j,b]}).forEach(o=>{let s=e.getComponent(o,h),i=e.getComponent(o,y),a=e.getComponent(o,j);r.ctx.fillStyle=a.fill,r.ctx.strokeStyle=a.stroke;let c=Math.cos(s.rad),d=Math.sin(s.rad);r.ctx.transform(c,d,-d,c,s.x,s.y),r.ctx.fillRect(i.offsetX*s.scaleX,i.offsetY*s.scaleY,i.width*s.scaleX,i.height*s.scaleY),r.ctx.strokeRect(i.offsetX*s.scaleX,i.offsetY*s.scaleY,i.width*s.scaleX,i.height*s.scaleY),r.ctx.transform(c,-d,d,c,c*-s.x+d*-s.y,-d*-s.x+c*-s.y)}),r.ctx.fillStyle=t,r.ctx.strokeStyle=n}function gt(e){let t=e.query({and:[x,h]}).find(a=>e.getComponent(a,x).isActive);if(!t)return;r.ctx.resetTransform();let n=e.getComponent(t,x),o=e.getComponent(t,h);if(n.targetEntity!=-1&&e.hasComponent(n.targetEntity,h)){let a=e.getComponent(n.targetEntity,h);Object.assign(o,a)}let s=Math.sin(n.tilt)*n.zoom,i=Math.cos(n.tilt)*n.zoom;r.ctx.transform(i,s,-s,i,i*-o.x-s*-o.y+r.ctx.canvas.width*.5,s*-o.x+i*-o.y+r.ctx.canvas.height*.5)}function ft(e){let t=R.dtMilli/1e3;e.query({and:[h,v]}).forEach(n=>{let o=e.getComponent(n,h),s=e.getComponent(n,v);o.x+=s.x*t,o.y+=s.y*t})}function G(e){e.query({and:[K,h]}).forEach(t=>{let n=e.getComponent(t,K),o=e.getComponent(t,h),s=new Image;s.src=n.src;let i=s.width,a=s.height,c=0,d=0;if(e.hasComponent(t,y)){let z=e.getComponent(t,y);i=z.width,a=z.height,c=z.offsetX,d=z.offsetY}let l=i/s.width,f=a/s.height,m=Math.cos(o.rad),u=Math.sin(o.rad);r.ctx.transform(m*l,u*l,-u*f,m*f,o.x,o.y),r.ctx.drawImage(s,c,d),r.ctx.transform(m/l,-u/l,u/f,m/f,m*-o.x/l+u*-o.y/f,-u*-o.x/l+m*-o.y/f)})}function mt(e){let t=X(C.pressPos,r.canvas),n=X(C.releasePos,r.canvas),o=X({x:C.x,y:C.y},r.canvas);e.query({and:[O,h,y,k]}).forEach(s=>{let i=e.getComponent(s,h),a=e.getComponent(s,O),c=e.getComponent(s,y),d=e.getComponent(s,k),l=(t.x-i.x)**2<(c.width/2)**2&&(t.y-i.y)**2<(c.height/2)**2;a.hovered=(o.x-i.x)**2<(c.width/2)**2&&(o.y-i.y)**2<(c.height/2)**2,a.pressed=a.hovered&&C.isDown&&l,a.clicked=C.justReleased&&l&&(n.x-i.x)**2<(c.width/2)**2&&(n.y-i.y)**2<(c.height/2)**2,d.callback(s)})}function ut(e){let t=r.ctx.fillStyle,n=1.5,o=.3,s=.2;e.query({and:[b,P,h,y]}).forEach(i=>{let a=e.getComponent(i,h),c=e.getComponent(i,y),d=e.getComponent(i,P),l=Math.cos(a.rad),f=Math.sin(a.rad),m=-(c.width*n)/2,u=-o/2+c.offsetY-1;r.ctx.fillStyle="black",r.ctx.fillRect(a.x-s/2+l*m-f*u,a.y-s/2+f*m+l*u,c.width*n+s,o+s),m=-c.width*n/2,u=-o/2+c.offsetY-1,r.ctx.fillStyle="green",r.ctx.fillRect(a.x+l*m-f*u,a.y+f*m+l*u,c.width*n*(d.current/d.max),o)}),r.ctx.fillStyle=t}function yt(e,t,n=0,o=0,s=1,i=1){let a=e.addEntity();return e.addComponent(a,h,{x:n,y:o}),e.addComponent(a,K,{src:t}),e.addComponent(a,y,{width:s,height:i}),a}function $(e,t=0,n=0,o=1,s=1,i=-o/2,a=-s/2){let c=e.addEntity();return e.addComponent(c,h,{x:t,y:n}),e.addComponent(c,y,{width:o,height:s,offsetX:i,offsetY:a}),e.addComponent(c,j),e.addComponent(c,b),c}function xt(e,t=0,n=0,o=10,s=10,i=a=>{let c=E.getComponent(a,O),d=E.getComponent(a,j);d.fill="grey",c.hovered&&(H=!1,d.fill="lightgrey"),c.pressed&&(d.fill="red"),c.clicked&&(d.fill="green")}){let a=$(e,t,n,o,s);return e.addComponent(a,O),e.addComponent(a,j),e.addComponent(a,k,{callback:i}),e.addComponent(a,W,{content:"Button",backgroundColor:"transparent",color:"white"}),a}function Ct(e,t=0,n=0){let o=$(e,t,n,1,1);return e.addComponent(o,v),e.addComponent(o,B,{...g.entities.player}),e.addComponent(o,P,{max:g.entities.player.healthPoint,current:g.entities.player.healthPoint}),e.addComponent(o,_),e.addComponent(o,I,{targetX:t,targetY:n}),o}function Mt(e,t,n){let o=$(e,t,n,3,10,-1.5,-10);return e.addComponent(o,B,{...g.entities.turrent}),e.addComponent(o,P,{max:g.entities.turrent.healthPoint,current:g.entities.turrent.healthPoint}),o}function kt(e,t,n){let o=e.addEntity();return e.addComponent(o,x,{zoom:30}),e.addComponent(o,h,{x:t,y:n}),o}function Et(e,t,n,o,s,i,a,c){return(e-s)**2<((n+a)/2)**2&&(t-i)**2<((o+c)/2)**2}function vt(e,t,n,o){let s=Math.cos(n),i=Math.sin(n),a={x:0,y:0},c=e.x-g.viewport.width/2,d=e.y-g.viewport.height/2;return a.x=s*c+i*d,a.y=-i*c+s*d,a.x/=o,a.y/=o,a.x+=t.x,a.y+=t.y,a}function bt(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function X(e,t){let n={x:0,y:0},o=t.getBoundingClientRect();return n.x=e.x-o.left,n.y=e.y-o.top,innerWidth/innerHeight<t.width/t.height?(n.x*=t.width/innerWidth,n.y*=t.width/innerWidth):(n.x*=t.height/innerHeight,n.y*=t.height/innerHeight),n}r.canvas.width=g.viewport.width;r.canvas.height=g.viewport.height;r.canvas.style.imageRendering="pixelated";r.ctx.lineWidth=.1;var p=new S,w=Mt(p,10,0);p.addComponent(w,T,{particleEntity:w,speed:20,spreadRadians:Math.PI*.25});p.addComponent(w,M);p.addComponent(w,k).callback=e=>{let t=p.hasComponent(e,M)&&p.getComponent(e,M);t&&(t.timeMilli<50||(t.reset=!0,p.hasComponent(e,T)&&(p.getComponent(e,T).emit=!0)))};for(let e=0;e<2;e++){let t=p.copyEntity(w);p.getComponent(t,h).y+=15*(e+1),p.getComponent(t,T).particleEntity=t}var U=Ct(p,0,0);p.getComponent(U,P).current*=.6;var Ft=yt(p,"./assets/Map_of_MOBA.svg",-150,-150,300,300),Tt=kt(p,0,0),L=p.getComponent(Tt,x);L.targetEntity=U;L.isActive=!0;L.zoom=15;var V=p.addEntity();p.addComponent(V,M);p.addComponent(V,k,{callback:e=>{let t=p.getComponent(e,M);t.timeMilli<5e3||(t.reset=!0,p.cleanObjectPools())}});var Kt=new q({cx:0,cy:0,width:1e10,height:1e10}),E=new S;xt(E,g.viewport.width*.9,g.viewport.height*.8,g.viewport.height*.3,g.viewport.height*.3);var J=E.addEntity(),St=E.addComponent(J,W,{content:"test string",backgroundColor:"white"});E.addComponent(J,h);(function e(){requestAnimationFrame(e);let t=p.getComponent(U,h);St.content=`FPS: ${Math.ceil(1e3/R.dtMilli)}
Entity count: ${p.entityCount()}
Device type: ${bt()}
Pos: (${Math.floor(t.x)}, ${Math.floor(t.y)})`,p.update(gt,ct,G,N,ut),r.ctx.resetTransform(),E.update(G,N,lt),E.update(mt),p.update(rt,dt,ht,pt,ft),st(C),nt(Q),at(R),H=!0})();})();
//# sourceMappingURL=out.js.map
