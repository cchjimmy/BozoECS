(()=>{var C=class{reserve;active;objectConstructor;constructor(t){this.reserve=[],this.active=[],this.objectConstructor=t}addObj(){return this.active.push(this.reserve.pop()??this.objectConstructor()),this.active[this.active.length-1]}findIndex(t){return this.active.findIndex(n=>n==t)}removeObj(t){let n=this.active[t];return this.active[t]=this.active[this.active.length-1],this.active.length--,this.reserve.push(n),n}getObj(t){return this.active[t]}len(){return this.active.length}};var h=class{static id=-1;owner=-1},M=class{pools=[];register(t){t.id==-1&&(t.id=this.pools.length),this.pools[t.id]??=new C(()=>new t)}isRegistered(t){return!!this.pools[t.id]}add(t){return this.pools[t.id].addObj()}delete(t,n){return this.pools[t.id].removeObj(n)}get(t,n){return this.pools[t.id].getObj(n)}len(t){return this.pools[t.id].len()}};var S=class{nextId=0;pool=new C(()=>this.nextId++);add(){return this.pool.addObj()}findIndex(t){return this.pool.findIndex(t)}delete(t){return this.pool.removeObj(t)}};var p=class e{static indices=[];static components=new M;static entities=new S;static entityMasks=[];static archetypes={0:new Set};static worlds=[];time=0;dt=0;localEntities=new Set;constructor(){e.worlds.push(this)}static createEntity(){let t=e.entities.add();return e.indices[t]=[],e.entityMasks[t]=0,e.archetypes[e.entityMasks[t]].add(t),t}static deleteEntity(t){for(let n of e.worlds)n.removeEntity(t);for(let n=0,o=e.components.pools.length;n<o;n++){if(!(e.entityMasks[t]&1<<n))continue;let s=e.components.pools[n].removeObj(e.indices[t][n]).constructor.prototype;e.indices[e.components.get(s,t).owner][n]=e.indices[t][n]}e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]=0,e.entities.delete(e.entities.findIndex(t))}addEntity(t){return t??=e.createEntity(),this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){if(!this.localEntities.has(t))throw new Error(`Entity ${t} does not exist.`)}static componentExists(t){e.components.isRegistered(t)||e.components.register(t)}static registerComponent(t){return e.components.register(t),e}static hasComponent(t,n){return(e.entityMasks[t]&1<<n.id)>0}static addComponent(t,n){if(e.componentExists(n),e.hasComponent(t,n))throw new Error(`Entity ${t} already had this component.`);e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]|=1<<n.id,e.archetypes[e.entityMasks[t]]??=new Set,e.archetypes[e.entityMasks[t]].add(t),e.indices[t][n.id]=e.components.len(n);let o=e.components.add(n);return o.owner=t,o}static removeComponent(t,n){if(e.componentExists(n),!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have component ${n.name}.`);e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]&=~(1<<n.id),e.archetypes[e.entityMasks[t]]??=new Set,e.archetypes[e.entityMasks[t]].add(t);let o=e.components.delete(n,e.indices[t][n.id]),s=e.components.get(n,e.indices[t][n.id]).owner;return e.indices[s][n.id]=e.indices[t][n.id],o}getComponent(t,n){if(this.entityExists(t),e.componentExists(n),!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have component ${n.name}.`);return e.components.get(n,e.indices[t][n.id])}update(...t){for(let n of t)n(this,this.dt/1e3);this.dt=performance.now()-this.time,this.time+=this.dt}query(t){let n=0,o=0,s=0;if(t.and)for(let r=0,c=t.and.length;r<c;r++)n|=1<<t.and[r].id;if(t.or)for(let r=0,c=t.or.length;r<c;r++)o|=1<<t.or[r].id;if(t.not)for(let r=0,c=t.not.length;r<c;r++)s|=1<<t.not[r].id;let i=[];for(let r in e.archetypes){let c=parseInt(r);(c&n)==n&&(c|o)>0&&(c&s)==0&&i.push(...this.localEntities.intersection(e.archetypes[r]))}return i}};var m={viewport:{width:300,height:150},player:{speed:20}};var l=class extends h{x=0;y=0},x=class extends h{x=0;y=0},I=class extends h{},v=class extends h{zoom=1;tilt=0;isActive=!1},f=class extends h{width=2;height=2},k=class extends h{src=""},w=class extends h{hovered=!1;pressed=!1;clicked=!1;callback=()=>{}},b=class extends h{fill="white";stroke="black"},W=class extends h{content="";fontSize=20;padding=3;color="black";backgroundColor="white"},E=class extends h{durationMilli=1e3;startMilli=0;callback=()=>{}};function A(e){e.query({and:[E]}).forEach(t=>{let n=e.getComponent(t,E);e.time-n.startMilli<n.durationMilli||(n.startMilli=e.time,n.callback(t))})}function $(e){a&&e.query({and:[W,l]}).forEach(t=>{let n=e.getComponent(t,W),o=e.getComponent(t,l);a.font=`${n.fontSize}px serif`;let s=a.measureText(n.content),i=a.fillStyle;a.fillStyle=n.backgroundColor,a.fillRect(o.x,o.y,n.padding*2+s.width,n.padding*2+s.fontBoundingBoxAscent),a.fillStyle=n.color,a.fillText(n.content,o.x+n.padding,o.y+n.padding+s.fontBoundingBoxAscent),a.fillStyle=i})}function z(e,t,n,o){let s=e.fillStyle,i=e.strokeStyle;e.fillStyle=o.fill,e.strokeStyle=o.stroke;let r=new Path2D(`M ${t.x-n.width*.5} ${t.y-n.height*.5} h ${n.width} v ${n.height} h ${-n.width} Z`);e.fill(r),e.stroke(r),e.fillStyle=s,e.strokeStyle=i}function j(e){e.query({and:[l,f,b]}).forEach(t=>{if(!a)return;let n=e.getComponent(t,l),o=e.getComponent(t,f),s=e.getComponent(t,b);z(a,n,o,s)})}function B(){if(!a)return;let e=a.fillStyle;a.fillStyle="#424242",a.fillRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle=e}function D(e){e.query({and:[I,x,v]}).forEach(t=>{let n=e.getComponent(t,x);n.x=0,n.y=0,(g.w||g.ArrowUp)&&n.y--,(g.a||g.ArrowLeft)&&n.x--,(g.s||g.ArrowDown)&&n.y++,(g.d||g.ArrowRight)&&n.x++;let o=(n.x**2+n.y**2)**.5;if(o==0)return;let s=e.getComponent(t,v),i=Math.cos(s.tilt),r=Math.sin(s.tilt),c=n.x=n.x/o*m.player.speed,u=n.y=n.y/o*m.player.speed;n.x=i*c-r*u,n.y=r*c+i*u})}function q(e){e.query({and:[v,l]}).forEach(t=>{let n=e.getComponent(t,v);if(!a||!n.isActive)return;let o=e.getComponent(t,l),s=Math.sin(n.tilt),i=Math.cos(n.tilt),r=-o.x*n.zoom,c=-o.y*n.zoom;a.setTransform(i*n.zoom,-s*n.zoom,s*n.zoom,i*n.zoom,r*i+c*-s+a.canvas.width*.5,r*s+c*i+a.canvas.height*.5)})}function H(e,t){e.query({and:[l,x]}).forEach(n=>{let o=e.getComponent(n,l),s=e.getComponent(n,x);o.x+=s.x*t,o.y+=s.y*t})}function R(e){a&&e.query({and:[k,l],or:[f]}).forEach(t=>{let n=e.getComponent(t,k),o=e.getComponent(t,l),s=p.hasComponent(t,f)&&e.getComponent(t,f),i=new Image;i.src=n.src;let r=s?s.width:i.width,c=s?s.height:i.height,u=r/i.width,T=c/i.height;a.transform(u,0,0,T,0,0),a.drawImage(i,(o.x-r/2)/u,(o.y-c/2)/T),a.transform(1/u,0,0,1/T,0,0)})}function U(e){e.query({and:[w,l,f]}).forEach(t=>{let n=e.getComponent(t,l),o=e.getComponent(t,w),s=e.getComponent(t,f),i=(d.pressPos.x-n.x)**2<(s.width/2)**2&&(d.pressPos.y-n.y)**2<(s.height/2)**2;o.hovered=(d.x-n.x)**2<(s.width/2)**2&&(d.y-n.y)**2<(s.height/2)**2,o.pressed=o.hovered&&d.isDown&&i,o.clicked=d.justReleased&&i&&(d.releasePos.x-n.x)**2<(s.width/2)**2&&(d.releasePos.y-n.y)**2<(s.height/2)**2,o.callback(t)})}function F(){a&&a.setTransform(1,0,0,1,0,0)}function P(e,t,n=0,o=0,s=1,i=1){let r=e.addEntity(),c=p.addComponent(r,l),u=p.addComponent(r,k),T=p.addComponent(r,f);return c.x=n,c.y=o,u.src=t,T.width=s,T.height=i,r}function X(e,t=0,n=0){let o=e.addEntity(),s=p.addComponent(o,l);p.addComponent(o,x),p.addComponent(o,f);let i=p.addComponent(o,b);return i.fill="green",s.x=t,s.y=n,o}function Y(e,t=0,n=0,o=10,s=10,i=()=>{}){let r=e.addEntity(),c=p.addComponent(r,l),u=p.addComponent(r,f),T=p.addComponent(r,w);return p.addComponent(r,b),c.x=t,c.y=n,u.width=o,u.height=s,T.callback=i,r}function G(e,t,n=()=>{}){let o=e.addEntity(),s=p.addComponent(o,E);return s.durationMilli=t,s.callback=n,o}var y=document.querySelector("canvas"),a=y?.getContext("2d"),g={},d={x:-1,y:-1,isDown:!1,pressPos:{x:-1,y:-1},justReleased:!1,releasePos:{x:0,y:0}};if(y&&a){y.width=m.viewport.width,y.height=m.viewport.height,y.style.imageRendering="pixelated",a.lineWidth=.1,document.onkeydown=i=>{g[i.key]=!0},document.onkeyup=i=>{delete g[i.key]},document.onpointermove=i=>{let r=y.getBoundingClientRect();d.x=i.x-r.left,d.y=i.y-r.top,innerWidth/innerHeight<y.width/y.height?(d.x*=y.width/innerWidth,d.y*=y.width/innerWidth):(d.x*=y.height/innerHeight,d.y*=y.height/innerHeight)},document.onpointerdown=()=>{d.isDown=!0,d.pressPos.x=d.x,d.pressPos.y=d.y},document.onpointerup=()=>{d.isDown=!1,d.justReleased=!0,d.releasePos.x=d.x,d.releasePos.y=d.y},document.body.append(y);let e=new p,t=X(e,0,0),n=e.getComponent(t,f);n.width=1,n.height=1;let o=p.addComponent(t,v);o.zoom=10,o.isActive=!0,p.addComponent(t,I),P(e,"./assets/Map_of_MOBA.svg",0,0,300,300),G(e,1e3,()=>console.log("TimerUp"));let s=new p;Y(s,m.viewport.width*.9,m.viewport.height*.8,m.viewport.height*.3,m.viewport.height*.3,i=>{s.getComponent(i,w).clicked&&console.log("clicked")}),P(s,"./assets/Map_of_MOBA.svg",m.viewport.width*.1,m.viewport.height*.2,m.viewport.height*.3,m.viewport.height*.3),function i(){e.update(B,q,R,j,F,D,A,H),s.update(R,j,$,U),d.justReleased=!1,requestAnimationFrame(i)}()}})();
