(()=>{var w=class{storage=[];objectConstructor;size=0;constructor(t){this.objectConstructor=t}len(){return this.size}addObj(){let t;return this.storage[this.size]?t=this.storage[this.size]:(t=this.objectConstructor(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(n=>n==t)}removeObj(t){if(t>=this.size)throw new Error("Index out of range.");let n=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=n,this.size--,n}getObj(t){if(t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var g=class e{static pools=new Map;static idMap=new Map;static register(t){e.idMap.set(t,e.idMap.size),e.pools.set(t,new w(()=>Object.assign({},t)))}static getId(t){return e.idMap.get(t)??-1}static add(t){return e.pools.get(t).addObj()}static delete(t,n){return e.pools.get(t).removeObj(n)}static get(t,n){return e.pools.get(t).getObj(n)}static len(t){return e.pools.get(t).len()}static typeLen(){return e.pools.size}static types(){return e.pools.keys().toArray()}};var b=class e{static nextId=0;static pool=new w(()=>e.nextId++);static add(){return e.pool.addObj()}static findIndex(t){return e.pool.findIndex(t)}static delete(t){return e.pool.removeObj(t)}};var a=class e{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static removeMap=new Map;static ownerMap=new Map;timeMilli=0;dtMilli=0;localEntities=new Set;constructor(){e.worlds.push(this)}static createEntity(){let t=b.add();return e.maskMap.set(t,0),e.getArchetype(0).add(t),t}static getArchetype(t){let n=e.archetypeMap.get(t);if(n==null){let o=new Set;return e.archetypeMap.set(t,o),o}return n}static deleteEntity(t){for(let o=0,s=e.worlds.length;o<s;o++)e.worlds[o].removeEntity(t);let n=g.types();for(let o=0,s=g.typeLen();o<s;o++){if(!(e.getMask(t)&1<<o))continue;e.getRemoveFn(o)(t);let i=e.getIndices(n[o]),r=e.getOwners(n[o]),c=e.getOwner(r,r.size-1),d=e.getIndex(i,t);r.set(d,c),i.set(c,d)}e.getArchetype(e.getMask(t)).delete(t),e.maskMap.set(t,0),b.delete(b.findIndex(t))}static getRemoveFn(t){let n=e.removeMap.get(t);if(n==null)throw new Error("Component not registered.");return n}addEntity(t){return t??=e.createEntity(),this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static componentExists(t){e.indexMap.has(t)||e.registerComponent(t)}static registerComponent(t){return g.register(t),e.indexMap.set(t,new Map),e.removeMap.set(g.getId(t),n=>g.delete(t,e.getIndex(e.getIndices(t),n))),e.ownerMap.set(t,new Map),e}static hasComponent(t,n){return(e.getMask(t)&1<<g.getId(n))>0}static addComponent(t,n){e.componentExists(n);let o=e.getMask(t),s=g.getId(n);if((o&1<<s)!=0)throw new Error(`Entity ${t} already had that component.`);e.getArchetype(o).delete(t),o|=1<<s,e.maskMap.set(t,o),e.getArchetype(o).add(t);let i=g.len(n);return e.getIndices(n).set(t,i),e.getOwners(n).set(i,t),g.add(n)}static getIndices(t){let n=e.indexMap.get(t);if(n==null)throw new Error("Component not registered.");return n}static getIndex(t,n){let o=t.get(n);if(o==null)throw new Error(`Entity ${n} does not exist.`);return o}static getOwners(t){let n=e.ownerMap.get(t);if(n==null)throw new Error("Component not registered.");return n}static getOwner(t,n){let o=t.get(n);if(o==null)throw new Error("Owner not found.");return o}static removeComponent(t,n){e.componentExists(n);let o=e.getMask(t),s=g.getId(n);if((o&1<<s)==0)throw new Error(`Entity ${t} does not have that component.`);e.getArchetype(o).delete(t),o&=~(1<<s),e.maskMap.set(t,o),e.getArchetype(o).add(t);let i=e.getIndices(n),r=e.getOwners(n),c=e.getIndex(i,t),d=g.delete(n,c),h=e.getOwner(r,r.size-1);return r.set(c,h),i.set(h,c),d}static getMask(t){return e.maskMap.get(t)??-1}static getComponent(t,n){if(!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have that component.`);return g.get(n,e.getIndex(e.getIndices(n),t))}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let n=0,o=0,s=0;if(t.and)for(let r=0,c=t.and.length;r<c;r++)n|=1<<g.getId(t.and[r]);if(t.or)for(let r=0,c=t.or.length;r<c;r++)o|=1<<g.getId(t.or[r]);if(t.not)for(let r=0,c=t.not.length;r<c;r++)s|=1<<g.getId(t.not[r]);let i=[];for(let r=e.archetypeMap.keys().toArray(),c=r.length,d=0,h=r[d];d<c;d++,h=r[d])(h&n)==n&&(h|o)>0&&(h&s)==0&&i.push(...this.localEntities.intersection(e.getArchetype(h)));return i}entityCount(){return this.localEntities.size}};var m={viewport:{width:800,height:400},player:{speed:20}};var u={x:0,y:0},x={x:0,y:0},S={},T={zoom:1,tilt:0,isActive:!1},y={width:2,height:2},C={src:""},M={hovered:!1,pressed:!1,clicked:!1,callback:e=>{}},v={fill:"white",stroke:"black"};function W(e,t,n,o){let s=e.fillStyle,i=e.strokeStyle;e.fillStyle=o.fill,e.strokeStyle=o.stroke;let r=new Path2D(`M ${t.x-n.width*.5} ${t.y-n.height*.5} h ${n.width} v ${n.height} h ${-n.width} Z`);e.fill(r),e.stroke(r),e.fillStyle=s,e.strokeStyle=i}function E(e){p&&e.query({and:[u,y,v]}).forEach(t=>{let n=a.getComponent(t,u),o=a.getComponent(t,y),s=a.getComponent(t,v);W(p,n,o,s)})}function A(){if(!p)return;let e=p.fillStyle;p.fillStyle="#424242",p.fillRect(0,0,p.canvas.width,p.canvas.height),p.fillStyle=e}function R(e){let t;e.query({and:[T,u]}).forEach(n=>{a.getComponent(n,T).isActive&&(t=a.getComponent(n,u))}),e.query({and:[S,u,x]}).forEach(n=>{})}function B(e){e.query({and:[T,u,x]}).forEach(t=>{let n=a.getComponent(t,T);if(!p||!n.isActive)return;let o=a.getComponent(t,u),s=Math.sin(n.tilt),i=Math.cos(n.tilt),r=-o.x*n.zoom,c=-o.y*n.zoom;p.transform(i*n.zoom,-s*n.zoom,s*n.zoom,i*n.zoom,i*r+s*c+p.canvas.width*.5,-s*r+i*c+p.canvas.height*.5);let d=a.getComponent(t,x),h=d.x,k=d.y;d.x=i*h-s*k,d.y=s*h+i*k})}function $(e){let t=e.dtMilli/1e3;e.query({and:[u,x]}).forEach(n=>{let o=a.getComponent(n,u),s=a.getComponent(n,x);o.x+=s.x*t,o.y+=s.y*t})}function j(e){p&&e.query({and:[C,u],or:[y]}).forEach(t=>{let n=a.getComponent(t,C),o=a.getComponent(t,u),s=a.hasComponent(t,y)&&a.getComponent(t,y),i=new Image;i.src=n.src;let r=s?s.width:i.width,c=s?s.height:i.height,d=r/i.width,h=c/i.height;p.transform(d,0,0,h,0,0),p.drawImage(i,(o.x-r/2)/d,(o.y-c/2)/h),p.transform(1/d,0,0,1/h,0,0)})}function q(e){e.query({and:[M,u,y]}).forEach(t=>{let n=a.getComponent(t,u),o=a.getComponent(t,M),s=a.getComponent(t,y),i=(l.pressPos.x-n.x)**2<(s.width/2)**2&&(l.pressPos.y-n.y)**2<(s.height/2)**2;o.hovered=(l.x-n.x)**2<(s.width/2)**2&&(l.y-n.y)**2<(s.height/2)**2,o.pressed=o.hovered&&l.isDown&&i,o.clicked=l.justReleased&&i&&(l.releasePos.x-n.x)**2<(s.width/2)**2&&(l.releasePos.y-n.y)**2<(s.height/2)**2,o.callback(t)})}function D(){p&&p.setTransform(1,0,0,1,0,0)}function I(e,t,n=0,o=0,s=1,i=1){let r=e.addEntity(),c=a.addComponent(r,u),d=a.addComponent(r,C),h=a.addComponent(r,y);return c.x=n,c.y=o,d.src=t,h.width=s,h.height=i,r}function z(e,t=0,n=0){let o=e.addEntity(),s=a.addComponent(o,u);a.addComponent(o,x),a.addComponent(o,y);let i=a.addComponent(o,v);return i.fill="green",s.x=t,s.y=n,o}function F(e,t=0,n=0,o=10,s=10,i=()=>{}){let r=e.addEntity(),c=a.addComponent(r,u),d=a.addComponent(r,y),h=a.addComponent(r,M);return a.addComponent(r,v),c.x=t,c.y=n,d.width=o,d.height=s,h.callback=i,r}function H(e,t,n,o){let s=Math.cos(n),i=Math.sin(n),r={x:0,y:0},c=e.x-m.viewport.width/2,d=e.y-m.viewport.height/2;return r.x=s*c-i*d,r.y=i*c+s*d,r.x/=o,r.y/=o,r.x+=t.x,r.y+=t.y,r}var f=document.querySelector("canvas"),p=f?.getContext("2d"),O={},l={x:0,y:0,isDown:!1,pressPos:{x:0,y:0},justReleased:!1,releasePos:{x:0,y:0}};if(f&&p){f.width=m.viewport.width,f.height=m.viewport.height,f.style.imageRendering="pixelated",p.lineWidth=.1,document.onkeydown=r=>{O[r.key]=!0},document.onkeyup=r=>{delete O[r.key]},document.onpointermove=r=>{let c=f.getBoundingClientRect();l.x=r.x-c.left,l.y=r.y-c.top,innerWidth/innerHeight<f.width/f.height?(l.x*=f.width/innerWidth,l.y*=f.width/innerWidth):(l.x*=f.height/innerHeight,l.y*=f.height/innerHeight)},document.onpointerdown=()=>{l.isDown=!0,l.pressPos.x=l.x,l.pressPos.y=l.y},document.onpointerup=()=>{l.isDown=!1,l.justReleased=!0,l.releasePos.x=l.x,l.releasePos.y=l.y},document.body.append(f);let e=new a,t=z(e,0,0),n=a.getComponent(t,y);n.width=1,n.height=1;let o=a.addComponent(t,T);o.zoom=30,o.isActive=!0,a.addComponent(t,S),I(e,"./assets/Map_of_MOBA.svg",0,0,300,300);let s=z(e,0,0),i=new a;F(i,m.viewport.width*.9,m.viewport.height*.8,m.viewport.height*.3,m.viewport.height*.3,r=>{a.getComponent(r,M).clicked&&console.log("clicked")}),I(i,"./assets/Map_of_MOBA.svg",m.viewport.width*.1,m.viewport.height*.2,m.viewport.height*.3,m.viewport.height*.3),function r(){A();let c=a.getComponent(s,u),d=H(l,a.getComponent(t,u),o.tilt,o.zoom);c.x=d.x,c.y=d.y,e.update(R,B,j,E,$),D(),i.update(j,E,q),l.justReleased=!1,requestAnimationFrame(r)}()}})();
//# sourceMappingURL=out.js.map
