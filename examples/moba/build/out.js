(()=>{var D=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(t){this.objectFactory=t}size(){return this.indexToKey.length}add(t){return this.keyToIndex.has(t)||(this.storage.length<=this.indexToKey.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.indexToKey.length),this.indexToKey[this.indexToKey.length]=t),this.storage[this.keyToIndex.get(t)]}remove(t){let n=this.keyToIndex.get(t),o=this.indexToKey[this.indexToKey.length-1];if(n==null||o==null)return;let i=this.storage[this.indexToKey.length-1];this.storage[this.indexToKey.length-1]=this.storage[n],this.storage[n]=i,this.indexToKey[n]=o,this.keyToIndex.set(o,n),this.indexToKey.pop(),this.keyToIndex.delete(t)}get(t){let n=this.keyToIndex.get(t);if(n==null)throw new Error("Key not found");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.indexToKey.length)}};var I=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new D(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,n){return Object.assign(this.pools.get(n).add(t),n)}remove(t,n){this.pools.get(n).remove(t)}get(t,n){return this.pools.get(n).get(t)}size(t){return this.pools.get(t).size()}delete(t){for(let n of this.pools)n[1].remove(t)}copy(t,n){for(let o of this.pools)o[1].has(t)&&Object.assign(o[1].add(n),o[1].get(t))}clean(){for(let t of this.pools)t[1].clean()}};function X(){return Math.random()}var b=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new I;addEntity(t=X()){return this.maskMap.set(t,0),this.getArchetype(0).add(t),t}copyEntity(t,n=X()){this.compManager.copy(t,n);let o=this.maskMap.get(t)??0;return this.maskMap.set(n,o),this.getArchetype(o).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.entitiesToDelete.push(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return((this.maskMap.get(t)??0)&1<<this.compManager.getId(n))>0}addComponent(t,n,o=n){this.registerComponent(n);let i=this.maskMap.get(t)??0,s=this.compManager.getId(n);return(i&1<<s)!=0?Object.assign(this.compManager.get(t,n),o):(this.getArchetype(i).delete(t),i|=1<<s,this.maskMap.set(t,i),this.getArchetype(i).add(t),Object.assign(this.compManager.add(t,n),o))}removeComponent(t,n){this.registerComponent(n);let o=this.maskMap.get(t)??0,i=this.compManager.getId(n);(o&1<<i)!=0&&(this.getArchetype(o).delete(t),o&=~(1<<i),this.maskMap.set(t,o),this.getArchetype(o).add(t),this.compManager.remove(t,n))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this);this.commitEntityDeletion()}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let t=this.entitiesToDelete.pop();this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,o=0;if(t.and)for(let s=0,a=t.and.length;s<a;s++)n|=1<<this.compManager.getId(t.and[s]);if(t.not)for(let s=0,a=t.not.length;s<a;s++)o|=1<<this.compManager.getId(t.not[s]);let i=[];for(let s of this.archetypeMap)s[1].size>0&&(s[0]&n)==n&&(s[0]&o)==0&&i.push(...s[1]);return i}entityCount(){return this.maskMap.size}};var p={viewport:{width:800,height:400},entities:{player:{healthPoint:10,moveSpeed:20},minion:{healthPoint:15,spawnRate:2},turrent:{healthPoint:100,abilityPower:100}}};var A=function(e){return e[e.Root=0]="Root",e[e.NE=1]="NE",e[e.NW=2]="NW",e[e.SE=3]="SE",e[e.SW=4]="SW",e}(A||{}),z=class{storage={};changed=[];bounds={};maxDepth=10;constructor(t,n=10){this.bounds[A.Root]=t,this.maxDepth=n,this.storage[A.Root]=new Set}index(t,n=A.Root.toString()){if(n.length>=this.maxDepth)return n;let o=this.bounds[n];for(let i=0;i<4;i++)if(this.bounds[n+i.toString()]??={cx:o.cx+o.width/4*(i%2==0?1:-1),cy:o.cy+o.height/4*(i<1?1:-1),width:o.width/2,height:o.height/2},this.contain(this.bounds[n+i.toString()],t))return this.index(t,n+i.toString());return n}insert(t){let n=this.index(t);this.storage[n]??=new Set,this.storage[n].add(t)}queryRange(t){return[...this.storage[this.index(t)]]}update(){for(let t in this.storage)for(let n of this.storage[t].values())this.contain(this.bounds[t],n)||this.changed.push(n);for(;this.changed.length;){let t=this.changed.pop();t&&this.insert(t)}}contain(t,n){return(t.cx-n.cx)**2<((t.width-n.width)/2)**2&&(t.cy-n.cy)**2<((t.height-n.height)/2)**2}intersect(t,n){return(t.cx-n.cx)**2<((t.width+n.width)/2)**2&&(t.cy-n.cy)**2<((t.height+n.height)/2)**2}};var Y={attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},S={current:0,max:0},C={callback:new Function},h={x:0,y:0,rad:0,scaleX:1,scaleY:1},T={x:0,y:0},$={};var P={},q={spreadRadians:0,particleEntity:-1,particleLifetimeSeconds:1,speed:1,emit:!1,particleTransition:function(e,t,n){let o=e.getComponent(t,h);o.scaleX=o.scaleY=-(n**2)+1}},f={zoom:20,tilt:0,isActive:!1,targetEntity:-1},g={width:1,height:1,offsetX:.5,offsetY:.5},O={src:""},W={hovered:!1,pressed:!1,clicked:!1},j={fill:"white",stroke:"black"},B={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},E={timeMilli:0,reset:!1,stop:!1},R={targetX:0,targetY:0},c=Z(),u=et(),J=Q(),v=ot(),F=!0;function Z(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function Q(){let e={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!e.isDown[t.key]&&(e.justPressed[t.key]=!0),e.isDown[t.key]=!0},globalThis.onkeyup=t=>{e.isDown[t.key]=!1,e.justReleased[t.key]=!0},e}function tt(e){for(let t in e.justPressed)e.justPressed[t]=!1;for(let t in e.justReleased)e.justReleased[t]=!1}function et(){let e={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.x=t.x,e.y=t.y,Object.assign(e.pressPos,e),e.isDown=e.justPressed=!0)},globalThis.onpointerup=t=>{e.x=t.x,e.y=t.y,Object.assign(e.releasePos,e),e.isDown=!1,e.justReleased=!0},globalThis.onpointermove=t=>{e.x=t.x,e.y=t.y},e}function nt(e){e.justPressed=!1,e.justReleased=!1}function ot(){return{dtMilli:0,timeMilli:0}}function it(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function st(e){let t=e.query({and:[f,h]}).find(i=>e.getComponent(i,f).isActive);if(!t)return;let n=e.getComponent(t,f),o=e.getComponent(t,h);e.query({and:[g,h]}).forEach(i=>{e.removeComponent(i,P);let s=e.getComponent(i,g),a=e.getComponent(i,h);kt(o.x,o.y,c.canvas.width/n.zoom,c.canvas.height/n.zoom,a.x+s.offsetX+s.width/2,a.y+s.offsetY+s.height/2,s.width,s.height)&&e.addComponent(i,P)})}function at(e){e.query({and:[q,h]}).forEach(t=>{let n=e.getComponent(t,q);if(!n.emit||!e.hasComponent(n.particleEntity,h))return;n.emit=!1;let o=e.getComponent(t,h),i=e.copyEntity(n.particleEntity),s=e.getComponent(i,h);Object.assign(s,o);let a=e.addComponent(i,E),r=o.rad+(Math.random()*2-1)*n.spreadRadians*.5;s.rad=r,e.addComponent(i,T,{x:Math.cos(r)*n.speed,y:Math.sin(r)*n.speed}),e.addComponent(i,C).callback=()=>{if(a.timeMilli<n.particleLifetimeSeconds*1e3){n.particleTransition(e,i,a.timeMilli/1e3/n.particleLifetimeSeconds);return}e.deleteEntity(i)}})}function ct(e){let t=e.query({and:[f,h]}).find(s=>e.getComponent(s,f).isActive);if(t==null)return;let n=e.getComponent(t,f),o=e.getComponent(t,h),i=K(u.pressPos,c.canvas);e.query({and:[R,$]}).forEach(s=>{if(!u.justPressed||!F)return;let a=e.getComponent(s,R),r=Et(i,o,n.tilt,n.zoom);a.targetX=r.x,a.targetY=r.y})}function rt(e){e.query({and:[R,h,T,Y]}).forEach(t=>{let n=e.getComponent(t,R),o=e.getComponent(t,h),i=e.getComponent(t,T),s=e.getComponent(t,Y),a=n.targetX-o.x,r=n.targetY-o.y,d=(a*a+r*r)**.5;if(d==0)return;let m=s.moveSpeed*v.dtMilli/1e3*2,x=d>m?s.moveSpeed:s.moveSpeed*d/m;i.x=a/d*x,i.y=r/d*x})}function ht(e){e.query({and:[E,C]}).forEach(t=>e.getComponent(t,C).callback(t)),e.query({and:[E]}).forEach(t=>{let n=e.getComponent(t,E);n.reset&&(n.timeMilli=0),n.reset=!1,n.stop||(n.timeMilli+=v.dtMilli)})}function dt(e){e.query({and:[B,h]}).forEach(t=>{let n=e.getComponent(t,B),o=e.getComponent(t,h);c.ctx.font=`${n.fontSize}px serif`;let i=c.ctx.fillStyle,s=n.content.split(`
`);for(let a=0,r=s.length;a<r;a++){let d=c.ctx.measureText(s[a]);c.ctx.fillStyle=n.backgroundColor,c.ctx.fillRect(o.x,o.y+a*(2*n.padding)+a*d.fontBoundingBoxAscent,n.padding*2+d.width,n.padding*2+d.fontBoundingBoxAscent),c.ctx.fillStyle=n.color,c.ctx.fillText(s[a],o.x+n.padding,o.y+a*(2*n.padding)+(a+1)*d.fontBoundingBoxAscent)}c.ctx.fillStyle=i})}function U(e){e.query({and:[h,g,j,P]}).forEach(t=>{let n=e.getComponent(t,h),o=e.getComponent(t,g),i=e.getComponent(t,j),s=c.ctx.fillStyle,a=c.ctx.strokeStyle;c.ctx.fillStyle=i.fill,c.ctx.strokeStyle=i.stroke;let r=Math.cos(n.rad),d=Math.sin(n.rad);c.ctx.transform(r,d,-d,r,n.x,n.y),c.ctx.fillRect(o.offsetX*n.scaleX,o.offsetY*n.scaleY,o.width*n.scaleX,o.height*n.scaleY),c.ctx.strokeRect(o.offsetX*n.scaleX,o.offsetY*n.scaleY,o.width*n.scaleX,o.height*n.scaleY),c.ctx.transform(r,-d,d,r,r*-n.x+d*-n.y,-d*-n.x+r*-n.y),c.ctx.fillStyle=s,c.ctx.strokeStyle=a})}function lt(e){let t=e.query({and:[f,h]}).find(a=>e.getComponent(a,f).isActive);if(!t)return;c.ctx.resetTransform();let n=e.getComponent(t,f),o=e.getComponent(t,h);if(n.targetEntity!=-1&&e.hasComponent(n.targetEntity,h)){let a=e.getComponent(n.targetEntity,h);Object.assign(o,a)}let i=Math.sin(n.tilt)*n.zoom,s=Math.cos(n.tilt)*n.zoom;c.ctx.transform(s,i,-i,s,s*-o.x-i*-o.y+c.ctx.canvas.width*.5,i*-o.x+s*-o.y+c.ctx.canvas.height*.5)}function pt(e){let t=v.dtMilli/1e3;e.query({and:[h,T]}).forEach(n=>{let o=e.getComponent(n,h),i=e.getComponent(n,T);o.x+=i.x*t,o.y+=i.y*t})}function N(e){e.query({and:[O,h]}).forEach(t=>{let n=e.getComponent(t,O),o=e.getComponent(t,h),i=e.hasComponent(t,g)&&e.getComponent(t,g),s=new Image;s.src=n.src;let a=i?i.width:s.width,r=i?i.height:s.height,d=a/s.width,m=r/s.height;c.ctx.transform(d,0,0,m,0,0),c.ctx.drawImage(s,(o.x-a/2)/d,(o.y-r/2)/m),c.ctx.transform(1/d,0,0,1/m,0,0)})}function gt(e){let t=K(u.pressPos,c.canvas),n=K(u.releasePos,c.canvas),o=K({x:u.x,y:u.y},c.canvas);e.query({and:[W,h,g,C]}).forEach(i=>{let s=e.getComponent(i,h),a=e.getComponent(i,W),r=e.getComponent(i,g),d=e.getComponent(i,C),m=(t.x-s.x)**2<(r.width/2)**2&&(t.y-s.y)**2<(r.height/2)**2;a.hovered=(o.x-s.x)**2<(r.width/2)**2&&(o.y-s.y)**2<(r.height/2)**2,a.pressed=a.hovered&&u.isDown&&m,a.clicked=u.justReleased&&m&&(n.x-s.x)**2<(r.width/2)**2&&(n.y-s.y)**2<(r.height/2)**2,d.callback(i)})}function mt(e){e.query({and:[P,S,h,g]}).forEach(t=>{let n=e.getComponent(t,h),o=e.getComponent(t,g),i=e.getComponent(t,S),s=Math.cos(n.rad),a=Math.sin(n.rad),r=c.ctx.strokeStyle,d=c.ctx.fillStyle,m=c.ctx.lineWidth;c.ctx.fillStyle="black";let x=o.width*1.5,M=-x/2,k=o.offsetY*n.scaleY-1;c.ctx.fillRect(n.x+s*M-a*k,n.y+a*M+s*k,x,.3),c.ctx.fillStyle="green",c.ctx.fillRect(n.x+s*M-a*k,n.y+a*M+s*k,x*(i.current/i.max),.3),c.ctx.strokeStyle="black",c.ctx.lineWidth=.1,c.ctx.strokeRect(n.x+s*M-a*k,n.y+a*M+s*k,x,.3),c.ctx.strokeStyle=r,c.ctx.fillStyle=d,c.ctx.lineWidth=m})}function ft(e,t,n=0,o=0,i=1,s=1){let a=e.addEntity();return e.addComponent(a,h,{x:n,y:o}),e.addComponent(a,O,{src:t}),e.addComponent(a,g,{width:i,height:s}),a}function H(e,t=0,n=0,o=1,i=1,s=-o/2,a=-i/2){let r=e.addEntity();return e.addComponent(r,h,{x:t,y:n}),e.addComponent(r,g,{width:o,height:i,offsetX:s,offsetY:a}),e.addComponent(r,j),e.addComponent(r,P),r}function ut(e,t=0,n=0,o=10,i=10,s=a=>{let r=y.getComponent(a,W),d=y.getComponent(a,j);d.fill="grey",r.hovered&&(F=!1,d.fill="lightgrey"),r.pressed&&(d.fill="red"),r.clicked&&(d.fill="green")}){let a=H(e,t,n,o,i);return e.addComponent(a,W),e.addComponent(a,j),e.addComponent(a,C,{callback:s}),e.addComponent(a,B,{content:"Button",backgroundColor:"transparent",color:"white"}),a}function yt(e,t=0,n=0){let o=H(e,t,n,1,1);return e.addComponent(o,T),e.addComponent(o,Y,{...p.entities.player}),e.addComponent(o,S,{max:p.entities.player.healthPoint,current:p.entities.player.healthPoint}),e.addComponent(o,$),e.addComponent(o,R,{targetX:t,targetY:n}),o}function xt(e,t,n){let o=H(e,t,n,3,10,-1.5,-10);return e.addComponent(o,Y,{...p.entities.turrent}),e.addComponent(o,S,{max:p.entities.turrent.healthPoint,current:p.entities.turrent.healthPoint}),o}function Ct(e,t,n){let o=e.addEntity();return e.addComponent(o,f,{zoom:30}),e.addComponent(o,h,{x:t,y:n}),o}function Mt(e="#424242"){let t=c.ctx.fillStyle;c.ctx.fillStyle=e,c.ctx.fillRect(0,0,c.canvas.width,c.canvas.height),c.ctx.fillStyle=t}function kt(e,t,n,o,i,s,a,r){return(e-i)**2<((n+a)/2)**2&&(t-s)**2<((o+r)/2)**2}function Et(e,t,n,o){let i=Math.cos(n),s=Math.sin(n),a={x:0,y:0},r=e.x-p.viewport.width/2,d=e.y-p.viewport.height/2;return a.x=i*r+s*d,a.y=-s*r+i*d,a.x/=o,a.y/=o,a.x+=t.x,a.y+=t.y,a}function vt(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function K(e,t){let n={x:0,y:0},o=t.getBoundingClientRect();return n.x=e.x-o.left,n.y=e.y-o.top,innerWidth/innerHeight<t.width/t.height?(n.x*=t.width/innerWidth,n.y*=t.width/innerWidth):(n.x*=t.height/innerHeight,n.y*=t.height/innerHeight),n}c.canvas.width=p.viewport.width;c.canvas.height=p.viewport.height;c.canvas.style.imageRendering="pixelated";c.ctx.lineWidth=.1;var l=new b,w=xt(l,10,0);l.addComponent(w,q,{particleEntity:w,speed:20,spreadRadians:Math.PI*.25});l.addComponent(w,E);l.addComponent(w,C).callback=e=>{let t=l.getComponent(e,E);t.timeMilli<50||(t.reset=!0,l.getComponent(e,q).emit=!0)};for(let e=0;e<2;e++)l.getComponent(l.copyEntity(w),h).y+=15*(e+1);var G=yt(l,0,0);l.getComponent(G,S).current*=.6;var Xt=ft(l,"./assets/Map_of_MOBA.svg",0,0,300,300),Tt=Ct(l,0,0),L=l.getComponent(Tt,f);L.targetEntity=G;L.isActive=!0;L.zoom=15;var Ot=new z({cx:0,cy:0,width:1e10,height:1e10}),y=new b;ut(y,p.viewport.width*.9,p.viewport.height*.8,p.viewport.height*.3,p.viewport.height*.3);var _=y.addEntity(),bt=y.addComponent(_,B,{content:"test string",backgroundColor:"white"});y.addComponent(_,h);(function e(){requestAnimationFrame(e),bt.content=`FPS: ${Math.ceil(1e3/v.dtMilli)}
Entity count: ${l.entityCount()}
Device type: ${vt()}`,v.timeMilli%5e3<100&&l.cleanObjectPools(),Mt(),l.update(lt,st,N,U,mt),c.ctx.resetTransform(),y.update(N,U,dt),y.update(gt),l.update(ht,rt,ct,at,pt),nt(u),tt(J),it(v),F=!0})();})();
//# sourceMappingURL=out.js.map
