(()=>{var q=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;constructor(e){this.objectFactory=e}size(){return this.keyToIndex.size}add(e){return this.keyToIndex.has(e)?this.storage[this.keyToIndex.get(e)]:(this.storage.length<=this.keyToIndex.size&&this.storage.push(this.objectFactory()),this.keyToIndex.set(e,this.keyToIndex.size),this.indexToKey[this.keyToIndex.size-1]=e,this.storage[this.keyToIndex.get(e)])}remove(e){let n=this.keyToIndex.get(e);if(n==null)return;let o=this.indexToKey[this.keyToIndex.size-1],s=this.storage[n];this.storage[n]=this.storage[this.keyToIndex.size-1],this.storage[this.keyToIndex.size-1]=s,this.indexToKey[n]=o,this.indexToKey.pop(),this.keyToIndex.set(o,n),this.keyToIndex.delete(e)}get(e){let n=this.keyToIndex.get(e);if(n==null)throw new Error("Key not found.");return this.storage[n]}has(e){return this.keyToIndex.has(e)}clean(){this.storage.splice(this.keyToIndex.size)}};var D=class{poolMap=new Map;idMap=new Map;register(e){this.poolMap.has(e)||(this.idMap.set(e,this.idMap.size),this.poolMap.set(e,new q(()=>({...e}))))}getId(e){let n=this.idMap.get(e);return n??(this.register(e),this.idMap.get(e))}add(e,n){return Object.assign(this.poolMap.get(n).add(e),n)}remove(e,n){this.poolMap.get(n).remove(e)}has(e,n){return this.poolMap.has(n)&&this.poolMap.get(n).has(e)}get(e,n){return this.poolMap.get(n).get(e)}size(e){return this.poolMap.get(e).size()}delete(e){for(let n of this.poolMap.entries())n[1].remove(e)}copy(e,n){for(let o of this.poolMap.entries())o[1].has(e)&&Object.assign(o[1].add(n),o[1].get(e))}clean(){for(let e of this.poolMap.entries())e[1].clean()}};function K(){return Math.random()}var j=class{compEntityMap=new Map;compManager=new D;entitySet=new Set;addEntity(e=K()){return this.entitySet.add(e),e}copyEntity(e,n=K()){this.compManager.copy(e,n);for(let o of this.compEntityMap)o[1].has(e)&&o[1].add(n);return this.entitySet.add(n),n}getCompEntityMap(e){let n=this.compEntityMap.get(e)??new Set;return this.compEntityMap.set(e,n),n}deleteEntity(e){this.compManager.delete(e);for(let n of this.compEntityMap)n[1].delete(e);this.entitySet.delete(e)}registerComponent(e){return this.compManager.register(e),this}hasComponent(e,n){return this.compManager.has(e,n)}addComponent(e,n,o=n){this.compManager.register(n);let s=this.getCompEntityMap(this.compManager.getId(n));return s.has(e)?Object.assign(this.compManager.get(e,n),o):(s.add(e),Object.assign(this.compManager.add(e,n),o))}removeComponent(e,n){this.compManager.register(n),this.getCompEntityMap(this.compManager.getId(n)).delete(e),this.compManager.remove(e,n)}getComponent(e,n){return this.compManager.get(e,n)}update(...e){for(let n=0,o=e.length;n<o;n++)e[n](this)}cleanObjectPools(){this.compManager.clean()}query(e){let n=this.entitySet;if(e.and)for(let o of e.and)n=n.intersection(this.getCompEntityMap(this.compManager.getId(o)));if(e.not)for(let o of e.not)n=n.difference(this.getCompEntityMap(this.compManager.getId(o)));return[...n]}entityCount(){return this.entitySet.size}};var l={viewport:{width:800,height:400},entities:{player:{healthPoint:10,moveSpeed:20},minion:{healthPoint:15,spawnRate:1},turrent:{healthPoint:100,abilityPower:100}}};var H={attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},v={current:0,max:0},S={callback:t=>{}},d={x:0,y:0,rad:0,scaleX:1,scaleY:1},T={x:0,y:0},A={},I={},O={spreadRadians:0,particleEntity:-1,particleLifetimeSeconds:1,particleSpeed:1,emit:!1,particleTransition:function(t,e,n){let o=t.getComponent(e,d);o.scaleX=o.scaleY=-((2*n-1)**10)+1}},y={zoom:20,tilt:0,isActive:!1,targetEntity:-1},m={width:1,height:1,x:-.5,y:-.5},w={image:new Image},X={hovered:!1,pressed:!1,clicked:!1},b={fill:"white",stroke:"black"},Y={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},E={timeMilli:0,reset:!1,stop:!1},z={targetX:0,targetY:0},r=Q(),C=et(),N=Z(),M=ot();function Q(){let t=document.querySelector("canvas")??document.createElement("canvas");if(!t)throw new Error("Cannot create canvas element.");let e=t.getContext("2d");if(!e)throw new Error("Cannot initialize context 2d.");return!document.querySelector("canvas")&&document.body.appendChild(t),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<t.width/t.height?(t.style.width="100%",t.style.height=""):(t.style.width="",t.style.height="100%")},{canvas:t,ctx:e}}function Z(){let t={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=e=>{!t.isDown[e.key]&&(t.justPressed[e.key]=!0),t.isDown[e.key]=!0},globalThis.onkeyup=e=>{t.isDown[e.key]=!1,t.justReleased[e.key]=!0},t}function tt(t){for(let e in t.justPressed)t.justPressed[e]=!1;for(let e in t.justReleased)t.justReleased[e]=!1}function et(){let t={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=e=>{e.target instanceof HTMLCanvasElement&&(t.x=e.x,t.y=e.y,Object.assign(t.pressPos,t),t.isDown=t.justPressed=!0)},globalThis.onpointerup=e=>{t.x=e.x,t.y=e.y,Object.assign(t.releasePos,t),t.isDown=!1,t.justReleased=!0},globalThis.onpointermove=e=>{t.x=e.x,t.y=e.y},t}function nt(t){t.justPressed=!1,t.justReleased=!1}function ot(){return{dtMilli:0,timeMilli:0,dtSeconds:0,timeSeconds:0}}function it(t){t.dtMilli=performance.now()-t.timeMilli,t.timeMilli+=t.dtMilli,t.dtSeconds=t.dtMilli/1e3,t.timeSeconds=t.timeMilli/1e3}function st(t){let e=t.query({and:[y,d]}).find(s=>t.getComponent(s,y).isActive);if(!e)return;let n=t.getComponent(e,y),o=t.getComponent(e,d);t.query({and:[m,d]}).forEach(s=>{let a=t.getComponent(s,m),i=t.getComponent(s,d);St(o.x,o.y,r.canvas.width/n.zoom,r.canvas.height/n.zoom,i.x+a.x+a.width/2,i.y+a.y+a.height/2,a.width,a.height)?t.addComponent(s,I):t.removeComponent(s,I)})}function at(t){t.query({and:[O,d]}).forEach(e=>{let n=t.getComponent(e,O);if(!n.emit)return;n.emit=!1;let o=t.getComponent(e,d),s=t.copyEntity(n.particleEntity);t.addComponent(s,d,o);let a=t.addComponent(s,E),i=o.rad+n.spreadRadians*(Math.random()-.5);t.addComponent(s,T,{x:Math.cos(i)*n.particleSpeed,y:Math.sin(i)*n.particleSpeed}),t.addComponent(s,S).callback=()=>{if(a.timeMilli<n.particleLifetimeSeconds*1e3){n.particleTransition(t,s,a.timeMilli/1e3/n.particleLifetimeSeconds);return}t.deleteEntity(s)}})}function ct(t){let e=t.query({and:[y,d]}).find(a=>t.getComponent(a,y).isActive);if(e==null)return;let n=t.getComponent(e,y),o=t.getComponent(e,d),s=B(C.pressPos,r.canvas);t.query({and:[z,A]}).forEach(a=>{if(!C.justPressed)return;let i=t.getComponent(a,z),c=Tt(s,o,n.tilt,n.zoom);i.targetX=c.x,i.targetY=c.y})}function rt(t){t.query({and:[z,d,T,H]}).forEach(e=>{let n=t.getComponent(e,z),o=t.getComponent(e,d),s=t.getComponent(e,T),a=t.getComponent(e,H),i=n.targetX-o.x,c=n.targetY-o.y,h=(i*i+c*c)**.5;if(h==0)return;let f=a.moveSpeed*M.dtSeconds*2,g=h>f?a.moveSpeed:a.moveSpeed*h/f;s.x=i/h*g,s.y=c/h*g})}function dt(t){t.query({and:[E]}).forEach(e=>{let n=t.getComponent(e,E);n.reset&&(n.timeMilli=0),n.reset=!1,n.stop||(n.timeMilli+=M.dtMilli)})}function W(t){for(let e of t.query({and:[S]}))t.getComponent(e,S).callback(e)}function ht(t){let e=r.ctx.fillStyle;t.query({and:[Y,d]}).forEach(n=>{let o=t.getComponent(n,Y),s=t.getComponent(n,d);r.ctx.font=`${o.fontSize}px serif`;let a=o.content.split(`
`);r.ctx.fillStyle=o.backgroundColor;for(let i=0,c=a.length;i<c;i++){let h=r.ctx.measureText(a[i]);r.ctx.fillRect(s.x,s.y+i*(2*o.padding)+i*h.fontBoundingBoxAscent,o.padding*2+h.width,o.padding*2+h.fontBoundingBoxAscent)}r.ctx.fillStyle=o.color;for(let i=0,c=a.length;i<c;i++){let h=r.ctx.measureText(a[i]);r.ctx.fillText(a[i],s.x+o.padding,s.y+i*(2*o.padding)+(i+1)*h.fontBoundingBoxAscent)}}),r.ctx.fillStyle=e}function $(t){let e=t.query({and:[d,m,b,I]});for(let n of e){let o=t.getComponent(n,d),s=t.getComponent(n,m),a=t.getComponent(n,b);r.ctx.fillStyle=a.stroke;let i=Math.cos(o.rad),c=Math.sin(o.rad);r.ctx.transform(i,c,-c,i,o.x,o.y),r.ctx.fillRect(s.x*o.scaleX-.5,s.y*o.scaleY-.5,s.width*o.scaleX+1,s.height*o.scaleY+1),r.ctx.transform(i,-c,c,i,i*-o.x+c*-o.y,-c*-o.x+i*-o.y)}for(let n of e){let o=t.getComponent(n,d),s=t.getComponent(n,m),a=t.getComponent(n,b);r.ctx.fillStyle=a.fill;let i=Math.cos(o.rad),c=Math.sin(o.rad);r.ctx.transform(i,c,-c,i,o.x,o.y),r.ctx.fillRect(s.x*o.scaleX,s.y*o.scaleY,s.width*o.scaleX,s.height*o.scaleY),r.ctx.transform(i,-c,c,i,i*-o.x+c*-o.y,-c*-o.x+i*-o.y)}}function pt(t){let e=t.query({and:[y,d]}).find(i=>t.getComponent(i,y).isActive);if(!e)return;r.ctx.resetTransform();let n=t.getComponent(e,y),o=t.getComponent(e,d);if(n.targetEntity!=-1&&t.hasComponent(n.targetEntity,d)){let i=t.getComponent(n.targetEntity,d);Object.assign(o,i)}let s=Math.sin(n.tilt)*n.zoom,a=Math.cos(n.tilt)*n.zoom;r.ctx.transform(a,s,-s,a,a*-o.x-s*-o.y+r.ctx.canvas.width*.5,s*-o.x+a*-o.y+r.ctx.canvas.height*.5)}function lt(t){t.query({and:[d,T]}).forEach(e=>{let n=t.getComponent(e,d),o=t.getComponent(e,T);n.x+=o.x*M.dtSeconds,n.y+=o.y*M.dtSeconds})}function L(t){t.query({and:[w,d]}).forEach(e=>{let n=t.getComponent(e,w),o=t.getComponent(e,d),s=n.image,a=s.width,i=s.height,c=0,h=0;if(t.hasComponent(e,m)){let R=t.getComponent(e,m);a=R.width,i=R.height,c=R.x,h=R.y}let f=a/s.width,g=i/s.height,u=Math.cos(o.rad),x=Math.sin(o.rad);r.ctx.transform(u*f,x*f,-x*g,u*g,o.x,o.y),r.ctx.drawImage(s,c,h),r.ctx.transform(u/f,-x/f,x/g,u/g,(u*-o.x+x*-o.y)/g,(-x*-o.x+u*-o.y)/g)})}function gt(t){let e=B(C.pressPos,r.canvas),n=B(C.releasePos,r.canvas),o=B({x:C.x,y:C.y},r.canvas);t.query({and:[X,d,m]}).forEach(s=>{let a=t.getComponent(s,d),i=t.getComponent(s,X),c=t.getComponent(s,m),h=(e.x-a.x)**2<(c.width/2)**2&&(e.y-a.y)**2<(c.height/2)**2;i.hovered=(o.x-a.x)**2<(c.width/2)**2&&(o.y-a.y)**2<(c.height/2)**2,i.pressed=i.hovered&&C.isDown&&h,i.clicked=C.justReleased&&h&&(n.x-a.x)**2<(c.width/2)**2&&(n.y-a.y)**2<(c.height/2)**2})}function mt(t){let s=t.query({and:[I,v,d,m]});r.ctx.fillStyle="black",r.ctx.beginPath();for(let a of s){let i=t.getComponent(a,d),c=t.getComponent(a,m),h=Math.cos(i.rad),f=Math.sin(i.rad),g=-(c.width*1.5)/2,u=-.3/2+c.y-1;r.ctx.rect(i.x-.2/2+h*g-f*u,i.y-.2/2+f*g+h*u,c.width*1.5+.2,.3+.2)}r.ctx.fill(),r.ctx.fillStyle="green",r.ctx.beginPath();for(let a of s){let i=t.getComponent(a,d),c=t.getComponent(a,m),h=t.getComponent(a,v),f=Math.cos(i.rad),g=Math.sin(i.rad),u=-(c.width*1.5)/2,x=-.3/2+c.y-1;r.ctx.rect(i.x+f*u-g*x,i.y+g*u+f*x,c.width*1.5*(h.current/h.max),.3)}r.ctx.fill()}function ft(t){let e=ut(t,-152,152),n=[-138,110,-110,138,-118,118];for(let o=0,s=n.length;o<s;o+=2)U(t,n[o],n[o+1],e),U(t,-n[o],-n[o+1],e)}function ut(t,e,n){let o=k(t);return t.addComponent(o,d,{x:e,y:n}),t.addComponent(o,v,{current:l.entities.minion.healthPoint,max:l.entities.minion.healthPoint}),o}function U(t,e,n,o){let s=t.addEntity();return t.addComponent(s,d,{x:e,y:n}),t.addComponent(s,O,{particleLifetimeSeconds:10,particleEntity:o}),t.addComponent(s,E),t.addComponent(s,S,{callback:a=>{let i=t.getComponent(a,E);i.timeMilli<1e3/l.entities.minion.spawnRate||(i.reset=!0,t.getComponent(a,O).emit=!0)}}),s}function yt(t){let e=[-10,10,-60,60,-108,108,-138,92,-138,0,-138,-110,-92,138,0,138,110,138];for(let n=0,o=e.length;n<o;n+=2)G(t,e[n],e[n+1]),G(t,-e[n],-e[n+1])}function xt(t){k(t,-128,128,10,10),k(t,128,-128,10,10)}function Ct(t,e,n=0,o=0,s=1,a=1){let i=t.addEntity();t.addComponent(i,d,{x:n,y:o});let c=new Image;return c.src=e,t.addComponent(i,w,{image:c}),t.addComponent(i,m,{width:s,height:a}),i}function k(t,e=0,n=0,o=1,s=1,a=-o/2,i=-s/2){let c=t.addEntity();return t.addComponent(c,d,{x:e,y:n}),t.addComponent(c,m,{width:o,height:s,x:a,y:i}),t.addComponent(c,b),t.addComponent(c,I),c}function Mt(t,e=0,n=0,o=10,s=10,a=i=>{let c=t.getComponent(i,X),h=t.getComponent(i,b);h.fill="grey",c.hovered&&(h.fill="lightgrey"),c.pressed&&(h.fill="red"),c.clicked&&(h.fill="green")}){let i=k(t,e,n,o,s);return t.addComponent(i,X),t.addComponent(i,b),t.addComponent(i,S,{callback:a}),t.addComponent(i,Y,{content:"Button",backgroundColor:"transparent",color:"white"}),i}function Et(t,e=0,n=0){let o=k(t,e,n,1,1);return t.addComponent(o,T),t.addComponent(o,H,{...l.entities.player}),t.addComponent(o,v,{max:l.entities.player.healthPoint,current:l.entities.player.healthPoint}),t.addComponent(o,A),t.addComponent(o,z,{targetX:e,targetY:n}),o}function G(t,e,n){let o=k(t,e,n,3,10,-1.5,-10);return t.addComponent(o,H,{...l.entities.turrent}),t.addComponent(o,v,{max:l.entities.turrent.healthPoint,current:l.entities.turrent.healthPoint}),o}function bt(t,e,n){let o=t.addEntity();return t.addComponent(o,y,{zoom:30}),t.addComponent(o,d,{x:e,y:n}),o}function vt(t="#424242"){let e=r.ctx.fillStyle;r.ctx.fillStyle=t,r.ctx.fillRect(0,0,r.canvas.width,r.canvas.height),r.ctx.fillStyle=e}function St(t,e,n,o,s,a,i,c){return(t-s)**2<((n+i)/2)**2&&(e-a)**2<((o+c)/2)**2}function Tt(t,e,n,o){let s=Math.cos(n),a=Math.sin(n),i={x:0,y:0},c=t.x-l.viewport.width/2,h=t.y-l.viewport.height/2;return i.x=s*c+a*h,i.y=-a*c+s*h,i.x/=o,i.y/=o,i.x+=e.x,i.y+=e.y,i}function kt(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function B(t,e){let n={x:0,y:0},o=e.getBoundingClientRect();return n.x=t.x-o.left,n.y=t.y-o.top,innerWidth/innerHeight<e.width/e.height?(n.x*=e.width/innerWidth,n.y*=e.width/innerWidth):(n.x*=e.height/innerHeight,n.y*=e.height/innerHeight),n}r.canvas.width=l.viewport.width;r.canvas.height=l.viewport.height;r.ctx.lineWidth=.1;var p=new j;Et(p,-146,146);yt(p);xt(p);ft(p);Ct(p,"./assets/Map_of_MOBA.svg",-150,-150,300,300);var Pt=bt(p,0,0),F=p.getComponent(Pt,y);F.targetEntity=p.query({and:[A]})[0];F.isActive=!0;F.zoom=15;var _=p.addEntity();p.addComponent(_,E);p.addComponent(_,S,{callback:t=>{let e=p.getComponent(t,E);e.timeMilli<1e3*60*5||(e.reset=!0,p.cleanObjectPools())}});var P=new j;Mt(P,l.viewport.width*.9,l.viewport.height*.8,l.viewport.height*.3,l.viewport.height*.3);var V=P.addEntity(),jt=P.addComponent(V,Y,{content:"test string",backgroundColor:"white"});P.addComponent(V,d);(function t(){requestAnimationFrame(t);let e=p.query({and:[A]})[0];p.getComponent(e,v).current*=.99**M.timeSeconds;let n=p.getComponent(e,d);jt.content=`FPS: ${Math.ceil(1e3/M.dtMilli)}
Entity count: ${p.entityCount()}
Device type: ${kt()}
Pos: (${Math.floor(n.x)}, ${Math.floor(n.y)})`,vt(),p.update(pt,st,L,$,mt),r.ctx.resetTransform(),P.update(L,$,ht),P.update(gt,W),p.update(at,rt,ct,dt,W,lt),nt(C),tt(N),it(M)})();})();
//# sourceMappingURL=out.js.map
