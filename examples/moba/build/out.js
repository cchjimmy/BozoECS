(()=>{var T=class{storage=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(){let t;return this.size<this.storage.length?t=this.storage[this.size]:(t=this.objectFactory(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(n=>n==t)}removeObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");let n=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=n,this.size--,n}getObj(t){if(t<0||t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var g=class e{static pools=new Map;static idMap=new Map;static register(t){e.idMap.set(t,e.idMap.size),e.pools.set(t,new T(()=>({...t})))}static getId(t){return e.idMap.get(t)??-1}static add(t){return Object.assign(e.pools.get(t).addObj(),t)}static delete(t,n){return e.pools.get(t).removeObj(n)}static get(t,n){return e.pools.get(t).getObj(n)}static len(t){return e.pools.get(t).len()}static typeLen(){return e.pools.size}static types(){return e.pools.keys().toArray()}};var w=class e{static nextId=0;static pool=new T(()=>e.nextId++);static add(){return e.pool.addObj()}static findIndex(t){return e.pool.findIndex(t)}static delete(t){return e.pool.removeObj(t)}};var a=class e{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];localEntities=new Set;timeMilli=0;dtMilli=0;constructor(){e.worlds.push(this)}static createEntity(){let t=w.add();return e.maskMap.set(t,0),e.getArchetype(0).add(t),t}static getArchetype(t){let n=e.archetypeMap.get(t)??new Set;return e.archetypeMap.set(t,n),n}static deleteEntity(t){for(let r=0,s=e.worlds.length;r<s;r++)e.worlds[r].removeEntity(t);let n=g.types(),o=e.maskMap.get(t);for(let r=0,s=n.length;r<s;r++)o&1<<r&&e.removeComponent(t,n[r]);w.delete(w.findIndex(t))}addEntity(t=e.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static registerComponent(t){return e.indexMap.has(t)||(g.register(t),e.indexMap.set(t,new Map)),e}static hasComponent(t,n){return!!(e.maskMap.get(t)&1<<g.getId(n))}static addComponent(t,n,o={}){e.registerComponent(n);let r=e.maskMap.get(t),s=g.getId(n);if((r&1<<s)!=0)throw new Error(`Entity ${t} already had that component.`);e.getArchetype(r).delete(t),r|=1<<s,e.maskMap.set(t,r),e.getArchetype(r).add(t);let i=g.len(n);return e.indexMap.get(n).set(t,i),Object.assign(g.add(n),o)}static removeComponent(t,n){e.registerComponent(n);let o=e.maskMap.get(t),r=g.getId(n);if((o&1<<r)==0)throw new Error(`Entity ${t} does not have that component.`);e.getArchetype(o).delete(t),o&=~(1<<r),e.maskMap.set(t,o),e.getArchetype(o).add(t);let s=e.indexMap.get(n),i=s.get(t),h=g.delete(n,i),c=s.keys().toArray().at(-1)??-1;return s.set(c,i),s.delete(t),h}static getComponent(t,n){return g.get(n,e.indexMap.get(n).get(t))}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let n=0,o=0;if(t.and)for(let s=0,i=t.and.length;s<i;s++)n|=1<<g.getId(t.and[s]);if(t.not)for(let s=0,i=t.not.length;s<i;s++)o|=1<<g.getId(t.not[s]);let r=[];for(let s=e.archetypeMap.keys().toArray(),i=s.length,h=0;h<i;h++){let c=s[h],m=e.getArchetype(c);m.size!=0&&(c&n)==n&&(c&o)==0&&r.push(...m)}return[...this.localEntities.intersection(new Set(r))]}entityCount(){return this.localEntities.size}};var y={viewport:{width:800,height:400},player:{speed:20},minions:{speed:20,spawnRate:2}};var M={healthPoint:0,attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},x={callback:new Function},p={x:0,y:0,rad:0,scaleX:1,scaleY:1},C={x:0,y:0},O={};var v={zoom:20,tilt:0,isActive:!1},f={width:2,height:2},S={src:""},k={hovered:!1,pressed:!1,clicked:!1},j={fill:"white",stroke:"black"},E={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},W={timeMilli:0,reset:!1,stop:!1},b={targetX:0,targetY:0},l={x:0,y:0,isDown:!1,pressPos:{x:0,y:0},justPressed:!1,justReleased:!1,releasePos:{x:0,y:0}},I={};function $(e){let t,n;e.query({and:[v,p]}).forEach(o=>{let r=a.getComponent(o,v);r.isActive&&(t=r,n=a.getComponent(o,p))}),e.query({and:[b,O]}).forEach(o=>{if(!t||!n)return;let r=a.getComponent(o,b);if(!l.justPressed)return;let s=Z(l.pressPos,n,t.tilt,t.zoom);r.targetX=s.x,r.targetY=s.y})}function X(e){e.query({and:[b,p,C,M]}).forEach(t=>{let n=a.getComponent(t,b),o=a.getComponent(t,p),r=a.getComponent(t,C),s=a.getComponent(t,M),i=n.targetX-o.x,h=n.targetY-o.y,c=(i*i+h*h)**.5;if(c==0)return;let m=s.moveSpeed*e.dtMilli/1e3*2,P=c>m?s.moveSpeed:s.moveSpeed*c/m;r.x=i/c*P,r.y=h/c*P})}function F(e){e.query({and:[W]}).forEach(t=>{a.hasComponent(t,x)&&a.getComponent(t,x).callback(t);let n=a.getComponent(t,W);n.reset&&(n.timeMilli=0),n.reset=!1,n.stop||(n.timeMilli+=e.dtMilli)})}function Y(e){d&&e.query({and:[E,p]}).forEach(t=>{let n=a.getComponent(t,E),o=a.getComponent(t,p);d.font=`${n.fontSize}px serif`;let r=d.fillStyle,s=n.content.split(`
`);for(let i=0,h=s.length;i<h;i++){let c=d.measureText(s[i]);d.fillStyle=n.backgroundColor,d.fillRect(o.x,o.y+i*(2*n.padding)+i*c.fontBoundingBoxAscent,n.padding*2+c.width,n.padding*2+c.fontBoundingBoxAscent),d.fillStyle=n.color,d.fillText(s[i],o.x+n.padding,o.y+i*(2*n.padding)+(i+1)*c.fontBoundingBoxAscent)}d.fillStyle=r})}function H(e,t,n,o){let r=e.fillStyle,s=e.strokeStyle;e.fillStyle=o.fill,e.strokeStyle=o.stroke;let i=new Path2D(`M ${t.x-n.width*.5*t.scaleX} ${t.y-n.height*.5*t.scaleY} h ${n.width*t.scaleX} v ${n.height*t.scaleY} h ${-n.width*t.scaleX} Z`);e.fill(i),e.stroke(i),e.fillStyle=r,e.strokeStyle=s}function A(e){d&&e.query({and:[p,f,j]}).forEach(t=>{let n=a.getComponent(t,p),o=a.getComponent(t,f),r=a.getComponent(t,j);H(d,n,o,r)})}function G(e){if(!d)return;let t=d.fillStyle;d.fillStyle="red",e.query({and:[b]}).forEach(n=>{let o=a.getComponent(n,b);d.fillRect(o.targetX-.5,o.targetY-.5,1,1)}),d.fillStyle=t}function K(e="#424242"){if(!d)return;let t=d.fillStyle;d.fillStyle=e,d.fillRect(0,0,d.canvas.width,d.canvas.height),d.fillStyle=t}function L(e){d&&e.query({and:[v,p]}).forEach(t=>{let n=a.getComponent(t,v);if(!n.isActive)return;D(d);let o=a.getComponent(t,p),r=Math.sin(n.tilt)*n.zoom,s=Math.cos(n.tilt)*n.zoom;d.transform(s,r,-r,s,s*-o.x-r*-o.y+d.canvas.width*.5,r*-o.x+s*-o.y+d.canvas.height*.5)})}function U(e){let t=e.dtMilli/1e3;e.query({and:[p,C]}).forEach(n=>{let o=a.getComponent(n,p),r=a.getComponent(n,C);o.x+=r.x*t,o.y+=r.y*t})}function z(e){d&&e.query({and:[S,p]}).forEach(t=>{let n=a.getComponent(t,S),o=a.getComponent(t,p),r=a.hasComponent(t,f)&&a.getComponent(t,f),s=new Image;s.src=n.src;let i=r?r.width:s.width,h=r?r.height:s.height,c=i/s.width,m=h/s.height;d.transform(c,0,0,m,0,0),d.drawImage(s,(o.x-i/2)/c,(o.y-h/2)/m),d.transform(1/c,0,0,1/m,0,0)})}function V(e){e.query({and:[k,p,f,x]}).forEach(t=>{let n=a.getComponent(t,p),o=a.getComponent(t,k),r=a.getComponent(t,f),s=a.getComponent(t,x),i=(l.pressPos.x-n.x)**2<(r.width/2)**2&&(l.pressPos.y-n.y)**2<(r.height/2)**2;o.hovered=(l.x-n.x)**2<(r.width/2)**2&&(l.y-n.y)**2<(r.height/2)**2,o.pressed=o.hovered&&l.isDown&&i,o.clicked=l.justReleased&&i&&(l.releasePos.x-n.x)**2<(r.width/2)**2&&(l.releasePos.y-n.y)**2<(r.height/2)**2,s.callback(t)})}function B(e,t=0,n=0,o=1,r=1){let s=e.addEntity();return a.addComponent(s,p,{x:t,y:n}),a.addComponent(s,f,{width:o,height:r}),a.addComponent(s,j,{fill:"green"}),s}function J(e,t=0,n=0,o=10,r=10,s=i=>{}){let i=e.addEntity();return a.addComponent(i,p,{x:t,y:n}),a.addComponent(i,f,{width:o,height:r}),a.addComponent(i,k),a.addComponent(i,j),a.addComponent(i,x,{callback:s}),i}function N(e,t=0,n=0){let o=B(e,t,n,1,1);return a.addComponent(o,C),a.addComponent(o,M,{moveSpeed:y.player.speed}),a.addComponent(o,O),a.addComponent(o,b,{targetX:t,targetY:n}),o}function Q(e,t,n){let o=B(e,t,n,3,10);return a.addComponent(o,M),o}function Z(e,t,n,o){let r=Math.cos(n),s=Math.sin(n),i={x:0,y:0},h=e.x-y.viewport.width/2,c=e.y-y.viewport.height/2;return i.x=r*h+s*c,i.y=-s*h+r*c,i.x/=o,i.y/=o,i.x+=t.x,i.y+=t.y,i}function D(e){e.setTransform(1,0,0,1,0,0)}function _(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function R(e){if(!u)return;let t=u.getBoundingClientRect();l.x=e.x-t.left,l.y=e.y-t.top,innerWidth/innerHeight<u.width/u.height?(l.x*=u.width/innerWidth,l.y*=u.width/innerWidth):(l.x*=u.height/innerHeight,l.y*=u.height/innerHeight)}var u=document.querySelector("canvas"),d=u?.getContext("2d");if(u&&d){u.width=y.viewport.width,u.height=y.viewport.height,u.style.imageRendering="pixelated",d.lineWidth=.1,document.onkeydown=c=>{I[c.key]=!0},document.onkeyup=c=>{I[c.key]=!1},document.onpointerdown=c=>{c.target==u&&(l.isDown=!0,l.justPressed=!0,R(c),Object.assign(l.pressPos,l))},document.onpointerup=c=>{l.isDown=!1,l.justReleased=!0,R(c),Object.assign(l.releasePos,l)},document.body.append(u);let e=new a,t=N(e,10,10),n=a.getComponent(t,p),o=Q(e,10,0),r=a.addComponent(t,v,{zoom:30,isActive:!0}),s=new a;J(s,y.viewport.width*.9,y.viewport.height*.8,y.viewport.height*.3,y.viewport.height*.3,c=>{a.getComponent(c,k).clicked&&console.log("clicked")});let i=s.addEntity(),h=a.addComponent(i,E,{content:"test string",backgroundColor:"white"});a.addComponent(i,p),function c(){K(),h.content=`FPS: ${Math.ceil(1e3/e.dtMilli)}
Entity count: ${e.entityCount()}
Device type: ${_()}`,e.update(F,L,X,$,z,A,G,U),D(d),s.update(z,A,Y,V),l.justReleased=!1,l.justPressed=!1,requestAnimationFrame(c)}()}})();
//# sourceMappingURL=out.js.map
