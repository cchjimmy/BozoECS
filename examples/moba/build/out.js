(()=>{var C=class{reserve;active;objectConstructor;constructor(t){this.reserve=[],this.active=[],this.objectConstructor=t}addObj(){return this.active.push(this.reserve.pop()??this.objectConstructor()),this.active[this.active.length-1]}findIndex(t){return this.active.findIndex(n=>n==t)}removeObj(t){let n=this.active[t];return this.active[t]=this.active[this.active.length-1],this.active.length--,this.reserve.push(n),n}getObj(t){return this.active[t]}len(){return this.active.length}};var m=class{static id=-1;owner=-1},E=class{pools=[];register(t){t.id==-1&&(t.id=this.pools.length),this.pools[t.id]??=new C(()=>new t)}isRegistered(t){return!!this.pools[t.id]}add(t){return this.pools[t.id].addObj()}delete(t,n){return this.pools[t.id].removeObj(n)}get(t,n){return this.pools[t.id].getObj(n)}len(t){return this.pools[t.id].len()}};var M=class{nextId=0;pool=new C(()=>this.nextId++);add(){return this.pool.addObj()}findIndex(t){return this.pool.findIndex(t)}delete(t){return this.pool.removeObj(t)}};var l=class e{static indices=[];static components=new E;static entities=new M;static entityMasks=[];static archetypes={0:new Set};static worlds=[];time=0;dt=0;localEntities=new Set;constructor(){e.worlds.push(this)}static createEntity(){let t=e.entities.add();return e.indices[t]=[],e.entityMasks[t]=0,e.archetypes[e.entityMasks[t]].add(t),t}static deleteEntity(t){for(let n of e.worlds)n.removeEntity(t);for(let n=0,o=e.components.pools.length;n<o;n++){if(!(e.entityMasks[t]&1<<n))continue;let s=e.components.pools[n].removeObj(e.indices[t][n]).constructor.prototype;e.indices[e.components.get(s,t).owner][n]=e.indices[t][n]}e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]=0,e.entities.delete(e.entities.findIndex(t))}addEntity(t){return t??=e.createEntity(),this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){if(!this.localEntities.has(t))throw new Error(`Entity ${t} does not exist.`)}static componentExists(t){e.components.isRegistered(t)||e.components.register(t)}static registerComponent(t){return e.components.register(t),e}static hasComponent(t,n){return(e.entityMasks[t]&1<<n.id)>0}static addComponent(t,n){if(e.componentExists(n),e.hasComponent(t,n))throw new Error(`Entity ${t} already had this component.`);e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]|=1<<n.id,e.archetypes[e.entityMasks[t]]??=new Set,e.archetypes[e.entityMasks[t]].add(t),e.indices[t][n.id]=e.components.len(n);let o=e.components.add(n);return o.owner=t,o}static removeComponent(t,n){if(e.componentExists(n),!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have component ${n.name}.`);e.archetypes[e.entityMasks[t]].delete(t),e.entityMasks[t]&=~(1<<n.id),e.archetypes[e.entityMasks[t]]??=new Set,e.archetypes[e.entityMasks[t]].add(t);let o=e.components.delete(n,e.indices[t][n.id]),s=e.components.get(n,e.indices[t][n.id]).owner;return e.indices[s][n.id]=e.indices[t][n.id],o}getComponent(t,n){if(this.entityExists(t),e.componentExists(n),!e.hasComponent(t,n))throw new Error(`Entity ${t} does not have component ${n.name}.`);return e.components.get(n,e.indices[t][n.id])}update(...t){for(let n of t)n(this,this.dt/1e3);this.dt=performance.now()-this.time,this.time+=this.dt}query(t){let n=0,o=0,s=0;if(t.and)for(let r=0,c=t.and.length;r<c;r++)n|=1<<t.and[r].id;if(t.or)for(let r=0,c=t.or.length;r<c;r++)o|=1<<t.or[r].id;if(t.not)for(let r=0,c=t.not.length;r<c;r++)s|=1<<t.not[r].id;let a=[];for(let r in e.archetypes){let c=parseInt(r);(c&n)==n&&(c|o)>0&&(c&s)==0&&a.push(...this.localEntities.intersection(e.archetypes[r]))}return a}};var W={player:{speed:20}};var p=class extends m{x=0;y=0},x=class extends m{x=0;y=0},S=class extends m{},T=class extends m{zoom=1;tilt=0;isActive=!1},h=class extends m{width=2;height=2},b=class extends m{src=""},u=class extends m{hovered=!1;pressed=!1;clicked=!1;callback=()=>{}},v=class extends m{fill="white";stroke="black"},I=class extends m{content="";fontSize=20;padding=3;color="black";backgroundColor="white"},w=class extends m{durationMilli=1e3;startMilli=0;callback=()=>{}};function R(e){e.query({and:[w]}).forEach(t=>{let n=e.getComponent(t,w);e.time-n.startMilli<n.durationMilli||(n.startMilli=e.time,n.callback(t))})}function O(e){i&&e.query({and:[I,p]}).forEach(t=>{let n=e.getComponent(t,I),o=e.getComponent(t,p);i.font=`${n.fontSize}px serif`;let s=i.measureText(n.content),a=i.fillStyle;i.fillStyle=n.backgroundColor,i.fillRect(o.x,o.y,n.padding*2+s.width,n.padding*2+s.fontBoundingBoxAscent),i.fillStyle=n.color,i.fillText(n.content,o.x+n.padding,o.y+n.padding+s.fontBoundingBoxAscent),i.fillStyle=a})}function P(e){e.query({and:[p,h,v],not:[u]}).forEach(t=>{if(!i)return;let n=e.getComponent(t,p),o=e.getComponent(t,h),s=e.getComponent(t,v),a=i.fillStyle,r=i.strokeStyle;i.fillStyle=s.fill,i.strokeStyle=s.stroke;let c=new Path2D(`M ${n.x-o.width*.5} ${n.y-o.height*.5} h ${o.width} v ${o.height} h ${-o.width} Z`);i.fill(c),i.stroke(c),i.fillStyle=a,i.strokeStyle=r})}function $(){if(!i)return;let e=i.fillStyle;i.fillStyle="#424242",i.fillRect(0,0,i.canvas.width,i.canvas.height),i.fillStyle=e}function A(e){e.query({and:[S,x,T]}).forEach(t=>{let n=e.getComponent(t,x);n.x=0,n.y=0,(f.w||f.ArrowUp)&&n.y++,(f.a||f.ArrowLeft)&&n.x--,(f.s||f.ArrowDown)&&n.y--,(f.d||f.ArrowRight)&&n.x++;let o=(n.x**2+n.y**2)**.5;if(o==0)return;let s=e.getComponent(t,T),a=Math.cos(s.tilt),r=Math.sin(s.tilt),c=n.x=n.x/o*W.player.speed,g=n.y=n.y/o*W.player.speed;n.x=a*c-r*g,n.y=r*c+a*g})}function z(e){e.query({and:[T,p]}).forEach(t=>{let n=e.getComponent(t,T);if(!i||!n.isActive)return;let o=e.getComponent(t,p),s=Math.sin(n.tilt),a=Math.cos(n.tilt),r=-o.x*n.zoom,c=-o.y*-n.zoom;i.setTransform(a*n.zoom,-s*-n.zoom,s*n.zoom,a*-n.zoom,r*a+c*-s+i.canvas.width*.5,r*s+c*a+i.canvas.height*.5)})}function B(e,t){e.query({and:[p,x]}).forEach(n=>{let o=e.getComponent(n,p),s=e.getComponent(n,x);o.x+=s.x*t,o.y+=s.y*t})}function q(e){i&&e.query({and:[b,p],or:[h]}).forEach(t=>{let n=e.getComponent(t,b),o=e.getComponent(t,p),s=l.hasComponent(t,h)&&e.getComponent(t,h),a=new Image;a.src=n.src;let r=s?s.width/a.width:1,c=s?s.height/a.height:1;i.transform(r,0,0,-c,o.x,o.y),i.drawImage(a,0,0),i.transform(1/r,0,0,1/-c,-o.x/r,o.y/c)})}function D(e){e.query({and:[u,p,h]}).forEach(t=>{let n=e.getComponent(t,p),o=e.getComponent(t,u),s=e.getComponent(t,h),a=(d.pressPos.x-n.x)**2<(s.width/2)**2&&(d.pressPos.y-n.y)**2<(s.height/2)**2;o.hovered=(d.x-n.x)**2<(s.width/2)**2&&(d.y-n.y)**2<(s.height/2)**2,o.pressed=o.hovered&&d.isDown&&a,o.clicked=d.justReleased&&a&&(d.releasePos.x-n.x)**2<(s.width/2)**2&&(d.releasePos.y-n.y)**2<(s.height/2)**2,o.callback(t)})}function H(){i&&i.setTransform(1,0,0,1,0,0)}function F(e){e.query({and:[p,u,h]}).forEach(t=>{if(!i)return;let n=e.getComponent(t,p),o=e.getComponent(t,h),s=i.fillStyle;i.fillStyle="green",i.fillRect(n.x-o.width*.5,n.y-o.height*.5,o.width,o.height),i.fillStyle=s})}function U(e,t,n=0,o=0,s=1,a=1){let r=e.addEntity(),c=l.addComponent(r,p),g=l.addComponent(r,b),k=l.addComponent(r,h);return c.x=n,c.y=o,g.src=t,k.width=s,k.height=a,r}function X(e,t=0,n=0){let o=e.addEntity(),s=l.addComponent(o,p);l.addComponent(o,x),l.addComponent(o,h);let a=l.addComponent(o,v);return a.fill="green",s.x=t,s.y=n,o}function Y(e,t=0,n=0,o=10,s=10,a=()=>{}){let r=e.addEntity(),c=l.addComponent(r,p),g=l.addComponent(r,h),k=l.addComponent(r,u);return l.addComponent(r,v),c.x=t,c.y=n,g.width=o,g.height=s,k.callback=a,r}function L(e,t,n=()=>{}){let o=e.addEntity(),s=l.addComponent(o,w);return s.durationMilli=t,s.callback=n,o}var y=document.querySelector("canvas"),i=y?.getContext("2d"),f={},d={x:-1,y:-1,isDown:!1,pressPos:{x:-1,y:-1},justReleased:!1,releasePos:{x:0,y:0}};if(y&&i){y.style.imageRendering="pixelated",i.lineWidth=.1,document.onkeydown=s=>{f[s.key]=!0},document.onkeyup=s=>{delete f[s.key]},document.onpointermove=s=>{let a=y.getBoundingClientRect();d.x=s.x-a.left,d.y=s.y-a.top,innerWidth/innerHeight<y.width/y.height?(d.x*=y.width/innerWidth,d.y*=y.width/innerWidth):(d.x*=y.height/innerHeight,d.y*=y.height/innerHeight)},document.onpointerdown=()=>{d.isDown=!0,d.pressPos.x=d.x,d.pressPos.y=d.y},document.onpointerup=()=>{d.isDown=!1,d.justReleased=!0,d.releasePos.x=d.x,d.releasePos.y=d.y},document.body.append(y);let e=new l,t=X(e,0,0),n=e.getComponent(t,h);n.width=1,n.height=1;let o=l.addComponent(t,T);o.zoom=10,o.isActive=!0,l.addComponent(t,S),U(e,"./assets/Map_of_MOBA.svg",0,300,300,300),Y(e,25,15,50,30,s=>{e.getComponent(s,u).clicked&&console.log("clicked")}),L(e,1e3,()=>console.log("TimerUp")),function s(){e.update($,z,q,P,H,F,O,A,D,R,B),d.justReleased=!1,requestAnimationFrame(s)}()}})();
