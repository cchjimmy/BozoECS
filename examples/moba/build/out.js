(()=>{var S=class{storage=[];indices=new Map;objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}addObj(t){let n;return this.size<this.storage.length?n=this.storage[this.size]:(n=this.objectFactory(),this.storage.push(n)),this.indices.set(t,this.size),this.size++,n}removeObj(t){let n=this.indices.get(t)??-1;if(n<0||n>=this.size)return!1;let o=this.storage[n];this.storage[n]=this.storage[this.size-1],this.storage[this.size-1]=o;for(let[r,s]of this.indices)if(s==this.size-1){this.indices.set(r,n);break}return this.indices.delete(t),this.size--,!0}getObj(t){let n=this.indices.get(t)??-1;if(n<0||n>=this.size)throw new Error("Index out of range.");return this.storage[n]}};var p=class e{static pools=new Map;static idMap=new Map;static register(t){e.pools.has(t)||(e.idMap.set(t,e.idMap.size),e.pools.set(t,new S(()=>({...t}))))}static getId(t){return e.idMap.get(t)??-1}static add(t,n){return Object.assign(e.pools.get(n).addObj(t),n)}static delete(t,n){return e.pools.get(n).removeObj(t)}static get(t,n){return e.pools.get(n).getObj(t)}static len(t){return e.pools.get(t).len()}static typeLen(){return e.pools.size}static types(){return e.pools.keys().toArray()}};var i=class e{static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static entitiesToDelete=[];localEntities=new Set;constructor(){e.worlds.push(this)}static createEntity(){let t=Math.random();return e.maskMap.set(t,0),e.getArchetype(0).add(t),t}static copyEntity(t){let n=Math.random(),o=p.types(),r=this.maskMap.get(t)??0;e.maskMap.set(n,r),e.getArchetype(r).add(n);for(let s=0,a=o.length;s<a;s++)r&1<<s&&Object.assign(p.add(n,o[s]),p.get(t,o[s]));return n}static getArchetype(t){let n=e.archetypeMap.get(t)??new Set;return e.archetypeMap.set(t,n),n}static deleteEntity(t){e.entitiesToDelete.push(t)}addEntity(t=e.createEntity()){return this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}static registerComponent(t){return p.register(t),e}static hasComponent(t,n){return((e.maskMap.get(t)??0)&1<<p.getId(n))>0}static addComponent(t,n,o=n){e.registerComponent(n);let r=e.maskMap.get(t)??0,s=p.getId(n);return(r&1<<s)!=0?Object.assign(p.get(t,n),o):(e.getArchetype(r).delete(t),r|=1<<s,e.maskMap.set(t,r),e.getArchetype(r).add(t),Object.assign(p.add(t,n),o))}static removeComponent(t,n){e.registerComponent(n);let o=e.maskMap.get(t)??0,r=p.getId(n);return(o&1<<r)==0?!1:(e.getArchetype(o).delete(t),o&=~(1<<r),e.maskMap.set(t,o),e.getArchetype(o).add(t),p.delete(t,n))}static getComponent(t,n){return p.get(t,n)}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this);for(;e.entitiesToDelete.length;){let n=e.entitiesToDelete.pop();for(let s=0,a=e.worlds.length;s<a;s++)e.worlds[s].localEntities.delete(n);let o=p.types(),r=e.maskMap.get(n)??0;e.maskMap.delete(n),e.getArchetype(r).delete(n);for(let s=0,a=o.length;s<a;s++)r&1<<s&&p.delete(n,o[s])}}query(t){let n=0,o=0;if(t.and)for(let s=0,a=t.and.length;s<a;s++)n|=1<<p.getId(t.and[s]);if(t.not)for(let s=0,a=t.not.length;s<a;s++)o|=1<<p.getId(t.not[s]);let r=[];for(let s=e.archetypeMap.keys().toArray(),a=s.length,h=0;h<a;h++){let d=s[h],u=e.getArchetype(d);u.size!=0&&(d&n)==n&&(d&o)==0&&r.push(...u)}return[...this.localEntities.intersection(new Set(r))]}entityCount(){return this.localEntities.size}};var g={viewport:{width:800,height:400},player:{speed:20},minions:{speed:20,spawnRate:2}};var j={healthPoint:0,attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},y={callback:new Function},l={x:0,y:0,rad:0,scaleX:1,scaleY:1},M={x:0,y:0},X={};var E={spread:0,particleEntity:-1,particleLifetimeSeconds:1,speed:1,emit:!1},k={zoom:20,tilt:0,isActive:!1,targetEntity:-1},f={width:2,height:2},z={src:""},P={hovered:!1,pressed:!1,clicked:!1},T={fill:"white",stroke:"black"},A={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},b={timeMilli:0,reset:!1,stop:!1},C={targetX:0,targetY:0},c=H(),m=K(),U=L(),w=J();function H(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function L(){let e={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!e.isDown[t.key]&&(e.justPressed[t.key]=!0),e.isDown[t.key]=!0},globalThis.onkeyup=t=>{e.isDown[t.key]=!1,e.justReleased[t.key]=!0},e}function G(e){for(let t in e.justPressed)e.justPressed[t]=!1;for(let t in e.justReleased)e.justReleased[t]=!1}function K(){let e={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{e.x=t.x,e.y=t.y,Object.assign(e.pressPos,e),e.isDown=e.justPressed=!0},globalThis.onpointerup=t=>{e.x=t.x,e.y=t.y,Object.assign(e.releasePos,e),e.isDown=!1,e.justReleased=!0},globalThis.onpointermove=t=>{e.x=t.x,e.y=t.y},e}function V(e){e.justPressed=!1,e.justReleased=!1}function J(){return{dtMilli:0,timeMilli:0}}function N(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function Q(e){e.query({and:[E,l]}).forEach(t=>{let n=i.getComponent(t,E);if(!n.emit||!i.hasComponent(n.particleEntity,l))return;n.emit=!1;let o=i.getComponent(t,l),r=i.copyEntity(n.particleEntity),s=i.getComponent(r,l);Object.assign(s,o),e.addEntity(r);let a=i.addComponent(r,b),h=Math.random()>.5,d=o.rad+Math.random()*n.spread*Math.PI*(-1*+h+ +!h);s.rad=d,i.addComponent(r,M,{x:Math.cos(d)*n.speed,y:Math.sin(d)*n.speed}),i.addComponent(r,y).callback=()=>{a.timeMilli<n.particleLifetimeSeconds*1e3||i.deleteEntity(r)}})}function Z(e){let t,n;e.query({and:[k,l]}).forEach(r=>{let s=i.getComponent(r,k);s.isActive&&(t=s,n=i.getComponent(r,l))});let o=D(m.pressPos,c.canvas);e.query({and:[C,X]}).forEach(r=>{if(!t||!n)return;let s=i.getComponent(r,C);if(!m.justPressed)return;let a=ut(o,n,t.tilt,t.zoom);s.targetX=a.x,s.targetY=a.y})}function _(e){e.query({and:[C,l,M,j]}).forEach(t=>{let n=i.getComponent(t,C),o=i.getComponent(t,l),r=i.getComponent(t,M),s=i.getComponent(t,j),a=n.targetX-o.x,h=n.targetY-o.y,d=(a*a+h*h)**.5;if(d==0)return;let u=s.moveSpeed*w.dtMilli/1e3*2,O=d>u?s.moveSpeed:s.moveSpeed*d/u;r.x=a/d*O,r.y=h/d*O})}function tt(e){e.query({and:[b]}).forEach(t=>{i.hasComponent(t,y)&&i.getComponent(t,y).callback(t);let n=i.getComponent(t,b);n.reset&&(n.timeMilli=0),n.reset=!1,n.stop||(n.timeMilli+=w.dtMilli)})}function et(e){e.query({and:[A,l]}).forEach(t=>{let n=i.getComponent(t,A),o=i.getComponent(t,l);c.ctx.font=`${n.fontSize}px serif`;let r=c.ctx.fillStyle,s=n.content.split(`
`);for(let a=0,h=s.length;a<h;a++){let d=c.ctx.measureText(s[a]);c.ctx.fillStyle=n.backgroundColor,c.ctx.fillRect(o.x,o.y+a*(2*n.padding)+a*d.fontBoundingBoxAscent,n.padding*2+d.width,n.padding*2+d.fontBoundingBoxAscent),c.ctx.fillStyle=n.color,c.ctx.fillText(s[a],o.x+n.padding,o.y+a*(2*n.padding)+(a+1)*d.fontBoundingBoxAscent)}c.ctx.fillStyle=r})}function nt(e,t,n,o){let r=e.fillStyle,s=e.strokeStyle;e.fillStyle=o.fill,e.strokeStyle=o.stroke;let a=Math.cos(t.rad),h=Math.sin(t.rad);e.transform(a,h,-h,a,t.x,t.y);let d=new Path2D(`M ${-n.width*.5*t.scaleX} ${-n.height*.5*t.scaleY} h ${n.width*t.scaleX} v ${n.height*t.scaleY} h ${-n.width*t.scaleX} Z`);e.fill(d),e.stroke(d),e.transform(a,-h,h,a,a*-t.x+h*-t.y,-h*-t.x+a*-t.y),e.fillStyle=r,e.strokeStyle=s}function B(e){e.query({and:[l,f,T]}).forEach(t=>{let n=i.getComponent(t,l),o=i.getComponent(t,f),r=i.getComponent(t,T);nt(c.ctx,n,o,r)})}function ot(e){let t=c.ctx.fillStyle;c.ctx.fillStyle="red",e.query({and:[C]}).forEach(n=>{let o=i.getComponent(n,C);c.ctx.fillRect(o.targetX-.5,o.targetY-.5,1,1)}),c.ctx.fillStyle=t}function st(e="#424242"){let t=c.ctx.fillStyle;c.ctx.fillStyle=e,c.ctx.fillRect(0,0,c.canvas.width,c.canvas.height),c.ctx.fillStyle=t}function it(e){e.query({and:[k,l]}).forEach(t=>{let n=i.getComponent(t,k);if(!n.isActive)return;W(c.ctx);let o=i.getComponent(t,l);if(n.targetEntity!=-1&&i.hasComponent(n.targetEntity,l)){let a=i.getComponent(n.targetEntity,l);Object.assign(o,a)}let r=Math.sin(n.tilt)*n.zoom,s=Math.cos(n.tilt)*n.zoom;c.ctx.transform(s,r,-r,s,s*-o.x-r*-o.y+c.ctx.canvas.width*.5,r*-o.x+s*-o.y+c.ctx.canvas.height*.5)})}function rt(e){let t=w.dtMilli/1e3;e.query({and:[l,M]}).forEach(n=>{let o=i.getComponent(n,l),r=i.getComponent(n,M);o.x+=r.x*t,o.y+=r.y*t})}function q(e){e.query({and:[z,l]}).forEach(t=>{let n=i.getComponent(t,z),o=i.getComponent(t,l),r=i.hasComponent(t,f)&&i.getComponent(t,f),s=new Image;s.src=n.src;let a=r?r.width:s.width,h=r?r.height:s.height,d=a/s.width,u=h/s.height;c.ctx.transform(d,0,0,u,0,0),c.ctx.drawImage(s,(o.x-a/2)/d,(o.y-h/2)/u),c.ctx.transform(1/d,0,0,1/u,0,0)})}function at(e){let t=D(m.pressPos,c.canvas),n=D(m.releasePos,c.canvas);e.query({and:[P,l,f,y]}).forEach(o=>{let r=i.getComponent(o,l),s=i.getComponent(o,P),a=i.getComponent(o,f),h=i.getComponent(o,y),d=(t.x-r.x)**2<(a.width/2)**2&&(t.y-r.y)**2<(a.height/2)**2;s.hovered=(m.x-r.x)**2<(a.width/2)**2&&(m.y-r.y)**2<(a.height/2)**2,s.pressed=s.hovered&&m.isDown&&d,s.clicked=m.justReleased&&d&&(n.x-r.x)**2<(a.width/2)**2&&(n.y-r.y)**2<(a.height/2)**2,h.callback(o)})}function ct(e,t,n=0,o=0,r=1,s=1){let a=e.addEntity();return i.addComponent(a,l,{x:n,y:o}),i.addComponent(a,z,{src:t}),i.addComponent(a,f,{width:r,height:s}),a}function F(e,t=0,n=0,o=1,r=1){let s=e.addEntity();return i.addComponent(s,l,{x:t,y:n}),i.addComponent(s,f,{width:o,height:r}),i.addComponent(s,T,{fill:"green"}),s}function dt(e,t=0,n=0,o=10,r=10,s=a=>{}){let a=e.addEntity();return i.addComponent(a,l,{x:t,y:n}),i.addComponent(a,f,{width:o,height:r}),i.addComponent(a,P),i.addComponent(a,T),i.addComponent(a,y,{callback:s}),a}function lt(e,t){let n=e.addEntity();return i.addComponent(n,b),i.addComponent(n,y).callback=t,n}function ht(e,t=0,n=0){let o=F(e,t,n,1,1);return i.addComponent(o,M),i.addComponent(o,j,{moveSpeed:g.player.speed}),i.addComponent(o,X),i.addComponent(o,C,{targetX:t,targetY:n}),o}function pt(e,t,n){let o=F(e,t,n,3,10);return i.addComponent(o,j),o}function gt(e,t,n){let o=e.addEntity();return i.addComponent(o,k,{zoom:30}),i.addComponent(o,l,{x:t,y:n}),o}function ut(e,t,n,o){let r=Math.cos(n),s=Math.sin(n),a={x:0,y:0},h=e.x-g.viewport.width/2,d=e.y-g.viewport.height/2;return a.x=r*h+s*d,a.y=-s*h+r*d,a.x/=o,a.y/=o,a.x+=t.x,a.y+=t.y,a}function W(e){e.resetTransform()}function mt(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function D(e,t){let n={x:0,y:0},o=t.getBoundingClientRect();return n.x=e.x-o.left,n.y=e.y-o.top,innerWidth/innerHeight<t.width/t.height?(n.x*=t.width/innerWidth,n.y*=t.width/innerWidth):(n.x*=t.height/innerHeight,n.y*=t.height/innerHeight),n}c.canvas.width=g.viewport.width;c.canvas.height=g.viewport.height;c.canvas.style.imageRendering="pixelated";c.ctx.lineWidth=.1;var x=new i,v=ht(x,0,0),ft=pt(x,10,0),Tt=ct(x,"./assets/Map_of_MOBA.svg",0,0,300,300),yt=gt(x,0,0),R=i.getComponent(yt,k);R.targetEntity=v;R.isActive=!0;R.zoom=20;i.addComponent(v,E,{particleEntity:ft,speed:20,particleLifetimeSeconds:1,spread:.2});lt(x,e=>{let t=i.getComponent(e,b);if(!(t.timeMilli<100)){if(t.reset=!0,!i.hasComponent(v,E)){i.deleteEntity(e);return}i.getComponent(v,E).emit=!0}});var I=new i;dt(I,g.viewport.width*.9,g.viewport.height*.8,g.viewport.height*.3,g.viewport.height*.3,e=>{i.getComponent(e,P).clicked&&console.log("clicked")});var Y=I.addEntity(),Ct=i.addComponent(Y,A,{content:"test string",backgroundColor:"white"});i.addComponent(Y,l);(function e(){i.getComponent(v,l).rad+=1*w.dtMilli/1e3,Ct.content=`FPS: ${Math.ceil(1e3/w.dtMilli)}
Entity count: ${x.entityCount()}
Device type: ${mt()}`,st(),x.update(tt,it,_,Z,Q,q,B,ot,rt),W(c.ctx),I.update(q,B,et,at),V(m),G(U),N(w),requestAnimationFrame(e)})();})();
//# sourceMappingURL=out.js.map
