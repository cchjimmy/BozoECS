(()=>{var b=class{storage=[];objectConstructor;size=0;constructor(t){this.objectConstructor=t}len(){return this.size}addObj(){let t;return this.storage[this.size]?t=this.storage[this.size]:(t=this.objectConstructor(),this.storage.push(t)),this.size++,t}findIndex(t){return this.storage.findIndex(e=>e==t)}removeObj(t){if(t>=this.size)throw new Error("Index out of range.");let e=this.storage[t];return this.storage[t]=this.storage[this.storage.length-1],this.storage[this.storage.length-1]=e,this.size--,e}getObj(t){if(t>=this.size)throw new Error("Index out of range.");return this.storage[t]}};var u=class n{static pools=new Map;static idMap=new Map;static register(t){n.idMap.set(t,n.idMap.size),n.pools.set(t,new b(()=>({...t})))}static getId(t){return n.idMap.get(t)??-1}static add(t){return n.pools.get(t).addObj()}static delete(t,e){return n.pools.get(t).removeObj(e)}static get(t,e){return n.pools.get(t).getObj(e)}static len(t){return n.pools.get(t).len()}static typeLen(){return n.pools.size}static types(){return n.pools.keys().toArray()}};var x=class n{static nextId=0;static pool=new b(()=>n.nextId++);static add(){return n.pool.addObj()}static findIndex(t){return n.pool.findIndex(t)}static delete(t){return n.pool.removeObj(t)}};var a=class n{static indexMap=new Map;static maskMap=new Map;static archetypeMap=new Map;static worlds=[];static removeMap=new Map;static ownerMap=new Map;timeMilli=0;dtMilli=0;localEntities=new Set;constructor(){n.worlds.push(this)}static createEntity(){let t=x.add();return n.maskMap.set(t,0),n.getArchetype(0).add(t),t}static getArchetype(t){let e=n.archetypeMap.get(t);if(e==null){let o=new Set;return n.archetypeMap.set(t,o),o}return e}static deleteEntity(t){for(let o=0,s=n.worlds.length;o<s;o++)n.worlds[o].removeEntity(t);let e=u.types();for(let o=0,s=u.typeLen();o<s;o++){if(!(n.getMask(t)&1<<o))continue;n.getRemoveFn(o)(t);let i=n.getIndices(e[o]),r=n.getOwners(e[o]),c=n.getOwner(r,r.size-1),d=n.getIndex(i,t);r.set(d,c),i.set(c,d)}n.getArchetype(n.getMask(t)).delete(t),n.maskMap.set(t,0),x.delete(x.findIndex(t))}static getRemoveFn(t){let e=n.removeMap.get(t);if(e==null)throw new Error("Component not registered.");return e}addEntity(t){return t??=n.createEntity(),this.localEntities.add(t),t}removeEntity(t){this.localEntities.delete(t)}entityExists(t){return this.localEntities.has(t)}static componentExists(t){n.indexMap.has(t)||n.registerComponent(t)}static registerComponent(t){return u.register(t),n.indexMap.set(t,new Map),n.removeMap.set(u.getId(t),e=>u.delete(t,n.getIndex(n.getIndices(t),e))),n.ownerMap.set(t,new Map),n}static hasComponent(t,e){return(n.getMask(t)&1<<u.getId(e))>0}static addComponent(t,e){n.componentExists(e);let o=n.getMask(t),s=u.getId(e);if((o&1<<s)!=0)throw new Error(`Entity ${t} already had that component.`);n.getArchetype(o).delete(t),o|=1<<s,n.maskMap.set(t,o),n.getArchetype(o).add(t);let i=u.len(e);return n.getIndices(e).set(t,i),n.getOwners(e).set(i,t),u.add(e)}static getIndices(t){let e=n.indexMap.get(t);if(e==null)throw new Error("Component not registered.");return e}static getIndex(t,e){let o=t.get(e);if(o==null)throw new Error(`Entity ${e} does not exist.`);return o}static getOwners(t){let e=n.ownerMap.get(t);if(e==null)throw new Error("Component not registered.");return e}static getOwner(t,e){let o=t.get(e);if(o==null)throw new Error("Owner not found.");return o}static removeComponent(t,e){n.componentExists(e);let o=n.getMask(t),s=u.getId(e);if((o&1<<s)==0)throw new Error(`Entity ${t} does not have that component.`);n.getArchetype(o).delete(t),o&=~(1<<s),n.maskMap.set(t,o),n.getArchetype(o).add(t);let i=n.getIndices(e),r=n.getOwners(e),c=n.getIndex(i,t),d=u.delete(e,c),g=n.getOwner(r,r.size-1);return r.set(c,g),i.set(g,c),d}static getMask(t){return n.maskMap.get(t)??-1}static getComponent(t,e){if(!n.hasComponent(t,e))throw new Error(`Entity ${t} does not have that component.`);return u.get(e,n.getIndex(n.getIndices(e),t))}update(...t){for(let e=0,o=t.length;e<o;e++)t[e](this);this.dtMilli=performance.now()-this.timeMilli,this.timeMilli+=this.dtMilli}query(t){let e=0,o=0,s=0;if(t.and)for(let r=0,c=t.and.length;r<c;r++)e|=1<<u.getId(t.and[r]);if(t.or)for(let r=0,c=t.or.length;r<c;r++)o|=1<<u.getId(t.or[r]);if(t.not)for(let r=0,c=t.not.length;r<c;r++)s|=1<<u.getId(t.not[r]);let i=[];for(let r=n.archetypeMap.keys().toArray(),c=r.length,d=0,g=r[d];d<c;d++,g=r[d])(g&e)==e&&(g|o)>0&&(g&s)==0&&i.push(...this.localEntities.intersection(n.getArchetype(g)));return i}entityCount(){return this.localEntities.size}};var m={viewport:{width:800,height:400},player:{speed:20}};var v={max:100};var h={x:0,y:0,rad:0,scaleX:1,scaleY:1},w={x:0,y:0},R={},T={zoom:1,tilt:0,isActive:!1},y={width:2,height:2},E={src:""},C={hovered:!1,pressed:!1,clicked:!1,callback:n=>{}},j={fill:"white",stroke:"black"},P={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},O={durationMilli:1e3,startMilli:0,callback:n=>{}},M={targetX:0,targetY:0,deactivateTolerance:1},p={x:0,y:0,isDown:!1,pressPos:{x:0,y:0},justPressed:!1,justReleased:!1,releasePos:{x:0,y:0}},k={};function q(n){n.query({and:[M,T,R,h]}).forEach(t=>{let e=a.getComponent(t,M),o=a.getComponent(t,T),s=a.getComponent(t,h);if(p.justPressed){let i=B({x:p.x,y:p.y},s,o.tilt,o.zoom);e.targetX=i.x,e.targetY=i.y}k.q&&(o.tilt+=1*n.dtMilli/1e3),k.e&&(o.tilt-=1*n.dtMilli/1e3)})}function D(n){n.query({and:[M,h,w,v]}).forEach(t=>{let e=a.getComponent(t,M),o=a.getComponent(t,h),s=a.getComponent(t,w),i=a.getComponent(t,v),r=e.targetX-o.x,c=e.targetY-o.y,d=(r*r+c*c)**.5;if(d<e.deactivateTolerance){s.x=s.y=0;return}s.x=r/d*i.max,s.y=c/d*i.max})}function F(n){n.query({and:[O]}).forEach(t=>{let e=a.getComponent(t,O);n.timeMilli-e.startMilli<e.durationMilli||(e.startMilli=n.timeMilli,e.callback(t))})}function X(n){l&&n.query({and:[P,h]}).forEach(t=>{let e=a.getComponent(t,P),o=a.getComponent(t,h);l.font=`${e.fontSize}px serif`;let s=l.measureText(e.content),i=l.fillStyle;l.fillStyle=e.backgroundColor,l.fillRect(o.x,o.y,e.padding*2+s.width,e.padding*2+s.fontBoundingBoxAscent),l.fillStyle=e.color,l.fillText(e.content,o.x+e.padding,o.y+e.padding+s.fontBoundingBoxAscent),l.fillStyle=i})}function Y(n,t,e,o){let s=n.fillStyle,i=n.strokeStyle;n.fillStyle=o.fill,n.strokeStyle=o.stroke;let r=new Path2D(`M ${t.x-e.width*.5} ${t.y-e.height*.5} h ${e.width} v ${e.height} h ${-e.width} Z`);n.fill(r),n.stroke(r),n.fillStyle=s,n.strokeStyle=i}function z(n){l&&n.query({and:[h,y,j]}).forEach(t=>{let e=a.getComponent(t,h),o=a.getComponent(t,y),s=a.getComponent(t,j);Y(l,e,o,s)})}function H(){if(!l)return;let n=l.fillStyle;l.fillStyle="#424242",l.fillRect(0,0,l.canvas.width,l.canvas.height),l.fillStyle=n}function G(n){n.query({and:[T,h,w]}).forEach(t=>{let e=a.getComponent(t,T);if(!l||!e.isActive)return;let o=a.getComponent(t,h),s=Math.sin(e.tilt),i=Math.cos(e.tilt),r=-o.x*e.zoom,c=-o.y*e.zoom;l.transform(i*e.zoom,s*e.zoom,-s*e.zoom,i*e.zoom,i*r+s*c+l.canvas.width*.5,-s*r+i*c+l.canvas.height*.5);let d=a.getComponent(t,w),g=d.x,I=d.y;d.x=i*g-s*I,d.y=s*g+i*I})}function K(n){let t=n.dtMilli/1e3;n.query({and:[h,w]}).forEach(e=>{let o=a.getComponent(e,h),s=a.getComponent(e,w);o.x+=s.x*t,o.y+=s.y*t})}function S(n){l&&n.query({and:[E,h],or:[y]}).forEach(t=>{let e=a.getComponent(t,E),o=a.getComponent(t,h),s=a.hasComponent(t,y)&&a.getComponent(t,y),i=new Image;i.src=e.src;let r=s?s.width:i.width,c=s?s.height:i.height,d=r/i.width,g=c/i.height;l.transform(d,0,0,g,0,0),l.drawImage(i,(o.x-r/2)/d,(o.y-c/2)/g),l.transform(1/d,0,0,1/g,0,0)})}function L(n){n.query({and:[C,h,y]}).forEach(t=>{let e=a.getComponent(t,h),o=a.getComponent(t,C),s=a.getComponent(t,y),i=(p.pressPos.x-e.x)**2<(s.width/2)**2&&(p.pressPos.y-e.y)**2<(s.height/2)**2;o.hovered=(p.x-e.x)**2<(s.width/2)**2&&(p.y-e.y)**2<(s.height/2)**2,o.pressed=o.hovered&&p.isDown&&i,o.clicked=p.justReleased&&i&&(p.releasePos.x-e.x)**2<(s.width/2)**2&&(p.releasePos.y-e.y)**2<(s.height/2)**2,o.callback(t)})}function U(){l&&l.setTransform(1,0,0,1,0,0)}function W(n,t,e=0,o=0,s=1,i=1){let r=n.addEntity(),c=a.addComponent(r,h),d=a.addComponent(r,E),g=a.addComponent(r,y);return c.x=e,c.y=o,d.src=t,g.width=s,g.height=i,r}function A(n,t=0,e=0){let o=n.addEntity(),s=a.addComponent(o,h);a.addComponent(o,w),a.addComponent(o,v),a.addComponent(o,y);let i=a.addComponent(o,j);return i.fill="green",s.x=t,s.y=e,o}function V(n,t=0,e=0,o=10,s=10,i=()=>{}){let r=n.addEntity(),c=a.addComponent(r,h),d=a.addComponent(r,y),g=a.addComponent(r,C);return a.addComponent(r,j),c.x=t,c.y=e,d.width=o,d.height=s,g.callback=i,r}function J(n){let t=A(n,0,0),e=a.getComponent(t,y);e.width=1,e.height=1;let o=a.getComponent(t,v);o.max=10;let s=a.addComponent(t,T);return s.zoom=30,s.isActive=!0,a.addComponent(t,R),a.addComponent(t,M),t}function B(n,t,e,o){let s=Math.cos(e),i=Math.sin(e),r={x:0,y:0},c=n.x-m.viewport.width/2,d=n.y-m.viewport.height/2;return r.x=s*c-i*d,r.y=i*c+s*d,r.x/=o,r.y/=o,r.x+=t.x,r.y+=t.y,r}var f=document.querySelector("canvas"),l=f?.getContext("2d");if(f&&l){f.width=m.viewport.width,f.height=m.viewport.height,f.style.imageRendering="pixelated",l.lineWidth=.1,document.onkeydown=s=>{k[s.key]=!0},document.onkeyup=s=>{delete k[s.key]},document.onpointermove=s=>{let i=f.getBoundingClientRect();p.x=s.x-i.left,p.y=s.y-i.top,innerWidth/innerHeight<f.width/f.height?(p.x*=f.width/innerWidth,p.y*=f.width/innerWidth):(p.x*=f.height/innerHeight,p.y*=f.height/innerHeight)},document.onpointerdown=()=>{p.isDown=!0,p.justPressed=!0,Object.assign(p.pressPos,p);let s=a.getComponent(e,h),i=a.getComponent(t,h),r=a.getComponent(t,T),c=B(p,i,r.tilt,r.zoom);Object.assign(s,c)},document.onpointerup=()=>{p.isDown=!1,p.justReleased=!0,Object.assign(p.releasePos,p)},document.body.append(f);let n=new a,t=J(n),e=A(n);W(n,"./assets/Map_of_MOBA.svg",0,0,300,300);let o=new a;V(o,m.viewport.width*.9,m.viewport.height*.8,m.viewport.height*.3,m.viewport.height*.3,s=>{a.getComponent(s,C).clicked&&console.log("clicked")}),W(o,"./assets/Map_of_MOBA.svg",m.viewport.width*.1,m.viewport.height*.2,m.viewport.height*.3,m.viewport.height*.3),function s(){H(),n.update(F,G,D,q,S,z,K),U(),o.update(S,z,X,L),p.justReleased=!1,p.justPressed=!1,requestAnimationFrame(s)}()}})();
//# sourceMappingURL=out.js.map
