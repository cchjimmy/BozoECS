(()=>{var I=class{storage=[];keyToIndex=new Map;indexToKey=[];objectFactory;size=0;constructor(t){this.objectFactory=t}len(){return this.size}add(t){let n=this.keyToIndex.get(t);return n!=null?this.storage[n]:(this.size>=this.storage.length&&this.storage.push(this.objectFactory()),this.keyToIndex.set(t,this.size),this.indexToKey[this.size]=t,this.size++,this.storage[this.size-1])}remove(t){let n=this.keyToIndex.get(t)??-1,o=this.indexToKey[this.size-1];if(n<0||n>=this.size||!o)return!1;let s=this.storage[n];return this.storage[n]=this.storage[this.size-1],this.storage[this.size-1]=s,this.keyToIndex.set(o,n),this.keyToIndex.delete(t),this.indexToKey[n]=o,this.size--,!0}get(t){let n=this.keyToIndex.get(t)??-1;if(n<0||n>=this.size)throw new Error("Index out of range.");return this.storage[n]}has(t){return this.keyToIndex.has(t)}clean(){this.storage.splice(this.size),this.indexToKey.splice(this.size);for(let t of this.keyToIndex.keys()){let n=this.keyToIndex.get(t)??-1;(n<0||n>=this.size)&&this.keyToIndex.delete(t)}}};var R=class{pools=new Map;idMap=new Map;register(t){this.pools.has(t)||(this.idMap.set(t,this.idMap.size),this.pools.set(t,new I(()=>({...t}))))}getId(t){return this.idMap.get(t)??-1}add(t,n){return Object.assign(this.pools.get(n).add(t),n)}remove(t,n){return this.pools.get(n).remove(t)}get(t,n){return this.pools.get(n).get(t)}len(t){return this.pools.get(t).len()}delete(t){for(let n of this.pools.values())n.remove(t)}copy(t,n){for(let o of this.pools.values()){let s=o;s.has(t)&&Object.assign(s.add(n),s.get(t))}}clean(){for(let t of this.pools.values())t.clean()}};function w(){return Math.random()}var T=class{maskMap=new Map;archetypeMap=new Map;entitiesToDelete=[];compManager=new R;frameCount=0;cleanUpMinutes=5;constructor(t=5){this.cleanUpMinutes=t}addEntity(t=w()){return this.maskMap.set(t,0),this.getArchetype(0).add(t),t}copyEntity(t,n=w()){this.compManager.copy(t,n);let o=this.maskMap.get(t)??0;return this.maskMap.set(n,o),this.getArchetype(o).add(n),n}getArchetype(t){let n=this.archetypeMap.get(t)??new Set;return this.archetypeMap.set(t,n),n}deleteEntity(t){this.entitiesToDelete.push(t)}registerComponent(t){return this.compManager.register(t),this}hasComponent(t,n){return((this.maskMap.get(t)??0)&1<<this.compManager.getId(n))>0}addComponent(t,n,o=n){this.registerComponent(n);let s=this.maskMap.get(t)??0,a=this.compManager.getId(n);return(s&1<<a)!=0?Object.assign(this.compManager.get(t,n),o):(this.getArchetype(s).delete(t),s|=1<<a,this.maskMap.set(t,s),this.getArchetype(s).add(t),Object.assign(this.compManager.add(t,n),o))}removeComponent(t,n){this.registerComponent(n);let o=this.maskMap.get(t)??0,s=this.compManager.getId(n);return(o&1<<s)==0?!1:(this.getArchetype(o).delete(t),o&=~(1<<s),this.maskMap.set(t,o),this.getArchetype(o).add(t),this.compManager.remove(t,n))}getComponent(t,n){return this.compManager.get(t,n)}update(...t){for(let n=0,o=t.length;n<o;n++)t[n](this);this.commitEntityDeletion(),this.frameCount%(this.cleanUpMinutes*60*60)==0&&this.cleanObjectPools(),this.frameCount++}commitEntityDeletion(){for(;this.entitiesToDelete.length;){let t=this.entitiesToDelete.pop();this.compManager.delete(t);let n=this.maskMap.get(t)??0;this.maskMap.delete(t),this.getArchetype(n).delete(t)}}cleanObjectPools(){this.compManager.clean()}query(t){let n=0,o=0;if(t.and)for(let a=0,i=t.and.length;a<i;a++)n|=1<<this.compManager.getId(t.and[a]);if(t.not)for(let a=0,i=t.not.length;a<i;a++)o|=1<<this.compManager.getId(t.not[a]);let s=[];return this.archetypeMap.forEach((a,i)=>{let r=this.getArchetype(i);r.size>0&&(i&n)==n&&(i&o)==0&&s.push(...r)}),[...new Set(s)]}entityCount(){return this.maskMap.size}};var p={viewport:{width:800,height:400},entities:{player:{healthPoint:10,moveSpeed:20},minion:{healthPoint:15,spawnRate:2},turrent:{healthPoint:100,abilityPower:100}}};var A={attackPoint:0,defencePoint:0,abilityPower:0,moveSpeed:0,attackSpeed:0},b={current:0,max:0},x={callback:new Function},h={x:0,y:0,rad:0,scaleX:1,scaleY:1},E={x:0,y:0},L={};var P={},Y={spreadRadians:0,particleEntity:-1,particleLifetimeSeconds:1,speed:1,emit:!1,particleTransition:function(e,t,n){let o=e.getComponent(t,h);o.scaleX=o.scaleY=-(n**2)+1}},u={zoom:20,tilt:0,isActive:!1,targetEntity:-1},g={width:1,height:1,offsetX:.5,offsetY:.5},B={src:""},X={hovered:!1,pressed:!1,clicked:!1},q={fill:"white",stroke:"black"},O={content:"",fontSize:20,padding:3,color:"black",backgroundColor:"white"},v={timeMilli:0,reset:!1,stop:!1},S={targetX:0,targetY:0},c=J(),f=Z(),V=N(),j=et(),W=!0;function J(){let e=document.querySelector("canvas")??document.createElement("canvas");if(!e)throw new Error("Cannot create canvas element.");let t=e.getContext("2d");if(!t)throw new Error("Cannot initialize context 2d.");return document.body.appendChild(e),globalThis.onresize=globalThis.onload=()=>{innerWidth/innerHeight<e.width/e.height?(e.style.width="100%",e.style.height=""):(e.style.width="",e.style.height="100%")},{canvas:e,ctx:t}}function N(){let e={isDown:{},justPressed:{},justReleased:{}};return globalThis.onkeydown=t=>{!e.isDown[t.key]&&(e.justPressed[t.key]=!0),e.isDown[t.key]=!0},globalThis.onkeyup=t=>{e.isDown[t.key]=!1,e.justReleased[t.key]=!0},e}function Q(e){for(let t in e.justPressed)e.justPressed[t]=!1;for(let t in e.justReleased)e.justReleased[t]=!1}function Z(){let e={x:0,y:0,isDown:!1,justPressed:!1,justReleased:!1,pressPos:{x:0,y:0},releasePos:{x:0,y:0}};return globalThis.onpointerdown=t=>{t.target instanceof HTMLCanvasElement&&(e.x=t.x,e.y=t.y,Object.assign(e.pressPos,e),e.isDown=e.justPressed=!0)},globalThis.onpointerup=t=>{e.x=t.x,e.y=t.y,Object.assign(e.releasePos,e),e.isDown=!1,e.justReleased=!0},globalThis.onpointermove=t=>{e.x=t.x,e.y=t.y},e}function tt(e){e.justPressed=!1,e.justReleased=!1}function et(){return{dtMilli:0,timeMilli:0}}function nt(e){e.dtMilli=performance.now()-e.timeMilli,e.timeMilli+=e.dtMilli}function ot(e){let t=e.query({and:[u,h]}).find(s=>e.getComponent(s,u).isActive);if(!t)return;let n=e.getComponent(t,u),o=e.getComponent(t,h);e.query({and:[g,h]}).forEach(s=>{e.removeComponent(s,P);let a=e.getComponent(s,g),i=e.getComponent(s,h);Ct(o.x,o.y,c.canvas.width/n.zoom,c.canvas.height/n.zoom,i.x+a.offsetX+a.width/2,i.y+a.offsetY+a.height/2,a.width,a.height)&&e.addComponent(s,P)})}function st(e){e.query({and:[Y,h]}).forEach(t=>{let n=e.getComponent(t,Y);if(!n.emit||!e.hasComponent(n.particleEntity,h))return;n.emit=!1;let o=e.getComponent(t,h),s=e.copyEntity(n.particleEntity),a=e.getComponent(s,h);Object.assign(a,o);let i=e.addComponent(s,v),r=o.rad+(Math.random()*2-1)*n.spreadRadians*.5;a.rad=r,e.addComponent(s,E,{x:Math.cos(r)*n.speed,y:Math.sin(r)*n.speed}),e.addComponent(s,x).callback=()=>{if(i.timeMilli<n.particleLifetimeSeconds*1e3){n.particleTransition(e,s,i.timeMilli/1e3/n.particleLifetimeSeconds);return}e.deleteEntity(s)}})}function it(e){let t=e.query({and:[u,h]}).find(a=>e.getComponent(a,u).isActive);if(t==null)return;let n=e.getComponent(t,u),o=e.getComponent(t,h),s=D(f.pressPos,c.canvas);e.query({and:[S,L]}).forEach(a=>{if(!f.justPressed||!W)return;let i=e.getComponent(a,S),r=Mt(s,o,n.tilt,n.zoom);i.targetX=r.x,i.targetY=r.y})}function at(e){e.query({and:[S,h,E,A]}).forEach(t=>{let n=e.getComponent(t,S),o=e.getComponent(t,h),s=e.getComponent(t,E),a=e.getComponent(t,A),i=n.targetX-o.x,r=n.targetY-o.y,l=(i*i+r*r)**.5;if(l==0)return;let m=a.moveSpeed*j.dtMilli/1e3*2,y=l>m?a.moveSpeed:a.moveSpeed*l/m;s.x=i/l*y,s.y=r/l*y})}function ct(e){e.query({and:[v,x]}).forEach(t=>e.getComponent(t,x).callback(t)),e.query({and:[v]}).forEach(t=>{let n=e.getComponent(t,v);n.reset&&(n.timeMilli=0),n.reset=!1,n.stop||(n.timeMilli+=j.dtMilli)})}function rt(e){e.query({and:[O,h]}).forEach(t=>{let n=e.getComponent(t,O),o=e.getComponent(t,h);c.ctx.font=`${n.fontSize}px serif`;let s=c.ctx.fillStyle,a=n.content.split(`
`);for(let i=0,r=a.length;i<r;i++){let l=c.ctx.measureText(a[i]);c.ctx.fillStyle=n.backgroundColor,c.ctx.fillRect(o.x,o.y+i*(2*n.padding)+i*l.fontBoundingBoxAscent,n.padding*2+l.width,n.padding*2+l.fontBoundingBoxAscent),c.ctx.fillStyle=n.color,c.ctx.fillText(a[i],o.x+n.padding,o.y+i*(2*n.padding)+(i+1)*l.fontBoundingBoxAscent)}c.ctx.fillStyle=s})}function H(e){e.query({and:[h,g,q,P]}).forEach(t=>{let n=e.getComponent(t,h),o=e.getComponent(t,g),s=e.getComponent(t,q),a=c.ctx.fillStyle,i=c.ctx.strokeStyle;c.ctx.fillStyle=s.fill,c.ctx.strokeStyle=s.stroke;let r=Math.cos(n.rad),l=Math.sin(n.rad);c.ctx.transform(r,l,-l,r,n.x,n.y),c.ctx.fillRect(o.offsetX*n.scaleX,o.offsetY*n.scaleY,o.width*n.scaleX,o.height*n.scaleY),c.ctx.strokeRect(o.offsetX*n.scaleX,o.offsetY*n.scaleY,o.width*n.scaleX,o.height*n.scaleY),c.ctx.transform(r,-l,l,r,r*-n.x+l*-n.y,-l*-n.x+r*-n.y),c.ctx.fillStyle=a,c.ctx.strokeStyle=i})}function ht(e){let t=e.query({and:[u,h]}).find(i=>e.getComponent(i,u).isActive);if(!t)return;c.ctx.resetTransform();let n=e.getComponent(t,u),o=e.getComponent(t,h);if(n.targetEntity!=-1&&e.hasComponent(n.targetEntity,h)){let i=e.getComponent(n.targetEntity,h);Object.assign(o,i)}let s=Math.sin(n.tilt)*n.zoom,a=Math.cos(n.tilt)*n.zoom;c.ctx.transform(a,s,-s,a,a*-o.x-s*-o.y+c.ctx.canvas.width*.5,s*-o.x+a*-o.y+c.ctx.canvas.height*.5)}function lt(e){let t=j.dtMilli/1e3;e.query({and:[h,E]}).forEach(n=>{let o=e.getComponent(n,h),s=e.getComponent(n,E);o.x+=s.x*t,o.y+=s.y*t})}function U(e){e.query({and:[B,h]}).forEach(t=>{let n=e.getComponent(t,B),o=e.getComponent(t,h),s=e.hasComponent(t,g)&&e.getComponent(t,g),a=new Image;a.src=n.src;let i=s?s.width:a.width,r=s?s.height:a.height,l=i/a.width,m=r/a.height;c.ctx.transform(l,0,0,m,0,0),c.ctx.drawImage(a,(o.x-i/2)/l,(o.y-r/2)/m),c.ctx.transform(1/l,0,0,1/m,0,0)})}function dt(e){let t=D(f.pressPos,c.canvas),n=D(f.releasePos,c.canvas),o=D({x:f.x,y:f.y},c.canvas);e.query({and:[X,h,g,x]}).forEach(s=>{let a=e.getComponent(s,h),i=e.getComponent(s,X),r=e.getComponent(s,g),l=e.getComponent(s,x),m=(t.x-a.x)**2<(r.width/2)**2&&(t.y-a.y)**2<(r.height/2)**2;i.hovered=(o.x-a.x)**2<(r.width/2)**2&&(o.y-a.y)**2<(r.height/2)**2,i.pressed=i.hovered&&f.isDown&&m,i.clicked=f.justReleased&&m&&(n.x-a.x)**2<(r.width/2)**2&&(n.y-a.y)**2<(r.height/2)**2,i.hovered&&(W=!1),l.callback(s)})}function pt(e){e.query({and:[P,b,h,g]}).forEach(t=>{let n=e.getComponent(t,h),o=e.getComponent(t,g),s=e.getComponent(t,b),a=Math.cos(n.rad),i=Math.sin(n.rad),r=c.ctx.strokeStyle,l=c.ctx.fillStyle,m=c.ctx.lineWidth;c.ctx.fillStyle="black";let y=o.width*1.5,M=-y/2,k=o.offsetY*n.scaleY-1;c.ctx.fillRect(n.x+a*M-i*k,n.y+i*M+a*k,y,.3),c.ctx.fillStyle="green",c.ctx.fillRect(n.x+a*M-i*k,n.y+i*M+a*k,y*(s.current/s.max),.3),c.ctx.strokeStyle="black",c.ctx.lineWidth=.1,c.ctx.strokeRect(n.x+a*M-i*k,n.y+i*M+a*k,y,.3),c.ctx.strokeStyle=r,c.ctx.fillStyle=l,c.ctx.lineWidth=m})}function gt(e,t,n=0,o=0,s=1,a=1){let i=e.addEntity();return e.addComponent(i,h,{x:n,y:o}),e.addComponent(i,B,{src:t}),e.addComponent(i,g,{width:s,height:a}),i}function F(e,t=0,n=0,o=1,s=1,a=-o/2,i=-s/2){let r=e.addEntity();return e.addComponent(r,h,{x:t,y:n}),e.addComponent(r,g,{width:o,height:s,offsetX:a,offsetY:i}),e.addComponent(r,q),e.addComponent(r,P),r}function mt(e,t=0,n=0,o=10,s=10,a=i=>{}){let i=F(e,t,n,o,s);return e.addComponent(i,X),e.addComponent(i,q),e.addComponent(i,x,{callback:a}),i}function ut(e,t=0,n=0){let o=F(e,t,n,1,1);return e.addComponent(o,E),e.addComponent(o,A,{...p.entities.player}),e.addComponent(o,b,{max:p.entities.player.healthPoint,current:p.entities.player.healthPoint}),e.addComponent(o,L),e.addComponent(o,S,{targetX:t,targetY:n}),o}function ft(e,t,n){let o=F(e,t,n,3,10,-1.5,-10);return e.addComponent(o,A,{...p.entities.turrent}),e.addComponent(o,b,{max:p.entities.turrent.healthPoint,current:p.entities.turrent.healthPoint}),o}function yt(e,t,n){let o=e.addEntity();return e.addComponent(o,u,{zoom:30}),e.addComponent(o,h,{x:t,y:n}),o}function xt(e="#424242"){let t=c.ctx.fillStyle;c.ctx.fillStyle=e,c.ctx.fillRect(0,0,c.canvas.width,c.canvas.height),c.ctx.fillStyle=t}function Ct(e,t,n,o,s,a,i,r){return(e-s)**2<((n+i)/2)**2&&(t-a)**2<((o+r)/2)**2}function Mt(e,t,n,o){let s=Math.cos(n),a=Math.sin(n),i={x:0,y:0},r=e.x-p.viewport.width/2,l=e.y-p.viewport.height/2;return i.x=s*r+a*l,i.y=-a*r+s*l,i.x/=o,i.y/=o,i.x+=t.x,i.y+=t.y,i}function kt(){return/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)?"Mobile":"Desktop"}function D(e,t){let n={x:0,y:0},o=t.getBoundingClientRect();return n.x=e.x-o.left,n.y=e.y-o.top,innerWidth/innerHeight<t.width/t.height?(n.x*=t.width/innerWidth,n.y*=t.width/innerWidth):(n.x*=t.height/innerHeight,n.y*=t.height/innerHeight),n}c.canvas.width=p.viewport.width;c.canvas.height=p.viewport.height;c.canvas.style.imageRendering="pixelated";c.ctx.lineWidth=.1;var d=new T,z=ft(d,10,0);d.addComponent(z,Y,{particleEntity:z,speed:20,spreadRadians:Math.PI*.25});d.addComponent(z,v);d.addComponent(z,x).callback=e=>{let t=d.getComponent(e,v);t.timeMilli<50||(t.reset=!0,d.getComponent(e,Y).emit=!0)};for(let e=0;e<2;e++)d.getComponent(d.copyEntity(z),h).y+=15*(e+1);var _=ut(d,0,0);d.getComponent(_,b).current*=.6;var qt=gt(d,"./assets/Map_of_MOBA.svg",0,0,300,300),vt=yt(d,0,0),K=d.getComponent(vt,u);K.targetEntity=_;K.isActive=!0;K.zoom=15;var C=new T;mt(C,p.viewport.width*.9,p.viewport.height*.8,p.viewport.height*.3,p.viewport.height*.3,e=>{let t=C.getComponent(e,X);t.clicked&&console.log("clicked"),t.hovered&&console.log("hovered")});var $=C.addEntity(),Et=C.addComponent($,O,{content:"test string",backgroundColor:"white"});C.addComponent($,h);(function e(){requestAnimationFrame(e),Et.content=`FPS: ${Math.ceil(1e3/j.dtMilli)}
Entity count: ${d.entityCount()}
Device type: ${kt()}`,xt(),d.update(ht,ot,U,H,pt),c.ctx.resetTransform(),C.update(U,H,rt),C.update(dt),d.update(ct,at,it,st,lt),tt(f),Q(V),nt(j),W=!0})();})();
//# sourceMappingURL=out.js.map
