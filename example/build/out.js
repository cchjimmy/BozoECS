(()=>{var u=class{reserve;active;objectConstructor;constructor(t){this.reserve=[],this.active=[],this.objectConstructor=t}addObj(){return this.active.push(this.reserve.pop()??this.objectConstructor()),this.active[this.active.length-1]}findIndex(t){return this.active.findIndex(e=>e==t)}removeObj(t){let e=this.active[t];return this.active[t]=this.active[--this.active.length],this.reserve.push(e),e}len(){return this.active.length}};var y=class{static id=-1;owner=-1},f=class{pools=[];register(t){t.id==-1&&(t.id=this.pools.length),this.pools[t.id]??=new u(()=>new t)}isRegistered(t){return!!this.pools[t.id]}add(t){return this.pools[t.id].addObj()}delete(t,e){return this.pools[t.id].removeObj(e)}get(t,e){return this.pools[t.id].active[e]}len(t){return this.pools[t.id].len()}};function x(...n){return n.reduce((t,e)=>t|=1<<e.id,0)}function b(n,t,e=!1){let o=[];if(e){let s=2**n.components.pools.length-1&~t;for(let r in n.archetypes)(parseInt(r)&~t&s)>0&&o.push(...n.archetypes[r])}else for(let s in n.archetypes)(parseInt(s)&t)==t&&o.push(...n.archetypes[s]);return o}var g=class{nextId=0;pool=new u(()=>this.nextId++);add(){return this.pool.addObj()}findIndex(t){return this.pool.findIndex(t)}delete(t){return this.pool.removeObj(t)}};var C=class{indices;components;entities;entityMasks;archetypes;constructor(){this.indices=[],this.components=new f,this.entities=new g,this.entityMasks=[],this.archetypes={0:new Set}}addEntity(){let t=this.entities.add();return this.indices[t]=[],this.entityMasks[t]=0,this.archetypes[0].add(t),t}removeEntity(t){let e=this.entities.pool.active[t];for(let o=0,s=this.components.pools.length;o<s;o++)this.entityMasks[e]&1<<o&&this.components.pools[o].removeObj(this.indices[e][o]);return this.archetypes[0].delete(e),this.entities.delete(t)}entityExists(t){if(!this.indices[t])throw new Error(`Entity ${t} does not exist.`)}componentExists(t){if(!this.components.isRegistered(t))throw new Error(`Component ${t.name} is not registered.`)}registerComponent(t){return this.components.register(t),this}hasComponent(t,e){return(this.entityMasks[t]&1<<e.id)>0}addComponent(t,e){if(this.entityExists(t),this.componentExists(e),this.hasComponent(t,e))throw new Error(`Entity ${t} already had this component.`);this.archetypes[this.entityMasks[t]].delete(t),this.entityMasks[t]|=1<<e.id,this.archetypes[this.entityMasks[t]]??=new Set,this.archetypes[this.entityMasks[t]].add(t),this.indices[t][e.id]=this.components.len(e);let o=this.components.add(e);return o.owner=t,o}removeComponent(t,e){if(this.entityExists(t),this.componentExists(e),!this.hasComponent(t,e))throw new Error(`Entity ${t} does not have component ${e.name}.`);this.archetypes[this.entityMasks[t]].delete(t),this.entityMasks[t]&=~(1<<e.id),this.archetypes[this.entityMasks[t]]??=new Set,this.archetypes[this.entityMasks[t]].add(t);let o=this.components.delete(e,this.indices[t][e.id]),s=this.components.pools[e.id].active[t].owner;return this.indices[s][e.id]=this.indices[t][e.id],o}getComponent(t,e){if(this.entityExists(t),this.componentExists(e),!this.hasComponent(t,e))throw new Error(`Entity ${t} does not have component ${e.name}.`);return this.components.get(e,this.indices[t][e.id])}};function d(n,t){return Math.random()*(t-n)+n}function v(n,t=0){let e=performance.now();t/=1e3,j(n,t),$(n,t),O(n,t),S(n,t),requestAnimationFrame(()=>v(n,performance.now()-e))}var h=document.createElement("canvas"),i=h.getContext("2d");document.body.appendChild(h);var w=1e3;function E(){h.width=innerWidth,h.height=innerHeight}E();window.onresize=E;document.body.style.margin="0px";document.body.style.userSelect="none";document.body.style.overflow="hidden";document.body.style.touchAction="none";var l=new C,a=class extends y{x=0;y=0},p=class extends y{x=0;y=0},m=class extends y{radius=10;color="green"};l.registerComponent(a).registerComponent(p).registerComponent(m);var I=x(a,m),k=x(a,p),M=x(a,p,m);function S(n,t){if(!i)return;let e=`FPS: ${(1/t).toFixed(0)}`,o=30,s=i.measureText(e),r=10,c=5,T=i.fillStyle;i.font=`${o}px serif`,i.fillStyle="white",i.fillRect(r,r,2*c+s.width,2*c+s.emHeightAscent),i.fillStyle="black",i.fillText(e,c+r,c+r+s.emHeightAscent),i.fillStyle=T}function j(n,t){if(!i)return;let e=2*Math.PI,o=b(n,I);i.lineWidth=3,i.fillRect(0,0,h.width,h.height);let s=i.strokeStyle;o.forEach(r=>{let c=n.getComponent(r,a),T=n.getComponent(r,m);i.strokeStyle=T.color,i.beginPath(),i.arc(c.x,c.y,T.radius,0,e),i.stroke()}),i.strokeStyle=s}function $(n,t){b(n,k).forEach(o=>{let s=n.getComponent(o,a),r=n.getComponent(o,p);s.x+=r.x*t,s.y+=r.y*t})}function O(n,t){b(n,M).forEach(o=>{let s=n.getComponent(o,a),r=n.getComponent(o,p),c=n.getComponent(o,m);(s.x-c.radius<0||s.x+c.radius>h.width)&&(r.x*=-1,s.x=s.x<h.width*.5?c.radius:h.width-c.radius),(s.y-c.radius<0||s.y+c.radius>h.height)&&(r.y*=-1,s.y=s.y<h.height*.5?c.radius:h.height-c.radius)})}function W(){let n=l.addEntity(),t=l.addComponent(n,a),e=l.addComponent(n,p),o=l.addComponent(n,m),s=100;return t.x=d(0,h.width),t.y=d(0,h.height),e.x=d(-s,s),e.y=d(-s,s),o.radius=d(10,30),o.color=`rgb(${d(0,255)}, ${d(0,255)}, ${d(0,255)})`,n}for(let n=0;n<w;++n)W();v(l);})();
